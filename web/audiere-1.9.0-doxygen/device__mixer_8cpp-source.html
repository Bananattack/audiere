<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>device_mixer.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>device_mixer.cpp</h1><a href="device__mixer_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="preprocessor">#ifdef _MSC_VER</span>
00002 <span class="preprocessor"></span><span class="preprocessor">#pragma warning(disable : 4786)</span>
00003 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00004 <span class="preprocessor"></span>
00005 
00006 <span class="preprocessor">#include &lt;algorithm&gt;</span>
00007 <span class="preprocessor">#include "<a class="code" href="device__mixer_8h.html">device_mixer.h</a>"</span>
00008 <span class="preprocessor">#include "<a class="code" href="resampler_8h.html">resampler.h</a>"</span>
00009 <span class="preprocessor">#include "<a class="code" href="utility_8h.html">utility.h</a>"</span>
00010 
00011 
00012 <span class="keyword">namespace </span>audiere {
00013 
<a name="l00014"></a><a class="code" href="classaudiere_1_1MixerDevice.html#a0">00014</a>   MixerDevice::MixerDevice(<span class="keywordtype">int</span> rate) {
00015     m_rate = rate;
00016   }
00017 
00018 
00019   OutputStream*
<a name="l00020"></a><a class="code" href="classaudiere_1_1MixerDevice.html#a1">00020</a>   MixerDevice::openStream(<a class="code" href="classaudiere_1_1SampleSource.html">SampleSource</a>* source) {
00021     <span class="keywordflow">return</span> (source ? <span class="keyword">new</span> <a class="code" href="classaudiere_1_1MixerDevice.html#l0">MixerStream</a>(<span class="keyword">this</span>, source, m_rate) : 0);
00022   }
00023 
00024 
00025   OutputStream*
<a name="l00026"></a><a class="code" href="classaudiere_1_1MixerDevice.html#a2">00026</a>   MixerDevice::openBuffer(
00027     <span class="keywordtype">void</span>* samples, <span class="keywordtype">int</span> frame_count,
00028     <span class="keywordtype">int</span> channel_count, <span class="keywordtype">int</span> sample_rate, <a class="code" href="namespaceaudiere.html#a59">SampleFormat</a> <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>)
00029   {
00030     <span class="keywordflow">return</span> <a class="code" href="classaudiere_1_1MixerDevice.html#a1">openStream</a>(<a class="code" href="namespaceaudiere.html#a57">OpenBufferStream</a>(
00031       samples, frame_count,
00032       channel_count, sample_rate, <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>));
00033   }
00034 
00035 
00036   <span class="keywordtype">int</span>
<a name="l00037"></a><a class="code" href="classaudiere_1_1MixerDevice.html#b0">00037</a>   MixerDevice::read(<span class="keyword">const</span> <span class="keywordtype">int</span> sample_count, <span class="keywordtype">void</span>* samples) {
00038     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"MixerDevice::read"</span>);
00039 
00040     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(<span class="keyword">this</span>);
00041 
00042     <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"done locking mixer device"</span>);
00043 
00044     <span class="comment">// are any sources playing?</span>
00045     <span class="keywordtype">bool</span> any_playing = <span class="keyword">false</span>;
00046     <span class="keywordflow">for</span> (std::list&lt;MixerStream*&gt;::iterator i = m_streams.begin();
00047          i != m_streams.end();
00048          ++i)
00049     {
00050       any_playing |= (*i)-&gt;isPlaying();
00051     }
00052   
00053     <span class="comment">// if not, return zeroed samples</span>
00054     <span class="keywordflow">if</span> (!any_playing) {
00055       memset(samples, 0, 4 * sample_count);
00056       <span class="keywordflow">return</span> sample_count;
00057     }
00058 
00059     <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"at least one stream is playing"</span>);
00060 
00061     <span class="comment">// buffer in which to mix the audio</span>
00062     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> BUFFER_SIZE = 4096;
00063 
00064     <span class="comment">// mix the output in chunks of BUFFER_SIZE samples</span>
00065     <a class="code" href="namespaceaudiere.html#a16">s16</a>* out = (<a class="code" href="namespaceaudiere.html#a16">s16</a>*)samples;
00066     <span class="keywordtype">int</span> left = sample_count;
00067     <span class="keywordflow">while</span> (left &gt; 0) {
00068       <span class="keywordtype">int</span> to_mix = std::min(BUFFER_SIZE, left);
00069 
00070       <a class="code" href="namespaceaudiere.html#a18">s32</a> mix_buffer[BUFFER_SIZE];
00071       memset(mix_buffer, 0, <span class="keyword">sizeof</span>(mix_buffer));
00072     
00073       <span class="keywordflow">for</span> (std::list&lt;MixerStream*&gt;::iterator s = m_streams.begin();
00074            s != m_streams.end();
00075            ++s)
00076       {
00077         <span class="keywordflow">if</span> ((*s)-&gt;isPlaying()) {
00078           <a class="code" href="namespaceaudiere.html#a16">s16</a> stream_buffer[BUFFER_SIZE * 2];
00079           (*s)-&gt;read(to_mix, stream_buffer);
00080           <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; to_mix * 2; ++i) {
00081             mix_buffer[i] += stream_buffer[i];
00082           }
00083         }
00084       }
00085 
00086       <span class="comment">// clamp each value in the buffer to the valid s16 range</span>
00087       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; to_mix * 2; ++i) {
00088         <a class="code" href="namespaceaudiere.html#a18">s32</a> mixed = mix_buffer[i];
00089         <a class="code" href="namespaceaudiere.html#a16">s16</a> o;
00090         <span class="keywordflow">if</span> (mixed &lt; -32768) {
00091           o = -32768;
00092         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mixed &gt; 32767) {
00093           o = 32767;
00094         } <span class="keywordflow">else</span> {
00095           o = mixed;
00096         }
00097         *out++ = o;
00098       }
00099 
00100       left -= to_mix;
00101     }
00102 
00103     <span class="keywordflow">return</span> sample_count;
00104   }
00105 
00106 
<a name="l00107"></a><a class="code" href="classaudiere_1_1MixerStream.html#a0">00107</a>   MixerStream::MixerStream(
00108     <a class="code" href="classaudiere_1_1MixerDevice.html">MixerDevice</a>* device,
00109     <a class="code" href="classaudiere_1_1SampleSource.html">SampleSource</a>* source,
00110     <span class="keywordtype">int</span> rate)
00111   {
00112     m_device     = device;
00113     m_source     = <span class="keyword">new</span> <a class="code" href="classaudiere_1_1RepeatableStream.html">RepeatableStream</a>(<span class="keyword">new</span> <a class="code" href="classaudiere_1_1Resampler.html">Resampler</a>(source, rate));
00114     m_last_l     = 0;
00115     m_last_r     = 0;
00116     m_is_playing = <span class="keyword">false</span>;
00117     m_volume     = 255;
00118     m_pan        = 0;
00119 
00120     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00121     m_device-&gt;m_streams.push_back(<span class="keyword">this</span>);
00122   }
00123 
00124 
<a name="l00125"></a><a class="code" href="classaudiere_1_1MixerStream.html#a1">00125</a>   MixerStream::~MixerStream() {
00126     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00127     m_device-&gt;m_streams.remove(<span class="keyword">this</span>);
00128   }
00129 
00130 
00131   <span class="keywordtype">void</span>
<a name="l00132"></a><a class="code" href="classaudiere_1_1MixerStream.html#a2">00132</a>   MixerStream::play() {
00133     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00134     m_is_playing = <span class="keyword">true</span>;
00135   }
00136 
00137 
00138   <span class="keywordtype">void</span>
<a name="l00139"></a><a class="code" href="classaudiere_1_1MixerStream.html#a3">00139</a>   MixerStream::stop() {
00140     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00141     m_is_playing = <span class="keyword">false</span>;
00142   }
00143 
00144 
00145   <span class="keywordtype">bool</span>
<a name="l00146"></a><a class="code" href="classaudiere_1_1MixerStream.html#a4">00146</a>   MixerStream::isPlaying() {
00147     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00148     <span class="keywordflow">return</span> m_is_playing;
00149   }
00150 
00151 
00152   <span class="keywordtype">void</span>
<a name="l00153"></a><a class="code" href="classaudiere_1_1MixerStream.html#a5">00153</a>   MixerStream::reset() {
00154     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00155     m_source-&gt;reset();
00156   }
00157 
00158 
00159   <span class="keywordtype">void</span>
<a name="l00160"></a><a class="code" href="classaudiere_1_1MixerStream.html#a6">00160</a>   MixerStream::setRepeat(<span class="keywordtype">bool</span> repeat) {
00161     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00162     m_source-&gt;setRepeat(repeat);
00163   }
00164 
00165 
00166   <span class="keywordtype">bool</span>
<a name="l00167"></a><a class="code" href="classaudiere_1_1MixerStream.html#a7">00167</a>   MixerStream::getRepeat() {
00168     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00169     <span class="keywordflow">return</span> m_source-&gt;getRepeat();
00170   }
00171 
00172 
00173   <span class="keywordtype">void</span>
<a name="l00174"></a><a class="code" href="classaudiere_1_1MixerStream.html#a8">00174</a>   MixerStream::setVolume(<span class="keywordtype">float</span> volume) {
00175     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00176     m_volume = int(volume * 255.0f + 0.5f);
00177   }
00178 
00179 
00180   <span class="keywordtype">float</span>
<a name="l00181"></a><a class="code" href="classaudiere_1_1MixerStream.html#a9">00181</a>   MixerStream::getVolume() {
00182     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00183     <span class="keywordflow">return</span> (m_volume / 255.0f);
00184   }
00185 
00186 
00187   <span class="keywordtype">void</span>
<a name="l00188"></a><a class="code" href="classaudiere_1_1MixerStream.html#a10">00188</a>   MixerStream::setPan(<span class="keywordtype">float</span> pan) {
00189     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00190     m_pan = int(pan * 255.0f);
00191   }
00192 
00193 
00194   <span class="keywordtype">float</span>
<a name="l00195"></a><a class="code" href="classaudiere_1_1MixerStream.html#a11">00195</a>   MixerStream::getPan() {
00196     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00197     <span class="keywordflow">return</span> m_pan = 255.0f;
00198   }
00199 
00200 
00201   <span class="keywordtype">bool</span>
<a name="l00202"></a><a class="code" href="classaudiere_1_1MixerStream.html#a12">00202</a>   MixerStream::isSeekable() {
00203     <span class="keywordflow">return</span> m_source-&gt;isSeekable();
00204   }
00205 
00206 
00207   <span class="keywordtype">int</span>
<a name="l00208"></a><a class="code" href="classaudiere_1_1MixerStream.html#a13">00208</a>   MixerStream::getLength() {
00209     <span class="keywordflow">return</span> m_source-&gt;getLength();
00210   }
00211 
00212 
00213   <span class="keywordtype">void</span>
<a name="l00214"></a><a class="code" href="classaudiere_1_1MixerStream.html#a14">00214</a>   MixerStream::setPosition(<span class="keywordtype">int</span> position) {
00215     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00216     m_source-&gt;setPosition(position);
00217   }
00218 
00219 
00220   <span class="keywordtype">int</span>
<a name="l00221"></a><a class="code" href="classaudiere_1_1MixerStream.html#a15">00221</a>   MixerStream::getPosition() {
00222     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00223     <span class="keywordflow">return</span> m_source-&gt;getPosition();
00224   }
00225 
00226 
00227   <span class="keywordtype">void</span>
00228   MixerStream::read(<span class="keywordtype">int</span> frame_count, <a class="code" href="namespaceaudiere.html#a16">s16</a>* buffer) {
00229     <span class="keywordtype">unsigned</span> read = m_source-&gt;read(frame_count, buffer);
00230 
00231     <span class="comment">// if we are done with the sample source, stop and reset it</span>
00232     <span class="keywordflow">if</span> (read == 0) {
00233       m_is_playing = <span class="keyword">false</span>;
00234       m_source-&gt;reset();
00235     }
00236 
00237     <span class="keywordtype">int</span> l_volume, r_volume;
00238     <span class="keywordflow">if</span> (m_pan &lt; 0) {
00239       l_volume = 255;
00240       r_volume = 255 + m_pan;
00241     } <span class="keywordflow">else</span> {
00242       l_volume = 255 - m_pan;
00243       r_volume = 255;
00244     }
00245 
00246     l_volume *= m_volume;
00247     r_volume *= m_volume;
00248 
00249     <a class="code" href="namespaceaudiere.html#a16">s16</a>* out = buffer;
00250     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; read; ++i) {
00251       *out = *out * l_volume / 255 / 255;
00252       ++out;
00253       *out = *out * r_volume / 255 / 255;
00254       ++out;
00255     }
00256 
00257     <span class="keywordtype">int</span> l = m_last_l;
00258     <span class="keywordtype">int</span> r = m_last_r;
00259 
00260     <span class="keywordflow">if</span> (read &gt; 0) {
00261       l = out[-2];
00262       r = out[-1];
00263     }
00264 
00265     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = read; i &lt; frame_count; ++i) {
00266       *out++ = m_last_l;
00267       *out++ = m_last_r;
00268     }
00269 
00270     m_last_l = l;
00271     m_last_r = r;
00272   }
00273 
00274 }
</pre></div><hr><address style="align: right;"><small>Generated on Sat Sep 7 15:33:39 2002 for audiere by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
