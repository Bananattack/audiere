<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>resampler.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>resampler.cpp</h1><a href="resampler_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="preprocessor">#include "<a class="code" href="resampler_8h.html">resampler.h</a>"</span>
00002 
00003 
00004 <span class="keyword">namespace </span>audiere {
00005 
<a name="l00006"></a><a class="code" href="classaudiere_1_1Resampler.html#a0">00006</a>   Resampler::Resampler(<a class="code" href="classaudiere_1_1SampleSource.html">SampleSource</a>* source, <span class="keywordtype">int</span> rate) {
00007     m_source = source;
00008     m_rate = rate;
00009     m_source-&gt;getFormat(
00010       m_native_channel_count,
00011       m_native_sample_rate,
00012       m_native_sample_format);
00013 
00014     fillBuffer();
00015     resetState();
00016   }
00017 
00018   <span class="keywordtype">void</span>
<a name="l00019"></a><a class="code" href="classaudiere_1_1Resampler.html#a1">00019</a>   Resampler::getFormat(
00020     <span class="keywordtype">int</span>&amp; channel_count,
00021     <span class="keywordtype">int</span>&amp; sample_rate,
00022     <a class="code" href="namespaceaudiere.html#a59">SampleFormat</a>&amp; <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>)
00023   {
00024     channel_count = 2;
00025     sample_rate = m_rate;
00026     <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a> = <a class="code" href="namespaceaudiere.html#a59a1">SF_S16</a>;
00027   }
00028 
00029   <span class="keywordtype">int</span>
<a name="l00030"></a><a class="code" href="classaudiere_1_1Resampler.html#a2">00030</a>   Resampler::read(<span class="keyword">const</span> <span class="keywordtype">int</span> frame_count, <span class="keywordtype">void</span>* buffer) {
00031     <a class="code" href="namespaceaudiere.html#a15">u16</a>* out = (<a class="code" href="namespaceaudiere.html#a15">u16</a>*)buffer;
00032 
00033     <span class="keywordtype">int</span> left = frame_count;
00034 
00035     <span class="comment">// if we didn't finish resampling last time...</span>
00036     <span class="keywordflow">while</span> (m_time &gt; m_native_sample_rate &amp;&amp; left &gt; 0) {
00037       m_time -= m_native_sample_rate;
00038       *out++ = m_sl;
00039       *out++ = m_sr;
00040       --left;
00041     }
00042 
00043     <span class="keywordflow">while</span> (left &gt; 0) {
00044 
00045       <span class="keywordflow">if</span> (m_samples_left == 0) {
00046         <span class="comment">// try to fill the native buffer</span>
00047         fillBuffer();
00048 
00049         <span class="comment">// could we read any more?</span>
00050         <span class="keywordflow">if</span> (m_samples_left == 0) {
00051           <span class="keywordflow">return</span> frame_count - left;
00052         }
00053       }
00054 
00055       m_sl = *m_position++;
00056       m_sr = *m_position++;
00057       --m_samples_left;
00058 
00059       m_time += m_rate;
00060       <span class="keywordflow">while</span> (m_time &gt; m_native_sample_rate &amp;&amp; left &gt; 0) {
00061         m_time -= m_native_sample_rate;
00062         *out++ = m_sl;
00063         *out++ = m_sr;
00064         --left;
00065       }
00066 
00067     }
00068     <span class="keywordflow">return</span> frame_count;
00069   }
00070 
00071   <span class="keywordtype">void</span>
<a name="l00072"></a><a class="code" href="classaudiere_1_1Resampler.html#a3">00072</a>   Resampler::reset() {
00073     m_source-&gt;reset();
00074     fillBuffer();
00075     resetState();
00076   }
00077 
00078 
<a name="l00079"></a><a class="code" href="namespaceaudiere.html#a39">00079</a>   <span class="keyword">inline</span> <a class="code" href="namespaceaudiere.html#a16">s16</a> <a class="code" href="namespaceaudiere.html#a39">u8tos16</a>(<a class="code" href="namespaceaudiere.html#a13">u8</a> u) {
00080     <span class="keywordflow">return</span> (<a class="code" href="namespaceaudiere.html#a16">s16</a>(u) - 128) * 256;
00081   }
00082 
00083   <span class="keywordtype">void</span>
00084   Resampler::fillBuffer() {
00085     <span class="comment">// we only support channels in [1, 2] and bits in [8, 16] now</span>
00086     <a class="code" href="namespaceaudiere.html#a13">u8</a> initial_buffer[NATIVE_BUFFER_SIZE * 4];
00087     <span class="keywordtype">unsigned</span> read = m_source-&gt;read(NATIVE_BUFFER_SIZE, initial_buffer);
00088 
00089     <a class="code" href="namespaceaudiere.html#a16">s16</a>* out = m_native_buffer;
00090 
00091     <span class="keywordflow">if</span> (m_native_channel_count == 1) {
00092       <span class="keywordflow">if</span> (m_native_sample_format == <a class="code" href="namespaceaudiere.html#a59a0">SF_U8</a>) {
00093 
00094         <span class="comment">// channels = 1, bits = 8</span>
00095         <a class="code" href="namespaceaudiere.html#a13">u8</a>* in = initial_buffer;
00096         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i &lt; read; ++i) {
00097           <a class="code" href="namespaceaudiere.html#a16">s16</a> sample = <a class="code" href="namespaceaudiere.html#a39">u8tos16</a>(*in++);
00098           *out++ = sample;
00099           *out++ = sample;
00100         }
00101 
00102       } <span class="keywordflow">else</span> {
00103 
00104         <span class="comment">// channels = 1, bits = 16</span>
00105         <a class="code" href="namespaceaudiere.html#a16">s16</a>* in = (<a class="code" href="namespaceaudiere.html#a16">s16</a>*)initial_buffer;
00106         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i &lt; read; ++i) {
00107           <a class="code" href="namespaceaudiere.html#a16">s16</a> sample = *in++;
00108           *out++ = sample;
00109           *out++ = sample;
00110         }
00111 
00112       }
00113     } <span class="keywordflow">else</span> {
00114       <span class="keywordflow">if</span> (m_native_sample_format == <a class="code" href="namespaceaudiere.html#a59a0">SF_U8</a>) {
00115 
00116         <span class="comment">// channels = 2, bits = 8</span>
00117         <a class="code" href="namespaceaudiere.html#a13">u8</a>* in = initial_buffer;
00118         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i &lt; read; ++i) {
00119           *out++ = <a class="code" href="namespaceaudiere.html#a39">u8tos16</a>(*in++);
00120           *out++ = <a class="code" href="namespaceaudiere.html#a39">u8tos16</a>(*in++);
00121         }
00122 
00123       } <span class="keywordflow">else</span> {
00124 
00125         <span class="comment">// channels = 2, bits = 16</span>
00126         <a class="code" href="namespaceaudiere.html#a16">s16</a>* in = (<a class="code" href="namespaceaudiere.html#a16">s16</a>*)initial_buffer;
00127         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i &lt; read; ++i) {
00128           *out++ = *in++;
00129           *out++ = *in++;
00130         }
00131       
00132       }
00133     }
00134 
00135     m_position = m_native_buffer;
00136     m_samples_left = read;
00137   }
00138 
00139   <span class="keywordtype">void</span>
00140   Resampler::resetState() {
00141     m_time = 0;
00142     m_sl = 0;
00143     m_sr = 0;
00144   }
00145 
00146   <span class="keywordtype">bool</span>
<a name="l00147"></a><a class="code" href="classaudiere_1_1Resampler.html#a4">00147</a>   Resampler::isSeekable() {
00148     <span class="keywordflow">return</span> m_source-&gt;isSeekable();
00149   }
00150 
00151   <span class="keywordtype">int</span>
<a name="l00152"></a><a class="code" href="classaudiere_1_1Resampler.html#a5">00152</a>   Resampler::getLength() {
00153     <span class="keywordflow">return</span> m_source-&gt;getLength();
00154   }
00155 
00156   <span class="keywordtype">void</span>
<a name="l00157"></a><a class="code" href="classaudiere_1_1Resampler.html#a6">00157</a>   Resampler::setPosition(<span class="keywordtype">int</span> position) {
00158     m_source-&gt;setPosition(position);
00159     fillBuffer();
00160     resetState();
00161   }
00162 
00163   <span class="keywordtype">int</span>
<a name="l00164"></a><a class="code" href="classaudiere_1_1Resampler.html#a7">00164</a>   Resampler::getPosition() {
00165     <span class="keywordflow">return</span> m_source-&gt;getPosition() - m_samples_left;
00166   }
00167 
00168 }
</pre></div><hr><address style="align: right;"><small>Generated on Sat Sep 7 15:33:40 2002 for audiere by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
