<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>device_ds_stream.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>device_ds_stream.cpp</h1><a href="device__ds__stream_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="preprocessor">#include "<a class="code" href="device__ds__stream_8h.html">device_ds_stream.h</a>"</span>
00002 <span class="preprocessor">#include "<a class="code" href="device__ds_8h.html">device_ds.h</a>"</span>
00003 <span class="preprocessor">#include "<a class="code" href="debug_8h.html">debug.h</a>"</span>
00004 
00005 
00006 <span class="keyword">namespace </span>audiere {
00007 
<a name="l00008"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a0">00008</a>   DSOutputStream::DSOutputStream(
00009     <a class="code" href="classaudiere_1_1DSAudioDevice.html">DSAudioDevice</a>* device,
00010     IDirectSoundBuffer* buffer,
00011     <span class="keywordtype">int</span> buffer_length,
00012     <a class="code" href="classaudiere_1_1SampleSource.html">SampleSource</a>* source)
00013   {
00014     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"DSOutputStream::DSOutputStream"</span>);
00015 
00016     m_device = device;
00017 
00018     m_buffer        = buffer;
00019     m_buffer_length = buffer_length;
00020     m_next_read     = 0;
00021     m_last_play     = 0;
00022 
00023     m_is_playing = <span class="keyword">false</span>;
00024 
00025     m_source = <span class="keyword">new</span> <a class="code" href="classaudiere_1_1RepeatableStream.html">RepeatableStream</a>(source);
00026 
00027     <span class="keywordtype">int</span> channel_count, sample_rate;
00028     <a class="code" href="namespaceaudiere.html#a59">SampleFormat</a> <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>;
00029     source-&gt;<a class="code" href="classaudiere_1_1SampleSource.html#a0">getFormat</a>(channel_count, sample_rate, <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>);
00030     m_sample_size = <a class="code" href="namespaceaudiere.html#a22">GetSampleSize</a>(<a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>) * channel_count;
00031 
00032     m_total_read    = 0;
00033     m_total_written = 0;
00034 
00035     m_last_sample = <span class="keyword">new</span> BYTE[m_sample_size];
00036 
00037     <a class="code" href="classaudiere_1_1DSOutputStream.html#a8">setVolume</a>(1);
00038     <a class="code" href="classaudiere_1_1DSOutputStream.html#a10">setPan</a>(0);
00039 
00040     <span class="comment">// fill the buffer with data</span>
00041     fillStream();
00042   }
00043 
00044 
<a name="l00045"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a1">00045</a>   DSOutputStream::~DSOutputStream() {
00046     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"DSOutputStream::~DSOutputStream"</span>);
00047 
00048     m_device-&gt;removeStream(<span class="keyword">this</span>);
00049 
00050     <span class="comment">// destroy the sound buffer interface</span>
00051     m_buffer-&gt;Release();
00052     <span class="keyword">delete</span>[] m_last_sample;
00053   }
00054 
00055   
00056   <span class="keywordtype">void</span>
<a name="l00057"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a2">00057</a>   DSOutputStream::play() {
00058     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"DSOutputStream::play"</span>);
00059     m_buffer-&gt;Play(0, 0, DSBPLAY_LOOPING);
00060     m_is_playing = <span class="keyword">true</span>;
00061   }
00062 
00063 
00064   <span class="keywordtype">void</span>
<a name="l00065"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a3">00065</a>   DSOutputStream::stop() {
00066     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"DSOutputStream::stop"</span>);
00067     m_buffer-&gt;Stop();
00068     m_is_playing = <span class="keyword">false</span>;
00069   }
00070 
00071 
00072   <span class="keywordtype">bool</span>
<a name="l00073"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a4">00073</a>   DSOutputStream::isPlaying() {
00074     <span class="keywordflow">return</span> m_is_playing;
00075   }
00076 
00077 
00078   <span class="keywordtype">void</span>
<a name="l00079"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a5">00079</a>   DSOutputStream::reset() {
00080     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"DSOutputStream::reset"</span>);
00081     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00082 
00083     <span class="comment">// figure out if we're playing or not</span>
00084     <span class="keywordtype">bool</span> is_playing = <a class="code" href="classaudiere_1_1DSOutputStream.html#a4">isPlaying</a>();
00085 
00086     <span class="comment">// if we're playing, stop</span>
00087     <span class="keywordflow">if</span> (is_playing) {
00088       <a class="code" href="classaudiere_1_1DSOutputStream.html#a3">stop</a>();
00089     }
00090 
00091     m_buffer-&gt;SetCurrentPosition(0);
00092     m_last_play = 0;
00093 
00094     m_source-&gt;reset();
00095     m_total_read = 0;
00096     m_total_written = 0;
00097     m_next_read = 0;
00098     fillStream();
00099 
00100     <span class="comment">// if we were playing, restart</span>
00101     <span class="keywordflow">if</span> (is_playing) {
00102       <a class="code" href="classaudiere_1_1DSOutputStream.html#a2">play</a>();
00103     }
00104   }
00105 
00106 
00107   <span class="keywordtype">void</span>
<a name="l00108"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a6">00108</a>   DSOutputStream::setRepeat(<span class="keywordtype">bool</span> repeat) {
00109     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00110     m_source-&gt;setRepeat(repeat);
00111   }
00112 
00113 
00114   <span class="keywordtype">bool</span>
<a name="l00115"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a7">00115</a>   DSOutputStream::getRepeat() {
00116     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00117     <span class="keywordflow">return</span> m_source-&gt;getRepeat();
00118   }
00119 
00120 
00121   <span class="keywordtype">void</span>
<a name="l00122"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a8">00122</a>   DSOutputStream::setVolume(<span class="keywordtype">float</span> volume) {
00123     m_volume = volume;
00124     m_buffer-&gt;SetVolume(DSAudioDevice::Volume_AudiereToDirectSound(volume));
00125   }
00126 
00127 
00128   <span class="keywordtype">float</span>
<a name="l00129"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a9">00129</a>   DSOutputStream::getVolume() {
00130     <span class="keywordflow">return</span> m_volume;
00131   }
00132 
00133 
00134   <span class="keywordtype">void</span>
<a name="l00135"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a10">00135</a>   DSOutputStream::setPan(<span class="keywordtype">float</span> pan) {
00136     m_pan = pan;
00137     m_buffer-&gt;SetPan(DSAudioDevice::Pan_AudiereToDirectSound(pan));
00138   }
00139 
00140 
00141   <span class="keywordtype">float</span>
<a name="l00142"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a11">00142</a>   DSOutputStream::getPan() {
00143     <span class="keywordflow">return</span> m_pan;
00144   }
00145 
00146 
00147   <span class="keywordtype">bool</span>
<a name="l00148"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a12">00148</a>   DSOutputStream::isSeekable() {
00149     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00150     <span class="keywordflow">return</span> m_source-&gt;isSeekable();
00151   }
00152 
00153 
00154   <span class="keywordtype">int</span>
<a name="l00155"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a13">00155</a>   DSOutputStream::getLength() {
00156     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00157     <span class="keywordflow">return</span> m_source-&gt;getLength();
00158   }
00159 
00160 
00161   <span class="keywordtype">void</span>
<a name="l00162"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a14">00162</a>   DSOutputStream::setPosition(<span class="keywordtype">int</span> position) {
00163     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00164 
00165     <span class="comment">// figure out if we're playing or not</span>
00166     <span class="keywordtype">bool</span> is_playing = <a class="code" href="classaudiere_1_1DSOutputStream.html#a4">isPlaying</a>();
00167 
00168     <span class="comment">// if we're playing, stop</span>
00169     <span class="keywordflow">if</span> (is_playing) {
00170       <a class="code" href="classaudiere_1_1DSOutputStream.html#a3">stop</a>();
00171     }
00172 
00173     m_source-&gt;setPosition(position);
00174     m_last_play = 0;
00175 
00176     m_source-&gt;setPosition(position);
00177     m_total_read = 0;
00178     m_total_written = 0;
00179     m_next_read = 0;
00180     fillStream();
00181 
00182     <span class="comment">// if we were playing, restart</span>
00183     <span class="keywordflow">if</span> (is_playing) {
00184       <a class="code" href="classaudiere_1_1DSOutputStream.html#a2">play</a>();
00185     }
00186   }
00187 
00188 
00189   <span class="keywordtype">int</span>
<a name="l00190"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a15">00190</a>   DSOutputStream::getPosition() {
00191     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00192     <span class="keywordtype">int</span> pos = m_source-&gt;getPosition() - (m_total_read - m_total_written);
00193     <span class="keywordflow">if</span> (pos &lt; 0) {
00194       pos += m_source-&gt;getLength();
00195     }
00196     <span class="keywordflow">return</span> pos;
00197   }
00198 
00199 
00200   <span class="keywordtype">void</span>
00201   DSOutputStream::fillStream() {
00202     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"DSOutputStream::fillStream"</span>);
00203 
00204     <span class="comment">// we know the stream is stopped, so just lock the buffer and fill it</span>
00205 
00206     <span class="keywordtype">void</span>* buffer = NULL;
00207     DWORD buffer_length = 0;
00208 
00209     <span class="comment">// lock</span>
00210     HRESULT result = m_buffer-&gt;Lock(
00211       0,
00212       m_buffer_length * m_sample_size,
00213       &amp;buffer,
00214       &amp;buffer_length,
00215       NULL,
00216       NULL,
00217       0);
00218     <span class="keywordflow">if</span> (FAILED(result) || !buffer) {
00219       <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"FillStream failed!"</span>);
00220       <span class="keywordflow">return</span>;
00221     }
00222 
00223     <a class="code" href="debug_8h.html#a2">ADR_IF_DEBUG</a> {
00224       <span class="keywordtype">char</span> str[80];
00225       sprintf(str, <span class="stringliteral">"Buffer Length = %d"</span>, buffer_length);
00226       <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(str);
00227     }
00228 
00229     <span class="comment">// fill</span>
00230     <span class="keywordtype">int</span> samples_to_read = buffer_length / m_sample_size;
00231     <span class="keywordtype">int</span> samples_read = streamRead(samples_to_read, buffer);
00232     <span class="keywordflow">if</span> (samples_read != samples_to_read) {
00233       m_next_read = samples_read;
00234     } <span class="keywordflow">else</span> {
00235       m_next_read = 0;
00236     }
00237 
00238     <span class="comment">// unlock</span>
00239     m_buffer-&gt;Unlock(buffer, buffer_length, NULL, 0);
00240   }
00241 
00242 
00243   <span class="keywordtype">void</span>
00244   DSOutputStream::update() {
00245     <span class="comment">// if it's not playing, don't do anything</span>
00246     <span class="keywordflow">if</span> (!<a class="code" href="classaudiere_1_1DSOutputStream.html#a4">isPlaying</a>()) {
00247       <span class="keywordflow">return</span>;
00248     }
00249 
00250     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"DSOutputStream::update"</span>);
00251 
00252     <span class="comment">/* this method reads more PCM data into the stream if it is required */</span>
00253 
00254     <span class="comment">// read the stream's play and write cursors</span>
00255     DWORD <a class="code" href="classaudiere_1_1DSOutputStream.html#a2">play</a>, write;
00256     HRESULT result = m_buffer-&gt;GetCurrentPosition(&amp;<a class="code" href="classaudiere_1_1DSOutputStream.html#a2">play</a>, &amp;write);
00257     <span class="keywordflow">if</span> (FAILED(result)) {
00258       <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"GetCurrentPosition failed"</span>);
00259       <span class="keywordflow">return</span>;
00260     }
00261 
00262     <a class="code" href="debug_8h.html#a2">ADR_IF_DEBUG</a> {
00263       <span class="keywordtype">char</span> str[160];
00264       sprintf(str,
00265         <span class="stringliteral">"play: %d  write: %d  nextread: %d"</span>,
00266         <a class="code" href="classaudiere_1_1DSOutputStream.html#a2">play</a>, write, m_next_read);
00267       <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(str);
00268     }
00269 
00270     <span class="comment">// deal with them in samples, not bytes</span>
00271     <a class="code" href="classaudiere_1_1DSOutputStream.html#a2">play</a>  /= m_sample_size;
00272     write /= m_sample_size;
00273 
00274     <span class="comment">// how many samples have we written since the last update?</span>
00275     <span class="keywordflow">if</span> (<a class="code" href="classaudiere_1_1DSOutputStream.html#a2">play</a> &lt; m_last_play) {
00276       m_total_written += <a class="code" href="classaudiere_1_1DSOutputStream.html#a2">play</a> + m_buffer_length - m_last_play;
00277     } <span class="keywordflow">else</span> {
00278       m_total_written += <a class="code" href="classaudiere_1_1DSOutputStream.html#a2">play</a> - m_last_play;
00279     }
00280     m_last_play = <a class="code" href="classaudiere_1_1DSOutputStream.html#a2">play</a>;
00281 
00282     <span class="comment">// read from |m_next_read| to |play|</span>
00283     <span class="keywordtype">int</span> read_length = <a class="code" href="classaudiere_1_1DSOutputStream.html#a2">play</a> - m_next_read;
00284     <span class="keywordflow">if</span> (read_length &lt; 0) {
00285       read_length += m_buffer_length;
00286     }
00287 
00288     <span class="keywordflow">if</span> (read_length == 0) {
00289       <span class="keywordflow">return</span>;
00290     }
00291 
00292     <span class="comment">// lock the buffer</span>
00293     <span class="keywordtype">void</span>* buffer1;
00294     <span class="keywordtype">void</span>* buffer2;
00295     DWORD buffer1_length;
00296     DWORD buffer2_length;
00297     result = m_buffer-&gt;Lock(
00298       m_next_read * m_sample_size,
00299       read_length * m_sample_size,
00300       &amp;buffer1, &amp;buffer1_length,
00301       &amp;buffer2, &amp;buffer2_length,
00302       0);
00303     <span class="keywordflow">if</span> (FAILED(result)) {
00304       <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"Lock() failed!"</span>);
00305       <span class="keywordflow">return</span>;
00306     }
00307 
00308     <a class="code" href="debug_8h.html#a2">ADR_IF_DEBUG</a> {
00309       <span class="keywordtype">char</span> str[160];
00310       sprintf(str, <span class="stringliteral">"buffer1: %d  buffer2: %d"</span>, buffer1_length, buffer2_length);
00311       <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(str);
00312     }
00313 
00314     <span class="comment">// now actually read samples</span>
00315     <span class="keywordtype">int</span> length1 = buffer1_length / m_sample_size;
00316     <span class="keywordtype">int</span> length2 = buffer2_length / m_sample_size;
00317     <span class="keywordtype">int</span> read = streamRead(length1, buffer1);
00318     <span class="keywordflow">if</span> (length1 == read) {
00319       read += streamRead(length2, buffer2);
00320     }
00321 
00322     <a class="code" href="debug_8h.html#a2">ADR_IF_DEBUG</a> {
00323       <span class="keywordtype">char</span> str[80];
00324       sprintf(str, <span class="stringliteral">"read: %d"</span>, read);
00325       <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(str);
00326     }
00327 
00328     m_next_read = (m_next_read + read) % m_buffer_length;
00329 
00330     <span class="comment">// unlock</span>
00331     m_buffer-&gt;Unlock(buffer1, buffer1_length, buffer2, buffer2_length);
00332 
00333   
00334     <span class="comment">// Should we stop?</span>
00335     <span class="keywordflow">if</span> (m_total_written &gt; m_total_read) {
00336       <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"Stopping stream!"</span>);
00337 
00338       <a class="code" href="classaudiere_1_1DSOutputStream.html#a3">stop</a>();
00339       m_buffer-&gt;SetCurrentPosition(0);
00340       m_last_play = 0;
00341 
00342       m_source-&gt;reset();
00343 
00344       m_total_written = 0;
00345       m_total_read = 0;
00346       m_next_read = 0;
00347       fillStream();
00348 
00349       <span class="keywordflow">return</span>;
00350     }
00351   }
00352 
00353 
00354   <span class="comment">// read as much as possible from the stream source, fill the rest with 0</span>
00355   <span class="keywordtype">int</span>
00356   DSOutputStream::streamRead(<span class="keywordtype">int</span> sample_count, <span class="keywordtype">void</span>* samples) {
00357     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"streamRead"</span>);
00358 
00359     <span class="comment">// try to read from the stream</span>
00360     <span class="keywordtype">int</span> samples_read = m_source-&gt;read(sample_count, samples);
00361 
00362     <span class="comment">// read the last sample</span>
00363     <span class="keywordflow">if</span> (samples_read &gt; 0) {
00364       memcpy(
00365         m_last_sample,
00366         (BYTE*)samples + (samples_read - 1) * m_sample_size,
00367         m_sample_size);
00368     }
00369 
00370     <span class="comment">// fill the rest with silence</span>
00371     BYTE* out = (BYTE*)samples + m_sample_size * samples_read;
00372     <span class="keywordtype">int</span> c = sample_count - samples_read;
00373     <span class="keywordflow">while</span> (c--) {
00374       memcpy(out, m_last_sample, m_sample_size);
00375       out += m_sample_size;
00376     }
00377 
00378     m_total_read += samples_read;
00379     <span class="keywordflow">return</span> samples_read;
00380   }
00381 
00382 }
</pre></div><hr><address style="align: right;"><small>Generated on Sat Sep 7 15:33:39 2002 for audiere by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
