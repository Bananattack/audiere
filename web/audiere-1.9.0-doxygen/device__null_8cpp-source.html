<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>device_null.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>device_null.cpp</h1><a href="device__null_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="preprocessor">#ifdef _MSC_VER</span>
00002 <span class="preprocessor"></span><span class="preprocessor">#pragma warning(disable : 4786)</span>
00003 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00004 <span class="preprocessor"></span>
00005 
00006 <span class="preprocessor">#include &lt;algorithm&gt;</span>
00007 <span class="preprocessor">#include &lt;functional&gt;</span>
00008 <span class="preprocessor">#include "<a class="code" href="device__null_8h.html">device_null.h</a>"</span>
00009 <span class="preprocessor">#include "<a class="code" href="timer_8h.html">timer.h</a>"</span>
00010 <span class="preprocessor">#include "<a class="code" href="threads_8h.html">threads.h</a>"</span>
00011 <span class="preprocessor">#include "<a class="code" href="utility_8h.html">utility.h</a>"</span>
00012 
00013 <span class="keyword">namespace </span>audiere {
00014 
00015   NullAudioDevice*
<a name="l00016"></a><a class="code" href="classaudiere_1_1NullAudioDevice.html#d0">00016</a>   NullAudioDevice::create(<span class="keyword">const</span> <a class="code" href="classaudiere_1_1ParameterList.html">ParameterList</a>&amp; <span class="comment">/*parameters*/</span>) {
00017     <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classaudiere_1_1NullAudioDevice.html">NullAudioDevice</a>;
00018   }
00019 
00020 
00021   NullAudioDevice::NullAudioDevice() {
00022   }
00023 
00024 
00025   NullAudioDevice::~NullAudioDevice() {
00026     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"~NullAudioDevice"</span>);
00027 
00028     <a class="code" href="debug_8h.html#a3">ADR_ASSERT</a>(m_streams.size() == 0,
00029       <span class="stringliteral">"Null output context should not die with open streams"</span>);
00030   }
00031 
00032 
00033   <span class="keywordtype">void</span>
<a name="l00034"></a><a class="code" href="classaudiere_1_1NullAudioDevice.html#a0">00034</a>   NullAudioDevice::update() {
00035     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"NullAudioDevice::update"</span>);
00036     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(<span class="keyword">this</span>);
00037 
00038     StreamList::iterator i = m_streams.begin();
00039     <span class="keywordflow">for</span> (; i != m_streams.end(); ++i) {
00040       (*i)-&gt;update();
00041     }
00042 
00043     <a class="code" href="namespaceaudiere.html#a43">AI_Sleep</a>(50);
00044   }
00045 
00046 
00047   OutputStream*
<a name="l00048"></a><a class="code" href="classaudiere_1_1NullAudioDevice.html#a1">00048</a>   NullAudioDevice::openStream(<a class="code" href="classaudiere_1_1SampleSource.html">SampleSource</a>* source) {
00049     <span class="keywordflow">if</span> (!source) {
00050       <span class="keywordflow">return</span> 0;
00051     }
00052 
00053     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(<span class="keyword">this</span>);
00054 
00055     <a class="code" href="classaudiere_1_1NullOutputStream.html">NullOutputStream</a>* stream = <span class="keyword">new</span> <a class="code" href="classaudiere_1_1NullAudioDevice.html#l0">NullOutputStream</a>(<span class="keyword">this</span>, source);
00056     m_streams.insert(stream);
00057     <span class="keywordflow">return</span> stream;
00058   }
00059 
00060 
00061   OutputStream*
<a name="l00062"></a><a class="code" href="classaudiere_1_1NullAudioDevice.html#a2">00062</a>   NullAudioDevice::openBuffer(
00063     <span class="keywordtype">void</span>* samples, <span class="keywordtype">int</span> frame_count,
00064     <span class="keywordtype">int</span> channel_count, <span class="keywordtype">int</span> sample_rate, <a class="code" href="namespaceaudiere.html#a59">SampleFormat</a> <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>)
00065   {
00066     <span class="keywordflow">return</span> <a class="code" href="classaudiere_1_1NullAudioDevice.html#a1">openStream</a>(<a class="code" href="namespaceaudiere.html#a57">OpenBufferStream</a>(
00067       samples, frame_count,
00068       channel_count, sample_rate, <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>));
00069   }
00070 
00071 
00072   <span class="keywordtype">void</span>
00073   NullAudioDevice::removeStream(NullOutputStream* stream) {
00074     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(<span class="keyword">this</span>);
00075 
00076     m_streams.erase(stream);
00077   }
00078 
00079 
00080   NullOutputStream::NullOutputStream(
00081     NullAudioDevice* device,
00082     SampleSource* source)
00083   : m_device(device)
00084   , m_source(new RepeatableStream(source))
00085   , m_is_playing(false)
00086   , m_volume(1)
00087   , m_pan(0)
00088   , m_last_update(0)
00089   {
00090     m_source-&gt;getFormat(m_channel_count, m_sample_rate, m_sample_format);
00091   }
00092 
00093 
00094   NullOutputStream::~NullOutputStream() {
00095     m_device-&gt;removeStream(<span class="keyword">this</span>);
00096 
00097     <span class="keyword">delete</span> m_source;
00098   }
00099 
00100 
00101   <span class="keywordtype">void</span>
<a name="l00102"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a0">00102</a>   NullOutputStream::play() {
00103     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"NullOutputStream::Play"</span>);
00104     m_is_playing = <span class="keyword">true</span>;
00105     resetTimer();
00106   }
00107 
00108 
00109   <span class="keywordtype">void</span>
<a name="l00110"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a1">00110</a>   NullOutputStream::stop() {
00111     m_is_playing = <span class="keyword">false</span>;
00112   }
00113 
00114 
00115   <span class="keywordtype">void</span>
<a name="l00116"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a2">00116</a>   NullOutputStream::reset() {
00117     resetTimer();
00118     m_source-&gt;<a class="code" href="classaudiere_1_1RepeatableStream.html#a5">reset</a>();
00119   }
00120 
00121 
00122   <span class="keywordtype">bool</span>
<a name="l00123"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a3">00123</a>   NullOutputStream::isPlaying() {
00124     <span class="keywordflow">return</span> m_is_playing;
00125   }
00126 
00127 
00128   <span class="keywordtype">void</span>
<a name="l00129"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a4">00129</a>   NullOutputStream::setRepeat(<span class="keywordtype">bool</span> repeat) {
00130     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00131     m_source-&gt;<a class="code" href="classaudiere_1_1RepeatableStream.html#a1">setRepeat</a>(repeat);
00132   }
00133 
00134 
00135   <span class="keywordtype">bool</span>
<a name="l00136"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a5">00136</a>   NullOutputStream::getRepeat() {
00137     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00138     <span class="keywordflow">return</span> m_source-&gt;<a class="code" href="classaudiere_1_1RepeatableStream.html#a2">getRepeat</a>();
00139   }
00140 
00141 
00142   <span class="keywordtype">void</span>
<a name="l00143"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a6">00143</a>   NullOutputStream::setVolume(<span class="keywordtype">float</span> volume) {
00144     m_volume = volume;
00145   }
00146 
00147 
00148   <span class="keywordtype">float</span>
<a name="l00149"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a7">00149</a>   NullOutputStream::getVolume() {
00150     <span class="keywordflow">return</span> m_volume;
00151   }
00152 
00153   
00154   <span class="keywordtype">void</span>
<a name="l00155"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a8">00155</a>   NullOutputStream::setPan(<span class="keywordtype">float</span> pan) {
00156     m_pan = pan;
00157   }
00158 
00159   
00160   <span class="keywordtype">float</span>
<a name="l00161"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a9">00161</a>   NullOutputStream::getPan() {
00162     <span class="keywordflow">return</span> m_pan;
00163   }
00164 
00165 
00166   <span class="keywordtype">bool</span>
<a name="l00167"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a10">00167</a>   NullOutputStream::isSeekable() {
00168     <span class="keywordflow">return</span> m_source-&gt;<a class="code" href="classaudiere_1_1RepeatableStream.html#a6">isSeekable</a>();
00169   }
00170 
00171 
00172   <span class="keywordtype">int</span>
<a name="l00173"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a11">00173</a>   NullOutputStream::getLength() {
00174     <span class="keywordflow">return</span> m_source-&gt;<a class="code" href="classaudiere_1_1RepeatableStream.html#a7">getLength</a>();
00175   }
00176 
00177 
00178   <span class="keywordtype">void</span>
<a name="l00179"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a12">00179</a>   NullOutputStream::setPosition(<span class="keywordtype">int</span> position) {
00180     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00181     m_source-&gt;<a class="code" href="classaudiere_1_1RepeatableStream.html#a8">setPosition</a>(position);
00182     <a class="code" href="classaudiere_1_1NullOutputStream.html#a2">reset</a>();
00183   }
00184 
00185 
00186   <span class="keywordtype">int</span>
<a name="l00187"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a13">00187</a>   NullOutputStream::getPosition() {
00188     <span class="keywordflow">return</span> m_source-&gt;<a class="code" href="classaudiere_1_1RepeatableStream.html#a9">getPosition</a>();
00189   }
00190 
00191 
00192   <span class="keywordtype">void</span>
00193   NullOutputStream::resetTimer() {
00194     m_last_update = <a class="code" href="timer__ansi_8cpp.html#a0">GetNow</a>();
00195   }
00196 
00197 
00198   <span class="keywordtype">void</span>
00199   NullOutputStream::update() {
00200     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"NullOutputStream::Update"</span>);
00201 
00202     <span class="keywordflow">if</span> (m_is_playing) {
00203       <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"Null output stream is playing"</span>);
00204 
00205       <span class="comment">// get number of milliseconds elapsed since last playing update</span>
00206       <span class="comment">// so we can read that much time worth of samples</span>
00207       <a class="code" href="namespaceaudiere.html#a19">u64</a> now = <a class="code" href="timer__ansi_8cpp.html#a0">GetNow</a>();
00208       <a class="code" href="namespaceaudiere.html#a19">u64</a> elapsed = now - m_last_update;
00209 
00210       <span class="keywordtype">int</span> samples_to_read = int(m_sample_rate * elapsed / 1000000);
00211 
00212       <a class="code" href="debug_8h.html#a2">ADR_IF_DEBUG</a> {
00213         <span class="keywordtype">char</span> str[100];
00214         sprintf(str, <span class="stringliteral">"Samples to read: %d"</span>, samples_to_read);
00215         <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(str);
00216       }
00217 
00218       <span class="keywordtype">int</span> samples_read = dummyRead(samples_to_read);
00219 
00220       <span class="keywordflow">if</span> (samples_read != samples_to_read) {
00221         <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"Stopping null output stream"</span>);
00222         m_source-&gt;reset();
00223         <a class="code" href="classaudiere_1_1NullOutputStream.html#a1">stop</a>();
00224       }
00225 
00226       m_last_update = now;
00227     }
00228   }
00229 
00230 
00231   <span class="keywordtype">int</span>
00232   NullOutputStream::dummyRead(<span class="keywordtype">int</span> samples_to_read) {
00233     <span class="keywordtype">int</span> total = 0;  <span class="comment">// number of samples read so far</span>
00234 
00235     <span class="keyword">const</span> <span class="keywordtype">int</span> bytes_per_sample = <a class="code" href="namespaceaudiere.html#a22">GetSampleSize</a>(m_sample_format);
00236 
00237     <span class="comment">// read samples into dummy buffer, counting the number we actually read</span>
00238     <a class="code" href="namespaceaudiere.html#a13">u8</a>* dummy = <span class="keyword">new</span> <a class="code" href="namespaceaudiere.html#a13">u8</a>[1024 * m_channel_count * bytes_per_sample];
00239     <span class="keywordflow">while</span> (samples_to_read &gt; 0) {
00240       <span class="keywordtype">int</span> read = std::min(1024, samples_to_read);
00241       <span class="keywordtype">int</span> actual_read = m_source-&gt;read(read, dummy);
00242       total += actual_read;
00243       samples_to_read -= actual_read;
00244       <span class="keywordflow">if</span> (actual_read &lt; read) {
00245         <span class="keywordflow">break</span>;
00246       }
00247     }
00248 
00249     <span class="keyword">delete</span>[] dummy;
00250     <span class="keywordflow">return</span> total;
00251   }
00252 
00253 }
</pre></div><hr><address style="align: right;"><small>Generated on Sat Sep 7 15:33:39 2002 for audiere by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
