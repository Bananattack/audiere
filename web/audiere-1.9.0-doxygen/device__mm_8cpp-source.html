<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>device_mm.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>device_mm.cpp</h1><a href="device__mm_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="preprocessor">#include &lt;windows.h&gt;</span>
00002 <span class="preprocessor">#include &lt;mmsystem.h&gt;</span>
00003 <span class="preprocessor">#include "<a class="code" href="device__mm_8h.html">device_mm.h</a>"</span>
00004 <span class="preprocessor">#include "<a class="code" href="utility_8h.html">utility.h</a>"</span>
00005 
00006 
00007 <span class="keyword">namespace </span>audiere {
00008 
00009   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> RATE = 44100;
00010 
00011 
00012   MMAudioDevice*
<a name="l00013"></a><a class="code" href="classaudiere_1_1MMAudioDevice.html#d0">00013</a>   MMAudioDevice::create(<span class="keyword">const</span> <a class="code" href="classaudiere_1_1ParameterList.html">ParameterList</a>&amp; <a class="code" href="namespaceaudiere_1_1hidden.html#a0">parameters</a>) {
00014     WAVEFORMATEX wfx;
00015     memset(&amp;wfx, 0, <span class="keyword">sizeof</span>(wfx));
00016     wfx.wFormatTag      = WAVE_FORMAT_PCM;
00017     wfx.nChannels       = 2;
00018     wfx.nSamplesPerSec  = RATE;
00019     wfx.nAvgBytesPerSec = RATE * 4;
00020     wfx.nBlockAlign     = 4;
00021     wfx.wBitsPerSample  = 16;
00022     wfx.cbSize          = <span class="keyword">sizeof</span>(WAVEFORMATEX);
00023 
00024     HWAVEOUT handle;
00025     MMRESULT result = waveOutOpen(&amp;handle, WAVE_MAPPER, &amp;wfx, 0, 0, 0);
00026     <span class="keywordflow">if</span> (result != MMSYSERR_NOERROR) {
00027       <span class="keywordflow">return</span> 0;
00028     }
00029 
00030     <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classaudiere_1_1MMAudioDevice.html">MMAudioDevice</a>(handle, RATE);
00031   }
00032 
00033 
00034   MMAudioDevice::MMAudioDevice(HWAVEOUT device, <span class="keywordtype">int</span> rate)
00035     : MixerDevice(rate)
00036   {
00037     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"MMAudioDevice::MMAudioDevice"</span>);
00038 
00039     m_device = device;
00040     m_current_buffer = 0;
00041 
00042     <span class="comment">// fill each buffer with samples and prepare it for output</span>
00043     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; BUFFER_COUNT; ++i) {
00044       WAVEHDR&amp; wh = m_buffers[i];
00045       memset(&amp;wh, 0, <span class="keyword">sizeof</span>(wh));
00046       wh.lpData         = (<span class="keywordtype">char</span>*)m_samples + i * BUFFER_LENGTH;
00047       wh.dwBufferLength = BUFFER_LENGTH;
00048 
00049       <a class="code" href="classaudiere_1_1MixerDevice.html#b0">read</a>(BUFFER_LENGTH / 4, wh.lpData);
00050 
00051       MMRESULT result = waveOutPrepareHeader(m_device, &amp;wh, <span class="keyword">sizeof</span>(wh));
00052       <span class="keywordflow">if</span> (result != MMSYSERR_NOERROR) {
00053         <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"waveOutPrepareHeader failed"</span>);
00054       }
00055 
00056       result = waveOutWrite(m_device, &amp;wh, <span class="keyword">sizeof</span>(wh));
00057       <span class="keywordflow">if</span> (result != MMSYSERR_NOERROR) {
00058         <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"waveOutWrite failed"</span>);
00059       }
00060     }
00061   }
00062 
00063 
00064   MMAudioDevice::~MMAudioDevice() {
00065     waveOutReset(m_device);
00066 
00067     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; BUFFER_COUNT; ++i) {
00068       WAVEHDR&amp; wh = m_buffers[i];
00069       <span class="keywordflow">if</span> (wh.dwFlags &amp; WHDR_PREPARED || wh.dwFlags &amp; WHDR_DONE) {
00070         waveOutUnprepareHeader(m_device, &amp;wh, <span class="keyword">sizeof</span>(wh));
00071       }
00072     }
00073 
00074     waveOutClose(m_device);
00075   }
00076 
00077 
00078   <span class="keywordtype">void</span>
<a name="l00079"></a><a class="code" href="classaudiere_1_1MMAudioDevice.html#a0">00079</a>   MMAudioDevice::update() {
00080     <span class="comment">// if a buffer is done playing, add it to the queue again</span>
00081     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; BUFFER_COUNT; ++i) {
00082       WAVEHDR&amp; wh = m_buffers[i];
00083       <span class="keywordflow">if</span> (wh.dwFlags &amp; WHDR_DONE) {
00084 
00085         <span class="comment">// unprepare</span>
00086         MMRESULT result = waveOutUnprepareHeader(m_device, &amp;wh, <span class="keyword">sizeof</span>(wh));
00087         <span class="keywordflow">if</span> (result != MMSYSERR_NOERROR) {
00088           <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"waveOutUnprepareHeader failed"</span>);
00089         }
00090 
00091         <span class="comment">// fill with new samples</span>
00092         <a class="code" href="classaudiere_1_1MixerDevice.html#b0">read</a>(BUFFER_LENGTH / 4, wh.lpData);
00093         wh.dwFlags = 0;
00094 
00095         <span class="comment">// prepare</span>
00096         result = waveOutPrepareHeader(m_device, &amp;wh, <span class="keyword">sizeof</span>(wh));
00097         <span class="keywordflow">if</span> (result != MMSYSERR_NOERROR) {
00098           <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"waveOutPrepareHeader failed"</span>);
00099         }
00100 
00101         <span class="comment">// write</span>
00102         result = waveOutWrite(m_device, &amp;wh, <span class="keyword">sizeof</span>(wh));
00103         <span class="keywordflow">if</span> (result != MMSYSERR_NOERROR) {
00104           <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"waveOutWrite failed"</span>);
00105         }
00106       }
00107     }
00108     Sleep(10);
00109   }
00110 
00111 }
</pre></div><hr><address style="align: right;"><small>Generated on Sat Sep 7 15:33:39 2002 for audiere by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
