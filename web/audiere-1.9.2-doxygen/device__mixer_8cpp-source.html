<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>device_mixer.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc1 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>device_mixer.cpp</h1><a href="device__mixer_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="preprocessor">#ifdef _MSC_VER</span>
00002 <span class="preprocessor"></span><span class="preprocessor">#pragma warning(disable : 4786)</span>
00003 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00004 <span class="preprocessor"></span>
00005 
00006 <span class="preprocessor">#include &lt;algorithm&gt;</span>
00007 <span class="preprocessor">#include "<a class="code" href="device__mixer_8h.html">device_mixer.h</a>"</span>
00008 <span class="preprocessor">#include "<a class="code" href="resampler_8h.html">resampler.h</a>"</span>
00009 <span class="preprocessor">#include "<a class="code" href="utility_8h.html">utility.h</a>"</span>
00010 
00011 
00012 <span class="keyword">namespace </span>audiere {
<a name="l00013"></a><a class="code" href="classaudiere_1_1MixerDevice.html#a0">00013</a> 
00014   MixerDevice::MixerDevice(<span class="keywordtype">int</span> rate) {
00015     m_rate = rate;
00016   }
00017 
00018 
<a name="l00019"></a><a class="code" href="classaudiere_1_1MixerDevice.html#a1">00019</a>   <a class="code" href="classaudiere_1_1OutputStream.html">OutputStream</a>*
00020   MixerDevice::openStream(<a class="code" href="classaudiere_1_1SampleSource.html">SampleSource</a>* source) {
00021     <span class="keywordflow">return</span> (source ? <span class="keyword">new</span> <a class="code" href="classaudiere_1_1MixerDevice.html#l0">MixerStream</a>(<span class="keyword">this</span>, source, m_rate) : 0);
00022   }
00023 
00024 
<a name="l00025"></a><a class="code" href="classaudiere_1_1MixerDevice.html#a2">00025</a>   <a class="code" href="classaudiere_1_1OutputStream.html">OutputStream</a>*
00026   MixerDevice::openBuffer(
00027     <span class="keywordtype">void</span>* samples, <span class="keywordtype">int</span> frame_count,
00028     <span class="keywordtype">int</span> channel_count, <span class="keywordtype">int</span> sample_rate, <a class="code" href="namespaceaudiere.html#a83">SampleFormat</a> <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>)
00029   {
00030     <span class="keywordflow">return</span> <a class="code" href="classaudiere_1_1MixerDevice.html#a1">openStream</a>(<a class="code" href="namespaceaudiere.html#a82">OpenBufferStream</a>(
00031       samples, frame_count,
00032       channel_count, sample_rate, <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>));
00033   }
00034 
00035 
<a name="l00036"></a><a class="code" href="classaudiere_1_1MixerDevice.html#b0">00036</a>   <span class="keywordtype">int</span>
00037   MixerDevice::read(<span class="keyword">const</span> <span class="keywordtype">int</span> sample_count, <span class="keywordtype">void</span>* samples) {
00038     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"MixerDevice::read"</span>);
00039 
00040     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(<span class="keyword">this</span>);
00041 
00042     <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"done locking mixer device"</span>);
00043 
00044     <span class="comment">// are any sources playing?</span>
00045     <span class="keywordtype">bool</span> any_playing = <span class="keyword">false</span>;
00046     <span class="keywordflow">for</span> (std::list&lt;MixerStream*&gt;::iterator i = m_streams.begin();
00047          i != m_streams.end();
00048          ++i)
00049     {
00050       any_playing |= (*i)-&gt;m_is_playing;
00051     }
00052   
00053     <span class="comment">// if not, return zeroed samples</span>
00054     <span class="keywordflow">if</span> (!any_playing) {
00055       memset(samples, 0, 4 * sample_count);
00056       <span class="keywordflow">return</span> sample_count;
00057     }
00058 
00059     <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"at least one stream is playing"</span>);
00060 
00061     <span class="comment">// buffer in which to mix the audio</span>
00062     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> BUFFER_SIZE = 4096;
00063 
00064     <span class="comment">// mix the output in chunks of BUFFER_SIZE samples</span>
00065     <a class="code" href="namespaceaudiere.html#a26">s16</a>* out = (<a class="code" href="namespaceaudiere.html#a26">s16</a>*)samples;
00066     <span class="keywordtype">int</span> left = sample_count;
00067     <span class="keywordflow">while</span> (left &gt; 0) {
00068       <span class="keywordtype">int</span> to_mix = std::min(BUFFER_SIZE, left);
00069 
00070       <a class="code" href="namespaceaudiere.html#a28">s32</a> mix_buffer[BUFFER_SIZE];
00071       memset(mix_buffer, 0, <span class="keyword">sizeof</span>(mix_buffer));
00072     
00073       <span class="keywordflow">for</span> (std::list&lt;MixerStream*&gt;::iterator s = m_streams.begin();
00074            s != m_streams.end();
00075            ++s)
00076       {
00077         <span class="keywordflow">if</span> ((*s)-&gt;m_is_playing) {
00078           <a class="code" href="namespaceaudiere.html#a26">s16</a> stream_buffer[BUFFER_SIZE * 2];
00079           (*s)-&gt;read(to_mix, stream_buffer);
00080           <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; to_mix * 2; ++i) {
00081             mix_buffer[i] += stream_buffer[i];
00082           }
00083         }
00084       }
00085 
00086       <span class="comment">// clamp each value in the buffer to the valid s16 range</span>
00087       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; to_mix * 2; ++i) {
00088         <a class="code" href="namespaceaudiere.html#a28">s32</a> mixed = mix_buffer[i];
00089         <a class="code" href="namespaceaudiere.html#a26">s16</a> o;
00090         <span class="keywordflow">if</span> (mixed &lt; -32768) {
00091           o = -32768;
00092         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mixed &gt; 32767) {
00093           o = 32767;
00094         } <span class="keywordflow">else</span> {
00095           o = mixed;
00096         }
00097         *out++ = o;
00098       }
00099 
00100       left -= to_mix;
00101     }
00102 
00103     <span class="keywordflow">return</span> sample_count;
00104   }
00105 
<a name="l00106"></a><a class="code" href="classaudiere_1_1MixerStream.html#a0">00106</a> 
00107   MixerStream::MixerStream(
00108     <a class="code" href="classaudiere_1_1MixerDevice.html">MixerDevice</a>* device,
00109     <a class="code" href="classaudiere_1_1SampleSource.html">SampleSource</a>* source,
00110     <span class="keywordtype">int</span> rate)
00111   {
00112     m_device     = device;
00113     m_resampler  = <span class="keyword">new</span> <a class="code" href="classaudiere_1_1Resampler.html">Resampler</a>(source, rate);
00114     m_source     = <span class="keyword">new</span> <a class="code" href="classaudiere_1_1RepeatableStream.html">RepeatableStream</a>(m_resampler.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00115     m_last_l     = 0;
00116     m_last_r     = 0;
00117     m_is_playing = <span class="keyword">false</span>;
00118     m_volume     = 255;
00119     m_pan        = 0;
00120 
00121     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00122     m_device-&gt;m_streams.push_back(<span class="keyword">this</span>);
00123   }
00124 
<a name="l00125"></a><a class="code" href="classaudiere_1_1MixerStream.html#a1">00125</a> 
00126   MixerStream::~MixerStream() {
00127     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00128     m_device-&gt;m_streams.remove(<span class="keyword">this</span>);
00129   }
00130 
00131 
<a name="l00132"></a><a class="code" href="classaudiere_1_1MixerStream.html#a2">00132</a>   <span class="keywordtype">void</span>
00133   MixerStream::play() {
00134     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00135     m_is_playing = <span class="keyword">true</span>;
00136   }
00137 
00138 
<a name="l00139"></a><a class="code" href="classaudiere_1_1MixerStream.html#a3">00139</a>   <span class="keywordtype">void</span>
00140   MixerStream::stop() {
00141     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00142     m_is_playing = <span class="keyword">false</span>;
00143   }
00144 
00145 
<a name="l00146"></a><a class="code" href="classaudiere_1_1MixerStream.html#a4">00146</a>   <span class="keywordtype">bool</span>
00147   MixerStream::isPlaying() {
00148     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00149     <span class="keywordflow">return</span> m_is_playing;
00150   }
00151 
00152 
<a name="l00153"></a><a class="code" href="classaudiere_1_1MixerStream.html#a5">00153</a>   <span class="keywordtype">void</span>
00154   MixerStream::reset() {
00155     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00156     m_source-&gt;reset();
00157   }
00158 
00159 
<a name="l00160"></a><a class="code" href="classaudiere_1_1MixerStream.html#a6">00160</a>   <span class="keywordtype">void</span>
00161   MixerStream::setRepeat(<span class="keywordtype">bool</span> repeat) {
00162     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00163     m_source-&gt;setRepeat(repeat);
00164   }
00165 
00166 
<a name="l00167"></a><a class="code" href="classaudiere_1_1MixerStream.html#a7">00167</a>   <span class="keywordtype">bool</span>
00168   MixerStream::getRepeat() {
00169     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00170     <span class="keywordflow">return</span> m_source-&gt;getRepeat();
00171   }
00172 
00173 
<a name="l00174"></a><a class="code" href="classaudiere_1_1MixerStream.html#a8">00174</a>   <span class="keywordtype">void</span>
00175   MixerStream::setVolume(<span class="keywordtype">float</span> volume) {
00176     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00177     m_volume = int(volume * 255.0f + 0.5f);
00178   }
00179 
00180 
<a name="l00181"></a><a class="code" href="classaudiere_1_1MixerStream.html#a9">00181</a>   <span class="keywordtype">float</span>
00182   MixerStream::getVolume() {
00183     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00184     <span class="keywordflow">return</span> (m_volume / 255.0f);
00185   }
00186 
00187 
<a name="l00188"></a><a class="code" href="classaudiere_1_1MixerStream.html#a10">00188</a>   <span class="keywordtype">void</span>
00189   MixerStream::setPan(<span class="keywordtype">float</span> pan) {
00190     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00191     m_pan = int(pan * 255.0f);
00192   }
00193 
00194 
<a name="l00195"></a><a class="code" href="classaudiere_1_1MixerStream.html#a11">00195</a>   <span class="keywordtype">float</span>
00196   MixerStream::getPan() {
00197     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00198     <span class="keywordflow">return</span> m_pan / 255.0f;
00199   }
00200 
00201 
<a name="l00202"></a><a class="code" href="classaudiere_1_1MixerStream.html#a12">00202</a>   <span class="keywordtype">void</span>
00203   MixerStream::setPitchShift(<span class="keywordtype">float</span> shift) {
00204     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00205     m_resampler-&gt;setPitchShift(shift);
00206   }
00207 
00208 
<a name="l00209"></a><a class="code" href="classaudiere_1_1MixerStream.html#a13">00209</a>   <span class="keywordtype">float</span>
00210   MixerStream::getPitchShift() {
00211     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00212     <span class="keywordflow">return</span> m_resampler-&gt;getPitchShift();
00213   }
00214 
00215 
<a name="l00216"></a><a class="code" href="classaudiere_1_1MixerStream.html#a14">00216</a>   <span class="keywordtype">bool</span>
00217   MixerStream::isSeekable() {
00218     <span class="keywordflow">return</span> m_source-&gt;isSeekable();
00219   }
00220 
00221 
<a name="l00222"></a><a class="code" href="classaudiere_1_1MixerStream.html#a15">00222</a>   <span class="keywordtype">int</span>
00223   MixerStream::getLength() {
00224     <span class="keywordflow">return</span> m_source-&gt;getLength();
00225   }
00226 
00227 
<a name="l00228"></a><a class="code" href="classaudiere_1_1MixerStream.html#a16">00228</a>   <span class="keywordtype">void</span>
00229   MixerStream::setPosition(<span class="keywordtype">int</span> position) {
00230     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00231     m_source-&gt;setPosition(position);
00232   }
00233 
00234 
<a name="l00235"></a><a class="code" href="classaudiere_1_1MixerStream.html#a17">00235</a>   <span class="keywordtype">int</span>
00236   MixerStream::getPosition() {
00237     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00238     <span class="keywordflow">return</span> m_source-&gt;getPosition();
00239   }
00240 
00241 
00242   <span class="keywordtype">void</span>
00243   MixerStream::read(<span class="keywordtype">int</span> frame_count, <a class="code" href="namespaceaudiere.html#a26">s16</a>* buffer) {
00244     <span class="keywordtype">unsigned</span> read = m_source-&gt;read(frame_count, buffer);
00245 
00246     <span class="comment">// if we are done with the sample source, stop and reset it</span>
00247     <span class="keywordflow">if</span> (read == 0) {
00248       m_is_playing = <span class="keyword">false</span>;
00249       m_source-&gt;reset();
00250     }
00251 
00252     <span class="keywordtype">int</span> l_volume, r_volume;
00253     <span class="keywordflow">if</span> (m_pan &lt; 0) {
00254       l_volume = 255;
00255       r_volume = 255 + m_pan;
00256     } <span class="keywordflow">else</span> {
00257       l_volume = 255 - m_pan;
00258       r_volume = 255;
00259     }
00260 
00261     l_volume *= m_volume;
00262     r_volume *= m_volume;
00263 
00264     <a class="code" href="namespaceaudiere.html#a26">s16</a>* out = buffer;
00265     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; read; ++i) {
00266       *out = *out * l_volume / 255 / 255;
00267       ++out;
00268       *out = *out * r_volume / 255 / 255;
00269       ++out;
00270     }
00271 
00272     <span class="keywordtype">int</span> l = m_last_l;
00273     <span class="keywordtype">int</span> r = m_last_r;
00274 
00275     <span class="keywordflow">if</span> (read &gt; 0) {
00276       l = out[-2];
00277       r = out[-1];
00278     }
00279 
00280     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = read; i &lt; frame_count; ++i) {
00281       *out++ = m_last_l;
00282       *out++ = m_last_r;
00283     }
00284 
00285     m_last_l = l;
00286     m_last_r = r;
00287   }
00288 
00289 }
</pre></div><hr><address style="align: right;"><small>Generated on Mon Jan 6 05:14:39 2003 for audiere by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc1 </small></address>
</body>
</html>
