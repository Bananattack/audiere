<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>sample_buffer.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc1 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>sample_buffer.cpp</h1><a href="sample__buffer_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="preprocessor">#include "<a class="code" href="audiere_8h.html">audiere.h</a>"</span>
00002 <span class="preprocessor">#include "<a class="code" href="internal_8h.html">internal.h</a>"</span>
00003 <span class="preprocessor">#include "<a class="code" href="utility_8h.html">utility.h</a>"</span>
00004 
00005 
00006 <span class="keyword">namespace </span>audiere {
<a name="l00007"></a><a class="code" href="classaudiere_1_1BufferStream.html">00007</a> 
00008   <span class="keyword">class </span><a class="code" href="classaudiere_1_1BufferStream.html">BufferStream</a> : <span class="keyword">public</span> <a class="code" href="classaudiere_1_1RefImplementation.html">RefImplementation</a>&lt;SampleSource&gt; {
<a name="l00009"></a><a class="code" href="classaudiere_1_1BufferStream.html#a0">00009</a>   <span class="keyword">public</span>:
00010     <a class="code" href="classaudiere_1_1BufferStream.html#a0">BufferStream</a>(<a class="code" href="classaudiere_1_1SampleBuffer.html">SampleBuffer</a>* buffer) {
00011       m_buffer = buffer;
00012 
00013       <span class="comment">// get the sample format so we can calculate the size of each frame</span>
00014       <span class="keywordtype">int</span> <a class="code" href="namespaceaudiere.html#a17">channel_count</a>, <a class="code" href="namespaceaudiere.html#a18">sample_rate</a>;
00015       <a class="code" href="namespaceaudiere.html#a83">SampleFormat</a> <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>;
00016       buffer-&gt;<a class="code" href="classaudiere_1_1SampleBuffer.html#a0">getFormat</a>(<a class="code" href="namespaceaudiere.html#a17">channel_count</a>, <a class="code" href="namespaceaudiere.html#a18">sample_rate</a>, <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>);
00017 
00018       m_frame_size  = <a class="code" href="namespaceaudiere.html#a17">channel_count</a> * <a class="code" href="namespaceaudiere.html#a35">GetSampleSize</a>(<a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>);
00019       m_frame_count = m_buffer-&gt;getLength();
00020       m_samples     = (<span class="keyword">const</span> <a class="code" href="namespaceaudiere.html#a23">u8</a>*)m_buffer-&gt;getSamples();
00021 
00022       m_position = 0;
00023     }
00024 
<a name="l00025"></a><a class="code" href="classaudiere_1_1BufferStream.html#a1">00025</a> 
00026     <span class="keywordtype">void</span> <a class="code" href="audiere_8h.html#a0">ADR_CALL</a> <a class="code" href="classaudiere_1_1BufferStream.html#a1">getFormat</a>(
00027       <span class="keywordtype">int</span>&amp; <a class="code" href="namespaceaudiere.html#a17">channel_count</a>,
00028       <span class="keywordtype">int</span>&amp; <a class="code" href="namespaceaudiere.html#a18">sample_rate</a>,
00029       <a class="code" href="namespaceaudiere.html#a83">SampleFormat</a>&amp; <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>)
00030     {
00031       m_buffer-&gt;getFormat(<a class="code" href="namespaceaudiere.html#a17">channel_count</a>, <a class="code" href="namespaceaudiere.html#a18">sample_rate</a>, <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>);
00032     }
00033 
<a name="l00034"></a><a class="code" href="classaudiere_1_1BufferStream.html#a2">00034</a> 
00035     <span class="keywordtype">int</span> <a class="code" href="audiere_8h.html#a0">ADR_CALL</a> <a class="code" href="classaudiere_1_1BufferStream.html#a2">read</a>(<span class="keywordtype">int</span> <a class="code" href="namespaceaudiere.html#a16">frame_count</a>, <span class="keywordtype">void</span>* buffer) {
00036       <span class="keywordtype">int</span> to_read = std::min(<a class="code" href="namespaceaudiere.html#a16">frame_count</a>, m_frame_count - m_position);
00037       memcpy(
00038         buffer,
00039         m_samples + m_position * m_frame_size,
00040         to_read * m_frame_size);
00041       m_position += to_read;
00042       <span class="keywordflow">return</span> to_read;
00043     }
00044 
<a name="l00045"></a><a class="code" href="classaudiere_1_1BufferStream.html#a3">00045</a> 
00046     <span class="keywordtype">void</span> <a class="code" href="audiere_8h.html#a0">ADR_CALL</a> <a class="code" href="classaudiere_1_1BufferStream.html#a3">reset</a>() {
00047       m_position = 0;
00048     }
00049 
<a name="l00050"></a><a class="code" href="classaudiere_1_1BufferStream.html#a4">00050</a> 
<a name="l00051"></a><a class="code" href="classaudiere_1_1BufferStream.html#a5">00051</a>     <span class="keywordtype">bool</span> <a class="code" href="audiere_8h.html#a0">ADR_CALL</a> <a class="code" href="classaudiere_1_1BufferStream.html#a4">isSeekable</a>()              { <span class="keywordflow">return</span> <span class="keyword">true</span>;           }
<a name="l00052"></a><a class="code" href="classaudiere_1_1BufferStream.html#a6">00052</a>     <span class="keywordtype">int</span> <a class="code" href="audiere_8h.html#a0">ADR_CALL</a> <a class="code" href="classaudiere_1_1BufferStream.html#a5">getLength</a>()                { <span class="keywordflow">return</span> m_frame_count;  }
<a name="l00053"></a><a class="code" href="classaudiere_1_1BufferStream.html#a7">00053</a>     <span class="keywordtype">void</span> <a class="code" href="audiere_8h.html#a0">ADR_CALL</a> <a class="code" href="classaudiere_1_1BufferStream.html#a6">setPosition</a>(<span class="keywordtype">int</span> position) { m_position = position; }
00054     <span class="keywordtype">int</span> <a class="code" href="audiere_8h.html#a0">ADR_CALL</a> <a class="code" href="classaudiere_1_1BufferStream.html#a7">getPosition</a>()              { <span class="keywordflow">return</span> m_position;     }
00055 
00056   <span class="keyword">private</span>:
00057     RefPtr&lt;SampleBuffer&gt; m_buffer;
00058     <span class="keywordtype">int</span> m_frame_size;
00059     <span class="keywordtype">int</span> m_frame_count;
00060     <span class="keyword">const</span> <a class="code" href="namespaceaudiere.html#a23">u8</a>* m_samples;
00061 
00062     <span class="keywordtype">int</span> m_position;  <span class="comment">// in frames</span>
00063   };
00064 
<a name="l00065"></a><a class="code" href="classaudiere_1_1SampleBufferImpl.html">00065</a> 
00066   <span class="keyword">class </span><a class="code" href="classaudiere_1_1SampleBufferImpl.html">SampleBufferImpl</a> : <span class="keyword">public</span> <a class="code" href="classaudiere_1_1RefImplementation.html">RefImplementation</a>&lt;SampleBuffer&gt; {
<a name="l00067"></a><a class="code" href="classaudiere_1_1SampleBufferImpl.html#a0">00067</a>   <span class="keyword">public</span>:
00068     <a class="code" href="classaudiere_1_1SampleBufferImpl.html#a0">SampleBufferImpl</a>(
00069       <span class="keywordtype">void</span>* samples, <span class="keywordtype">int</span> <a class="code" href="namespaceaudiere.html#a16">frame_count</a>,
00070       <span class="keywordtype">int</span> <a class="code" href="namespaceaudiere.html#a17">channel_count</a>, <span class="keywordtype">int</span> <a class="code" href="namespaceaudiere.html#a18">sample_rate</a>, <a class="code" href="namespaceaudiere.html#a83">SampleFormat</a> <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>)
00071     {
00072       <span class="keyword">const</span> <span class="keywordtype">int</span> frame_size = <a class="code" href="namespaceaudiere.html#a17">channel_count</a> * <a class="code" href="namespaceaudiere.html#a35">GetSampleSize</a>(<a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>);
00073       <span class="keyword">const</span> <span class="keywordtype">int</span> buffer_size = <a class="code" href="namespaceaudiere.html#a16">frame_count</a> * frame_size;
00074       m_samples = <span class="keyword">new</span> <a class="code" href="namespaceaudiere.html#a23">u8</a>[buffer_size];
00075       <span class="keywordflow">if</span> (samples) {
00076         memcpy(m_samples, samples, buffer_size);
00077       } <span class="keywordflow">else</span> {
00078         memset(m_samples, 0, buffer_size);
00079       }
00080 
00081       m_frame_count   = <a class="code" href="namespaceaudiere.html#a16">frame_count</a>;
00082       m_channel_count = <a class="code" href="namespaceaudiere.html#a17">channel_count</a>;
00083       m_sample_rate   = <a class="code" href="namespaceaudiere.html#a18">sample_rate</a>;
00084       m_sample_format = <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>;
00085     }
<a name="l00086"></a><a class="code" href="classaudiere_1_1SampleBufferImpl.html#a1">00086</a> 
00087     <a class="code" href="classaudiere_1_1SampleBufferImpl.html#a1">~SampleBufferImpl</a>() {
00088       <span class="keyword">delete</span>[] m_samples;
00089     }
<a name="l00090"></a><a class="code" href="classaudiere_1_1SampleBufferImpl.html#a2">00090</a> 
00091     <span class="keywordtype">void</span> <a class="code" href="audiere_8h.html#a0">ADR_CALL</a> <a class="code" href="classaudiere_1_1SampleBufferImpl.html#a2">getFormat</a>(
00092       <span class="keywordtype">int</span>&amp; <a class="code" href="namespaceaudiere.html#a17">channel_count</a>,
00093       <span class="keywordtype">int</span>&amp; <a class="code" href="namespaceaudiere.html#a18">sample_rate</a>,
00094       <a class="code" href="namespaceaudiere.html#a83">SampleFormat</a>&amp; <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>)
00095     {
00096       <a class="code" href="namespaceaudiere.html#a17">channel_count</a> = m_channel_count;
00097       <a class="code" href="namespaceaudiere.html#a18">sample_rate</a>   = m_sample_rate;
00098       <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a> = m_sample_format;
00099     }
<a name="l00100"></a><a class="code" href="classaudiere_1_1SampleBufferImpl.html#a3">00100</a> 
00101     <span class="keywordtype">int</span> <a class="code" href="audiere_8h.html#a0">ADR_CALL</a> <a class="code" href="classaudiere_1_1SampleBufferImpl.html#a3">getLength</a>() {
00102       <span class="keywordflow">return</span> m_frame_count;
00103     }
<a name="l00104"></a><a class="code" href="classaudiere_1_1SampleBufferImpl.html#a4">00104</a> 
00105     <span class="keyword">const</span> <span class="keywordtype">void</span>* <a class="code" href="audiere_8h.html#a0">ADR_CALL</a> <a class="code" href="classaudiere_1_1SampleBufferImpl.html#a4">getSamples</a>() {
00106       <span class="keywordflow">return</span> m_samples;
00107     }
<a name="l00108"></a><a class="code" href="classaudiere_1_1SampleBufferImpl.html#a5">00108</a> 
00109     <a class="code" href="classaudiere_1_1SampleSource.html">SampleSource</a>* <a class="code" href="audiere_8h.html#a0">ADR_CALL</a> <a class="code" href="classaudiere_1_1SampleBufferImpl.html#a5">openStream</a>() {
00110       <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classaudiere_1_1BufferStream.html">BufferStream</a>(<span class="keyword">this</span>);
00111     }
00112 
00113   <span class="keyword">private</span>:
00114     <a class="code" href="namespaceaudiere.html#a23">u8</a>* m_samples;
00115     <span class="keywordtype">int</span> m_frame_count;
00116     <span class="keywordtype">int</span> m_channel_count;
00117     <span class="keywordtype">int</span> m_sample_rate;
00118     <a class="code" href="namespaceaudiere.html#a83">SampleFormat</a> m_sample_format;
00119   };
00120 
00121 
00122   <a class="code" href="namespaceaudiere.html#a52">ADR_EXPORT</a>(SampleBuffer*, AdrCreateSampleBuffer)(
<a name="l00123"></a><a class="code" href="namespaceaudiere.html#a18">00123</a>     <span class="keywordtype">void</span>* samples,
00124     <span class="keywordtype">int</span> <a class="code" href="namespaceaudiere.html#a16">frame_count</a>,
00125     <span class="keywordtype">int</span> <a class="code" href="namespaceaudiere.html#a17">channel_count</a>,
00126     <span class="keywordtype">int</span> <a class="code" href="namespaceaudiere.html#a18">sample_rate</a>,
00127     <a class="code" href="namespaceaudiere.html#a83">SampleFormat</a> <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>)
00128   {
00129     <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classaudiere_1_1SampleBufferImpl.html">SampleBufferImpl</a>(
00130       samples, <a class="code" href="namespaceaudiere.html#a16">frame_count</a>,
00131       <a class="code" href="namespaceaudiere.html#a17">channel_count</a>, <a class="code" href="namespaceaudiere.html#a18">sample_rate</a>, <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>);
00132   }
00133 
00134   <a class="code" href="namespaceaudiere.html#a52">ADR_EXPORT</a>(SampleBuffer*, AdrCreateSampleBufferFromSource)(
00135     SampleSource* source)
00136   {
00137     <span class="comment">// if there is no source or it isn't seekable, we can't make a</span>
00138     <span class="comment">// buffer from it</span>
00139     <span class="keywordflow">if</span> (!source || !source-&gt;isSeekable()) {
00140       <span class="keywordflow">return</span> 0;
00141     }
00142 
00143     <span class="keywordtype">int</span> length = source-&gt;getLength();
00144     <span class="keywordtype">int</span> <a class="code" href="namespaceaudiere.html#a17">channel_count</a>, <a class="code" href="namespaceaudiere.html#a18">sample_rate</a>;
00145     <a class="code" href="namespaceaudiere.html#a83">SampleFormat</a> <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>;
00146     source-&gt;getFormat(<a class="code" href="namespaceaudiere.html#a17">channel_count</a>, <a class="code" href="namespaceaudiere.html#a18">sample_rate</a>, <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>);
00147 
00148     <span class="keywordtype">int</span> stream_length_bytes = length *
00149       <a class="code" href="namespaceaudiere.html#a17">channel_count</a> * <a class="code" href="namespaceaudiere.html#a35">GetSampleSize</a>(<a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>);
00150     <a class="code" href="namespaceaudiere.html#a23">u8</a>* buffer = <span class="keyword">new</span> <a class="code" href="namespaceaudiere.html#a23">u8</a>[stream_length_bytes];
00151 
00152     source-&gt;setPosition(0);
00153     source-&gt;read(length, buffer);
00154 
00155     SampleBuffer* sb = <a class="code" href="namespaceaudiere.html#a46">CreateSampleBuffer</a>(
00156       buffer, length, <a class="code" href="namespaceaudiere.html#a17">channel_count</a>, <a class="code" href="namespaceaudiere.html#a18">sample_rate</a>, <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>);
00157 
00158     <span class="keyword">delete</span>[] buffer;
00159     <span class="keywordflow">return</span> sb;
00160   }
00161 
00162 }
</pre></div><hr><address style="align: right;"><small>Generated on Mon Jan 6 05:14:41 2003 for audiere by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc1 </small></address>
</body>
</html>
