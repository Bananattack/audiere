<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>threads_win32.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc1 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>threads_win32.cpp</h1><a href="threads__win32_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="preprocessor">#include &lt;windows.h&gt;</span>
00002 <span class="preprocessor">#include &lt;process.h&gt;</span>
00003 <span class="preprocessor">#include "<a class="code" href="threads_8h.html">threads.h</a>"</span>
00004 
00005 
00006 <span class="keyword">namespace </span>audiere {
00007 
<a name="l00008"></a><a class="code" href="structaudiere_1_1ThreadInternal.html#m0">00008</a>   <span class="keyword">struct </span><a class="code" href="structaudiere_1_1ThreadInternal.html">ThreadInternal</a> {
<a name="l00009"></a><a class="code" href="structaudiere_1_1ThreadInternal.html#m2">00009</a>     <a class="code" href="namespaceaudiere.html#a20">AI_ThreadRoutine</a> <a class="code" href="structaudiere_1_1ThreadInternal.html#m0">routine</a>;
00010     <span class="keywordtype">void</span>*            <a class="code" href="structaudiere_1_1ThreadInternal.html#m1">opaque</a>;
00011   };
00012 
<a name="l00013"></a><a class="code" href="structaudiere_1_1AI__CriticalSectionStruct.html#m1">00013</a>   <span class="keyword">struct </span><a class="code" href="structaudiere_1_1AI__CriticalSectionStruct.html">AI_CriticalSectionStruct</a> {
00014     CRITICAL_SECTION <a class="code" href="structaudiere_1_1AI__CriticalSectionStruct.html#m1">cs</a>;
00015   };
00016 
00017 
00018   <span class="keyword">static</span> DWORD WINAPI InternalThreadRoutine(<span class="keywordtype">void</span>* opaque);
00019 
<a name="l00020"></a><a class="code" href="namespaceaudiere.html#a72">00020</a> 
00021   <span class="keywordtype">bool</span> <a class="code" href="namespaceaudiere.html#a72">SupportsThreadPriority</a>() {
00022     <span class="comment">// For some reason or another, Windows 95, 98, and ME always</span>
00023     <span class="comment">// deadlock when Audiere tries to use a thread priority other</span>
00024     <span class="comment">// than 0.  Therefore, disable the higher priority on those</span>
00025     <span class="comment">// operating systems.</span>
00026     OSVERSIONINFO info;
00027     info.dwOSVersionInfoSize = <span class="keyword">sizeof</span>(info);
00028     <span class="keywordflow">if</span> (GetVersionEx(&amp;info) &amp;&amp;
00029         info.dwPlatformId == VER_PLATFORM_WIN32_WINDOWS) {
00030       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00031     } <span class="keywordflow">else</span> {
00032       <span class="keywordflow">return</span> <span class="keyword">true</span>;
00033     }
00034   }
00035 
<a name="l00036"></a><a class="code" href="namespaceaudiere.html#a73">00036</a> 
00037   <span class="keywordtype">int</span> <a class="code" href="namespaceaudiere.html#a73">GetWin32Priority</a>(<span class="keywordtype">int</span> priority) {
00038     <span class="keywordflow">if</span> (priority &lt; -2) {
00039       <span class="keywordflow">return</span> THREAD_PRIORITY_IDLE;
00040     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (priority == -2) {
00041       <span class="keywordflow">return</span> THREAD_PRIORITY_LOWEST;
00042     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (priority == -1) {
00043       <span class="keywordflow">return</span> THREAD_PRIORITY_BELOW_NORMAL;
00044     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (priority == 0) {
00045       <span class="keywordflow">return</span> THREAD_PRIORITY_NORMAL;
00046     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (priority == 1) {
00047       <span class="keywordflow">return</span> THREAD_PRIORITY_ABOVE_NORMAL;
00048     } <span class="keywordflow">else</span> {
00049       <span class="keywordflow">return</span> THREAD_PRIORITY_HIGHEST;
00050     }
00051   }
00052 
00053 
00054   <span class="keywordtype">bool</span> <a class="code" href="namespaceaudiere.html#a64">AI_CreateThread</a>(<a class="code" href="namespaceaudiere.html#a20">AI_ThreadRoutine</a> routine, <span class="keywordtype">void</span>* opaque, <span class="keywordtype">int</span> priority) {
00055     <span class="comment">// create internal thread data</span>
00056     ThreadInternal* internal = <span class="keyword">new</span> ThreadInternal;
00057     internal-&gt;routine  = routine;
00058     internal-&gt;opaque   = opaque;
00059     
00060     <span class="comment">// create the actual thread</span>
00061     <span class="comment">// use _beginthread because it makes a thread-safe C library</span>
00062     DWORD threadid;
00063     HANDLE handle = CreateThread(
00064       0, 0, InternalThreadRoutine, internal,
00065       CREATE_SUSPENDED, &amp;threadid);
00066     <span class="keywordflow">if</span> (handle) {
00067       <span class="keywordflow">if</span> (<a class="code" href="namespaceaudiere.html#a72">SupportsThreadPriority</a>()) {
00068         SetThreadPriority(handle, <a class="code" href="namespaceaudiere.html#a73">GetWin32Priority</a>(priority));
00069       }
00070       ResumeThread(handle);
00071       CloseHandle(handle);
00072       <span class="keywordflow">return</span> <span class="keyword">true</span>;
00073     } <span class="keywordflow">else</span> {
00074       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00075     }
00076   }
00077 
00078 
00079   DWORD WINAPI InternalThreadRoutine(<span class="keywordtype">void</span>* opaque) {
00080     ThreadInternal* internal = (ThreadInternal*)opaque;
00081 
00082     <span class="comment">// call the function passed </span>
00083     internal-&gt;routine(internal-&gt;opaque);
00084     <span class="keyword">delete</span> internal;
00085     <span class="keywordflow">return</span> 0;
00086   }
00087 
00088 
00089   <span class="keywordtype">void</span> <a class="code" href="namespaceaudiere.html#a65">AI_Sleep</a>(<span class="keywordtype">unsigned</span> milliseconds) {
00090     ::Sleep(milliseconds);
00091   }
00092 
00093 
00094   <a class="code" href="namespaceaudiere.html#a21">AI_CriticalSection</a> <a class="code" href="namespaceaudiere.html#a66">AI_CreateCriticalSection</a>() {
00095     AI_CriticalSectionStruct* cs = <span class="keyword">new</span> AI_CriticalSectionStruct;
00096     ::InitializeCriticalSection(&amp;cs-&gt;cs);
00097     <span class="keywordflow">return</span> cs;
00098   }
00099 
00100 
00101   <span class="keywordtype">void</span> <a class="code" href="namespaceaudiere.html#a67">AI_DestroyCriticalSection</a>(<a class="code" href="namespaceaudiere.html#a21">AI_CriticalSection</a> cs) {
00102     ::DeleteCriticalSection(&amp;cs-&gt;cs);
00103     <span class="keyword">delete</span> cs;
00104   }
00105 
00106 
00107   <span class="keywordtype">void</span> <a class="code" href="namespaceaudiere.html#a68">AI_EnterCriticalSection</a>(<a class="code" href="namespaceaudiere.html#a21">AI_CriticalSection</a> cs) {
00108     ::EnterCriticalSection(&amp;cs-&gt;cs);
00109   }
00110 
00111 
00112   <span class="keywordtype">void</span> <a class="code" href="namespaceaudiere.html#a69">AI_LeaveCriticalSection</a>(<a class="code" href="namespaceaudiere.html#a21">AI_CriticalSection</a> cs) {
00113     ::LeaveCriticalSection(&amp;cs-&gt;cs);
00114   }
00115 
00116 }
</pre></div><hr><address style="align: right;"><small>Generated on Mon Jan 6 05:14:41 2003 for audiere by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc1 </small></address>
</body>
</html>
