<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>device_ds.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc1 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>device_ds.cpp</h1><a href="device__ds_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="preprocessor">#include &lt;math.h&gt;</span>
00002 <span class="preprocessor">#include "<a class="code" href="device__ds_8h.html">device_ds.h</a>"</span>
00003 <span class="preprocessor">#include "<a class="code" href="device__ds__stream_8h.html">device_ds_stream.h</a>"</span>
00004 <span class="preprocessor">#include "<a class="code" href="device__ds__buffer_8h.html">device_ds_buffer.h</a>"</span>
00005 <span class="preprocessor">#include "<a class="code" href="debug_8h.html">debug.h</a>"</span>
00006 <span class="preprocessor">#include "<a class="code" href="utility_8h.html">utility.h</a>"</span>
00007 
00008 
00009 <span class="keyword">namespace </span>audiere {
00010 
00011   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> DEFAULT_BUFFER_LENGTH = 1000;  <span class="comment">// one second</span>
00012 
00013 
<a name="l00014"></a><a class="code" href="classaudiere_1_1DSAudioDevice.html#d0">00014</a>   <a class="code" href="classaudiere_1_1DSAudioDevice.html">DSAudioDevice</a>*
00015   DSAudioDevice::create(<span class="keyword">const</span> <a class="code" href="classaudiere_1_1ParameterList.html">ParameterList</a>&amp; <a class="code" href="namespaceaudiere_1_1hidden.html#a0">parameters</a>) {
00016     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"DSAudioDevice::create"</span>);
00017 
00018     <span class="keywordtype">int</span> buffer_length = atoi(<a class="code" href="namespaceaudiere_1_1hidden.html#a0">parameters</a>.getValue(<span class="stringliteral">"buffer"</span>, <span class="stringliteral">""</span>).c_str());
00019     <span class="keywordflow">if</span> (buffer_length &lt;= 0) {
00020       buffer_length = DEFAULT_BUFFER_LENGTH;
00021     }
00022     <span class="keywordtype">bool</span> global_focus = <a class="code" href="namespaceaudiere_1_1hidden.html#a0">parameters</a>.getBoolean(<span class="stringliteral">"global"</span>, <span class="keyword">true</span>);
00023 
00024     <span class="comment">// initialize COM</span>
00025     HRESULT rv = CoInitialize(NULL);
00026     <span class="keywordflow">if</span> (FAILED(rv)) {
00027       <span class="keywordflow">return</span> 0;
00028     }
00029 
00030     <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"COM initialized properly"</span>);
00031 
00032     <span class="comment">// register anonymous window class</span>
00033     <span class="comment">// don't worry about failure, if it fails, the window creation will fail</span>
00034     WNDCLASS wc;
00035     wc.style          = 0;
00036     wc.lpfnWndProc    = DefWindowProc;
00037     wc.cbClsExtra     = 0;
00038     wc.cbWndExtra     = 0;
00039     wc.hInstance      = GetModuleHandle(NULL);
00040     wc.hIcon          = NULL;
00041     wc.hCursor        = NULL;
00042     wc.hbrBackground  = NULL;
00043     wc.lpszMenuName   = NULL;
00044     wc.lpszClassName  = <span class="stringliteral">"AudiereHiddenWindow"</span>;
00045     RegisterClass(&amp;wc);
00046 
00047     <span class="comment">// create anonymous window</span>
00048     HWND anonymous_window = CreateWindow(
00049       <span class="stringliteral">"AudiereHiddenWindow"</span>, <span class="stringliteral">""</span>, WS_POPUP,
00050       0, 0, 0, 0,
00051       NULL, NULL, GetModuleHandle(NULL), NULL);
00052     <span class="keywordflow">if</span> (!anonymous_window) {
00053       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00054     }
00055 
00056     <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"Anonymous window created successfully"</span>);
00057 
00058     <span class="comment">// create the DirectSound object</span>
00059     IDirectSound* direct_sound;
00060     rv = CoCreateInstance(
00061       CLSID_DirectSound,
00062       NULL,
00063       CLSCTX_INPROC_SERVER,
00064       IID_IDirectSound,
00065       (<span class="keywordtype">void</span>**)&amp;direct_sound);
00066     <span class="keywordflow">if</span> (FAILED(rv) || !direct_sound) {
00067       DestroyWindow(anonymous_window);
00068       <span class="keywordflow">return</span> 0;
00069     }
00070 
00071     <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"Created DS object"</span>);
00072 
00073     LPCGUID guid = NULL;
00074     GUID stack_guid;  <span class="comment">// so we can point 'guid' to an object that won't be destroyed</span>
00075 
00076     std::string guid_string = <a class="code" href="namespaceaudiere_1_1hidden.html#a0">parameters</a>.getValue(<span class="stringliteral">"device_guid"</span>, <span class="stringliteral">""</span>);
00077     <span class="keywordflow">if</span> (!guid_string.empty()) {
00078       <span class="keywordflow">if</span> (UuidFromString((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)guid_string.c_str(), &amp;stack_guid) == RPC_S_OK) {
00079         guid = &amp;stack_guid;
00080       }
00081     }
00082 
00083     <span class="comment">// initialize the DirectSound device</span>
00084     rv = direct_sound-&gt;Initialize(guid);
00085     <span class="keywordflow">if</span> (FAILED(rv)) {
00086       DestroyWindow(anonymous_window);
00087       direct_sound-&gt;Release();
00088       <span class="keywordflow">return</span> 0;
00089     }
00090 
00091     <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"Initialized DS object"</span>);
00092 
00093     <span class="comment">// set the cooperative level</span>
00094     rv = direct_sound-&gt;SetCooperativeLevel(anonymous_window, DSSCL_NORMAL);
00095     <span class="keywordflow">if</span> (FAILED(rv)) {
00096       DestroyWindow(anonymous_window);
00097       direct_sound-&gt;Release();
00098       <span class="keywordflow">return</span> 0;
00099     }
00100 
00101     <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"Set cooperative level"</span>);
00102 
00103     <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classaudiere_1_1DSAudioDevice.html">DSAudioDevice</a>(
00104       global_focus, buffer_length, anonymous_window, direct_sound);
00105   }
00106 
00107 
00108   DSAudioDevice::DSAudioDevice(
00109     <span class="keywordtype">bool</span> global_focus,
00110     <span class="keywordtype">int</span> buffer_length,
00111     HWND anonymous_window,
00112     IDirectSound* direct_sound)
00113   {
00114     m_global_focus     = global_focus;
00115     m_buffer_length    = buffer_length;
00116     m_anonymous_window = anonymous_window;
00117     m_direct_sound     = direct_sound;
00118   }
00119 
00120 
00121   DSAudioDevice::~DSAudioDevice() {
00122     <a class="code" href="debug_8h.html#a3">ADR_ASSERT</a>(m_open_streams.size() == 0,
00123       <span class="stringliteral">"DirectSound output context should not die with open streams"</span>);
00124 
00125     <span class="comment">// if the anonymous window is open, close it</span>
00126     <span class="keywordflow">if</span> (m_anonymous_window) {
00127       DestroyWindow(m_anonymous_window);
00128       m_anonymous_window = NULL;
00129     }
00130 
00131     <span class="comment">// shut down DirectSound</span>
00132     <span class="keywordflow">if</span> (m_direct_sound) {
00133       m_direct_sound-&gt;Release();
00134       m_direct_sound = NULL;
00135     }
00136   }
00137 
00138 
<a name="l00139"></a><a class="code" href="classaudiere_1_1DSAudioDevice.html#a0">00139</a>   <span class="keywordtype">void</span>
00140   DSAudioDevice::update() {
00141     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"DSAudioDevice::update"</span>);
00142     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(<span class="keyword">this</span>);
00143 
00144     <span class="comment">// enumerate all open streams</span>
00145     StreamList::iterator i = m_open_streams.begin();
00146     <span class="keywordflow">while</span> (i != m_open_streams.end()) {
00147       <a class="code" href="classaudiere_1_1DSOutputStream.html">DSOutputStream</a>* s = *i++;
00148       s-&gt;<a class="code" href="classaudiere_1_1DSOutputStream.html#c1">update</a>();
00149     }
00150 
00151     Sleep(50);
00152   }
00153 
00154 
<a name="l00155"></a><a class="code" href="classaudiere_1_1DSAudioDevice.html#a1">00155</a>   <a class="code" href="classaudiere_1_1OutputStream.html">OutputStream</a>*
00156   DSAudioDevice::openStream(<a class="code" href="classaudiere_1_1SampleSource.html">SampleSource</a>* source) {
00157     <span class="keywordflow">if</span> (!source) {
00158       <span class="keywordflow">return</span> 0;
00159     }
00160 
00161     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"DSAudioDevice::openStream"</span>);
00162     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(<span class="keyword">this</span>);
00163 
00164     <span class="keywordtype">int</span> channel_count, sample_rate;
00165     <a class="code" href="namespaceaudiere.html#a83">SampleFormat</a> <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>;
00166     source-&gt;<a class="code" href="classaudiere_1_1SampleSource.html#a0">getFormat</a>(channel_count, sample_rate, <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>);
00167 
00168     <span class="keywordtype">int</span> frame_size = channel_count * <a class="code" href="namespaceaudiere.html#a35">GetSampleSize</a>(<a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>);
00169 
00170     <span class="comment">// calculate an ideal buffer size</span>
00171     <span class="keywordtype">int</span> buffer_length = sample_rate * m_buffer_length / 1000;
00172 
00173     <span class="comment">// define the wave format</span>
00174     WAVEFORMATEX wfx;
00175     memset(&amp;wfx, 0, <span class="keyword">sizeof</span>(wfx));
00176     wfx.wFormatTag      = WAVE_FORMAT_PCM;
00177     wfx.nChannels       = channel_count;
00178     wfx.nSamplesPerSec  = sample_rate;
00179     wfx.nAvgBytesPerSec = sample_rate * frame_size;
00180     wfx.nBlockAlign     = frame_size;
00181     wfx.wBitsPerSample  = <a class="code" href="namespaceaudiere.html#a35">GetSampleSize</a>(<a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>) * 8;
00182     wfx.cbSize          = <span class="keyword">sizeof</span>(wfx);
00183 
00184     DSBUFFERDESC dsbd;
00185     memset(&amp;dsbd, 0, <span class="keyword">sizeof</span>(dsbd));
00186     dsbd.dwSize        = <span class="keyword">sizeof</span>(dsbd);
00187     dsbd.dwFlags       = DSBCAPS_GETCURRENTPOSITION2 | DSBCAPS_CTRLPAN |
00188                          DSBCAPS_CTRLVOLUME | DSBCAPS_CTRLFREQUENCY;
00189     <span class="keywordflow">if</span> (m_global_focus) {
00190       dsbd.dwFlags |= DSBCAPS_GLOBALFOCUS;
00191     }
00192     dsbd.dwBufferBytes = frame_size * buffer_length;
00193     dsbd.lpwfxFormat   = &amp;wfx;
00194 
00195     <span class="comment">// create the DirectSound buffer</span>
00196     IDirectSoundBuffer* buffer;
00197     HRESULT result = m_direct_sound-&gt;CreateSoundBuffer(
00198       &amp;dsbd, &amp;buffer, NULL);
00199     <span class="keywordflow">if</span> (FAILED(result) || !buffer) {
00200       <span class="keywordflow">return</span> 0;
00201     }
00202 
00203     <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"CreateSoundBuffer succeeded"</span>);
00204 
00205     <a class="code" href="classaudiere_1_1DSOutputStream.html">DSOutputStream</a>* stream = <span class="keyword">new</span> <a class="code" href="classaudiere_1_1DSAudioDevice.html#l0">DSOutputStream</a>(
00206       <span class="keyword">this</span>, buffer, buffer_length, source);
00207 
00208     <span class="comment">// add ourselves to the list of streams and return</span>
00209     m_open_streams.push_back(stream);
00210     <span class="keywordflow">return</span> stream;
00211   }
00212 
00213 
<a name="l00214"></a><a class="code" href="classaudiere_1_1DSAudioDevice.html#a2">00214</a>   <a class="code" href="classaudiere_1_1OutputStream.html">OutputStream</a>*
00215   DSAudioDevice::openBuffer(
00216     <span class="keywordtype">void</span>* samples, <span class="keywordtype">int</span> frame_count,
00217     <span class="keywordtype">int</span> channel_count, <span class="keywordtype">int</span> sample_rate, <a class="code" href="namespaceaudiere.html#a83">SampleFormat</a> <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>)
00218   {
00219     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"DSAudioDevice::openBuffer"</span>);
00220     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(<span class="keyword">this</span>);
00221 
00222     <span class="keywordtype">int</span> frame_size = channel_count * <a class="code" href="namespaceaudiere.html#a35">GetSampleSize</a>(<a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>);
00223     <span class="keywordtype">int</span> buffer_size = frame_count * frame_size;
00224 
00225     WAVEFORMATEX wfx;
00226     memset(&amp;wfx, 0, <span class="keyword">sizeof</span>(wfx));
00227     wfx.wFormatTag      = WAVE_FORMAT_PCM;
00228     wfx.nChannels       = channel_count;
00229     wfx.nSamplesPerSec  = sample_rate;
00230     wfx.nAvgBytesPerSec = sample_rate * frame_size;
00231     wfx.nBlockAlign     = frame_size;
00232     wfx.wBitsPerSample  = <a class="code" href="namespaceaudiere.html#a35">GetSampleSize</a>(<a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>) * 8;
00233     wfx.cbSize          = <span class="keyword">sizeof</span>(wfx);
00234 
00235     DSBUFFERDESC dsbd;
00236     memset(&amp;dsbd, 0, <span class="keyword">sizeof</span>(dsbd));
00237     dsbd.dwSize        = <span class="keyword">sizeof</span>(dsbd);
00238     dsbd.dwFlags       = DSBCAPS_GETCURRENTPOSITION2 | DSBCAPS_CTRLPAN |
00239                          DSBCAPS_CTRLVOLUME | DSBCAPS_CTRLFREQUENCY |
00240                          DSBCAPS_STATIC;
00241     <span class="keywordflow">if</span> (m_global_focus) {
00242       dsbd.dwFlags |= DSBCAPS_GLOBALFOCUS;
00243     }
00244     dsbd.dwBufferBytes = buffer_size;
00245     dsbd.lpwfxFormat   = &amp;wfx;
00246 
00247     IDirectSoundBuffer* buffer;
00248     HRESULT result = m_direct_sound-&gt;CreateSoundBuffer(
00249       &amp;dsbd, &amp;buffer, NULL);
00250     <span class="keywordflow">if</span> (FAILED(result) || !buffer) {
00251       <span class="keywordflow">return</span> 0;
00252     }
00253 
00254     <span class="keywordtype">void</span>* data;
00255     DWORD data_size;
00256     result = buffer-&gt;Lock(0, buffer_size, &amp;data, &amp;data_size, 0, 0, 0);
00257     <span class="keywordflow">if</span> (FAILED(result)) {
00258       buffer-&gt;Release();
00259       <span class="keywordflow">return</span> 0;
00260     }
00261 
00262     memcpy(data, samples, data_size);
00263     buffer-&gt;Unlock(data, data_size, 0, 0);
00264 
00265     <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classaudiere_1_1DSOutputBuffer.html">DSOutputBuffer</a>(<span class="keyword">this</span>, buffer, frame_count, frame_size);
00266   }
00267 
00268 
00269   <span class="keywordtype">void</span>
00270   DSAudioDevice::removeStream(DSOutputStream* stream) {
00271     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(<span class="keyword">this</span>);
00272     m_open_streams.remove(stream);
00273   }
00274 
00275 
<a name="l00276"></a><a class="code" href="classaudiere_1_1DSAudioDevice.html#d1">00276</a>   <span class="keywordtype">int</span>
00277   DSAudioDevice::Volume_AudiereToDirectSound(<span class="keywordtype">float</span> volume) {
00278     <span class="keywordflow">if</span> (volume == 0) {
00279       <span class="keywordflow">return</span> -10000;
00280     } <span class="keywordflow">else</span> {
00281       <span class="keywordtype">double</span> attenuate = 1000 * log(1 / volume);
00282       <span class="keywordflow">return</span> int(-attenuate);
00283     }
00284   }
00285 
00286 
<a name="l00287"></a><a class="code" href="classaudiere_1_1DSAudioDevice.html#d2">00287</a>   <span class="keywordtype">int</span>
00288   DSAudioDevice::Pan_AudiereToDirectSound(<span class="keywordtype">float</span> pan) {
00289     <span class="keywordflow">if</span> (pan &lt; 0) {
00290       <span class="keywordflow">return</span> -<a class="code" href="classaudiere_1_1DSAudioDevice.html#d2">Pan_AudiereToDirectSound</a>(-pan);
00291     } <span class="keywordflow">else</span> {
00292       <span class="keywordflow">return</span> -<a class="code" href="classaudiere_1_1DSAudioDevice.html#d1">Volume_AudiereToDirectSound</a>(1 - pan);
00293     }
00294   }
00295 
00296 }
</pre></div><hr><address style="align: right;"><small>Generated on Mon Jan 6 05:14:39 2003 for audiere by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc1 </small></address>
</body>
</html>
