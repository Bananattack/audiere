<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>device_oal.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc1 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>device_oal.cpp</h1><a href="device__oal_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="preprocessor">#include "<a class="code" href="device__oal_8h.html">device_oal.h</a>"</span>
00002 <span class="preprocessor">#include "<a class="code" href="threads_8h.html">threads.h</a>"</span>
00003 
00004 
00005 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> BUFFER_COUNT = 4;
00006 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> BUFFER_MILLISECONDS = 250;
00007 
00008 
00009 <span class="keyword">namespace </span>audiere {
00010 
<a name="l00011"></a><a class="code" href="classaudiere_1_1OALAudioDevice.html#d0">00011</a>   <a class="code" href="classaudiere_1_1OALAudioDevice.html">OALAudioDevice</a>*
00012   OALAudioDevice::create(<span class="keyword">const</span> <a class="code" href="classaudiere_1_1ParameterList.html">ParameterList</a>&amp; <a class="code" href="namespaceaudiere_1_1hidden.html#a0">parameters</a>) {
00013     <span class="comment">// open an output device</span>
00014     ALCdevice* device = alcOpenDevice(0);
00015     <span class="keywordflow">if</span> (!device) {
00016       <span class="keywordflow">return</span> 0;
00017     }
00018 
00019     <span class="comment">// create a rendering context</span>
00020     ALCcontext* context = alcCreateContext(device, 0);
00021     <span class="keywordflow">if</span> (!context) {
00022       alcCloseDevice(device);
00023       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00024     }
00025 
00026     alcMakeContextCurrent(context);
00027 
00028     <span class="comment">// define the listener state</span>
00029     ALfloat position[]    = { 0.0, 0.0, 0.0 };
00030     ALfloat velocity[]    = { 0.0, 0.0, 0.0 };
00031     ALfloat orientation[] = { 0.0, 0.0, -1.0, 0.0, 1.0, 0.0 };
00032 
00033     <span class="comment">// set the listener state</span>
00034     <span class="keywordtype">bool</span> success = <span class="keyword">false</span>;
00035     alListenerfv(AL_POSITION, position);
00036     <span class="keywordflow">if</span> (alGetError() == AL_NO_ERROR) {
00037       alListenerfv(AL_VELOCITY, velocity);
00038       <span class="keywordflow">if</span> (alGetError() == AL_NO_ERROR) {
00039         alListenerfv(AL_ORIENTATION, orientation);
00040         <span class="keywordflow">if</span> (alGetError() == AL_NO_ERROR) {
00041 
00042           <span class="comment">// set the distance model</span>
00043           alDistanceModel(AL_NONE);
00044           success = (alGetError() == AL_NO_ERROR);
00045 
00046         }
00047       }
00048     }
00049 
00050     <span class="comment">// if we failed, go home</span>
00051     <span class="keywordflow">if</span> (!success) {
00052       alcMakeContextCurrent(0);
00053       alcDestroyContext(context);
00054       alcCloseDevice(device);
00055       <span class="keywordflow">return</span> 0;
00056     }
00057 
00058     <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classaudiere_1_1OALAudioDevice.html">OALAudioDevice</a>(device, context);
00059   }
00060 
00061 
00062   OALAudioDevice::OALAudioDevice(ALCdevice* device, ALCcontext* context) {
00063     m_device  = device;
00064     m_context = context;
00065   }
00066 
00067 
00068   OALAudioDevice::~OALAudioDevice() {
00069     <span class="keywordflow">if</span> (m_context) {
00070       alcMakeContextCurrent(0);
00071       alcDestroyContext(m_context);
00072       m_context = 0;
00073     }
00074 
00075     <span class="keywordflow">if</span> (m_device) {
00076       alcCloseDevice(m_device);
00077       m_device = 0;
00078     }
00079   }
00080 
00081 
<a name="l00082"></a><a class="code" href="classaudiere_1_1OALAudioDevice.html#a0">00082</a>   <span class="keywordtype">void</span>
00083   OALAudioDevice::update() {
00084     <span class="comment">// enumerate all open streams</span>
00085     StreamList::iterator i = m_open_streams.begin();
00086     <span class="keywordflow">while</span> (i != m_open_streams.end()) {
00087       <a class="code" href="classaudiere_1_1OALOutputStream.html">OALOutputStream</a>* s = *i++;
00088       s-&gt;<a class="code" href="classaudiere_1_1OALOutputStream.html#c2">update</a>();
00089     }
00090   }
00091 
00092 
<a name="l00093"></a><a class="code" href="classaudiere_1_1OALAudioDevice.html#a1">00093</a>   <a class="code" href="classaudiere_1_1OutputStream.html">OutputStream</a>*
00094   OALAudioDevice::openStream(<a class="code" href="classaudiere_1_1SampleSource.html">SampleSource</a>* source) {
00095     <span class="keywordflow">if</span> (!source) {
00096       <span class="keywordflow">return</span> 0;
00097     }
00098 
00099     <span class="keywordtype">int</span> channel_count, sample_rate;
00100     <a class="code" href="namespaceaudiere.html#a83">SampleFormat</a> <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>;
00101     source-&gt;<a class="code" href="classaudiere_1_1SampleSource.html#a0">getFormat</a>(channel_count, sample_rate, <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>);
00102 
00103     <span class="comment">// calculate OpenAL format</span>
00104     ALenum format;
00105     <span class="keywordflow">if</span> (channel_count == 1 &amp;&amp; <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a> == <a class="code" href="namespaceaudiere.html#a83a6">SF_U8</a>) {
00106       format = AL_FORMAT_MONO8;
00107     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (channel_count == 1 &amp;&amp; <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a> == <a class="code" href="namespaceaudiere.html#a83a7">SF_S16</a>) {
00108       format = AL_FORMAT_MONO16;
00109     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (channel_count == 2 &amp;&amp; <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a> == <a class="code" href="namespaceaudiere.html#a83a6">SF_U8</a>) {
00110       format = AL_FORMAT_STEREO8;
00111     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (channel_count == 2 &amp;&amp; <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a> == <a class="code" href="namespaceaudiere.html#a83a7">SF_S16</a>) {
00112       format = AL_FORMAT_STEREO16;
00113     } <span class="keywordflow">else</span> {
00114       <span class="keywordflow">return</span> 0;
00115     }
00116 
00117     <span class="comment">// generate buffers</span>
00118     ALuint* buffers = <span class="keyword">new</span> ALuint[BUFFER_COUNT];
00119     alGenBuffers(BUFFER_COUNT, buffers);
00120     <span class="keywordflow">if</span> (alGetError() != AL_NO_ERROR) {
00121       <span class="keyword">delete</span>[] buffers;
00122       <span class="keywordflow">return</span> NULL;
00123     }
00124 
00125     <span class="comment">// generate sources</span>
00126     <span class="comment">// we have one source for each channel</span>
00127     ALuint al_source;
00128     alGenSources(1, &amp;al_source);
00129     <span class="keywordflow">if</span> (alGetError() != AL_NO_ERROR) {
00130       alDeleteBuffers(BUFFER_COUNT, buffers);
00131       <span class="keyword">delete</span>[] buffers;
00132       <span class="keywordflow">return</span> NULL;
00133     }
00134 
00135     <a class="code" href="classaudiere_1_1OALOutputStream.html">OALOutputStream</a>* stream = <span class="keyword">new</span> <a class="code" href="classaudiere_1_1OALAudioDevice.html#l0">OALOutputStream</a>(
00136       <span class="keyword">this</span>,
00137       source,
00138       al_source,
00139       buffers,
00140       format,
00141       sample_rate);
00142     m_open_streams.push_back(stream);
00143     <span class="keywordflow">return</span> stream;
00144   }
00145 
00146 
<a name="l00147"></a><a class="code" href="classaudiere_1_1OALAudioDevice.html#a2">00147</a>   <a class="code" href="classaudiere_1_1OutputStream.html">OutputStream</a>*
00148   OALAudioDevice::openBuffer(
00149     <span class="keywordtype">void</span>* samples, <span class="keywordtype">int</span> frame_count,
00150     <span class="keywordtype">int</span> channel_count, <span class="keywordtype">int</span> sample_rate, <a class="code" href="namespaceaudiere.html#a83">SampleFormat</a> <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>)
00151   {
00153     <span class="keywordflow">return</span> 0;
00154   }
00155 
00156 
00157   <span class="keywordtype">void</span>
00158   OALAudioDevice::removeStream(OALOutputStream* stream) {
00159     m_open_streams.remove(stream);
00160   }
00161 
00162 
00163   OALOutputStream::OALOutputStream(
00164     OALAudioDevice* device,
00165     SampleSource* source,
00166     ALuint al_source,
00167     ALuint* buffers,
00168     ALenum format,
00169     <span class="keywordtype">int</span> sample_rate)
00170   {
00171     m_device = device;
00172 
00173     m_source = source;
00174 
00175     m_sample_rate = sample_rate;
00176     m_format = format;
00177     <span class="keywordflow">switch</span> (format) {
00178       <span class="keywordflow">case</span> AL_FORMAT_MONO8:    m_sample_size = 1; <span class="keywordflow">break</span>;
00179       <span class="keywordflow">case</span> AL_FORMAT_MONO16:   m_sample_size = 2; <span class="keywordflow">break</span>;
00180       <span class="keywordflow">case</span> AL_FORMAT_STEREO8:  m_sample_size = 2; <span class="keywordflow">break</span>;
00181       <span class="keywordflow">case</span> AL_FORMAT_STEREO16: m_sample_size = 4; <span class="keywordflow">break</span>;
00182     }
00183 
00184     m_last_sample = <span class="keyword">new</span> ALubyte[m_sample_size];
00185     memset(m_last_sample, 0, m_sample_size);
00186 
00187     m_ALsource = al_source;
00188     m_buffers  = buffers;
00189 
00190     m_is_playing = <span class="keyword">false</span>;
00191     m_volume     = 1;
00192 
00193     <span class="comment">// calculate the desired length (in samples) of each buffer</span>
00194     m_buffer_length = BUFFER_MILLISECONDS * m_sample_rate / 1000;
00195 
00196     fillBuffers();
00197 
00198     <span class="comment">// queue up the source's buffers</span>
00199     alSourceQueueBuffers(m_ALsource, BUFFER_COUNT, m_buffers);
00200   }
00201 
00202 
00203   OALOutputStream::~OALOutputStream() {
00204     m_device-&gt;removeStream(<span class="keyword">this</span>);
00205 
00206     alDeleteSources(1, &amp;m_ALsource);
00207     alDeleteBuffers(BUFFER_COUNT, m_buffers);
00208     <span class="keyword">delete</span>[] m_buffers;
00209     <span class="keyword">delete</span>[] m_last_sample;
00210   }
00211 
00212 
00213   <span class="keywordtype">void</span>
00214   OALOutputStream::update() {
00215     <span class="comment">// are there any buffers that have been processed?</span>
00216     ALint processed_buffers;
00217 <span class="preprocessor">#ifdef _WIN32 // XXX more OpenAL hacks</span>
00218 <span class="preprocessor"></span>    alGetSourcei(m_ALsource, AL_BUFFERS_PROCESSED, &amp;processed_buffers);
00219 <span class="preprocessor">#else</span>
00220 <span class="preprocessor"></span>    alGetSourceiv(m_ALsource, AL_BUFFERS_PROCESSED, &amp;processed_buffers);
00221 <span class="preprocessor">#endif</span>
00222 <span class="preprocessor"></span>
00223     <span class="comment">// don't do any allocations if we don't need to</span>
00224     <span class="keywordflow">if</span> (processed_buffers == 0) {
00225       <span class="keywordflow">return</span>;
00226     }
00227 
00228     <span class="keywordtype">int</span> read_size_samples = m_buffer_length;
00229     <span class="keywordtype">int</span> read_size_bytes = read_size_samples * m_sample_size;
00230     ALubyte* sample_buffer = <span class="keyword">new</span> ALubyte[read_size_bytes];
00231 
00232     <span class="keywordtype">int</span> buffer_length_bytes = read_size_bytes;
00233     <span class="keywordflow">while</span> (processed_buffers--) {
00234 
00235       <span class="keywordflow">if</span> (read(sample_buffer, read_size_samples) == 0) {
00236         stop();
00237         <span class="keywordflow">break</span>;
00238       }
00239 
00240       <span class="comment">// unqueue/refill/queue</span>
00241       ALuint buffer;
00242       alSourceUnqueueBuffers(m_ALsource, 1, &amp;buffer);
00243 
00244       alBufferData(
00245         buffer,
00246         m_format,
00247         sample_buffer,
00248         buffer_length_bytes,
00249         m_sample_rate);
00250 
00251       alSourceQueueBuffers(m_ALsource, 1, &amp;buffer);
00252     }
00253 
00254     <span class="keyword">delete</span>[] sample_buffer;
00255 
00256     <a class="code" href="namespaceaudiere.html#a65">AI_Sleep</a>(50);
00257   }
00258 
00259 
00260   <span class="keywordtype">int</span>
00261   OALOutputStream::read(<span class="keywordtype">void</span>* samples, <span class="keywordtype">int</span> sample_count) {
00262     <span class="comment">// try to read from the stream</span>
00263     <span class="keywordtype">int</span> samples_read = m_source-&gt;read(sample_count, samples);
00264 
00265     <span class="comment">// read the last sample</span>
00266     <span class="keywordflow">if</span> (samples_read &gt; 0) {
00267       memcpy(
00268         m_last_sample,
00269         (ALubyte*)samples + (samples_read - 1) * m_sample_size,
00270         m_sample_size);
00271     }
00272 
00273     <span class="comment">// fill the rest with silence</span>
00274     ALubyte* out = (ALubyte*)samples + m_sample_size * samples_read;
00275     <span class="keywordtype">int</span> c = sample_count - samples_read;
00276     <span class="keywordflow">while</span> (c--) {
00277       memcpy(out, m_last_sample, m_sample_size);
00278       out += m_sample_size;
00279     }
00280 
00281     <span class="keywordflow">return</span> samples_read;
00282   }
00283 
00284 
00285   <span class="keywordtype">void</span>
00286   OALOutputStream::fillBuffers() {
00287     <span class="keywordtype">int</span> samples_to_read = m_buffer_length * BUFFER_COUNT;
00288     <span class="keywordtype">int</span> allocate = samples_to_read * m_sample_size;
00289     ALubyte* sample_buffer = <span class="keyword">new</span> ALubyte[allocate];
00290     read(sample_buffer, samples_to_read);
00291    
00292     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; BUFFER_COUNT; i++) {      
00293       alBufferData(
00294         m_buffers[i],
00295         m_format,
00296         sample_buffer + i * m_buffer_length * m_sample_size,
00297         m_buffer_length * m_sample_size,
00298         m_sample_rate);
00299     }
00300 
00301     <span class="keyword">delete</span>[] sample_buffer;
00302   }
00303 
00304 
<a name="l00305"></a><a class="code" href="classaudiere_1_1OALOutputStream.html#a0">00305</a>   <span class="keywordtype">void</span>
00306   OALOutputStream::play() {
00307     alSourcePlay(m_ALsource);
00308     m_is_playing = <span class="keyword">true</span>;
00309   }
00310 
00311 
<a name="l00312"></a><a class="code" href="classaudiere_1_1OALOutputStream.html#a1">00312</a>   <span class="keywordtype">void</span>
00313   OALOutputStream::stop() {
00314     alSourcePause(m_ALsource);
00315     m_is_playing = <span class="keyword">false</span>;
00316   }
00317 
00318 
<a name="l00319"></a><a class="code" href="classaudiere_1_1OALOutputStream.html#a2">00319</a>   <span class="keywordtype">bool</span>
00320   OALOutputStream::isPlaying() {
00321     <span class="keywordflow">return</span> m_is_playing;
00322   }
00323 
00324 
<a name="l00325"></a><a class="code" href="classaudiere_1_1OALOutputStream.html#a3">00325</a>   <span class="keywordtype">void</span>
00326   OALOutputStream::reset() {
00327     <span class="keywordtype">bool</span> is_playing = <a class="code" href="classaudiere_1_1OALOutputStream.html#a2">isPlaying</a>();
00328     <span class="keywordflow">if</span> (is_playing) {
00329       <a class="code" href="classaudiere_1_1OALOutputStream.html#a1">stop</a>();
00330     }
00331 
00332     <span class="comment">// reset stream</span>
00333 
00334     <span class="keywordflow">if</span> (is_playing) {
00335       <a class="code" href="classaudiere_1_1OALOutputStream.html#a0">play</a>();
00336     }
00337   }
00338 
00339 
<a name="l00340"></a><a class="code" href="classaudiere_1_1OALOutputStream.html#a4">00340</a>   <span class="keywordtype">void</span>
00341   OALOutputStream::setRepeat(<span class="keywordtype">bool</span> repeat) {
00343   }
00344 
00345 
<a name="l00346"></a><a class="code" href="classaudiere_1_1OALOutputStream.html#a5">00346</a>   <span class="keywordtype">bool</span>
00347   OALOutputStream::getRepeat() {
00349     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00350   }
00351 
00352 
<a name="l00353"></a><a class="code" href="classaudiere_1_1OALOutputStream.html#a6">00353</a>   <span class="keywordtype">void</span>
00354   OALOutputStream::setVolume(<span class="keywordtype">float</span> volume) {
00355     m_volume = volume;
00356     alSourcef(m_ALsource, AL_GAIN, volume);
00357   }
00358 
00359 
<a name="l00360"></a><a class="code" href="classaudiere_1_1OALOutputStream.html#a7">00360</a>   <span class="keywordtype">float</span>
00361   OALOutputStream::getVolume() {
00362     <span class="keywordflow">return</span> m_volume;
00363   }
00364 
00365 
<a name="l00366"></a><a class="code" href="classaudiere_1_1OALOutputStream.html#a8">00366</a>   <span class="keywordtype">void</span>
00367   OALOutputStream::setPan(<span class="keywordtype">float</span> pan) {
00369   }
00370 
00371 
<a name="l00372"></a><a class="code" href="classaudiere_1_1OALOutputStream.html#a9">00372</a>   <span class="keywordtype">float</span>
00373   OALOutputStream::getPan() {
00375     <span class="keywordflow">return</span> 0.0f;
00376   }
00377 
00378 
<a name="l00379"></a><a class="code" href="classaudiere_1_1OALOutputStream.html#a10">00379</a>   <span class="keywordtype">void</span>
00380   OALOutputStream::setPitchShift(<span class="keywordtype">float</span> shift) {
00382   }
00383 
00384 
<a name="l00385"></a><a class="code" href="classaudiere_1_1OALOutputStream.html#a11">00385</a>   <span class="keywordtype">float</span>
00386   OALOutputStream::getPitchShift() {
00388     <span class="keywordflow">return</span> 0;
00389   }
00390 
00391 
<a name="l00392"></a><a class="code" href="classaudiere_1_1OALOutputStream.html#a12">00392</a>   <span class="keywordtype">bool</span>
00393   OALOutputStream::isSeekable() {
00395     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00396   }
00397 
00398 
<a name="l00399"></a><a class="code" href="classaudiere_1_1OALOutputStream.html#a13">00399</a>   <span class="keywordtype">int</span>
00400   OALOutputStream::getLength() {
00402     <span class="keywordflow">return</span> 0;
00403   }
00404 
00405 
<a name="l00406"></a><a class="code" href="classaudiere_1_1OALOutputStream.html#a14">00406</a>   <span class="keywordtype">void</span>
00407   OALOutputStream::setPosition(<span class="keywordtype">int</span> <span class="comment">/*position*/</span>) {
00409   }
00410 
00411 
<a name="l00412"></a><a class="code" href="classaudiere_1_1OALOutputStream.html#a15">00412</a>   <span class="keywordtype">int</span>
00413   OALOutputStream::getPosition() {
00415     <span class="keywordflow">return</span> 0;
00416   }
00417 
00418 }
</pre></div><hr><address style="align: right;"><small>Generated on Mon Jan 6 05:14:40 2003 for audiere by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc1 </small></address>
</body>
</html>
