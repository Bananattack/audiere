<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>resampler.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>resampler.cpp</h1><a href="resampler_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="preprocessor">#include "<a class="code" href="resampler_8h.html">resampler.h</a>"</span>
00002 
00003 
00004 <span class="keyword">namespace </span>audiere {
00005 
<a name="l00006"></a><a class="code" href="classaudiere_1_1Resampler.html#a0">00006</a>   Resampler::Resampler(<a class="code" href="classaudiere_1_1SampleSource.html">SampleSource</a>* source, <span class="keywordtype">int</span> rate) {
00007     m_source = source;
00008     m_rate = rate;
00009     m_source-&gt;getFormat(
00010       m_native_channel_count,
00011       m_native_sample_rate,
00012       m_native_sample_format);
00013 
00014     m_shift = 1;
00015 
00016     fillBuffer();
00017     resetState();
00018   }
00019 
00020   <span class="keywordtype">void</span>
<a name="l00021"></a><a class="code" href="classaudiere_1_1Resampler.html#a1">00021</a>   Resampler::getFormat(
00022     <span class="keywordtype">int</span>&amp; channel_count,
00023     <span class="keywordtype">int</span>&amp; sample_rate,
00024     <a class="code" href="namespaceaudiere.html#a83">SampleFormat</a>&amp; <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>)
00025   {
00026     channel_count = 2;
00027     sample_rate = m_rate;
00028     <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a> = <a class="code" href="namespaceaudiere.html#a83a7">SF_S16</a>;
00029   }
00030 
00031   <span class="keywordtype">int</span>
<a name="l00032"></a><a class="code" href="classaudiere_1_1Resampler.html#a2">00032</a>   Resampler::read(<span class="keyword">const</span> <span class="keywordtype">int</span> frame_count, <span class="keywordtype">void</span>* buffer) {
00033     <a class="code" href="namespaceaudiere.html#a26">u16</a>* out = (<a class="code" href="namespaceaudiere.html#a26">u16</a>*)buffer;
00034 
00035     <span class="keywordtype">int</span> left = frame_count;
00036 
00037     <span class="comment">// if we didn't finish resampling last time...</span>
00038     <span class="keywordflow">while</span> (m_time &gt; m_native_sample_rate &amp;&amp; left &gt; 0) {
00039       m_time -= m_native_sample_rate;
00040       *out++ = m_sl;
00041       *out++ = m_sr;
00042       --left;
00043     }
00044 
00045     <span class="keywordflow">while</span> (left &gt; 0) {
00046 
00047       <span class="keywordflow">if</span> (m_samples_left == 0) {
00048         <span class="comment">// try to fill the native buffer</span>
00049         fillBuffer();
00050 
00051         <span class="comment">// could we read any more?</span>
00052         <span class="keywordflow">if</span> (m_samples_left == 0) {
00053           <span class="keywordflow">return</span> frame_count - left;
00054         }
00055       }
00056 
00057       m_sl = *m_position++;
00058       m_sr = *m_position++;
00059       --m_samples_left;
00060 
00061       m_time += m_rate / m_shift;
00062       <span class="keywordflow">while</span> (m_time &gt; m_native_sample_rate &amp;&amp; left &gt; 0) {
00063         m_time -= m_native_sample_rate;
00064         *out++ = m_sl;
00065         *out++ = m_sr;
00066         --left;
00067       }
00068 
00069     }
00070     <span class="keywordflow">return</span> frame_count;
00071   }
00072 
00073   <span class="keywordtype">void</span>
<a name="l00074"></a><a class="code" href="classaudiere_1_1Resampler.html#a3">00074</a>   Resampler::reset() {
00075     m_source-&gt;reset();
00076     fillBuffer();
00077     resetState();
00078   }
00079 
00080 
<a name="l00081"></a><a class="code" href="namespaceaudiere.html#a60">00081</a>   <span class="keyword">inline</span> <a class="code" href="namespaceaudiere.html#a27">s16</a> <a class="code" href="namespaceaudiere.html#a60">u8tos16</a>(<a class="code" href="namespaceaudiere.html#a24">u8</a> u) {
00082     <span class="keywordflow">return</span> (<a class="code" href="namespaceaudiere.html#a27">s16</a>(u) - 128) * 256;
00083   }
00084 
00085   <span class="keywordtype">void</span>
00086   Resampler::fillBuffer() {
00087     <span class="comment">// we only support channels in [1, 2] and bits in [8, 16] now</span>
00088     <a class="code" href="namespaceaudiere.html#a24">u8</a> initial_buffer[NATIVE_BUFFER_SIZE * 4];
00089     <span class="keywordtype">unsigned</span> read = m_source-&gt;read(NATIVE_BUFFER_SIZE, initial_buffer);
00090 
00091     <a class="code" href="namespaceaudiere.html#a27">s16</a>* out = m_native_buffer;
00092 
00093     <span class="keywordflow">if</span> (m_native_channel_count == 1) {
00094       <span class="keywordflow">if</span> (m_native_sample_format == <a class="code" href="namespaceaudiere.html#a83a6">SF_U8</a>) {
00095 
00096         <span class="comment">// channels = 1, bits = 8</span>
00097         <a class="code" href="namespaceaudiere.html#a24">u8</a>* in = initial_buffer;
00098         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i &lt; read; ++i) {
00099           <a class="code" href="namespaceaudiere.html#a27">s16</a> sample = <a class="code" href="namespaceaudiere.html#a60">u8tos16</a>(*in++);
00100           *out++ = sample;
00101           *out++ = sample;
00102         }
00103 
00104       } <span class="keywordflow">else</span> {
00105 
00106         <span class="comment">// channels = 1, bits = 16</span>
00107         <a class="code" href="namespaceaudiere.html#a27">s16</a>* in = (<a class="code" href="namespaceaudiere.html#a27">s16</a>*)initial_buffer;
00108         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i &lt; read; ++i) {
00109           <a class="code" href="namespaceaudiere.html#a27">s16</a> sample = *in++;
00110           *out++ = sample;
00111           *out++ = sample;
00112         }
00113 
00114       }
00115     } <span class="keywordflow">else</span> {
00116       <span class="keywordflow">if</span> (m_native_sample_format == <a class="code" href="namespaceaudiere.html#a83a6">SF_U8</a>) {
00117 
00118         <span class="comment">// channels = 2, bits = 8</span>
00119         <a class="code" href="namespaceaudiere.html#a24">u8</a>* in = initial_buffer;
00120         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i &lt; read; ++i) {
00121           *out++ = <a class="code" href="namespaceaudiere.html#a60">u8tos16</a>(*in++);
00122           *out++ = <a class="code" href="namespaceaudiere.html#a60">u8tos16</a>(*in++);
00123         }
00124 
00125       } <span class="keywordflow">else</span> {
00126 
00127         <span class="comment">// channels = 2, bits = 16</span>
00128         <a class="code" href="namespaceaudiere.html#a27">s16</a>* in = (<a class="code" href="namespaceaudiere.html#a27">s16</a>*)initial_buffer;
00129         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i &lt; read; ++i) {
00130           *out++ = *in++;
00131           *out++ = *in++;
00132         }
00133       
00134       }
00135     }
00136 
00137     m_position = m_native_buffer;
00138     m_samples_left = read;
00139   }
00140 
00141   <span class="keywordtype">void</span>
00142   Resampler::resetState() {
00143     m_time = 0;
00144     m_sl = 0;
00145     m_sr = 0;
00146   }
00147 
00148   <span class="keywordtype">bool</span>
<a name="l00149"></a><a class="code" href="classaudiere_1_1Resampler.html#a4">00149</a>   Resampler::isSeekable() {
00150     <span class="keywordflow">return</span> m_source-&gt;isSeekable();
00151   }
00152 
00153   <span class="keywordtype">int</span>
<a name="l00154"></a><a class="code" href="classaudiere_1_1Resampler.html#a5">00154</a>   Resampler::getLength() {
00155     <span class="keywordflow">return</span> m_source-&gt;getLength();
00156   }
00157 
00158   <span class="keywordtype">void</span>
<a name="l00159"></a><a class="code" href="classaudiere_1_1Resampler.html#a6">00159</a>   Resampler::setPosition(<span class="keywordtype">int</span> position) {
00160     m_source-&gt;setPosition(position);
00161     fillBuffer();
00162     resetState();
00163   }
00164 
00165   <span class="keywordtype">int</span>
<a name="l00166"></a><a class="code" href="classaudiere_1_1Resampler.html#a7">00166</a>   Resampler::getPosition() {
00167     <span class="keywordflow">return</span> m_source-&gt;getPosition() - m_samples_left;
00168   }
00169 
00170   <span class="keywordtype">void</span>
<a name="l00171"></a><a class="code" href="classaudiere_1_1Resampler.html#a8">00171</a>   Resampler::setPitchShift(<span class="keywordtype">float</span> shift) {
00172     m_shift = shift;
00173   }
00174 
00175   <span class="keywordtype">float</span>
<a name="l00176"></a><a class="code" href="classaudiere_1_1Resampler.html#a9">00176</a>   Resampler::getPitchShift() {
00177     <span class="keywordflow">return</span> m_shift;
00178   }
00179 
00180 }
</pre></div><hr><address style="align: right;"><small>Generated on Sat Oct 12 01:43:04 2002 for audiere by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
