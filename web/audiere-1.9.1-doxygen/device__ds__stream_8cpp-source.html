<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>device_ds_stream.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>device_ds_stream.cpp</h1><a href="device__ds__stream_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="preprocessor">#include "<a class="code" href="device__ds__stream_8h.html">device_ds_stream.h</a>"</span>
00002 <span class="preprocessor">#include "<a class="code" href="device__ds_8h.html">device_ds.h</a>"</span>
00003 <span class="preprocessor">#include "<a class="code" href="debug_8h.html">debug.h</a>"</span>
00004 
00005 
00006 <span class="keyword">namespace </span>audiere {
00007 
<a name="l00008"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a0">00008</a>   DSOutputStream::DSOutputStream(
00009     <a class="code" href="classaudiere_1_1DSAudioDevice.html">DSAudioDevice</a>* device,
00010     IDirectSoundBuffer* buffer,
00011     <span class="keywordtype">int</span> buffer_length,
00012     <a class="code" href="classaudiere_1_1SampleSource.html">SampleSource</a>* source)
00013   {
00014     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"DSOutputStream::DSOutputStream"</span>);
00015 
00016     m_device = device;
00017 
00018     m_buffer        = buffer;
00019     m_buffer_length = buffer_length;
00020     m_next_read     = 0;
00021     m_last_play     = 0;
00022 
00023     DWORD frequency;
00024     m_buffer-&gt;GetFrequency(&amp;frequency);
00025     m_base_frequency = frequency;
00026 
00027     m_is_playing = <span class="keyword">false</span>;
00028 
00029     m_source = <span class="keyword">new</span> <a class="code" href="classaudiere_1_1RepeatableStream.html">RepeatableStream</a>(source);
00030 
00031     <span class="keywordtype">int</span> channel_count, sample_rate;
00032     <a class="code" href="namespaceaudiere.html#a83">SampleFormat</a> <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>;
00033     source-&gt;<a class="code" href="classaudiere_1_1SampleSource.html#a0">getFormat</a>(channel_count, sample_rate, <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>);
00034     m_sample_size = <a class="code" href="namespaceaudiere.html#a35">GetSampleSize</a>(<a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>) * channel_count;
00035 
00036     m_total_read    = 0;
00037     m_total_written = 0;
00038 
00039     m_last_sample = <span class="keyword">new</span> BYTE[m_sample_size];
00040 
00041     <a class="code" href="classaudiere_1_1DSOutputStream.html#a8">setVolume</a>(1);
00042     <a class="code" href="classaudiere_1_1DSOutputStream.html#a10">setPan</a>(0);
00043 
00044     <span class="comment">// fill the buffer with data</span>
00045     fillStream();
00046   }
00047 
00048 
<a name="l00049"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a1">00049</a>   DSOutputStream::~DSOutputStream() {
00050     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"DSOutputStream::~DSOutputStream"</span>);
00051 
00052     m_device-&gt;removeStream(<span class="keyword">this</span>);
00053 
00054     <span class="comment">// destroy the sound buffer interface</span>
00055     m_buffer-&gt;Release();
00056     <span class="keyword">delete</span>[] m_last_sample;
00057   }
00058 
00059   
00060   <span class="keywordtype">void</span>
<a name="l00061"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a2">00061</a>   DSOutputStream::play() {
00062     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"DSOutputStream::play"</span>);
00063     m_buffer-&gt;Play(0, 0, DSBPLAY_LOOPING);
00064     m_is_playing = <span class="keyword">true</span>;
00065   }
00066 
00067 
00068   <span class="keywordtype">void</span>
<a name="l00069"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a3">00069</a>   DSOutputStream::stop() {
00070     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"DSOutputStream::stop"</span>);
00071     m_buffer-&gt;Stop();
00072     m_is_playing = <span class="keyword">false</span>;
00073   }
00074 
00075 
00076   <span class="keywordtype">bool</span>
<a name="l00077"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a4">00077</a>   DSOutputStream::isPlaying() {
00078     <span class="keywordflow">return</span> m_is_playing;
00079   }
00080 
00081 
00082   <span class="keywordtype">void</span>
<a name="l00083"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a5">00083</a>   DSOutputStream::reset() {
00084     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"DSOutputStream::reset"</span>);
00085     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(<span class="keyword">this</span>);
00086 
00087     <span class="comment">// figure out if we're playing or not</span>
00088     <span class="keywordtype">bool</span> is_playing = <a class="code" href="classaudiere_1_1DSOutputStream.html#a4">isPlaying</a>();
00089 
00090     <span class="comment">// if we're playing, stop</span>
00091     <span class="keywordflow">if</span> (is_playing) {
00092       <a class="code" href="classaudiere_1_1DSOutputStream.html#a3">stop</a>();
00093     }
00094 
00095     m_buffer-&gt;SetCurrentPosition(0);
00096     m_last_play = 0;
00097 
00098     m_source-&gt;reset();
00099     m_total_read = 0;
00100     m_total_written = 0;
00101     m_next_read = 0;
00102     fillStream();
00103 
00104     <span class="comment">// if we were playing, restart</span>
00105     <span class="keywordflow">if</span> (is_playing) {
00106       <a class="code" href="classaudiere_1_1DSOutputStream.html#a2">play</a>();
00107     }
00108   }
00109 
00110 
00111   <span class="keywordtype">void</span>
<a name="l00112"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a6">00112</a>   DSOutputStream::setRepeat(<span class="keywordtype">bool</span> repeat) {
00113     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(<span class="keyword">this</span>);
00114     m_source-&gt;setRepeat(repeat);
00115   }
00116 
00117 
00118   <span class="keywordtype">bool</span>
<a name="l00119"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a7">00119</a>   DSOutputStream::getRepeat() {
00120     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(<span class="keyword">this</span>);
00121     <span class="keywordflow">return</span> m_source-&gt;getRepeat();
00122   }
00123 
00124 
00125   <span class="keywordtype">void</span>
<a name="l00126"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a8">00126</a>   DSOutputStream::setVolume(<span class="keywordtype">float</span> volume) {
00127     m_volume = volume;
00128     m_buffer-&gt;SetVolume(DSAudioDevice::Volume_AudiereToDirectSound(volume));
00129   }
00130 
00131 
00132   <span class="keywordtype">float</span>
<a name="l00133"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a9">00133</a>   DSOutputStream::getVolume() {
00134     <span class="keywordflow">return</span> m_volume;
00135   }
00136 
00137 
00138   <span class="keywordtype">void</span>
<a name="l00139"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a10">00139</a>   DSOutputStream::setPan(<span class="keywordtype">float</span> pan) {
00140     m_pan = pan;
00141     m_buffer-&gt;SetPan(DSAudioDevice::Pan_AudiereToDirectSound(pan));
00142   }
00143 
00144 
00145   <span class="keywordtype">float</span>
<a name="l00146"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a11">00146</a>   DSOutputStream::getPan() {
00147     <span class="keywordflow">return</span> m_pan;
00148   }
00149 
00150 
00151   <span class="keywordtype">void</span>
<a name="l00152"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a12">00152</a>   DSOutputStream::setPitchShift(<span class="keywordtype">float</span> shift) {
00153     m_buffer-&gt;SetFrequency(DWORD(m_base_frequency * shift));
00154   }
00155 
00156 
00157   <span class="keywordtype">float</span>
<a name="l00158"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a13">00158</a>   DSOutputStream::getPitchShift() {
00159     DWORD frequency;
00160     m_buffer-&gt;GetFrequency(&amp;frequency);
00161     <span class="keywordflow">return</span> float(frequency) / m_base_frequency;
00162   }
00163   
00164 
00165   <span class="keywordtype">bool</span>
<a name="l00166"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a14">00166</a>   DSOutputStream::isSeekable() {
00167     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(<span class="keyword">this</span>);
00168     <span class="keywordflow">return</span> m_source-&gt;isSeekable();
00169   }
00170 
00171 
00172   <span class="keywordtype">int</span>
<a name="l00173"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a15">00173</a>   DSOutputStream::getLength() {
00174     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(<span class="keyword">this</span>);
00175     <span class="keywordflow">return</span> m_source-&gt;getLength();
00176   }
00177 
00178 
00179   <span class="keywordtype">void</span>
<a name="l00180"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a16">00180</a>   DSOutputStream::setPosition(<span class="keywordtype">int</span> position) {
00181     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(<span class="keyword">this</span>);
00182 
00183     <span class="comment">// figure out if we're playing or not</span>
00184     <span class="keywordtype">bool</span> is_playing = <a class="code" href="classaudiere_1_1DSOutputStream.html#a4">isPlaying</a>();
00185 
00186     <span class="comment">// if we're playing, stop</span>
00187     <span class="keywordflow">if</span> (is_playing) {
00188       <a class="code" href="classaudiere_1_1DSOutputStream.html#a3">stop</a>();
00189     }
00190 
00191     m_source-&gt;setPosition(position);
00192     m_last_play = 0;
00193 
00194     m_source-&gt;setPosition(position);
00195     m_total_read = 0;
00196     m_total_written = 0;
00197     m_next_read = 0;
00198     fillStream();
00199 
00200     <span class="comment">// if we were playing, restart</span>
00201     <span class="keywordflow">if</span> (is_playing) {
00202       <a class="code" href="classaudiere_1_1DSOutputStream.html#a2">play</a>();
00203     }
00204   }
00205 
00206 
00207   <span class="keywordtype">int</span>
<a name="l00208"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a17">00208</a>   DSOutputStream::getPosition() {
00209     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(<span class="keyword">this</span>);
00210     <span class="keywordtype">int</span> pos = m_source-&gt;getPosition() - (m_total_read - m_total_written);
00211     <span class="keywordflow">if</span> (pos &lt; 0) {
00212       pos += m_source-&gt;getLength();
00213     }
00214     <span class="keywordflow">return</span> pos;
00215   }
00216 
00217 
00218   <span class="keywordtype">void</span>
00219   DSOutputStream::fillStream() {
00220     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"DSOutputStream::fillStream"</span>);
00221 
00222     <span class="comment">// we know the stream is stopped, so just lock the buffer and fill it</span>
00223 
00224     <span class="keywordtype">void</span>* buffer = NULL;
00225     DWORD buffer_length = 0;
00226 
00227     <span class="comment">// lock</span>
00228     HRESULT result = m_buffer-&gt;Lock(
00229       0,
00230       m_buffer_length * m_sample_size,
00231       &amp;buffer,
00232       &amp;buffer_length,
00233       NULL,
00234       NULL,
00235       0);
00236     <span class="keywordflow">if</span> (FAILED(result) || !buffer) {
00237       <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"FillStream failed!"</span>);
00238       <span class="keywordflow">return</span>;
00239     }
00240 
00241     <a class="code" href="debug_8h.html#a2">ADR_IF_DEBUG</a> {
00242       <span class="keywordtype">char</span> str[80];
00243       sprintf(str, <span class="stringliteral">"Buffer Length = %d"</span>, buffer_length);
00244       <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(str);
00245     }
00246 
00247     <span class="comment">// fill</span>
00248     <span class="keywordtype">int</span> samples_to_read = buffer_length / m_sample_size;
00249     <span class="keywordtype">int</span> samples_read = streamRead(samples_to_read, buffer);
00250     <span class="keywordflow">if</span> (samples_read != samples_to_read) {
00251       m_next_read = samples_read;
00252     } <span class="keywordflow">else</span> {
00253       m_next_read = 0;
00254     }
00255 
00256     <span class="comment">// unlock</span>
00257     m_buffer-&gt;Unlock(buffer, buffer_length, NULL, 0);
00258   }
00259 
00260 
00261   <span class="keywordtype">void</span>
00262   DSOutputStream::update() {
00263     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(<span class="keyword">this</span>);
00264 
00265     <span class="comment">// if it's not playing, don't do anything</span>
00266     <span class="keywordflow">if</span> (!<a class="code" href="classaudiere_1_1DSOutputStream.html#a4">isPlaying</a>()) {
00267       <span class="keywordflow">return</span>;
00268     }
00269 
00270     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"DSOutputStream::update"</span>);
00271 
00272     <span class="comment">/* this method reads more PCM data into the stream if it is required */</span>
00273 
00274     <span class="comment">// read the stream's play and write cursors</span>
00275     DWORD <a class="code" href="classaudiere_1_1DSOutputStream.html#a2">play</a>, write;
00276     HRESULT result = m_buffer-&gt;GetCurrentPosition(&amp;<a class="code" href="classaudiere_1_1DSOutputStream.html#a2">play</a>, &amp;write);
00277     <span class="keywordflow">if</span> (FAILED(result)) {
00278       <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"GetCurrentPosition failed"</span>);
00279       <span class="keywordflow">return</span>;
00280     }
00281 
00282     <a class="code" href="debug_8h.html#a2">ADR_IF_DEBUG</a> {
00283       <span class="keywordtype">char</span> str[160];
00284       sprintf(str,
00285         <span class="stringliteral">"play: %d  write: %d  nextread: %d"</span>,
00286         <a class="code" href="classaudiere_1_1DSOutputStream.html#a2">play</a>, write, m_next_read);
00287       <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(str);
00288     }
00289 
00290     <span class="comment">// deal with them in samples, not bytes</span>
00291     <a class="code" href="classaudiere_1_1DSOutputStream.html#a2">play</a>  /= m_sample_size;
00292     write /= m_sample_size;
00293 
00294     <span class="comment">// how many samples have we written since the last update?</span>
00295     <span class="keywordflow">if</span> (<a class="code" href="classaudiere_1_1DSOutputStream.html#a2">play</a> &lt; m_last_play) {
00296       m_total_written += <a class="code" href="classaudiere_1_1DSOutputStream.html#a2">play</a> + m_buffer_length - m_last_play;
00297     } <span class="keywordflow">else</span> {
00298       m_total_written += <a class="code" href="classaudiere_1_1DSOutputStream.html#a2">play</a> - m_last_play;
00299     }
00300     m_last_play = <a class="code" href="classaudiere_1_1DSOutputStream.html#a2">play</a>;
00301 
00302     <span class="comment">// read from |m_next_read| to |play|</span>
00303     <span class="keywordtype">int</span> read_length = <a class="code" href="classaudiere_1_1DSOutputStream.html#a2">play</a> - m_next_read;
00304     <span class="keywordflow">if</span> (read_length &lt; 0) {
00305       read_length += m_buffer_length;
00306     }
00307 
00308     <span class="keywordflow">if</span> (read_length == 0) {
00309       <span class="keywordflow">return</span>;
00310     }
00311 
00312     <span class="comment">// lock the buffer</span>
00313     <span class="keywordtype">void</span>* buffer1;
00314     <span class="keywordtype">void</span>* buffer2;
00315     DWORD buffer1_length;
00316     DWORD buffer2_length;
00317     result = m_buffer-&gt;Lock(
00318       m_next_read * m_sample_size,
00319       read_length * m_sample_size,
00320       &amp;buffer1, &amp;buffer1_length,
00321       &amp;buffer2, &amp;buffer2_length,
00322       0);
00323     <span class="keywordflow">if</span> (FAILED(result)) {
00324       <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"Lock() failed!"</span>);
00325       <span class="keywordflow">return</span>;
00326     }
00327 
00328     <a class="code" href="debug_8h.html#a2">ADR_IF_DEBUG</a> {
00329       <span class="keywordtype">char</span> str[160];
00330       sprintf(str, <span class="stringliteral">"buffer1: %d  buffer2: %d"</span>, buffer1_length, buffer2_length);
00331       <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(str);
00332     }
00333 
00334     <span class="comment">// now actually read samples</span>
00335     <span class="keywordtype">int</span> length1 = buffer1_length / m_sample_size;
00336     <span class="keywordtype">int</span> length2 = buffer2_length / m_sample_size;
00337     <span class="keywordtype">int</span> read = streamRead(length1, buffer1);
00338     <span class="keywordflow">if</span> (length1 == read) {
00339       read += streamRead(length2, buffer2);
00340     }
00341 
00342     <a class="code" href="debug_8h.html#a2">ADR_IF_DEBUG</a> {
00343       <span class="keywordtype">char</span> str[80];
00344       sprintf(str, <span class="stringliteral">"read: %d"</span>, read);
00345       <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(str);
00346     }
00347 
00348     m_next_read = (m_next_read + read) % m_buffer_length;
00349 
00350     <span class="comment">// unlock</span>
00351     m_buffer-&gt;Unlock(buffer1, buffer1_length, buffer2, buffer2_length);
00352 
00353   
00354     <span class="comment">// Should we stop?</span>
00355     <span class="keywordflow">if</span> (m_total_written &gt; m_total_read) {
00356       <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"Stopping stream!"</span>);
00357 
00358       <a class="code" href="classaudiere_1_1DSOutputStream.html#a3">stop</a>();
00359       m_buffer-&gt;SetCurrentPosition(0);
00360       m_last_play = 0;
00361 
00362       m_source-&gt;reset();
00363 
00364       m_total_written = 0;
00365       m_total_read = 0;
00366       m_next_read = 0;
00367       fillStream();
00368 
00369       <span class="keywordflow">return</span>;
00370     }
00371   }
00372 
00373 
00374   <span class="comment">// read as much as possible from the stream source, fill the rest with 0</span>
00375   <span class="keywordtype">int</span>
00376   DSOutputStream::streamRead(<span class="keywordtype">int</span> sample_count, <span class="keywordtype">void</span>* samples) {
00377     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"streamRead"</span>);
00378 
00379     <span class="comment">// try to read from the stream</span>
00380     <span class="keywordtype">int</span> samples_read = m_source-&gt;read(sample_count, samples);
00381 
00382     <span class="comment">// read the last sample</span>
00383     <span class="keywordflow">if</span> (samples_read &gt; 0) {
00384       memcpy(
00385         m_last_sample,
00386         (BYTE*)samples + (samples_read - 1) * m_sample_size,
00387         m_sample_size);
00388     }
00389 
00390     <span class="comment">// fill the rest with silence</span>
00391     BYTE* out = (BYTE*)samples + m_sample_size * samples_read;
00392     <span class="keywordtype">int</span> c = sample_count - samples_read;
00393     <span class="keywordflow">while</span> (c--) {
00394       memcpy(out, m_last_sample, m_sample_size);
00395       out += m_sample_size;
00396     }
00397 
00398     m_total_read += samples_read;
00399     <span class="keywordflow">return</span> samples_read;
00400   }
00401 
00402 }
</pre></div><hr><address style="align: right;"><small>Generated on Sat Oct 12 01:43:02 2002 for audiere by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
