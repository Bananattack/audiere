<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>device_null.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>device_null.cpp</h1><a href="device__null_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="preprocessor">#ifdef _MSC_VER</span>
00002 <span class="preprocessor"></span><span class="preprocessor">#pragma warning(disable : 4786)</span>
00003 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00004 <span class="preprocessor"></span>
00005 
00006 <span class="preprocessor">#include &lt;algorithm&gt;</span>
00007 <span class="preprocessor">#include &lt;functional&gt;</span>
00008 <span class="preprocessor">#include "<a class="code" href="device__null_8h.html">device_null.h</a>"</span>
00009 <span class="preprocessor">#include "<a class="code" href="timer_8h.html">timer.h</a>"</span>
00010 <span class="preprocessor">#include "<a class="code" href="threads_8h.html">threads.h</a>"</span>
00011 <span class="preprocessor">#include "<a class="code" href="utility_8h.html">utility.h</a>"</span>
00012 
00013 <span class="keyword">namespace </span>audiere {
00014 
00015   NullAudioDevice*
<a name="l00016"></a><a class="code" href="classaudiere_1_1NullAudioDevice.html#d0">00016</a>   NullAudioDevice::create(<span class="keyword">const</span> <a class="code" href="classaudiere_1_1ParameterList.html">ParameterList</a>&amp; <span class="comment">/*parameters*/</span>) {
00017     <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classaudiere_1_1NullAudioDevice.html">NullAudioDevice</a>;
00018   }
00019 
00020 
00021   NullAudioDevice::NullAudioDevice() {
00022   }
00023 
00024 
00025   NullAudioDevice::~NullAudioDevice() {
00026     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"~NullAudioDevice"</span>);
00027 
00028     <a class="code" href="debug_8h.html#a3">ADR_ASSERT</a>(m_streams.size() == 0,
00029       <span class="stringliteral">"Null output context should not die with open streams"</span>);
00030   }
00031 
00032 
00033   <span class="keywordtype">void</span>
<a name="l00034"></a><a class="code" href="classaudiere_1_1NullAudioDevice.html#a0">00034</a>   NullAudioDevice::update() {
00035     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"NullAudioDevice::update"</span>);
00036     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(<span class="keyword">this</span>);
00037 
00038     StreamList::iterator i = m_streams.begin();
00039     <span class="keywordflow">for</span> (; i != m_streams.end(); ++i) {
00040       (*i)-&gt;update();
00041     }
00042 
00043     <a class="code" href="namespaceaudiere.html#a65">AI_Sleep</a>(50);
00044   }
00045 
00046 
00047   OutputStream*
<a name="l00048"></a><a class="code" href="classaudiere_1_1NullAudioDevice.html#a1">00048</a>   NullAudioDevice::openStream(<a class="code" href="classaudiere_1_1SampleSource.html">SampleSource</a>* source) {
00049     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"NullAudioDevice::openStream"</span>);
00050     
00051     <span class="keywordflow">if</span> (!source) {
00052       <span class="keywordflow">return</span> 0;
00053     }
00054 
00055     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(<span class="keyword">this</span>);
00056 
00057     <a class="code" href="classaudiere_1_1NullOutputStream.html">NullOutputStream</a>* stream = <span class="keyword">new</span> <a class="code" href="classaudiere_1_1NullAudioDevice.html#l0">NullOutputStream</a>(<span class="keyword">this</span>, source);
00058     m_streams.push_back(stream);
00059     <span class="keywordflow">return</span> stream;
00060   }
00061 
00062 
00063   OutputStream*
<a name="l00064"></a><a class="code" href="classaudiere_1_1NullAudioDevice.html#a2">00064</a>   NullAudioDevice::openBuffer(
00065     <span class="keywordtype">void</span>* samples, <span class="keywordtype">int</span> frame_count,
00066     <span class="keywordtype">int</span> channel_count, <span class="keywordtype">int</span> sample_rate, <a class="code" href="namespaceaudiere.html#a83">SampleFormat</a> <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>)
00067   {
00068     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"NullAudioDevice::openBuffer"</span>);
00069 
00070     <a class="code" href="classaudiere_1_1RefPtr.html">RefPtr&lt;SampleSource&gt;</a> <a class="code" href="namespaceaudiere.html#a19">source</a>(<a class="code" href="namespaceaudiere.html#a82">OpenBufferStream</a>(
00071       samples, frame_count,
00072       channel_count, sample_rate, <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>));
00073     <span class="keywordflow">return</span> <a class="code" href="classaudiere_1_1NullAudioDevice.html#a1">openStream</a>(source.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00074   }
00075 
00076 
00077   <span class="keywordtype">void</span>
00078   NullAudioDevice::removeStream(NullOutputStream* stream) {
00079     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(<span class="keyword">this</span>);
00080     m_streams.remove(stream);
00081   }
00082 
00083 
00084   NullOutputStream::NullOutputStream(
00085     NullAudioDevice* device,
00086     SampleSource* source)
00087   : m_device(device)
00088   , m_source(new RepeatableStream(source))
00089   , m_is_playing(false)
00090   , m_volume(1)
00091   , m_pan(0)
00092   , m_shift(1)
00093   , m_last_update(0)
00094   {
00095     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"NullOutputStream::NullOutputStream"</span>);
00096     m_source-&gt;getFormat(m_channel_count, m_sample_rate, m_sample_format);
00097   }
00098 
00099 
00100   NullOutputStream::~NullOutputStream() {
00101     m_device-&gt;removeStream(<span class="keyword">this</span>);
00102   }
00103 
00104 
00105   <span class="keywordtype">void</span>
<a name="l00106"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a0">00106</a>   NullOutputStream::play() {
00107     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"NullOutputStream::play"</span>);
00108     m_is_playing = <span class="keyword">true</span>;
00109     resetTimer();
00110   }
00111 
00112 
00113   <span class="keywordtype">void</span>
<a name="l00114"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a1">00114</a>   NullOutputStream::stop() {
00115     m_is_playing = <span class="keyword">false</span>;
00116   }
00117 
00118 
00119   <span class="keywordtype">void</span>
<a name="l00120"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a2">00120</a>   NullOutputStream::reset() {
00121     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00122     resetTimer();
00123     m_source-&gt;reset();
00124   }
00125 
00126 
00127   <span class="keywordtype">bool</span>
<a name="l00128"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a3">00128</a>   NullOutputStream::isPlaying() {
00129     <span class="keywordflow">return</span> m_is_playing;
00130   }
00131 
00132 
00133   <span class="keywordtype">void</span>
<a name="l00134"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a4">00134</a>   NullOutputStream::setRepeat(<span class="keywordtype">bool</span> repeat) {
00135     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00136     m_source-&gt;setRepeat(repeat);
00137   }
00138 
00139 
00140   <span class="keywordtype">bool</span>
<a name="l00141"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a5">00141</a>   NullOutputStream::getRepeat() {
00142     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00143     <span class="keywordflow">return</span> m_source-&gt;getRepeat();
00144   }
00145 
00146 
00147   <span class="keywordtype">void</span>
<a name="l00148"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a6">00148</a>   NullOutputStream::setVolume(<span class="keywordtype">float</span> volume) {
00149     m_volume = volume;
00150   }
00151 
00152 
00153   <span class="keywordtype">float</span>
<a name="l00154"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a7">00154</a>   NullOutputStream::getVolume() {
00155     <span class="keywordflow">return</span> m_volume;
00156   }
00157 
00158   
00159   <span class="keywordtype">void</span>
<a name="l00160"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a8">00160</a>   NullOutputStream::setPan(<span class="keywordtype">float</span> pan) {
00161     m_pan = pan;
00162   }
00163 
00164   
00165   <span class="keywordtype">float</span>
<a name="l00166"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a9">00166</a>   NullOutputStream::getPan() {
00167     <span class="keywordflow">return</span> m_pan;
00168   }
00169 
00170 
00171   <span class="keywordtype">void</span>
<a name="l00172"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a10">00172</a>   NullOutputStream::setPitchShift(<span class="keywordtype">float</span> shift) {
00173     m_shift = shift;
00174   }
00175 
00176 
00177   <span class="keywordtype">float</span>
<a name="l00178"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a11">00178</a>   NullOutputStream::getPitchShift() {
00179     <span class="keywordflow">return</span> m_shift;
00180   }
00181 
00182 
00183   <span class="keywordtype">bool</span>
<a name="l00184"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a12">00184</a>   NullOutputStream::isSeekable() {
00185     <span class="keywordflow">return</span> m_source-&gt;isSeekable();
00186   }
00187 
00188 
00189   <span class="keywordtype">int</span>
<a name="l00190"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a13">00190</a>   NullOutputStream::getLength() {
00191     <span class="keywordflow">return</span> m_source-&gt;getLength();
00192   }
00193 
00194 
00195   <span class="keywordtype">void</span>
<a name="l00196"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a14">00196</a>   NullOutputStream::setPosition(<span class="keywordtype">int</span> position) {
00197     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00198     m_source-&gt;setPosition(position);
00199     <a class="code" href="classaudiere_1_1NullOutputStream.html#a2">reset</a>();
00200   }
00201 
00202 
00203   <span class="keywordtype">int</span>
<a name="l00204"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a15">00204</a>   NullOutputStream::getPosition() {
00205     <span class="keywordflow">return</span> m_source-&gt;getPosition();
00206   }
00207 
00208 
00209   <span class="keywordtype">void</span>
00210   NullOutputStream::resetTimer() {
00211     m_last_update = <a class="code" href="timer__ansi_8cpp.html#a0">GetNow</a>();
00212   }
00213 
00214 
00215   <span class="keywordtype">void</span>
00216   NullOutputStream::update() {
00217     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"NullOutputStream::update"</span>);
00218 
00219     <span class="keywordflow">if</span> (m_is_playing) {
00220       <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"Null output stream is playing"</span>);
00221 
00222       <span class="comment">// get number of microseconds elapsed since last playing update</span>
00223       <span class="comment">// so we can read that much time worth of samples</span>
00224       <a class="code" href="namespaceaudiere.html#a30">u64</a> now = <a class="code" href="timer__ansi_8cpp.html#a0">GetNow</a>();
00225       <a class="code" href="namespaceaudiere.html#a30">u64</a> elapsed = now - m_last_update;
00226 
00227       <span class="keywordtype">double</span> shifted_time = m_shift * <a class="code" href="namespaceaudiere.html#a31">s64</a>(elapsed) / 1000000.0;  <span class="comment">// in seconds</span>
00228       <span class="keywordtype">int</span> samples_to_read = int(m_sample_rate * shifted_time);
00229 
00230       <a class="code" href="debug_8h.html#a2">ADR_IF_DEBUG</a> {
00231         <span class="keywordtype">char</span> str[100];
00232         sprintf(str, <span class="stringliteral">"Samples to read: %d"</span>, samples_to_read);
00233         <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(str);
00234       }
00235 
00236       <span class="keywordtype">int</span> samples_read = dummyRead(samples_to_read);
00237 
00238       <span class="keywordflow">if</span> (samples_read != samples_to_read) {
00239         <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"Stopping null output stream"</span>);
00240         m_source-&gt;reset();
00241         <a class="code" href="classaudiere_1_1NullOutputStream.html#a1">stop</a>();
00242       }
00243 
00244       m_last_update = now;
00245     }
00246   }
00247 
00248 
00249   <span class="keywordtype">int</span>
00250   NullOutputStream::dummyRead(<span class="keywordtype">int</span> samples_to_read) {
00251     <span class="keywordtype">int</span> total = 0;  <span class="comment">// number of samples read so far</span>
00252 
00253     <span class="keyword">const</span> <span class="keywordtype">int</span> bytes_per_sample = <a class="code" href="namespaceaudiere.html#a35">GetSampleSize</a>(m_sample_format);
00254 
00255     <span class="comment">// read samples into dummy buffer, counting the number we actually read</span>
00256     <a class="code" href="namespaceaudiere.html#a24">u8</a>* dummy = <span class="keyword">new</span> <a class="code" href="namespaceaudiere.html#a24">u8</a>[1024 * m_channel_count * bytes_per_sample];
00257     <span class="keywordflow">while</span> (samples_to_read &gt; 0) {
00258       <span class="keywordtype">int</span> read = std::min(1024, samples_to_read);
00259       <span class="keywordtype">int</span> actual_read = m_source-&gt;read(read, dummy);
00260       total += actual_read;
00261       samples_to_read -= actual_read;
00262       <span class="keywordflow">if</span> (actual_read &lt; read) {
00263         <span class="keywordflow">break</span>;
00264       }
00265     }
00266 
00267     <span class="keyword">delete</span>[] dummy;
00268     <span class="keywordflow">return</span> total;
00269   }
00270 
00271 }
</pre></div><hr><address style="align: right;"><small>Generated on Sat Oct 12 01:43:02 2002 for audiere by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
