<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>input_mp3.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.17 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>input_mp3.cpp</h1><a href="input__mp3_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment">  THIS IS WRITTEN FOR CHAD AUSTIN FOR AUDIERE</span>
00003 <span class="comment">  By Jacky Chong</span>
00004 <span class="comment"></span>
00005 <span class="comment">  In short, this is some wierd shit I wrote up because Chad</span>
00006 <span class="comment">  didn't want to touch this. Also, I have no idea what I've</span>
00007 <span class="comment">  done as well to get it work as well.</span>
00008 <span class="comment">*/</span>
00009 
00010 <span class="preprocessor">#include &lt;string.h&gt;</span>
00011 <span class="preprocessor">#include "<a class="code" href="input__mp3_8h.html">input_mp3.h</a>"</span>
00012 <span class="preprocessor">#include "<a class="code" href="utility_8h.html">utility.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="debug_8h.html">debug.h</a>"</span>
00014 
00015 
00016 <span class="comment">// The number of MP3 frame that are processed at a time.  If this value</span>
00017 <span class="comment">// is smaller, the decoder should take less memory.  However, it may</span>
00018 <span class="comment">// skip on corrupt MP3s.</span>
00019 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> FRAME_COUNT = 10;
00020 
00021 
00022 <span class="keyword">namespace </span>audiere {
00023 
00024 
<a name="l00025"></a><a class="code" href="classaudiere_1_1MyLoader.html">00025</a>   <span class="keyword">class </span><a class="code" href="classaudiere_1_1MyLoader.html">MyLoader</a> : <span class="keyword">public</span> Soundinputstream {
00026   <span class="keyword">public</span>:
<a name="l00027"></a><a class="code" href="classaudiere_1_1MyLoader.html#a0">00027</a>     <a class="code" href="classaudiere_1_1MyLoader.html#a0">MyLoader</a>(<a class="code" href="classaudiere_1_1File.html">File</a>* file) {
00028       m_file = file;
00029       m_eof = <span class="keyword">false</span>;
00030     }
00031 
<a name="l00032"></a><a class="code" href="classaudiere_1_1MyLoader.html#a1">00032</a>     <span class="keywordtype">bool</span> <a class="code" href="classaudiere_1_1MyLoader.html#a1">open</a>(<span class="keywordtype">char</span>* <span class="comment">/*filename*/</span>) {
00033       <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">// already open!</span>
00034     }
00035 
<a name="l00036"></a><a class="code" href="classaudiere_1_1MyLoader.html#a2">00036</a>     <span class="keywordtype">void</span> <a class="code" href="classaudiere_1_1MyLoader.html#a2">close</a>() {
00037       m_file = 0;
00038     }
00039 
<a name="l00040"></a><a class="code" href="classaudiere_1_1MyLoader.html#a3">00040</a>     <span class="keywordtype">int</span> <a class="code" href="classaudiere_1_1MyLoader.html#a3">getbytedirect</a>() {
00041       <a class="code" href="namespaceaudiere.html#a24">u8</a> b;
00042       <span class="keywordflow">if</span> (m_file-&gt;read(&amp;b, 1) == 1) {
00043         <span class="keywordflow">return</span> b;
00044       } <span class="keywordflow">else</span> {
00045         seterrorcode(SOUND_ERROR_FILEREADFAIL);
00046         m_eof = <span class="keyword">true</span>;
00047         <span class="keywordflow">return</span> -1;
00048       }
00049     }
00050 
<a name="l00051"></a><a class="code" href="classaudiere_1_1MyLoader.html#a4">00051</a>     <span class="keywordtype">bool</span> <a class="code" href="classaudiere_1_1MyLoader.html#a4">_readbuffer</a>(<span class="keywordtype">char</span>* buffer, <span class="keywordtype">int</span> size) {
00052       <span class="keywordflow">if</span> (m_file-&gt;read(buffer, size) == size) {
00053         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00054       } <span class="keywordflow">else</span> {
00055         seterrorcode(SOUND_ERROR_FILEREADFAIL);
00056         m_eof = <span class="keyword">true</span>;
00057         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00058       }
00059     }
00060 
<a name="l00061"></a><a class="code" href="classaudiere_1_1MyLoader.html#a5">00061</a>     <span class="keywordtype">bool</span> <a class="code" href="classaudiere_1_1MyLoader.html#a5">eof</a>() {
00062       <span class="keywordflow">return</span> m_eof;
00063     }
00064 
<a name="l00065"></a><a class="code" href="classaudiere_1_1MyLoader.html#a6">00065</a>     <span class="keywordtype">int</span> <a class="code" href="classaudiere_1_1MyLoader.html#a6">getblock</a>(<span class="keywordtype">char</span>* buffer, <span class="keywordtype">int</span> size) {
00066       <span class="keywordtype">int</span> read = m_file-&gt;read(buffer, size);
00067       <span class="keywordflow">if</span> (read != size) {
00068         m_eof = <span class="keyword">true</span>;
00069       }
00070       <span class="keywordflow">return</span> size;
00071     }
00072 
<a name="l00073"></a><a class="code" href="classaudiere_1_1MyLoader.html#a7">00073</a>     <span class="keywordtype">int</span> <a class="code" href="classaudiere_1_1MyLoader.html#a7">getsize</a>() {
00074       <span class="keywordtype">int</span> pos = m_file-&gt;tell();
00075       m_file-&gt;seek(0, File::END);
00076       <span class="keywordtype">int</span> size = m_file-&gt;tell();
00077       m_file-&gt;seek(pos, File::BEGIN);
00078       <span class="keywordflow">return</span> size;
00079     }
00080 
<a name="l00081"></a><a class="code" href="classaudiere_1_1MyLoader.html#a8">00081</a>     <span class="keywordtype">void</span> <a class="code" href="classaudiere_1_1MyLoader.html#a8">setposition</a>(<span class="keywordtype">int</span> pos) {
00082       m_file-&gt;seek(pos, File::BEGIN);
00083       m_eof = <span class="keyword">false</span>;
00084     }
00085 
<a name="l00086"></a><a class="code" href="classaudiere_1_1MyLoader.html#a9">00086</a>     <span class="keywordtype">int</span> <a class="code" href="classaudiere_1_1MyLoader.html#a9">getposition</a>() {
00087       <span class="keywordflow">return</span> m_file-&gt;tell();
00088     }
00089 
00090   <span class="keyword">private</span>:
00091     RefPtr&lt;File&gt; m_file;
00092     <span class="keywordtype">bool</span> m_eof;
00093   };
00094 
00095 
<a name="l00096"></a><a class="code" href="classaudiere_1_1MP3InputStream.html#a0">00096</a>   MP3InputStream::MP3InputStream() {
00097     m_file = 0;
00098 
00099     m_channel_count = 2;
00100     m_sample_rate = 44100;
00101     m_sample_format = <a class="code" href="namespaceaudiere.html#a83a7">SF_S16</a>;
00102 
00103     m_decoder = 0;
00104     m_loader = 0;
00105   }
00106 
00107   
<a name="l00108"></a><a class="code" href="classaudiere_1_1MP3InputStream.html#a1">00108</a>   MP3InputStream::~MP3InputStream() {
00109     <span class="keywordflow">if</span> (m_decoder) {
00110       <span class="keyword">delete</span> m_decoder;
00111     }
00112     <span class="keywordflow">if</span> (m_loader) {
00113       <span class="keyword">delete</span> m_loader;
00114     }
00115   }
00116 
00117 
00118   <span class="keywordtype">bool</span>
<a name="l00119"></a><a class="code" href="classaudiere_1_1MP3InputStream.html#a2">00119</a>   MP3InputStream::initialize(<a class="code" href="classaudiere_1_1File.html">File</a>* file) {
00120     m_file = file;
00121     m_loader = <span class="keyword">new</span> <a class="code" href="classaudiere_1_1MyLoader.html">MyLoader</a>(file);
00122     m_decoder = <span class="keyword">new</span> Mpegtoraw(m_loader, <span class="keyword">this</span>);
00123 
00124     <span class="comment">// empty filename because we don't use it</span>
00125     m_decoder-&gt;initialize(<span class="stringliteral">""</span>);
00126 
00127     <span class="comment">// this should call setsoundtype with the format of the stream</span>
00128     <span class="keywordflow">if</span> (!m_decoder-&gt;run(FRAME_COUNT)) {
00129       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00130     }
00131 
00132     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00133   }
00134 
00135 
00136   <span class="keywordtype">void</span>
<a name="l00137"></a><a class="code" href="classaudiere_1_1MP3InputStream.html#a3">00137</a>   MP3InputStream::getFormat(
00138     <span class="keywordtype">int</span>&amp; channel_count, 
00139     <span class="keywordtype">int</span>&amp; sample_rate, 
00140     <a class="code" href="namespaceaudiere.html#a83">SampleFormat</a>&amp; <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a>) 
00141   {
00142     channel_count = m_channel_count;
00143     sample_rate = m_sample_rate;
00144     <a class="code" href="namespaceaudiere_1_1hidden.html#a6">sample_format</a> = m_sample_format;
00145   }
00146 
00147   
00148   <span class="keywordtype">int</span>
<a name="l00149"></a><a class="code" href="classaudiere_1_1MP3InputStream.html#a4">00149</a>   MP3InputStream::read(<span class="keywordtype">int</span> frame_count, <span class="keywordtype">void</span>* samples) {
00150     <span class="keyword">const</span> <span class="keywordtype">int</span> frame_size = m_channel_count * <a class="code" href="namespaceaudiere.html#a35">GetSampleSize</a>(m_sample_format);
00151 
00152     <span class="keywordtype">int</span> frames_read = 0;
00153     <a class="code" href="namespaceaudiere.html#a24">u8</a>* out = (<a class="code" href="namespaceaudiere.html#a24">u8</a>*)samples;
00154 
00155     <span class="keywordflow">while</span> (frames_read &lt; frame_count) {
00156 
00157       <span class="comment">// no more samples?  ask the MP3 for more</span>
00158       <span class="keywordflow">if</span> (m_buffer.<a class="code" href="classaudiere_1_1QueueBuffer.html#a2">getSize</a>() &lt; frame_size) {
00159         <span class="keywordflow">if</span> (!m_decoder-&gt;run(FRAME_COUNT)) {
00160           <span class="comment">// done decoding?</span>
00161           <span class="keywordflow">return</span> frames_read;
00162         }
00163 
00164         <span class="comment">// if the buffer is still empty, we are done</span>
00165         <span class="keywordflow">if</span> (m_buffer.<a class="code" href="classaudiere_1_1QueueBuffer.html#a2">getSize</a>() &lt; frame_size) {
00166           <span class="keywordflow">return</span> frames_read;
00167         }
00168       }
00169 
00170       <span class="keyword">const</span> <span class="keywordtype">int</span> frames_left = frame_count - frames_read;
00171       <span class="keyword">const</span> <span class="keywordtype">int</span> frames_to_read = std::min(
00172         frames_left,
00173         m_buffer.<a class="code" href="classaudiere_1_1QueueBuffer.html#a2">getSize</a>() / frame_size);
00174 
00175       m_buffer.<a class="code" href="classaudiere_1_1QueueBuffer.html#a4">read</a>(out, frames_to_read * frame_size);
00176       out += frames_to_read * frame_size;
00177       frames_read += frames_to_read;
00178     }
00179 
00180     <span class="keywordflow">return</span> frames_read;
00181   }
00182 
00183 
00184   <span class="keywordtype">void</span>
<a name="l00185"></a><a class="code" href="classaudiere_1_1MP3InputStream.html#a5">00185</a>   MP3InputStream::reset() {
00186     m_file-&gt;seek(0, File::BEGIN);
00187 
00188     <span class="keywordflow">if</span> (m_decoder) {
00189       <span class="keyword">delete</span> m_decoder;
00190     }
00191     <span class="keywordflow">if</span> (m_loader) {
00192       <span class="keyword">delete</span> m_loader;
00193     }
00194 
00195     m_loader = <span class="keyword">new</span> <a class="code" href="classaudiere_1_1MyLoader.html">MyLoader</a>(m_file.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00196     m_decoder = <span class="keyword">new</span> Mpegtoraw(m_loader, <span class="keyword">this</span>);
00197 
00198     <span class="comment">// empty filename because we don't use it</span>
00199     m_decoder-&gt;initialize(<span class="stringliteral">""</span>);
00200 
00201     <span class="comment">// this should call setsoundtype with the format of the stream</span>
00202     <span class="keywordflow">if</span> (!m_decoder-&gt;run(FRAME_COUNT)) {
00203       <span class="keywordflow">return</span>;
00204     }
00205   }
00206 
00207 
00208   <span class="keywordtype">bool</span>
<a name="l00209"></a><a class="code" href="classaudiere_1_1MP3InputStream.html#a6">00209</a>   MP3InputStream::initialize(<span class="keywordtype">char</span>* <span class="comment">/*filename*/</span>) {
00210     <span class="comment">// nothing!</span>
00211     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00212   }
00213 
00214 
00215   <span class="keywordtype">bool</span>
<a name="l00216"></a><a class="code" href="classaudiere_1_1MP3InputStream.html#a7">00216</a>   MP3InputStream::setsoundtype(<span class="keywordtype">int</span> stereo, <span class="keywordtype">int</span> samplesize, <span class="keywordtype">int</span> speed) {
00217     m_channel_count = (stereo ? 2 : 1);
00218     m_sample_rate = speed;
00219 
00220     <span class="keywordflow">if</span> (samplesize == 8) {
00221       m_sample_format = <a class="code" href="namespaceaudiere.html#a83a6">SF_U8</a>;
00222     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (samplesize == 16) {
00223       m_sample_format = <a class="code" href="namespaceaudiere.html#a83a7">SF_S16</a>;
00224     } <span class="keywordflow">else</span> {
00225       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00226     }
00227 
00228     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00229   }
00230 
00231 
00232   <span class="keywordtype">bool</span>
<a name="l00233"></a><a class="code" href="classaudiere_1_1MP3InputStream.html#a8">00233</a>   MP3InputStream::putblock(<span class="keywordtype">void</span>* buffer, <span class="keywordtype">int</span> size) {
00234     m_buffer.<a class="code" href="classaudiere_1_1QueueBuffer.html#a3">write</a>(buffer, size);
00235     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00236   }
00237 
00238 }
</pre></div><hr><address style="align: right;"><small>Generated on Sat Oct 12 01:43:03 2002 for audiere by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.17 </small></address>
</body>
</html>
