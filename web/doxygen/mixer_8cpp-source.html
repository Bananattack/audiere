<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>mixer.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.8.1 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>mixer.cpp</h1><a href="mixer_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="preprocessor">#include &lt;algorithm&gt;</font>
00002 <font class="preprocessor">#include "<a class="code" href="audiere_8h.html">audiere.h</a>"</font>
00003 <font class="preprocessor">#include "<a class="code" href="mixer_8hpp.html">mixer.hpp</a>"</font>
00004 <font class="preprocessor">#include "<a class="code" href="output_8hpp.html">output.hpp</a>"</font>
00005 <font class="preprocessor">#include "<a class="code" href="resampler_8hpp.html">resampler.hpp</a>"</font>
00006 
00007 
00009 
<a name="l00010"></a><a class="code" href="classMixer.html#a0">00010</a> <a class="code" href="classMixer.html#a0">Mixer::Mixer</a>()<font class="keyword"></font>
00011 <font class="keyword"></font>{
00012 }
00013 
00015 
<a name="l00016"></a><a class="code" href="classMixer.html#a1">00016</a> <a class="code" href="classMixer.html#a1">Mixer::~Mixer</a>()<font class="keyword"></font>
00017 <font class="keyword"></font>{
00018   <font class="comment">// assume all streams have been removed</font>
00019 }
00020 
00022 
00023 <font class="keywordtype">void</font>
<a name="l00024"></a><a class="code" href="classMixer.html#a2">00024</a> <a class="code" href="classMixer.html#a2">Mixer::GetFormat</a>(<font class="keywordtype">int</font>&amp; channel_count, <font class="keywordtype">int</font>&amp; sample_rate, <font class="keywordtype">int</font>&amp; bits_per_sample)<font class="keyword"></font>
00025 <font class="keyword"></font>{
00026   channel_count = 2;
00027   sample_rate = 44100;
00028   bits_per_sample = 16;
00029 }
00030 
00032 
00033 <font class="keywordtype">int</font>
<a name="l00034"></a><a class="code" href="classMixer.html#a3">00034</a> <a class="code" href="classMixer.html#a3">Mixer::Read</a>(<font class="keyword">const</font> <font class="keywordtype">int</font> sample_count, <font class="keywordtype">void</font>* samples)<font class="keyword"></font>
00035 <font class="keyword"></font>{
00036   <font class="comment">// are any sources playing?</font>
00037   <font class="keywordtype">bool</font> any_playing = <font class="keyword">false</font>;
00038   SourceMap::iterator i = m_sources.begin();
00039   <font class="keywordflow">while</font> (i != m_sources.end()) {
00040     any_playing |= i-&gt;second.is_playing;
00041     ++i;
00042   }
00043   
00044   <font class="comment">// if not, return zeroed samples</font>
00045   <font class="keywordflow">if</font> (!any_playing) {
00046     memset(samples, 0, 4 * sample_count);
00047     <font class="keywordflow">return</font> sample_count;
00048   }
00049 
00050   <font class="keyword">static</font> <font class="keyword">const</font> <font class="keywordtype">int</font> BUFFER_SIZE = 4096;
00051 
00052   <font class="comment">// create buffers in which to mix</font>
00053   adr_s32 mix_buffer[BUFFER_SIZE];
00054   adr_s16 stream_buffer[BUFFER_SIZE * 2];
00055   std::fill(mix_buffer, mix_buffer + BUFFER_SIZE, 0);
00056 
00057   adr_s16* out = (adr_s16*)samples;
00058   <font class="keywordtype">int</font> left = sample_count;
00059   <font class="keywordflow">while</font> (left &gt; 0) {
00060     <font class="keywordtype">int</font> playing = 0;
00061     <font class="keywordtype">int</font> to_mix = std::min(BUFFER_SIZE, left);
00062 
00063     SourceMap::iterator s = m_sources.begin();
00064     <font class="keywordflow">for</font> (; s != m_sources.end(); ++s) {
00065       <font class="keywordflow">if</font> (s-&gt;second.is_playing) {
00066         <a class="code" href="classMixer.html#a3">Read</a>(s-&gt;first, s-&gt;second, to_mix, stream_buffer);
00067         <font class="keywordflow">for</font> (<font class="keywordtype">int</font> i = 0; i &lt; to_mix * 2; ++i) {
00068           mix_buffer[i] += stream_buffer[i];
00069         }
00070         ++playing;
00071       }
00072     }
00073 
00074     <font class="comment">// do the division</font>
00075     <font class="keywordflow">if</font> (playing != 0) {
00076       <font class="keywordflow">for</font> (<font class="keywordtype">int</font> i = 0; i &lt; to_mix * 2; ++i) {
00077         *out++ = mix_buffer[i] / playing;
00078       }
00079     }
00080 
00081     left -= to_mix;
00082   }
00083 
00084   <font class="keywordflow">return</font> sample_count;
00085 }
00086 
00088 
00089 <font class="keywordtype">bool</font>
<a name="l00090"></a><a class="code" href="classMixer.html#a4">00090</a> <a class="code" href="classMixer.html#a4">Mixer::Reset</a>()<font class="keyword"></font>
00091 <font class="keyword"></font>{
00092   <font class="keywordflow">return</font> <font class="keyword">true</font>;
00093 }
00094 
00096 
00097 <font class="keywordtype">void</font>
<a name="l00098"></a><a class="code" href="classMixer.html#a5">00098</a> <a class="code" href="classMixer.html#a5">Mixer::AddSource</a>(<a class="code" href="classISampleSource.html">ISampleSource</a>* source)<font class="keyword"></font>
00099 <font class="keyword"></font>{
00100   <font class="comment">// initial source attributes</font>
00101   SourceAttributes sa;
00102   sa.resampler = <font class="keyword">new</font> Resampler(source);
00103   sa.last_l = 0;
00104   sa.last_r = 0;
00105   sa.is_playing = <font class="keyword">true</font>;
00106   sa.volume = ADR_VOLUME_MAX;
00107 
00108   m_sources[source] = sa;
00109 }
00110 
00112 
00113 <font class="keywordtype">void</font>
<a name="l00114"></a><a class="code" href="classMixer.html#a6">00114</a> <a class="code" href="classMixer.html#a6">Mixer::RemoveSource</a>(<a class="code" href="classISampleSource.html">ISampleSource</a>* source)<font class="keyword"></font>
00115 <font class="keyword"></font>{
00116   <font class="keyword">delete</font> m_sources[source].resampler;
00117   m_sources.erase(source);
00118 }
00119 
00121 
00122 <font class="keywordtype">bool</font>
<a name="l00123"></a><a class="code" href="classMixer.html#a7">00123</a> <a class="code" href="classMixer.html#a7">Mixer::IsPlaying</a>(<a class="code" href="classISampleSource.html">ISampleSource</a>* source)<font class="keyword"></font>
00124 <font class="keyword"></font>{
00125   <font class="keywordflow">return</font> m_sources[source].is_playing;
00126 }
00127 
00129 
00130 <font class="keywordtype">void</font>
<a name="l00131"></a><a class="code" href="classMixer.html#a8">00131</a> <a class="code" href="classMixer.html#a8">Mixer::SetPlaying</a>(<a class="code" href="classISampleSource.html">ISampleSource</a>* source, <font class="keywordtype">bool</font> is_playing)<font class="keyword"></font>
00132 <font class="keyword"></font>{
00133   m_sources[source].is_playing = is_playing;
00134 }
00135 
00137 
00138 <font class="keywordtype">int</font>
<a name="l00139"></a><a class="code" href="classMixer.html#a9">00139</a> <a class="code" href="classMixer.html#a9">Mixer::GetVolume</a>(<a class="code" href="classISampleSource.html">ISampleSource</a>* source)<font class="keyword"></font>
00140 <font class="keyword"></font>{
00141   <font class="keywordflow">return</font> m_sources[source].volume;
00142 }
00143 
00145 
00146 <font class="keywordtype">void</font>
<a name="l00147"></a><a class="code" href="classMixer.html#a10">00147</a> <a class="code" href="classMixer.html#a10">Mixer::SetVolume</a>(<a class="code" href="classISampleSource.html">ISampleSource</a>* source, <font class="keywordtype">int</font> volume)<font class="keyword"></font>
00148 <font class="keyword"></font>{
00149   m_sources[source].volume = volume;
00150 }
00151 
00153 
00154 <font class="keywordtype">void</font>
00155 <a class="code" href="classMixer.html#a3">Mixer::Read</a>(<a class="code" href="classISampleSource.html">ISampleSource</a>* source,
00156             SourceAttributes&amp; attr,
00157             <font class="keywordtype">int</font> to_mix,
00158             adr_s16* buffer)  <font class="comment">// size = to_mix * 4</font>
00159 {
00160   <font class="keywordtype">unsigned</font> read = attr.resampler-&gt;Read(to_mix, buffer);
00161 
00162   <font class="keywordflow">if</font> (read == 0) {
00163     attr.is_playing = <font class="keyword">false</font>;
00164   }
00165 
00166   <font class="comment">// grab them early so we don't lose optimizations due to aliasing</font>
00167   adr_s16 l = attr.last_l;
00168   adr_s16 r = attr.last_r;
00169 
00170   adr_s16* out = buffer;
00171   <font class="keywordflow">for</font> (<font class="keywordtype">int</font> i = 0; i &lt; read; ++i) {
00172     *out = *out * attr.volume / 255;
00173     ++out;
00174     *out = *out * attr.volume / 255;
00175     ++out;
00176   }
00177 
00178   <font class="keywordflow">if</font> (read &gt;= 0) {
00179     l = out[-2];
00180     r = out[-1];
00181   }
00182 
00183   <font class="keywordflow">for</font> (<font class="keywordtype">int</font> i = read; i &lt; to_mix; ++i) {
00184     *out++ = l;
00185     *out++ = r;
00186   }
00187 
00188   attr.last_l = l;
00189   attr.last_r = r;
00190 }
00191 
</pre></div><hr><address><small>Generated at Mon Jun 10 02:55:12 2002 for audiere by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.8.1 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2001</small></address>
</body>
</html>
