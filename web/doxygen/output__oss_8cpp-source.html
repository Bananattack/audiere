<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>output_oss.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.8.1 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>output_oss.cpp</h1><a href="output__oss_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="preprocessor">#ifdef WITH_OSS</font>
00002 <font class="preprocessor"></font>
00003 <font class="preprocessor">#include &lt;algorithm&gt;</font>
00004 <font class="preprocessor">#include &lt;string&gt;</font>
00005 <font class="preprocessor">#include &lt;stdio.h&gt;</font>
00006 <font class="preprocessor">#include &lt;unistd.h&gt;</font>
00007 <font class="preprocessor">#include &lt;fcntl.h&gt;</font>
00008 <font class="preprocessor">#include &lt;sys/ioctl.h&gt;</font>
00009 <font class="preprocessor">#include &lt;sys/soundcard.h&gt;</font>
00010 <font class="preprocessor">#include "<a class="code" href="output__oss_8hpp.html">output_oss.hpp</a>"</font>
00011 <font class="preprocessor">#include "<a class="code" href="debug_8hpp.html">debug.hpp</a>"</font>
00012 
00013 
00015 
00016 <a class="code" href="classOSSOutputContext.html#a0">OSSOutputContext::OSSOutputContext</a>()<font class="keyword"></font>
00017 <font class="keyword"></font>{
00018   m_output_device = -1;
00019 }
00020 
00022 
00023 <a class="code" href="classOSSOutputContext.html#a1">OSSOutputContext::~OSSOutputContext</a>()<font class="keyword"></font>
00024 <font class="keyword"></font>{
00025   <a class="code" href="debug_8hpp.html#a1">ADR_GUARD</a>(<font class="stringliteral">"OSSOutputContext::~OSSOutputContext"</font>);
00026 
00027   <font class="keywordflow">if</font> (m_output_device != -1) {
00028     close(m_output_device);
00029   }
00030 }
00031 
00033 
00034 <font class="keywordtype">bool</font>
00035 <a class="code" href="classOSSOutputContext.html#a2">OSSOutputContext::Initialize</a>(<font class="keyword">const</font> <font class="keywordtype">char</font>* parameters)<font class="keyword"></font>
00036 <font class="keyword"></font>{
00037   ParameterList pl;
00038   <a class="code" href="output_8hpp.html#a4">ParseParameters</a>(parameters, pl);
00039 
00040   std::string device = <font class="stringliteral">"/dev/dsp"</font>;  <font class="comment">// default device</font>
00041 
00042   ParameterList::iterator i;
00043   <font class="keywordflow">for</font> (i = pl.begin(); i != pl.end(); ++i) {
00044     <font class="keywordflow">if</font> (i-&gt;first == <font class="stringliteral">"device"</font>) {
00045       device = i-&gt;second;
00046     }
00047   }
00048 
00049   <font class="comment">// attempt to open output device</font>
00050   m_output_device = open(device.c_str(), O_WRONLY);
00051   <font class="keywordflow">if</font> (m_output_device == -1) {
00052     perror(device.c_str());
00053     <font class="keywordflow">return</font> <font class="keyword">false</font>;
00054   }
00055 
00056   <font class="keywordtype">int</font> format = AFMT_S16_LE;
00057   <font class="keywordflow">if</font> (ioctl(m_output_device, SNDCTL_DSP_SETFMT, &amp;format) == -1) {
00058     perror(<font class="stringliteral">"SNDCTL_DSP_SETFMT"</font>);
00059     <font class="keywordflow">return</font> <font class="keyword">false</font>;
00060   }
00061   <font class="keywordflow">if</font> (format != AFMT_S16_LE) {
00062     <font class="comment">// unsupported format</font>
00063     <font class="keywordflow">return</font> <font class="keyword">false</font>;
00064   }
00065 
00066   <font class="keywordtype">int</font> stereo = 1;
00067   <font class="keywordflow">if</font> (ioctl(m_output_device, SNDCTL_DSP_STEREO, &amp;stereo) == -1) {
00068     perror(<font class="stringliteral">"SNDCTL_DSP_STEREO"</font>);
00069     <font class="keywordflow">return</font> <font class="keyword">false</font>;
00070   }
00071   <font class="keywordflow">if</font> (stereo != 1) {
00072     <font class="comment">// unsupported channel number</font>
00073     <font class="keywordflow">return</font> <font class="keyword">false</font>;
00074   }
00075 
00076   <font class="keywordtype">int</font> speed = 44100;
00077   <font class="keywordflow">if</font> (ioctl(m_output_device, SNDCTL_DSP_SPEED, &amp;speed) == -1) {
00078     perror(<font class="stringliteral">"SNDCTL_DSP_SPEED"</font>);
00079     <font class="keywordflow">return</font> <font class="keyword">false</font>;
00080   }
00081   <font class="keywordflow">if</font> (abs(44100 - speed) &gt; 2205) {
00082     <font class="comment">// unsupported sampling rate</font>
00083     <font class="keywordflow">return</font> <font class="keyword">false</font>;
00084   }
00085 
00086   <font class="keywordflow">return</font> <font class="keyword">true</font>;
00087 }
00088 
00090 
00091 <font class="keywordtype">void</font>
00092 <a class="code" href="classOSSOutputContext.html#a3">OSSOutputContext::Update</a>()<font class="keyword"></font>
00093 <font class="keyword"></font>{
00094   <font class="comment">// find out how much data we can write to the device before it blocks</font>
00095   audio_buf_info info;
00096   <font class="keywordflow">if</font> (ioctl(m_output_device, SNDCTL_DSP_GETOSPACE, &amp;info) == -1) {
00097     <font class="keywordflow">return</font>;
00098   }
00099 
00100   <font class="comment">// how many samples is that?</font>
00101   <font class="keywordtype">int</font> sample_count = info.bytes / 4;
00102 
00103   <font class="comment">// write to the OSS device, 1024 samples at a time</font>
00104   <font class="keyword">static</font> <font class="keyword">const</font> <font class="keywordtype">int</font> BUFFER_SIZE = 1024;
00105   <font class="keywordtype">char</font> buffer[BUFFER_SIZE * 4];
00106   <font class="keywordflow">while</font> (sample_count &gt; 0) {
00107     <font class="keywordtype">int</font> transfer_count = std::min(sample_count, BUFFER_SIZE);
00108 
00109     m_mixer.Read(transfer_count, buffer);
00110     write(m_output_device, buffer, transfer_count * 4);
00111 
00112     sample_count -= transfer_count;
00113   }
00114 
00115   usleep(50000);  <font class="comment">// 5 milliseconds</font>
00116 }
00117 
00119 
00120 <a class="code" href="classIOutputStream.html">IOutputStream</a>*
00121 <a class="code" href="classOSSOutputContext.html#a4">OSSOutputContext::OpenStream</a>(<a class="code" href="classISampleSource.html">ISampleSource</a>* source)<font class="keyword"></font>
00122 <font class="keyword"></font>{
00123   <font class="keywordflow">return</font> <font class="keyword">new</font> OSSOutputStream(&amp;m_mixer, source);
00124 }
00125 
00127 
00128 OSSOutputStream::OSSOutputStream(<a class="code" href="classMixer.html">Mixer</a>* mixer, <a class="code" href="classISampleSource.html">ISampleSource</a>* source)<font class="keyword"></font>
00129 <font class="keyword"></font>{
00130   m_mixer      = mixer;
00131   m_source     = source;
00132 
00133   m_mixer-&gt;AddSource(source);
00134 }
00135 
00137 
00138 OSSOutputStream::~OSSOutputStream()<font class="keyword"></font>
00139 <font class="keyword"></font>{
00140   m_mixer-&gt;RemoveSource(m_source);
00141 }
00142 
00144 
00145 <font class="keywordtype">void</font>
00146 <a class="code" href="classOSSOutputStream.html#a0">OSSOutputStream::Play</a>()<font class="keyword"></font>
00147 <font class="keyword"></font>{
00148   m_mixer-&gt;SetPlaying(m_source, <font class="keyword">true</font>);
00149 }
00150 
00152 
00153 <font class="keywordtype">void</font>
00154 <a class="code" href="classOSSOutputStream.html#a1">OSSOutputStream::Stop</a>()<font class="keyword"></font>
00155 <font class="keyword"></font>{
00156   m_mixer-&gt;SetPlaying(m_source, <font class="keyword">false</font>);
00157 }
00158 
00160 
00161 <font class="keywordtype">void</font>
00162 <a class="code" href="classOSSOutputStream.html#a2">OSSOutputStream::Reset</a>()<font class="keyword"></font>
00163 <font class="keyword"></font>{
00164   m_source-&gt;<a class="code" href="classISampleSource.html#a3">Reset</a>();
00165 }
00166 
00168 
00169 <font class="keywordtype">bool</font>
00170 <a class="code" href="classOSSOutputStream.html#a3">OSSOutputStream::IsPlaying</a>()<font class="keyword"></font>
00171 <font class="keyword"></font>{
00172   <font class="keywordflow">return</font> m_mixer-&gt;IsPlaying(m_source);
00173 }
00174 
00176 
00177 <font class="keywordtype">void</font>
00178 <a class="code" href="classOSSOutputStream.html#a4">OSSOutputStream::SetVolume</a>(<font class="keywordtype">int</font> volume)<font class="keyword"></font>
00179 <font class="keyword"></font>{
00180   m_volume = volume;
00181   m_mixer-&gt;SetVolume(m_source, m_volume);
00182 }
00183 
00185 
00186 <font class="keywordtype">int</font>
00187 <a class="code" href="classOSSOutputStream.html#a5">OSSOutputStream::GetVolume</a>()<font class="keyword"></font>
00188 <font class="keyword"></font>{
00189   <font class="keywordflow">return</font> m_volume;
00190 }
00191 
00193 
00194 <font class="preprocessor">#endif</font>
</font></pre></div><hr><address><small>Generated at Mon Jun 10 02:55:12 2002 for audiere by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.8.1 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2001</small></address>
</body>
</html>
