<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>output_ds.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.8.1 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>output_ds.cpp</h1><a href="output__ds_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">/*</font>
00002 <font class="comment">  Audiere DirectSound driver</font>
00003 <font class="comment"></font>
00004 <font class="comment">  Terminology</font>
00005 <font class="comment"></font>
00006 <font class="comment">  block </font>
00007 <font class="comment">  - set of bytes for the smallest block of audio in a stream</font>
00008 <font class="comment">    (including all of the channels)</font>
00009 <font class="comment"></font>
00010 <font class="comment">  buffer</font>
00011 <font class="comment">  - a circular audio buffer which is constantly refilled with</font>
00012 <font class="comment">    new data from the stream source</font>
00013 <font class="comment"></font>
00014 <font class="comment">  segment</font>
00015 <font class="comment">  - buffers are split into a set of segments data flows from</font>
00016 <font class="comment">    the stream source into the buffer a segment at a time</font>
00017 <font class="comment"></font>
00018 <font class="comment">*/</font>
00019 
00020 
00021 <font class="preprocessor">#include &lt;math.h&gt;</font>
00022 <font class="preprocessor">#include "<a class="code" href="output__ds_8hpp.html">output_ds.hpp</a>"</font>
00023 <font class="preprocessor">#include "<a class="code" href="debug_8hpp.html">debug.hpp</a>"</font>
00024 <font class="preprocessor">#include "<a class="code" href="input_8hpp.html">input.hpp</a>"</font>
00025 
00026 
00027 <font class="keyword">static</font> <font class="keyword">const</font> <font class="keywordtype">int</font> DS_DefaultBufferLength = 1000;  <font class="comment">// one second</font>
00028 
00029 
00030 <font class="comment">// DirectSound treats volumes as decibels (exponential growth like the Richter</font>
00031 <font class="comment">// scale).  We want a linear ramp.  Do the conversion!</font>
<a name="l00032"></a><a class="code" href="output__ds_8cpp.html#a1">00032</a> <font class="keyword">inline</font> <font class="keywordtype">int</font> <a class="code" href="output__ds_8cpp.html#a1">Volume_AudiereToDirectSound</a>(<font class="keywordtype">int</font> volume)<font class="keyword"> </font>{
00033   <font class="comment">// I can't figure out the proper math, and this comes close enough...</font>
00034   <font class="keywordtype">double</font> fv = volume / 255.0;  <font class="comment">// range: 0-1</font>
00035   <font class="keywordtype">double</font> attenuate = pow(1 - fv, 3);
00036   <font class="keywordflow">return</font> <a class="code" href="audiere_8h.html#a16">int</a>(-10000 * attenuate);
00037 }
00038 
00039 
00041 
<a name="l00042"></a><a class="code" href="classDSOutputContext.html#a0">00042</a> <a class="code" href="classDSOutputContext.html#a0">DSOutputContext::DSOutputContext</a>()<font class="keyword"></font>
00043 <font class="keyword"></font>{
00044   m_DirectSound     = NULL;
00045   m_BufferLength    = DS_DefaultBufferLength;
00046   m_AnonymousWindow = NULL;
00047 }
00048 
00050 
<a name="l00051"></a><a class="code" href="classDSOutputContext.html#a1">00051</a> <a class="code" href="classDSOutputContext.html#a1">DSOutputContext::~DSOutputContext</a>()<font class="keyword"></font>
00052 <font class="keyword"></font>{
00053   <a class="code" href="debug_8hpp.html#a4">ADR_ASSERT</a>(m_OpenStreams.size() == 0,
00054     <font class="stringliteral">"DirectSound output context should not die with open streams"</font>);
00055 
00056   <font class="comment">// if the anonymous window is open, close it</font>
00057   <font class="keywordflow">if</font> (m_AnonymousWindow) {
00058     DestroyWindow(m_AnonymousWindow);
00059     m_AnonymousWindow = NULL;
00060   }
00061 
00062   <font class="comment">// shut down DirectSound</font>
00063   <font class="keywordflow">if</font> (m_DirectSound) {
00064     m_DirectSound-&gt;Release();
00065     m_DirectSound = NULL;
00066   }
00067 }
00068 
00070 
00071 <font class="keywordtype">bool</font>
<a name="l00072"></a><a class="code" href="classDSOutputContext.html#a2">00072</a> <a class="code" href="classDSOutputContext.html#a2">DSOutputContext::Initialize</a>(<font class="keyword">const</font> <font class="keywordtype">char</font>* parameters)<font class="keyword"></font>
00073 <font class="keyword"></font>{
00074   <a class="code" href="debug_8hpp.html#a1">ADR_GUARD</a>(<font class="stringliteral">"DSOutputContext::Initialize"</font>);
00075 
00076   <font class="comment">// parse the parameter list</font>
00077   ParameterList pl;
00078   <a class="code" href="output_8hpp.html#a4">ParseParameters</a>(parameters, pl);
00079 
00080   ParameterList::iterator i = pl.begin();
00081   <font class="keywordflow">while</font> (i != pl.end()) {
00082     
00083     <font class="keywordflow">if</font> (i-&gt;first.c_str() == <font class="stringliteral">"buffer"</font>) {
00084       m_BufferLength = atoi(i-&gt;second.c_str());
00085       <font class="keywordflow">if</font> (m_BufferLength == 0) {
00086         m_BufferLength = DS_DefaultBufferLength;
00087       }
00088     }
00089 
00090     ++i;
00091   }
00092 
00093   <font class="comment">// initialize COM</font>
00094   HRESULT rv = CoInitialize(NULL);
00095   <font class="keywordflow">if</font> (FAILED(rv)) {
00096     <font class="keywordflow">return</font> <font class="keyword">false</font>;
00097   }
00098 
00099   <a class="code" href="debug_8hpp.html#a2">ADR_LOG</a>(<font class="stringliteral">"COM initialized properly"</font>);
00100 
00101   <font class="comment">// register anonymous window class</font>
00102   <font class="comment">// don't worry about failure, if it fails, the window creation will fail</font>
00103   WNDCLASS wc;
00104   wc.style          = 0;
00105   wc.lpfnWndProc    = DefWindowProc;
00106   wc.cbClsExtra     = 0;
00107   wc.cbWndExtra     = 0;
00108   wc.hInstance      = GetModuleHandle(NULL);
00109   wc.hIcon          = NULL;
00110   wc.hCursor        = NULL;
00111   wc.hbrBackground  = NULL;
00112   wc.lpszMenuName   = NULL;
00113   wc.lpszClassName  = <font class="stringliteral">"AudiereHiddenWindow"</font>;
00114   RegisterClass(&amp;wc);
00115 
00116   <font class="comment">// create anonymous window</font>
00117   m_AnonymousWindow = CreateWindow(
00118     <font class="stringliteral">"AudiereHiddenWindow"</font>, <font class="stringliteral">""</font>, WS_POPUP,
00119     0, 0, 0, 0,
00120     NULL, NULL, GetModuleHandle(NULL), NULL);
00121   <font class="keywordflow">if</font> (!m_AnonymousWindow) {
00122     <font class="keywordflow">return</font> <font class="keyword">false</font>;
00123   }
00124 
00125   <a class="code" href="debug_8hpp.html#a2">ADR_LOG</a>(<font class="stringliteral">"Anonymous window created successfully"</font>);
00126 
00127   <font class="comment">// create the DirectSound object</font>
00128   rv = CoCreateInstance(
00129     GetCLSID(),
00130     NULL,
00131     CLSCTX_INPROC_SERVER,
00132     IID_IDirectSound,
00133     (<font class="keywordtype">void</font>**)&amp;m_DirectSound);
00134   <font class="keywordflow">if</font> (FAILED(rv) || !m_DirectSound) {
00135     DestroyWindow(m_AnonymousWindow);
00136     m_AnonymousWindow = NULL;
00137     <font class="keywordflow">return</font> <font class="keyword">false</font>;
00138   }
00139 
00140   <a class="code" href="debug_8hpp.html#a2">ADR_LOG</a>(<font class="stringliteral">"Created DS object"</font>);
00141 
00142   <font class="comment">// initialize the DirectSound device</font>
00143   rv = m_DirectSound-&gt;Initialize(NULL);
00144   <font class="keywordflow">if</font> (FAILED(rv)) {
00145     DestroyWindow(m_AnonymousWindow);
00146     m_AnonymousWindow = NULL;
00147     m_DirectSound-&gt;Release();
00148     m_DirectSound = NULL;
00149     <font class="keywordflow">return</font> <font class="keyword">false</font>;
00150   }
00151 
00152   <a class="code" href="debug_8hpp.html#a2">ADR_LOG</a>(<font class="stringliteral">"Initialized DS object"</font>);
00153 
00154   <font class="comment">// set the cooperative level</font>
00155   rv = m_DirectSound-&gt;SetCooperativeLevel(
00156     m_AnonymousWindow,
00157     GetCooperativeLevel());
00158   <font class="keywordflow">if</font> (FAILED(rv)) {
00159     DestroyWindow(m_AnonymousWindow);
00160     m_AnonymousWindow = NULL;
00161     m_DirectSound-&gt;Release();
00162     m_DirectSound = NULL;
00163     <font class="keywordflow">return</font> <font class="keyword">false</font>;
00164   }
00165 
00166   <a class="code" href="debug_8hpp.html#a2">ADR_LOG</a>(<font class="stringliteral">"Set cooperative level"</font>);
00167 
00168   <font class="keywordflow">if</font> (!CreatePrimarySoundBuffer(m_DirectSound)) {
00169 
00170     <a class="code" href="debug_8hpp.html#a2">ADR_LOG</a>(<font class="stringliteral">"CreatePrimarySoundBuffer failed"</font>);
00171 
00172     DestroyWindow(m_AnonymousWindow);
00173     m_AnonymousWindow = NULL;
00174     m_DirectSound-&gt;Release();
00175     m_DirectSound = NULL;
00176     <font class="keywordflow">return</font> <font class="keyword">false</font>;
00177   }
00178 
00179   <a class="code" href="debug_8hpp.html#a2">ADR_LOG</a>(<font class="stringliteral">"Primary sound buffer created"</font>);
00180 
00181   <font class="keywordflow">return</font> <font class="keyword">true</font>;
00182 }
00183 
00185 
00186 <font class="keywordtype">void</font>
<a name="l00187"></a><a class="code" href="classDSOutputContext.html#a3">00187</a> <a class="code" href="classDSOutputContext.html#a3">DSOutputContext::Update</a>()<font class="keyword"></font>
00188 <font class="keyword"></font>{
00189   <a class="code" href="debug_8hpp.html#a1">ADR_GUARD</a>(<font class="stringliteral">"DSOutputContext::Update"</font>);
00190 
00191   <font class="comment">// enumerate all open streams</font>
00192   StreamList::iterator i = m_OpenStreams.begin();
00193   <font class="keywordflow">while</font> (i != m_OpenStreams.end()) {
00194     <a class="code" href="classDSOutputStream.html">DSOutputStream</a>* s = *i++;
00195     s-&gt;<a class="code" href="classDSOutputStream.html#a7">Update</a>();
00196   }
00197 
00198   Sleep(50);
00199 }
00200 
00202 
00203 <a class="code" href="classIOutputStream.html">IOutputStream</a>*
<a name="l00204"></a><a class="code" href="classDSOutputContext.html#a4">00204</a> <a class="code" href="classDSOutputContext.html#a4">DSOutputContext::OpenStream</a>(<a class="code" href="classISampleSource.html">ISampleSource</a>* source)<font class="keyword"></font>
00205 <font class="keyword"></font>{
00206   <a class="code" href="debug_8hpp.html#a1">ADR_GUARD</a>(<font class="stringliteral">"DSOutputContext::OpenStream"</font>);
00207 
00208   <font class="keywordtype">int</font> channel_count, sample_rate, bits_per_sample;
00209   source-&gt;<a class="code" href="classISampleSource.html#a1">GetFormat</a>(channel_count, sample_rate, bits_per_sample);
00210 
00211   <font class="keywordtype">int</font> sample_size = channel_count * bits_per_sample / 8;
00212 
00213   <font class="comment">// calculate an ideal buffer size</font>
00214   <font class="keywordtype">int</font> buffer_length = sample_rate * m_BufferLength / 1000;
00215 
00216   <font class="comment">// define the wave format</font>
00217   WAVEFORMATEX wfx;
00218   memset(&amp;wfx, 0, <font class="keyword">sizeof</font>(wfx));
00219   wfx.wFormatTag      = WAVE_FORMAT_PCM;
00220   wfx.nChannels       = channel_count;
00221   wfx.nSamplesPerSec  = sample_rate;
00222   wfx.nAvgBytesPerSec = sample_rate * sample_size;
00223   wfx.nBlockAlign     = sample_size;
00224   wfx.wBitsPerSample  = bits_per_sample;
00225   wfx.cbSize          = <font class="keyword">sizeof</font>(wfx);
00226 
00227   <font class="comment">// define the DirectSound buffer type</font>
00228 <font class="preprocessor">  #if DIRECTSOUND_VERSION &gt;= 0x0700</font>
00229 <font class="preprocessor"></font>    DSBUFFERDESC1 dsbd;
00230 <font class="preprocessor">  #else</font>
00231 <font class="preprocessor"></font>    DSBUFFERDESC dsbd;
00232 <font class="preprocessor">  #endif</font>
00233 <font class="preprocessor"></font>  memset(&amp;dsbd, 0, <font class="keyword">sizeof</font>(dsbd));
00234   dsbd.dwSize          = <font class="keyword">sizeof</font>(dsbd);
00235   dsbd.dwFlags         = DSBCAPS_GETCURRENTPOSITION2 | DSBCAPS_CTRLPAN |
00236                          DSBCAPS_CTRLVOLUME | DSBCAPS_GLOBALFOCUS;
00237   dsbd.dwBufferBytes   = sample_size * buffer_length;
00238   dsbd.lpwfxFormat     = &amp;wfx;
00239 
00240   <font class="comment">// create the DirectSound buffer</font>
00241   IDirectSoundBuffer* buffer;
00242   HRESULT result = m_DirectSound-&gt;CreateSoundBuffer(
00243     (DSBUFFERDESC*)&amp;dsbd,
00244     &amp;buffer,
00245     NULL);
00246   <font class="keywordflow">if</font> (FAILED(result) || !buffer) {
00247     <font class="keywordflow">return</font> 0;
00248   }
00249 
00250   <a class="code" href="debug_8hpp.html#a2">ADR_LOG</a>(<font class="stringliteral">"CreateSoundBuffer succeeded"</font>);
00251 
00252   <a class="code" href="classDSOutputStream.html">DSOutputStream</a>* stream = <font class="keyword">new</font> <a class="code" href="classDSOutputContext.html#l0">DSOutputStream</a>(
00253     <font class="keyword">this</font>, buffer, sample_size, buffer_length, source);
00254 
00255   <font class="comment">// add ourselves to the list of streams and return</font>
00256   m_OpenStreams.push_back(stream);
00257   <font class="keywordflow">return</font> stream;
00258 }
00259 
00261 
00262 <font class="keywordtype">void</font>
00263 DSOutputContext::RemoveStream(<a class="code" href="classDSOutputStream.html">DSOutputStream</a>* stream)<font class="keyword"></font>
00264 <font class="keyword"></font>{
00265   m_OpenStreams.remove(stream);
00266 }
00267 
00269 
00270 DSOutputStream::DSOutputStream(
00271   <a class="code" href="classDSOutputContext.html">DSOutputContext</a>* context,
00272   IDirectSoundBuffer* buffer,
00273   <font class="keywordtype">int</font> sample_size,
00274   <font class="keywordtype">int</font> buffer_length,
00275   <a class="code" href="classISampleSource.html">ISampleSource</a>* source)<font class="keyword"></font>
00276 <font class="keyword"></font>{
00277   <a class="code" href="debug_8hpp.html#a1">ADR_GUARD</a>(<font class="stringliteral">"DSOutputStream::DSOutputStream"</font>);
00278 
00279   m_Context = context;
00280   m_Buffer = buffer;
00281   m_NextRead = 0;
00282   m_BufferLength = buffer_length;
00283 
00284   m_Source = source;
00285 
00286   m_SampleSize = sample_size;
00287   m_LastSample = <font class="keyword">new</font> BYTE[sample_size];
00288 
00289   SetVolume(ADR_VOLUME_MAX);
00290 
00291   <font class="comment">// fill the buffer with data</font>
00292   FillStream();
00293 }
00294 
00296 
00297 DSOutputStream::~DSOutputStream()<font class="keyword"></font>
00298 <font class="keyword"></font>{
00299   <a class="code" href="debug_8hpp.html#a1">ADR_GUARD</a>(<font class="stringliteral">"DSOutputStream::~DSOutputStream"</font>);
00300 
00301   m_Context-&gt;RemoveStream(<font class="keyword">this</font>);
00302 
00303   <font class="comment">// destroy the sound buffer interface</font>
00304   m_Buffer-&gt;Release();
00305   <font class="keyword">delete</font>[] m_LastSample;
00306 }
00307 
00309 
00310 <font class="keywordtype">void</font>
<a name="l00311"></a><a class="code" href="classDSOutputStream.html#a6">00311</a> <a class="code" href="classDSOutputStream.html#a6">DSOutputStream::FillStream</a>()<font class="keyword"></font>
00312 <font class="keyword"></font>{
00313   <a class="code" href="debug_8hpp.html#a1">ADR_GUARD</a>(<font class="stringliteral">"DSOutputStream::FillStream"</font>);
00314 
00315   <font class="comment">// we know the stream is stopped, so just lock the buffer and fill it</font>
00316 
00317   <font class="keywordtype">void</font>* buffer = NULL;
00318   DWORD buffer_length = 0;
00319 
00320   <font class="comment">// lock</font>
00321   HRESULT result = m_Buffer-&gt;Lock(
00322     0,
00323     m_BufferLength * m_SampleSize,
00324     &amp;buffer,
00325     &amp;buffer_length,
00326     NULL,
00327     NULL,
00328     0);
00329   <font class="keywordflow">if</font> (FAILED(result) || !buffer) {
00330     <a class="code" href="debug_8hpp.html#a2">ADR_LOG</a>(<font class="stringliteral">"FillStream failed!"</font>);
00331     <font class="keywordflow">return</font>;
00332   }
00333 
00334   ADR_IF_DEBUG {
00335     <font class="keywordtype">char</font> str[80];
00336     sprintf(str, <font class="stringliteral">"Buffer Length = %d"</font>, buffer_length);
00337     <a class="code" href="debug_8hpp.html#a2">ADR_LOG</a>(str);
00338   }
00339 
00340   <font class="comment">// fill</font>
00341   <font class="keywordtype">int</font> samples_to_read = buffer_length / m_SampleSize;
00342   <font class="keywordtype">int</font> samples_read = <a class="code" href="classDSOutputStream.html#a8">StreamRead</a>(samples_to_read, buffer);
00343   <font class="keywordflow">if</font> (samples_read != samples_to_read) {
00344     m_NextRead = samples_read;
00345   } <font class="keywordflow">else</font> {
00346     m_NextRead = 0;
00347   }
00348 
00349   <font class="comment">// unlock</font>
00350   m_Buffer-&gt;Unlock(buffer, buffer_length, NULL, 0);
00351 }
00352 
00354 
00355 <font class="keywordtype">void</font>
<a name="l00356"></a><a class="code" href="classDSOutputStream.html#a7">00356</a> <a class="code" href="classDSOutputStream.html#a7">DSOutputStream::Update</a>()<font class="keyword"></font>
00357 <font class="keyword"></font>{
00358   <a class="code" href="debug_8hpp.html#a1">ADR_GUARD</a>(<font class="stringliteral">"DSOutputStream::Update"</font>);
00359 
00360   <font class="comment">// if it's not playing, don't do anything</font>
00361   <font class="keywordflow">if</font> (!<a class="code" href="classDSOutputStream.html#a3">IsPlaying</a>()) {
00362     <font class="keywordflow">return</font>;
00363   }
00364 
00365   <font class="comment">/* this method reads more PCM data into the stream if it is required */</font>
00366 
00367   <font class="comment">// read the stream's play and write cursors</font>
00368   DWORD play;
00369   DWORD write;
00370   HRESULT result = m_Buffer-&gt;GetCurrentPosition(&amp;play, &amp;write);
00371   <font class="keywordflow">if</font> (FAILED(result)) {
00372     <a class="code" href="debug_8hpp.html#a2">ADR_LOG</a>(<font class="stringliteral">"GetCurrentPosition failed"</font>);
00373     <font class="keywordflow">return</font>;
00374   }
00375 
00376   ADR_IF_DEBUG {
00377     <font class="keywordtype">char</font> str[160];
00378     sprintf(str, <font class="stringliteral">"play: %d  write: %d"</font>, play, write);
00379     <a class="code" href="debug_8hpp.html#a2">ADR_LOG</a>(str);
00380   }
00381 
00382   <font class="comment">// deal with them in samples, not bytes</font>
00383   play  /= m_SampleSize;
00384   write /= m_SampleSize;
00385 
00386   <font class="comment">// read from |m_NextRead| to |play|</font>
00387   <font class="keywordtype">int</font> read_length = play - m_NextRead;
00388   <font class="keywordflow">if</font> (read_length &lt; 0) {
00389     read_length += m_BufferLength;
00390   }
00391 
00392   <font class="keywordflow">if</font> (read_length == 0) {
00393     <font class="keywordflow">return</font>;
00394   }
00395 
00396   <font class="comment">// lock the buffer</font>
00397   <font class="keywordtype">void</font>* buffer1;
00398   <font class="keywordtype">void</font>* buffer2;
00399   DWORD buffer1_length;
00400   DWORD buffer2_length;
00401   result = m_Buffer-&gt;Lock(
00402     m_NextRead * m_SampleSize,
00403     read_length * m_SampleSize,
00404     &amp;buffer1,
00405     &amp;buffer1_length,
00406     &amp;buffer2,
00407     &amp;buffer2_length,
00408     0
00409   );
00410   <font class="keywordflow">if</font> (FAILED(result)) {
00411     <a class="code" href="debug_8hpp.html#a2">ADR_LOG</a>(<font class="stringliteral">"Lock() failed!"</font>);
00412     <font class="keywordflow">return</font>;
00413   }
00414 
00415   ADR_IF_DEBUG {
00416     <font class="keywordtype">char</font> str[160];
00417     sprintf(str, <font class="stringliteral">"buffer1: %d  buffer2: %d"</font>, buffer1_length, buffer2_length);
00418     <a class="code" href="debug_8hpp.html#a2">ADR_LOG</a>(str);
00419   }
00420 
00421   <font class="comment">// now actually read samples</font>
00422   <font class="keywordtype">int</font> length1 = buffer1_length / m_SampleSize;
00423   <font class="keywordtype">int</font> length2 = buffer2_length / m_SampleSize;
00424   <font class="keywordtype">int</font> read = <a class="code" href="classDSOutputStream.html#a8">StreamRead</a>(length1, buffer1);
00425   <font class="keywordflow">if</font> (length1 == read) {
00426     read += <a class="code" href="classDSOutputStream.html#a8">StreamRead</a>(length2, buffer2);
00427   }
00428 
00429   ADR_IF_DEBUG {
00430     <font class="keywordtype">char</font> str[80];
00431     sprintf(str, <font class="stringliteral">"read: %d"</font>, read);
00432     <a class="code" href="debug_8hpp.html#a2">ADR_LOG</a>(str);
00433   }
00434 
00435   m_NextRead = (m_NextRead + read) % m_BufferLength;
00436 
00437   <font class="comment">// unlock</font>
00438   m_Buffer-&gt;Unlock(buffer1, buffer1_length, buffer2, buffer2_length);
00439 
00440   
00441   <font class="comment">// Should we stop?  If we didn't read any data, and if the read cursor</font>
00442   <font class="comment">// is between the play and the write cursors, we should.</font>
00443   <font class="keywordflow">if</font> (read == 0 &amp;&amp; <a class="code" href="classDSOutputStream.html#a9">IsBetween</a>(m_NextRead, play, write)) {
00444 
00445     <a class="code" href="debug_8hpp.html#a2">ADR_LOG</a>(<font class="stringliteral">"Stopping stream!"</font>);
00446 
00447     m_Buffer-&gt;Stop();
00448     m_Buffer-&gt;SetCurrentPosition(0);
00449 
00450     m_Source-&gt;<a class="code" href="classISampleSource.html#a3">Reset</a>();
00451 
00452     m_NextRead = 0;
00453     <a class="code" href="classDSOutputStream.html#a6">FillStream</a>();
00454 
00455     <font class="keywordflow">return</font>;
00456   }
00457 }
00458 
00460 
00461 <font class="comment">// read as much as possible from the stream source, fill the rest with 0</font>
00462 <font class="keywordtype">int</font>
<a name="l00463"></a><a class="code" href="classDSOutputStream.html#a8">00463</a> <a class="code" href="classDSOutputStream.html#a8">DSOutputStream::StreamRead</a>(<font class="keywordtype">int</font> sample_count, <font class="keywordtype">void</font>* samples)<font class="keyword"></font>
00464 <font class="keyword"></font>{
00465   <a class="code" href="debug_8hpp.html#a1">ADR_GUARD</a>(<font class="stringliteral">"StreamRead"</font>);
00466 
00467   <font class="comment">// try to read from the stream</font>
00468   <font class="keywordtype">int</font> samples_read = m_Source-&gt;<a class="code" href="classISampleSource.html#a2">Read</a>(sample_count, samples);
00469 
00470   <font class="comment">// read the last sample</font>
00471   <font class="keywordflow">if</font> (samples_read &gt; 0) {
00472     memcpy(
00473       m_LastSample,
00474       (BYTE*)samples + (samples_read - 1) * m_SampleSize,
00475       m_SampleSize);
00476   }
00477 
00478   <font class="comment">// fill the rest with silence</font>
00479   BYTE* out = (BYTE*)samples + m_SampleSize * samples_read;
00480   <font class="keywordtype">int</font> c = sample_count - samples_read;
00481   <font class="keywordflow">while</font> (c--) {
00482     memcpy(out, m_LastSample, m_SampleSize);
00483     out += m_SampleSize;
00484   }
00485 
00486   <font class="keywordflow">return</font> samples_read;
00487 }
00488 
00490 
00491 <font class="keywordtype">bool</font>
<a name="l00492"></a><a class="code" href="classDSOutputStream.html#a9">00492</a> <a class="code" href="classDSOutputStream.html#a9">DSOutputStream::IsBetween</a>(<font class="keywordtype">int</font> position, <font class="keywordtype">int</font> start, <font class="keywordtype">int</font> end)<font class="keyword"></font>
00493 <font class="keyword"></font>{
00494   <font class="keywordflow">if</font> (start &lt; end) {
00495     <font class="keywordflow">return</font> (position &gt;= start &amp;&amp; position &lt; end);
00496   } <font class="keywordflow">else</font> {
00497     <font class="keywordflow">return</font> (position &gt;= start || position &lt; end);
00498   }
00499 }
00500 
00502 
00503 <font class="keywordtype">void</font>
<a name="l00504"></a><a class="code" href="classDSOutputStream.html#a0">00504</a> <a class="code" href="classDSOutputStream.html#a0">DSOutputStream::Play</a>()<font class="keyword"></font>
00505 <font class="keyword"></font>{
00506   m_Buffer-&gt;Play(0, 0, DSBPLAY_LOOPING);
00507 }
00508 
00510 
00511 <font class="keywordtype">void</font>
<a name="l00512"></a><a class="code" href="classDSOutputStream.html#a1">00512</a> <a class="code" href="classDSOutputStream.html#a1">DSOutputStream::Stop</a>()<font class="keyword"></font>
00513 <font class="keyword"></font>{
00514   m_Buffer-&gt;Stop();
00515 }
00516 
00518 
00519 <font class="keywordtype">void</font>
<a name="l00520"></a><a class="code" href="classDSOutputStream.html#a2">00520</a> <a class="code" href="classDSOutputStream.html#a2">DSOutputStream::Reset</a>()<font class="keyword"></font>
00521 <font class="keyword"></font>{
00522   <a class="code" href="debug_8hpp.html#a1">ADR_GUARD</a>(<font class="stringliteral">"DSOutputStream::Reset"</font>);
00523 
00524   <font class="comment">// figure out if we're playing or not</font>
00525   <font class="keywordtype">bool</font> is_playing = <a class="code" href="classDSOutputStream.html#a3">IsPlaying</a>();
00526 
00527   <font class="comment">// if we're playing, stop</font>
00528   <font class="keywordflow">if</font> (is_playing) {
00529     m_Buffer-&gt;Stop();
00530   }
00531 
00532   m_Buffer-&gt;SetCurrentPosition(0);
00533   m_Source-&gt;<a class="code" href="classISampleSource.html#a3">Reset</a>();
00534   m_NextRead = 0;
00535   <a class="code" href="classDSOutputStream.html#a6">FillStream</a>();
00536 
00537   <font class="comment">// if we were playing, restart</font>
00538   <font class="keywordflow">if</font> (is_playing) {
00539     m_Buffer-&gt;Play(0, 0, DSBPLAY_LOOPING);
00540   }
00541 }
00542 
00544 
00545 <font class="keywordtype">bool</font>
<a name="l00546"></a><a class="code" href="classDSOutputStream.html#a3">00546</a> <a class="code" href="classDSOutputStream.html#a3">DSOutputStream::IsPlaying</a>()<font class="keyword"></font>
00547 <font class="keyword"></font>{
00548   DWORD status;
00549   HRESULT rv = m_Buffer-&gt;GetStatus(&amp;status);
00550   <font class="keywordflow">return</font> (SUCCEEDED(rv) &amp;&amp; status &amp; DSBSTATUS_PLAYING);
00551 }
00552 
00554 
00555 <font class="keywordtype">void</font>
<a name="l00556"></a><a class="code" href="classDSOutputStream.html#a4">00556</a> <a class="code" href="classDSOutputStream.html#a4">DSOutputStream::SetVolume</a>(<font class="keywordtype">int</font> volume)<font class="keyword"></font>
00557 <font class="keyword"></font>{
00558   m_Volume = volume;
00559   m_Buffer-&gt;SetVolume(<a class="code" href="output__ds_8cpp.html#a1">Volume_AudiereToDirectSound</a>(volume));
00560 }
00561 
00563 
00564 <font class="keywordtype">int</font>
<a name="l00565"></a><a class="code" href="classDSOutputStream.html#a5">00565</a> <a class="code" href="classDSOutputStream.html#a5">DSOutputStream::GetVolume</a>()<font class="keyword"></font>
00566 <font class="keyword"></font>{
00567   <font class="keywordflow">return</font> m_Volume;
00568 }
00569 
</pre></div><hr><address><small>Generated at Mon Jun 10 02:55:12 2002 for audiere by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.8.1 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2001</small></address>
</body>
</html>
