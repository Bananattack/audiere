<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>context.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.8.1 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>context.cpp</h1><a href="context_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="preprocessor">#include "<a class="code" href="context_8hpp.html">context.hpp</a>"</font>
00002 <font class="preprocessor">#include "<a class="code" href="stream_8hpp.html">stream.hpp</a>"</font>
00003 <font class="preprocessor">#include "<a class="code" href="threads_8hpp.html">threads.hpp</a>"</font>
00004 
00005 
00007 
<a name="l00008"></a><a class="code" href="classContext.html#d0">00008</a> <a class="code" href="classContext.html">Context</a>* <a class="code" href="classContext.html#d0">Context::Create</a>(
00009   <font class="keyword">const</font> <font class="keywordtype">char</font>* output_device,
00010   <font class="keyword">const</font> <font class="keywordtype">char</font>* parameters,
00011   <a class="code" href="classIFileSystem.html">IFileSystem</a>* file_system)<font class="keyword"></font>
00012 <font class="keyword"></font>{
00013   <a class="code" href="debug_8hpp.html#a1">ADR_GUARD</a>(<font class="stringliteral">"Context::Create"</font>);
00014 
00015   <a class="code" href="classContext.html">Context</a>* context = <font class="keyword">new</font> Context();
00016   <font class="keywordflow">if</font> (context-&gt;Initialize(output_device, parameters, file_system)) {
00017     <font class="keywordflow">return</font> context;
00018   } <font class="keywordflow">else</font> {
00019     <a class="code" href="debug_8hpp.html#a2">ADR_LOG</a>(<font class="stringliteral">"deleting context object"</font>);
00020     <font class="keyword">delete</font> context;
00021     <font class="keywordflow">return</font> 0;
00022   }
00023 }
00024 
00026 
00027 Context::Context()<font class="keyword"></font>
00028 <font class="keyword"></font>{
00029   m_ref_count = 0;
00030   m_thread_should_die = <font class="keyword">false</font>;
00031   m_thread_exists = <font class="keyword">false</font>;
00032   m_file_system = 0;
00033   m_output_context = 0;
00034 }
00035 
00037 
00038 Context::~Context()<font class="keyword"></font>
00039 <font class="keyword"></font>{
00040   <a class="code" href="debug_8hpp.html#a1">ADR_GUARD</a>(<font class="stringliteral">"Context::~Context"</font>);
00041 
00042   <font class="keywordflow">if</font> (m_thread_exists) {
00043     <a class="code" href="debug_8hpp.html#a2">ADR_LOG</a>(<font class="stringliteral">"asking thread to die..."</font>);
00044 
00045     <font class="comment">// ask the thread to die</font>
00046     m_thread_should_die = <font class="keyword">true</font>;
00047 
00048     <font class="comment">// wait until the thread is dead</font>
00049     <font class="keywordflow">while</font> (m_thread_should_die) {
00050       <a class="code" href="threads__win32_8cpp.html#a2">AI_Sleep</a>(50);
00051     }
00052 
00053     <a class="code" href="debug_8hpp.html#a2">ADR_LOG</a>(<font class="stringliteral">"thread is dead"</font>);
00054   }
00055 
00056   <font class="keyword">delete</font> m_output_context;
00057   <font class="keyword">delete</font> m_file_system;
00058 }
00059 
00061 
00062 <font class="keywordtype">bool</font>
00063 Context::Initialize(
00064   <font class="keyword">const</font> <font class="keywordtype">char</font>* output_device,
00065   <font class="keyword">const</font> <font class="keywordtype">char</font>* parameters,
00066   <a class="code" href="classIFileSystem.html">IFileSystem</a>* file_system)<font class="keyword"></font>
00067 <font class="keyword"></font>{
00068   m_ref_count = 1;
00069   m_thread_should_die = <font class="keyword">false</font>;
00070   m_thread_exists = <font class="keyword">false</font>;
00071 
00072   m_file_system = file_system;
00073 
00074   m_output_context = <a class="code" href="output_8hpp.html#a3">OpenContext</a>(output_device, parameters);
00075   <font class="keywordflow">if</font> (!m_output_context) {
00076     <a class="code" href="debug_8hpp.html#a2">ADR_LOG</a>(<font class="stringliteral">"could not open output context"</font>);
00077     <font class="keywordflow">return</font> <font class="keyword">false</font>;
00078   }
00079 
00080   <a class="code" href="debug_8hpp.html#a2">ADR_LOG</a>(<font class="stringliteral">"creating thread..."</font>);
00081 
00082   <font class="comment">// create a thread</font>
00083   <font class="comment">// this is particularly odd:  don't create a thread with higher priority than</font>
00084   <font class="comment">// 0 on Win9x, or some race condition occurs and the update thread completely</font>
00085   <font class="comment">// starves the main thread of the program.</font>
00086   <font class="comment">//</font>
00087   <font class="comment">// the race condition is related to the locks (critical sections)...</font>
00088   <font class="keywordtype">bool</font> result = <a class="code" href="threads__win32_8cpp.html#a1">AI_CreateThread</a>(ThreadRoutine, <font class="keyword">this</font>, 0);  <font class="comment">/* +4  */</font>
00089   <font class="keywordflow">if</font> (!result) {
00090     <a class="code" href="debug_8hpp.html#a2">ADR_LOG</a>(<font class="stringliteral">"thread creation failed!"</font>);
00091     <font class="keyword">delete</font> m_output_context;
00092     <font class="keywordflow">return</font> <font class="keyword">false</font>;
00093   }
00094 
00095   <a class="code" href="debug_8hpp.html#a2">ADR_LOG</a>(<font class="stringliteral">"thread creation succeeded"</font>);
00096   <font class="keywordflow">return</font> <font class="keyword">true</font>;
00097 }
00098 
00100 
00101 <font class="keywordtype">void</font>
<a name="l00102"></a><a class="code" href="classContext.html#a0">00102</a> <a class="code" href="classContext.html#a0">Context::AddRef</a>()<font class="keyword"></font>
00103 <font class="keyword"></font>{
00104   ++m_ref_count;
00105 }
00106 
00108 
00109 <font class="keywordtype">void</font>
<a name="l00110"></a><a class="code" href="classContext.html#a1">00110</a> <a class="code" href="classContext.html#a1">Context::Release</a>()<font class="keyword"></font>
00111 <font class="keyword"></font>{
00112   <a class="code" href="debug_8hpp.html#a1">ADR_GUARD</a>(<font class="stringliteral">"Context::Release"</font>);
00113 
00114   <font class="keywordflow">if</font> (--m_ref_count == 0) {
00115     <font class="keyword">delete</font> <font class="keyword">this</font>;
00116   }
00117 }
00118 
00120 
00121 <font class="keywordtype">void</font>
00122 <a class="code" href="threads__posix_8cpp.html#a0">Context::ThreadRoutine</a>(<font class="keywordtype">void</font>* opaque)<font class="keyword"></font>
00123 <font class="keyword"></font>{
00124   <a class="code" href="classContext.html">Context</a>* context = reinterpret_cast&lt;Context*&gt;(opaque);
00125   context-&gt;<a class="code" href="threads__posix_8cpp.html#a0">ThreadRoutine</a>();
00126 }
00127 
00129 
00130 <font class="keywordtype">void</font>
00131 <a class="code" href="threads__posix_8cpp.html#a0">Context::ThreadRoutine</a>()<font class="keyword"></font>
00132 <font class="keyword"></font>{
00133   m_thread_exists = <font class="keyword">true</font>;
00134 
00135   <font class="comment">// while we're not dead, process the sound update loop</font>
00136   <font class="keywordflow">while</font> (!m_thread_should_die) {
00137     <a class="code" href="debug_8hpp.html#a2">ADR_LOG</a>(<font class="stringliteral">"Updating output context..."</font>);
00138     ::AI_Lock l__(<font class="keyword">this</font>);
00139     m_output_context-&gt;<a class="code" href="classIOutputContext.html#a1">Update</a>();
00140   }
00141 
00142   <font class="comment">// okay, we're dead now</font>
00143   m_thread_should_die = <font class="keyword">false</font>;
00144   m_thread_exists = <font class="keyword">false</font>;
00145 }
00146 
00148 
00149 <a class="code" href="classStream.html">Stream</a>*
<a name="l00150"></a><a class="code" href="classContext.html#a2">00150</a> <a class="code" href="classContext.html#a2">Context::OpenStream</a>(<font class="keyword">const</font> <font class="keywordtype">char</font>* filename)<font class="keyword"></font>
00151 <font class="keyword"></font>{
00152   <a class="code" href="debug_8hpp.html#a1">ADR_GUARD</a>(<font class="stringliteral">"Context::OpenStream"</font>);
00153 
00154   <a class="code" href="classAI__Lock.html">AI_Lock</a> l__(<font class="keyword">this</font>);
00155 
00156   <a class="code" href="classStream.html">Stream</a>* stream = <font class="keyword">new</font> <a class="code" href="classContext.html#l0">Stream</a>();
00157   <font class="keywordflow">if</font> (stream-&gt;Initialize(<font class="keyword">this</font>, filename)) {
00158     <font class="keywordflow">return</font> stream;
00159   } <font class="keywordflow">else</font> {
00160     <font class="keyword">delete</font> stream;
00161     <font class="keywordflow">return</font> 0;
00162   }
00163 }
00164 
</pre></div><hr><address><small>Generated at Mon Jun 10 02:55:12 2002 for audiere by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.8.1 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2001</small></address>
</body>
</html>
