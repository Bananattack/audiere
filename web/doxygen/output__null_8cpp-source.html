<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>output_null.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.8.1 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>output_null.cpp</h1><a href="output__null_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="preprocessor">#ifdef _MSC_VER</font>
00002 <font class="preprocessor"></font><font class="preprocessor">#pragma warning(disable : 4786)</font>
00003 <font class="preprocessor"></font><font class="preprocessor">#endif</font>
00004 <font class="preprocessor"></font>
00005 
00006 <font class="preprocessor">#include &lt;algorithm&gt;</font>
00007 <font class="preprocessor">#include &lt;functional&gt;</font>
00008 <font class="preprocessor">#include "<a class="code" href="output__null_8hpp.html">output_null.hpp</a>"</font>
00009 <font class="preprocessor">#include "<a class="code" href="input_8hpp.html">input.hpp</a>"</font>
00010 <font class="preprocessor">#include "<a class="code" href="timer_8hpp.html">timer.hpp</a>"</font>
00011 <font class="preprocessor">#include "<a class="code" href="threads_8hpp.html">threads.hpp</a>"</font>
00012 <font class="preprocessor">#include "<a class="code" href="utility_8hpp.html">utility.hpp</a>"</font>
00013 
00014 
00016 
<a name="l00017"></a><a class="code" href="classNullOutputContext.html#a0">00017</a> <a class="code" href="classNullOutputContext.html#a0">NullOutputContext::NullOutputContext</a>()<font class="keyword"></font>
00018 <font class="keyword"></font>{
00019 }
00020 
00022 
<a name="l00023"></a><a class="code" href="classNullOutputContext.html#a1">00023</a> <a class="code" href="classNullOutputContext.html#a1">NullOutputContext::~NullOutputContext</a>()<font class="keyword"></font>
00024 <font class="keyword"></font>{
00025   <a class="code" href="debug_8hpp.html#a4">ADR_ASSERT</a>(m_streams.size() == 0,
00026     <font class="stringliteral">"Null output context should not die with open streams"</font>);
00027 }
00028 
00030 
00031 <font class="keywordtype">bool</font>
<a name="l00032"></a><a class="code" href="classNullOutputContext.html#a2">00032</a> <a class="code" href="classNullOutputContext.html#a2">NullOutputContext::Initialize</a>(<font class="keyword">const</font> <font class="keywordtype">char</font>* <font class="comment">/*parameters*/</font>)<font class="keyword"></font>
00033 <font class="keyword"></font>{
00034   <font class="keywordflow">return</font> <font class="keyword">true</font>;
00035 }
00036 
00038 
00039 <font class="keywordtype">void</font>
<a name="l00040"></a><a class="code" href="classNullOutputContext.html#a3">00040</a> <a class="code" href="classNullOutputContext.html#a3">NullOutputContext::Update</a>()<font class="keyword"></font>
00041 <font class="keyword"></font>{
00042   <font class="comment">/*</font>
00043 <font class="comment">    UGH.  We can't use VC6 here because you can't use mem_fun with void</font>
00044 <font class="comment">    functions.  :(</font>
00045 <font class="comment">  std::for_each(</font>
00046 <font class="comment">    m_streams.begin(),</font>
00047 <font class="comment">    m_streams.end(),</font>
00048 <font class="comment">    std::mem_fun(&amp;NullOutputStream::Update));</font>
00049 <font class="comment">  */</font>
00050 
00051   StreamList::iterator i = m_streams.begin();
00052   <font class="keywordflow">for</font> (; i != m_streams.end(); ++i) {
00053     (*i)-&gt;Update();
00054   }
00055 
00056   <a class="code" href="threads__win32_8cpp.html#a2">AI_Sleep</a>(50);
00057 }
00058 
00060 
00061 <a class="code" href="classIOutputStream.html">IOutputStream</a>*
<a name="l00062"></a><a class="code" href="classNullOutputContext.html#a4">00062</a> <a class="code" href="classNullOutputContext.html#a4">NullOutputContext::OpenStream</a>(<a class="code" href="classISampleSource.html">ISampleSource</a>* source)<font class="keyword"></font>
00063 <font class="keyword"></font>{
00064   <a class="code" href="classNullOutputStream.html">NullOutputStream</a>* stream = <font class="keyword">new</font> <a class="code" href="classNullOutputContext.html#l0">NullOutputStream</a>(<font class="keyword">this</font>, source);
00065   m_streams.insert(stream);
00066   <font class="keywordflow">return</font> stream;
00067 }
00068 
00070 
00071 <font class="keywordtype">void</font>
00072 NullOutputContext::RemoveStream(<a class="code" href="classNullOutputStream.html">NullOutputStream</a>* stream)<font class="keyword"> </font>{
00073   m_streams.erase(stream);
00074 }
00075 
00077 
00078 NullOutputStream::NullOutputStream(
00079   <a class="code" href="classNullOutputContext.html">NullOutputContext</a>* context,
00080   <a class="code" href="classISampleSource.html">ISampleSource</a>* source)
00081 : m_context(context)
00082 , m_source(source)
00083 , m_is_playing(<font class="keyword">false</font>)
00084 , m_volume(ADR_VOLUME_MAX)
00085 , m_last_update(0)<font class="keyword"></font>
00086 <font class="keyword"></font>{
00087   m_source-&gt;GetFormat(m_channel_count, m_sample_rate, m_bits_per_sample);
00088 }
00089 
00091 
00092 NullOutputStream::~NullOutputStream()<font class="keyword"></font>
00093 <font class="keyword"></font>{
00094   m_context-&gt;RemoveStream(<font class="keyword">this</font>);
00095 }
00096 
00098 
00099 <font class="keywordtype">void</font>
<a name="l00100"></a><a class="code" href="classNullOutputStream.html#a0">00100</a> <a class="code" href="classNullOutputStream.html#a0">NullOutputStream::Play</a>()<font class="keyword"></font>
00101 <font class="keyword"></font>{
00102   <a class="code" href="debug_8hpp.html#a1">ADR_GUARD</a>(<font class="stringliteral">"NullOutputStream::Play"</font>);
00103   m_is_playing = <font class="keyword">true</font>;
00104   ResetTimer();
00105 }
00106 
00108 
00109 <font class="keywordtype">void</font>
<a name="l00110"></a><a class="code" href="classNullOutputStream.html#a1">00110</a> <a class="code" href="classNullOutputStream.html#a1">NullOutputStream::Stop</a>()<font class="keyword"></font>
00111 <font class="keyword"></font>{
00112   m_is_playing = <font class="keyword">false</font>;
00113 }
00114 
00116 
00117 <font class="keywordtype">void</font>
<a name="l00118"></a><a class="code" href="classNullOutputStream.html#a2">00118</a> <a class="code" href="classNullOutputStream.html#a2">NullOutputStream::Reset</a>()<font class="keyword"></font>
00119 <font class="keyword"></font>{
00120   ResetTimer();
00121 }
00122 
00124 
00125 <font class="keywordtype">bool</font>
<a name="l00126"></a><a class="code" href="classNullOutputStream.html#a3">00126</a> <a class="code" href="classNullOutputStream.html#a3">NullOutputStream::IsPlaying</a>()<font class="keyword"></font>
00127 <font class="keyword"></font>{
00128   <font class="keywordflow">return</font> m_is_playing;
00129 }
00130 
00132 
00133 <font class="keywordtype">void</font>
<a name="l00134"></a><a class="code" href="classNullOutputStream.html#a4">00134</a> <a class="code" href="classNullOutputStream.html#a4">NullOutputStream::SetVolume</a>(<font class="keywordtype">int</font> volume)<font class="keyword"></font>
00135 <font class="keyword"></font>{
00136   m_volume = volume;
00137 }
00138 
00140 
00141 <font class="keywordtype">int</font>
<a name="l00142"></a><a class="code" href="classNullOutputStream.html#a5">00142</a> <a class="code" href="classNullOutputStream.html#a5">NullOutputStream::GetVolume</a>()<font class="keyword"></font>
00143 <font class="keyword"></font>{
00144   <font class="keywordflow">return</font> m_volume;
00145 }
00146 
00148 
00149 <font class="keywordtype">void</font>
00150 NullOutputStream::ResetTimer()<font class="keyword"></font>
00151 <font class="keyword"></font>{
00152   m_last_update = <a class="code" href="timer_8hpp.html#a1">GetNow</a>();
00153 }
00154 
00156 
00157 <font class="keywordtype">void</font>
00158 NullOutputStream::Update()<font class="keyword"></font>
00159 <font class="keyword"></font>{
00160   <a class="code" href="debug_8hpp.html#a1">ADR_GUARD</a>(<font class="stringliteral">"NullOutputStream::Update"</font>);
00161 
00162   <font class="keywordflow">if</font> (m_is_playing) {
00163     <a class="code" href="debug_8hpp.html#a2">ADR_LOG</a>(<font class="stringliteral">"Null output stream is playing"</font>);
00164 
00165     <font class="comment">// get number of milliseconds elapsed since last playing update</font>
00166     <font class="comment">// so we can read that much time worth of samples</font>
00167     adr_u64 now = <a class="code" href="timer_8hpp.html#a1">GetNow</a>();
00168     adr_u64 elapsed = now - m_last_update;
00169 
00170     ADR_IF_DEBUG {
00171       <font class="keywordtype">char</font> str[100];
00172       sprintf(str, <font class="stringliteral">"Elapsed: %I64d"</font>, elapsed);
00173       <a class="code" href="debug_8hpp.html#a2">ADR_LOG</a>(str);
00174     }
00175 
00176     <font class="keywordtype">int</font> samples_to_read = <a class="code" href="audiere_8h.html#a16">int</a>(m_sample_rate * elapsed / 1000000);
00177 
00178     ADR_IF_DEBUG {
00179       <font class="keywordtype">char</font> str[100];
00180       sprintf(str, <font class="stringliteral">"Samples to read: %d"</font>, samples_to_read);
00181       <a class="code" href="debug_8hpp.html#a2">ADR_LOG</a>(str);
00182     }
00183 
00184     <font class="keywordtype">int</font> samples_read = DummyRead(samples_to_read);
00185 
00186     <font class="keywordflow">if</font> (samples_read != samples_to_read) {
00187       <a class="code" href="debug_8hpp.html#a2">ADR_LOG</a>(<font class="stringliteral">"Stopping null output stream"</font>);
00188       m_source-&gt;<a class="code" href="classISampleSource.html#a3">Reset</a>();
00189       <a class="code" href="classNullOutputStream.html#a1">Stop</a>();
00190     }
00191 
00192     m_last_update = now;
00193   }
00194 }
00195 
00197 
00198 <font class="keywordtype">int</font>
00199 NullOutputStream::DummyRead(<font class="keywordtype">int</font> samples_to_read)<font class="keyword"></font>
00200 <font class="keyword"></font>{
00201   <font class="keywordtype">int</font> total = 0;  <font class="comment">// number of samples read so far</font>
00202 
00203   <font class="comment">// read samples into dummy buffer, counting the number we actually read</font>
00204   adr_u8* dummy = <font class="keyword">new</font> adr_u8[1024 * m_channel_count * m_bits_per_sample / 8];
00205   <font class="keywordflow">while</font> (samples_to_read &gt; 0) {
00206     <font class="keywordtype">int</font> read = <a class="code" href="utility_8hpp.html#a2">adr_min</a>(1024, samples_to_read);
00207     <font class="keywordtype">int</font> actual_read = m_source-&gt;<a class="code" href="classISampleSource.html#a2">Read</a>(read, dummy);
00208     total += actual_read;
00209     samples_to_read -= actual_read;
00210     <font class="keywordflow">if</font> (actual_read &lt; read) {
00211       <font class="keywordflow">break</font>;
00212     }
00213   }
00214 
00215   <font class="keyword">delete</font>[] dummy;
00216   <font class="keywordflow">return</font> total;
00217 }
00218 
</pre></div><hr><address><small>Generated at Mon Jun 10 02:55:12 2002 for audiere by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.8.1 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2001</small></address>
</body>
</html>
