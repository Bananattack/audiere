<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>file_win32.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.8.1 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>file_win32.cpp</h1><a href="file__win32_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">// THIS FILE MAY HAVE INCORRECT SEMANTICS ON WINDOWS 95, 98, AND ME</font>
00002 <font class="comment">// test with mod files</font>
00003 
00004 
00005 <font class="preprocessor">#include &lt;windows.h&gt;</font>
00006 <font class="preprocessor">#include "<a class="code" href="file_8hpp.html">file.hpp</a>"</font>
00007 
00008 
00009 <font class="comment">// WIN32_FILE</font>
<a name="l00010"></a><a class="code" href="structADR__FileHandle.html">00010</a> <font class="keyword">struct </font><a class="code" href="structADR__FileHandle.html">ADR_FileHandle</a>
00011 {
<a name="l00012"></a><a class="code" href="structADR__FileHandle.html#m0">00012</a>   HANDLE handle;
00013 };
00014 
00015 
00016 <font class="keyword">static</font> <a class="code" href="structADR__FileHandle.html">ADR_FILE</a> DefaultFileOpenA(<font class="keyword">const</font> <font class="keywordtype">char</font>* filename);
00017 
00018 
00020 
<a name="l00021"></a><a class="code" href="file__win32_8cpp.html#a1">00021</a> <a class="code" href="structADR__FileHandle.html">ADR_FILE</a> ADR_CALL <a class="code" href="file__win32_8cpp.html#a1">DefaultFileOpen</a>(<font class="keywordtype">void</font>* <font class="comment">/*opaque*/</font>, <font class="keyword">const</font> <font class="keywordtype">char</font>* filename)<font class="keyword"></font>
00022 <font class="keyword"></font>{
00023   <font class="comment">// first, let's try to convert the UTF-8 filename to a wide string</font>
00024   <font class="comment">// calculate length of UTF-8 string</font>
00025   <font class="keywordtype">int</font> wfilename_length = MultiByteToWideChar(
00026     CP_UTF8, 0,
00027     filename, -1,
00028     0, NULL);
00029   
00030   <font class="comment">// do the conversion now</font>
00031   WCHAR* wfilename = <font class="keyword">new</font> WCHAR[wfilename_length + 1];
00032   wfilename[wfilename_length] = 0;
00033   <font class="keywordtype">int</font> result = MultiByteToWideChar(
00034     CP_UTF8, 0,
00035     filename, -1,
00036     wfilename, wfilename_length + 1);
00037 
00038   <font class="keywordflow">if</font> (result == 0) {
00039     <font class="keyword">delete</font>[] wfilename;
00040     <font class="keywordflow">return</font> DefaultFileOpenA(filename);
00041   }
00042 
00043   HANDLE handle = CreateFileW(
00044     wfilename, GENERIC_READ, FILE_SHARE_READ, NULL,
00045     OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);
00046   <font class="keywordflow">if</font> (handle == INVALID_HANDLE_VALUE) {
00047     <font class="keywordflow">return</font> DefaultFileOpenA(filename);
00048   }
00049 
00050   <font class="keyword">delete</font>[] wfilename;
00051 
00052   <a class="code" href="structADR__FileHandle.html">ADR_FileHandle</a>* file = <font class="keyword">new</font> <a class="code" href="structADR__FileHandle.html">ADR_FileHandle</a>;
00053   file-&gt;handle = handle;
00054   <font class="keywordflow">return</font> file;
00055 }
00056 
00058 
00059 <a class="code" href="structADR__FileHandle.html">ADR_FILE</a> DefaultFileOpenA(<font class="keyword">const</font> <font class="keywordtype">char</font>* filename)<font class="keyword"></font>
00060 <font class="keyword"></font>{
00061   HANDLE handle = CreateFileA(
00062     filename, GENERIC_READ, FILE_SHARE_READ, NULL,
00063     OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);
00064   <font class="keywordflow">if</font> (handle == INVALID_HANDLE_VALUE) {
00065     <font class="keywordflow">return</font> NULL;
00066   }
00067 
00068   <a class="code" href="structADR__FileHandle.html">ADR_FileHandle</a>* file = <font class="keyword">new</font> <a class="code" href="structADR__FileHandle.html">ADR_FileHandle</a>;
00069   file-&gt;handle = handle;
00070   <font class="keywordflow">return</font> file;
00071 }
00072 
00074 
<a name="l00075"></a><a class="code" href="file__win32_8cpp.html#a2">00075</a> <font class="keywordtype">void</font> ADR_CALL <a class="code" href="file__win32_8cpp.html#a2">DefaultFileClose</a>(<a class="code" href="structADR__FileHandle.html">ADR_FILE</a> file)<font class="keyword"></font>
00076 <font class="keyword"></font>{
00077   CloseHandle(file-&gt;handle);
00078   <font class="keyword">delete</font> file;
00079 }
00080 
00082 
<a name="l00083"></a><a class="code" href="file__win32_8cpp.html#a3">00083</a> <font class="keywordtype">int</font> ADR_CALL <a class="code" href="file__win32_8cpp.html#a3">DefaultFileRead</a>(<a class="code" href="structADR__FileHandle.html">ADR_FILE</a> file, <font class="keywordtype">void</font>* buffer, <font class="keywordtype">int</font> size)<font class="keyword"></font>
00084 <font class="keyword"></font>{
00085   DWORD read;
00086   BOOL result = ReadFile(file-&gt;handle, buffer, size, &amp;read, NULL);
00087   <font class="keywordflow">return</font> (result ? read : 0);
00088 }
00089 
00091 
<a name="l00092"></a><a class="code" href="file__win32_8cpp.html#a4">00092</a> <font class="keywordtype">int</font> ADR_CALL <a class="code" href="file__win32_8cpp.html#a4">DefaultFileSeek</a>(<a class="code" href="structADR__FileHandle.html">ADR_FILE</a> file, <font class="keywordtype">int</font> destination)<font class="keyword"></font>
00093 <font class="keyword"></font>{
00094   <font class="keywordtype">int</font> d = SetFilePointer(file-&gt;handle, destination, NULL, FILE_BEGIN);
00095   <font class="keywordflow">return</font> (d != destination);
00096 }
00097 
00099 
<a name="l00100"></a><a class="code" href="file__win32_8cpp.html#a5">00100</a> <font class="keywordtype">int</font> ADR_CALL <a class="code" href="file__win32_8cpp.html#a5">DefaultFileTell</a>(<a class="code" href="structADR__FileHandle.html">ADR_FILE</a> file)<font class="keyword"></font>
00101 <font class="keyword"></font>{
00102   <font class="keywordflow">return</font> SetFilePointer(file-&gt;handle, 0, NULL, FILE_CURRENT);
00103 }
00104 
</pre></div><hr><address><small>Generated at Mon Jun 10 02:55:12 2002 for audiere by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.8.1 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2001</small></address>
</body>
</html>
