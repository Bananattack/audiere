<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>resampler.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.8.1 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>resampler.cpp</h1><a href="resampler_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="preprocessor">#include "<a class="code" href="resampler_8hpp.html">resampler.hpp</a>"</font>
00002 
00003 
00005 
<a name="l00006"></a><a class="code" href="classResampler.html#a0">00006</a> <a class="code" href="classResampler.html#a0">Resampler::Resampler</a>(<a class="code" href="classISampleSource.html">ISampleSource</a>* source)<font class="keyword"></font>
00007 <font class="keyword"></font>{
00008   m_source = source;
00009   m_source-&gt;<a class="code" href="classISampleSource.html#a1">GetFormat</a>(
00010     m_native_channel_count,
00011     m_native_sample_rate,
00012     m_native_bits_per_sample);
00013 
00014   FillBuffer();
00015   ResetState();
00016 }
00017 
00019 
<a name="l00020"></a><a class="code" href="classResampler.html#a1">00020</a> <a class="code" href="classResampler.html#a1">Resampler::~Resampler</a>()<font class="keyword"></font>
00021 <font class="keyword"></font>{
00022 }
00023 
00025 
00026 <font class="keywordtype">void</font>
<a name="l00027"></a><a class="code" href="classResampler.html#a2">00027</a> <a class="code" href="classResampler.html#a2">Resampler::GetFormat</a>(<font class="keywordtype">int</font>&amp; channel_count, <font class="keywordtype">int</font>&amp; sample_rate, <font class="keywordtype">int</font>&amp; bits_per_sample)<font class="keyword"></font>
00028 <font class="keyword"></font>{
00029   channel_count = 2;
00030   sample_rate = 44100;
00031   bits_per_sample = 16;
00032 }
00033 
00035 
00036 <font class="keywordtype">int</font>
<a name="l00037"></a><a class="code" href="classResampler.html#a3">00037</a> <a class="code" href="classResampler.html#a3">Resampler::Read</a>(<font class="keyword">const</font> <font class="keywordtype">int</font> sample_count, <font class="keywordtype">void</font>* samples)<font class="keyword"></font>
00038 <font class="keyword"></font>{
00039   adr_u16* out = (adr_u16*)samples;
00040 
00041   <font class="keywordtype">int</font> left = sample_count;
00042 
00043   <font class="comment">// if we didn't finish resampling last time...</font>
00044   <font class="keywordflow">while</font> (m_time &gt; m_native_sample_rate &amp;&amp; left &gt; 0) {
00045     m_time -= m_native_sample_rate;
00046     *out++ = m_sl;
00047     *out++ = m_sr;
00048     --left;
00049   }
00050 
00051   <font class="keywordflow">while</font> (left &gt; 0) {
00052 
00053     <font class="keywordflow">if</font> (m_samples_left == 0) {
00054       <font class="comment">// try to fill the native buffer</font>
00055       FillBuffer();
00056 
00057       <font class="comment">// could we read any more?</font>
00058       <font class="keywordflow">if</font> (m_samples_left == 0) {
00059         <font class="keywordflow">return</font> sample_count - left;
00060       }
00061     }
00062 
00063     m_sl = *m_position++;
00064     m_sr = *m_position++;
00065     --m_samples_left;
00066 
00067     m_time += 44100;
00068     <font class="keywordflow">while</font> (m_time &gt; m_native_sample_rate &amp;&amp; left &gt; 0) {
00069       m_time -= m_native_sample_rate;
00070       *out++ = m_sl;
00071       *out++ = m_sr;
00072       --left;
00073     }
00074 
00075   }
00076   <font class="keywordflow">return</font> sample_count;
00077 }
00078 
00080 
00081 <font class="keywordtype">bool</font>
<a name="l00082"></a><a class="code" href="classResampler.html#a4">00082</a> <a class="code" href="classResampler.html#a4">Resampler::Reset</a>()<font class="keyword"></font>
00083 <font class="keyword"></font>{
00084   <font class="keywordflow">if</font> (m_source-&gt;<a class="code" href="classISampleSource.html#a3">Reset</a>()) {
00085     FillBuffer();
00086     ResetState();
00087     <font class="keywordflow">return</font> <font class="keyword">true</font>;
00088   } <font class="keywordflow">else</font> {
00089     <font class="keywordflow">return</font> <font class="keyword">false</font>;
00090   }
00091 }
00092 
00094 
<a name="l00095"></a><a class="code" href="resampler_8cpp.html#a0">00095</a> <font class="keyword">inline</font> adr_s16 <a class="code" href="resampler_8cpp.html#a0">u8tos16</a>(adr_u8 u)<font class="keyword"> </font>{
00096   <font class="keywordflow">return</font> (<a class="code" href="config_8h.html#a3">adr_s16</a>(u) - 127) * (1 &lt;&lt; 8);
00097 }
00098 
00099 <font class="keywordtype">void</font>
00100 Resampler::FillBuffer()<font class="keyword"></font>
00101 <font class="keyword"></font>{
00102   <font class="comment">// we only support channels in [1, 2] and bits in [8, 16] now</font>
00103   adr_u8 initial_buffer[NATIVE_BUFFER_SIZE * 4];
00104   <font class="keywordtype">unsigned</font> read = m_source-&gt;Read(NATIVE_BUFFER_SIZE, initial_buffer);
00105 
00106   adr_s16* out = m_native_buffer;
00107 
00108   <font class="keywordflow">if</font> (m_native_channel_count == 1) {
00109     <font class="keywordflow">if</font> (m_native_bits_per_sample == 8) {
00110 
00111       <font class="comment">// channels = 1, bits = 8</font>
00112       adr_u8* in = initial_buffer;
00113       <font class="keywordflow">for</font> (<font class="keywordtype">unsigned</font> i = 0; i &lt; read; ++i) {
00114         adr_s16 sample = <a class="code" href="resampler_8cpp.html#a0">u8tos16</a>(*in++);
00115         *out++ = sample;
00116         *out++ = sample;
00117       }
00118 
00119     } <font class="keywordflow">else</font> {
00120 
00121       <font class="comment">// channels = 1, bits = 16</font>
00122       adr_s16* in = (adr_s16*)initial_buffer;
00123       <font class="keywordflow">for</font> (<font class="keywordtype">unsigned</font> i = 0; i &lt; read; ++i) {
00124         adr_s16 sample = *in++;
00125         *out++ = sample;
00126         *out++ = sample;
00127       }
00128 
00129     }
00130   } <font class="keywordflow">else</font> {
00131     <font class="keywordflow">if</font> (m_native_bits_per_sample == 8) {
00132 
00133       <font class="comment">// channels = 2, bits = 8</font>
00134       adr_u8* in = initial_buffer;
00135       <font class="keywordflow">for</font> (<font class="keywordtype">unsigned</font> i = 0; i &lt; read; ++i) {
00136         *out++ = <a class="code" href="resampler_8cpp.html#a0">u8tos16</a>(*in++);
00137         *out++ = <a class="code" href="resampler_8cpp.html#a0">u8tos16</a>(*in++);
00138       }
00139 
00140     } <font class="keywordflow">else</font> {
00141 
00142       <font class="comment">// channels = 2, bits = 16</font>
00143       adr_s16* in = (adr_s16*)initial_buffer;
00144       <font class="keywordflow">for</font> (<font class="keywordtype">unsigned</font> i = 0; i &lt; read; ++i) {
00145         *out++ = *in++;
00146         *out++ = *in++;
00147       }
00148       
00149     }
00150   }
00151 
00152   m_position = m_native_buffer;
00153   m_samples_left = read;
00154 }
00155 
00157 
00158 <font class="keywordtype">void</font>
00159 Resampler::ResetState()<font class="keyword"></font>
00160 <font class="keyword"></font>{
00161   m_time = 0;
00162   m_sl = 0;
00163   m_sr = 0;
00164 }
00165 
</pre></div><hr><address><small>Generated at Mon Jun 10 02:55:12 2002 for audiere by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.8.1 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2001</small></address>
</body>
</html>
