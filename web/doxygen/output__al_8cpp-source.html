<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>output_al.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.8.1 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>output_al.cpp</h1><a href="output__al_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="preprocessor">#ifdef WITH_OPENAL</font>
00002 <font class="preprocessor"></font>
00003 <font class="preprocessor">#include &lt;limits.h&gt;</font>
00004 <font class="preprocessor">#include "<a class="code" href="output__al_8hpp.html">output_al.hpp</a>"</font>
00005 <font class="preprocessor">#include "<a class="code" href="threads_8hpp.html">threads.hpp</a>"</font>
00006 
00007 
00008 <font class="keyword">static</font> <font class="keyword">const</font> <font class="keywordtype">int</font> BUFFER_COUNT = 4;
00009 <font class="keyword">static</font> <font class="keyword">const</font> <font class="keywordtype">int</font> BUFFER_MILLISECONDS = 250;
00010 
00011 
00013 
00014 <a class="code" href="classALOutputContext.html#a0">ALOutputContext::ALOutputContext</a>()<font class="keyword"></font>
00015 <font class="keyword"></font>{
00016   m_Device = 0;
00017   m_Context = 0;
00018 }
00019 
00021 
00022 <a class="code" href="classALOutputContext.html#a1">ALOutputContext::~ALOutputContext</a>()<font class="keyword"></font>
00023 <font class="keyword"></font>{
00024   <font class="keywordflow">if</font> (m_Context) {
00025     alcMakeContextCurrent(0);
00026     alcDestroyContext(m_Context);
00027     m_Context = 0;
00028   }
00029 
00030   <font class="keywordflow">if</font> (m_Device) {
00031     alcCloseDevice(m_Device);
00032     m_Device = 0;
00033   }
00034 }
00035 
00037 
00038 <font class="keywordtype">bool</font>
00039 <a class="code" href="classALOutputContext.html#a2">ALOutputContext::Initialize</a>(<font class="keyword">const</font> <font class="keywordtype">char</font>* parameters)<font class="keyword"></font>
00040 <font class="keyword"></font>{
00041   <font class="comment">// are we already initialized?</font>
00042   <font class="keywordflow">if</font> (m_Device) {
00043     <font class="keywordflow">return</font> <font class="keyword">false</font>;
00044   }
00045 
00046   <font class="comment">// open an output device</font>
00047   m_Device = alcOpenDevice(0);
00048   <font class="keywordflow">if</font> (!m_Device) {
00049     <font class="keywordflow">return</font> <font class="keyword">false</font>;
00050   }
00051 
00052   <font class="comment">// create a rendering context</font>
00053   m_Context = alcCreateContext(m_Device, 0);
00054   <font class="keywordflow">if</font> (!m_Context) {
00055     alcCloseDevice(m_Device);
00056     m_Device = 0;
00057     <font class="keywordflow">return</font> <font class="keyword">false</font>;
00058   }
00059 
00060   alcMakeContextCurrent(m_Context);
00061 
00062   <font class="comment">// define the listener state</font>
00063   ALfloat position[]    = { 0.0, 0.0, 0.0 };
00064   ALfloat velocity[]    = { 0.0, 0.0, 0.0 };
00065   ALfloat orientation[] = { 0.0, 0.0, -1.0, 0.0, 1.0, 0.0 };
00066 
00067   <font class="comment">// set the listener state</font>
00068   <font class="keywordtype">bool</font> success = <font class="keyword">false</font>;
00069   alListenerfv(AL_POSITION, position);
00070   <font class="keywordflow">if</font> (alGetError() == AL_NO_ERROR) {
00071     alListenerfv(AL_VELOCITY, velocity);
00072     <font class="keywordflow">if</font> (alGetError() == AL_NO_ERROR) {
00073       alListenerfv(AL_ORIENTATION, orientation);
00074       <font class="keywordflow">if</font> (alGetError() == AL_NO_ERROR) {
00075 
00076         <font class="comment">// set the distance model</font>
00077         alDistanceModel(AL_NONE);
00078         success = (alGetError() == AL_NO_ERROR);
00079 
00080       }
00081     }
00082   }
00083 
00084   <font class="comment">// if we failed, go home</font>
00085   <font class="keywordflow">if</font> (!success) {
00086     alcMakeContextCurrent(0);
00087     alcDestroyContext(m_Context);
00088     m_Context = 0;
00089     alcCloseDevice(m_Device);
00090     m_Device = 0;
00091     <font class="keywordflow">return</font> <font class="keyword">false</font>;
00092   }
00093 
00094   <font class="keywordflow">return</font> (m_Device != 0);
00095 }
00096 
00098 
00099 <font class="keywordtype">void</font>
00100 <a class="code" href="classALOutputContext.html#a3">ALOutputContext::Update</a>()<font class="keyword"></font>
00101 <font class="keyword"></font>{
00102   <font class="comment">// enumerate all open streams</font>
00103   StreamList::iterator i = m_OpenStreams.begin();
00104   <font class="keywordflow">while</font> (i != m_OpenStreams.end()) {
00105     <a class="code" href="classALOutputStream.html">ALOutputStream</a>* s = *i++;
00106     s-&gt;Update();
00107   }
00108 }
00109 
00111 
00112 <a class="code" href="classIOutputStream.html">IOutputStream</a>*
00113 <a class="code" href="classALOutputContext.html#a4">ALOutputContext::OpenStream</a>(<a class="code" href="classISampleSource.html">ISampleSource</a>* source)<font class="keyword"></font>
00114 <font class="keyword"></font>{
00115   <font class="keywordtype">int</font> channel_count;
00116   <font class="keywordtype">int</font> sample_rate;
00117   <font class="keywordtype">int</font> bits_per_sample;
00118   source-&gt;<a class="code" href="classISampleSource.html#a1">GetFormat</a>(channel_count, sample_rate, bits_per_sample);
00119 
00120   <font class="comment">// calculate OpenAL format</font>
00121   ALenum format;
00122   <font class="keywordflow">if</font> (channel_count == 1 &amp;&amp; bits_per_sample == 8) {
00123     format = AL_FORMAT_MONO8;
00124   } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (channel_count == 1 &amp;&amp; bits_per_sample == 16) {
00125     format = AL_FORMAT_MONO16;
00126   } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (channel_count == 2 &amp;&amp; bits_per_sample == 8) {
00127     format = AL_FORMAT_STEREO8;
00128   } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (channel_count == 2 &amp;&amp; bits_per_sample == 16) {
00129     format = AL_FORMAT_STEREO16;
00130   } <font class="keywordflow">else</font> {
00131     <font class="keywordflow">return</font> 0;
00132   }
00133 
00134   <font class="comment">// generate buffers</font>
00135   ALuint* buffers = <font class="keyword">new</font> ALuint[BUFFER_COUNT];
00136   alGenBuffers(BUFFER_COUNT, buffers);
00137   <font class="keywordflow">if</font> (alGetError() != AL_NO_ERROR) {
00138     <font class="keyword">delete</font>[] buffers;
00139     <font class="keywordflow">return</font> NULL;
00140   }
00141 
00142   <font class="comment">// generate sources</font>
00143   <font class="comment">// we have one source for each channel</font>
00144   ALuint al_source;
00145   alGenSources(1, &amp;al_source);
00146   <font class="keywordflow">if</font> (alGetError() != AL_NO_ERROR) {
00147     alDeleteBuffers(BUFFER_COUNT, buffers);
00148     <font class="keyword">delete</font>[] buffers;
00149     <font class="keywordflow">return</font> NULL;
00150   }
00151 
00152   <a class="code" href="classALOutputStream.html">ALOutputStream</a>* stream = <font class="keyword">new</font> ALOutputStream(
00153     <font class="keyword">this</font>,
00154     source,
00155     al_source,
00156     buffers,
00157     format,
00158     sample_rate);
00159   m_OpenStreams.push_back(stream);
00160   <font class="keywordflow">return</font> stream;
00161 }
00162 
00164 
00165 ALOutputStream::ALOutputStream(
00166   <a class="code" href="classALOutputContext.html">ALOutputContext</a>* context,
00167   <a class="code" href="classISampleSource.html">ISampleSource</a>* source,
00168   ALuint al_source,
00169   ALuint* buffers,
00170   ALenum format,
00171   <font class="keywordtype">int</font> sample_rate)<font class="keyword"></font>
00172 <font class="keyword"></font>{
00173   <font class="comment">// fill the members</font>
00174   m_Context = context;
00175   m_Source = source;
00176 
00177   m_SampleRate = sample_rate;
00178   m_Format = format;
00179   <font class="keywordflow">switch</font> (format) {
00180     <font class="keywordflow">case</font> AL_FORMAT_MONO8:    m_SampleSize = 1; <font class="keywordflow">break</font>;
00181     <font class="keywordflow">case</font> AL_FORMAT_MONO16:   m_SampleSize = 2; <font class="keywordflow">break</font>;
00182     <font class="keywordflow">case</font> AL_FORMAT_STEREO8:  m_SampleSize = 2; <font class="keywordflow">break</font>;
00183     <font class="keywordflow">case</font> AL_FORMAT_STEREO16: m_SampleSize = 4; <font class="keywordflow">break</font>;
00184   }
00185 
00186   m_LastSample = <font class="keyword">new</font> ALubyte[m_SampleSize];
00187   memset(m_LastSample, 0, m_SampleSize);
00188 
00189   m_ALSource = al_source;
00190   m_Buffers  = buffers;
00191 
00192   m_IsPlaying = <font class="keyword">false</font>;
00193   m_Volume    = ADR_VOLUME_MAX;
00194 
00195   <font class="comment">// calculate the desired length (in samples) of each buffer</font>
00196   m_BufferLength = BUFFER_MILLISECONDS * m_SampleRate / 1000;
00197 
00198   FillBuffers();
00199 
00200   <font class="comment">// queue up the source's buffers</font>
00201   alSourceQueueBuffers(m_ALSource, BUFFER_COUNT, m_Buffers);
00202 }
00203 
00205 
00206 ALOutputStream::~ALOutputStream()<font class="keyword"></font>
00207 <font class="keyword"></font>{
00208   <font class="comment">// remove ourself from the list</font>
00209   ALOutputContext::StreamList::iterator i = m_Context-&gt;m_OpenStreams.begin();
00210   <font class="keywordflow">while</font> (i != m_Context-&gt;m_OpenStreams.end()) {
00211     <font class="keywordflow">if</font> (*i == <font class="keyword">this</font>) {
00212       m_Context-&gt;m_OpenStreams.erase(i);
00213       <font class="keywordflow">break</font>;
00214     }
00215     ++i;
00216   }
00217 
00218   alDeleteSources(1, &amp;m_ALSource);
00219   alDeleteBuffers(BUFFER_COUNT, m_Buffers);
00220   <font class="keyword">delete</font>[] m_Buffers;
00221   <font class="keyword">delete</font>[] m_LastSample;
00222 }
00223 
00225 
00226 <font class="keywordtype">void</font>
00227 ALOutputStream::Update()<font class="keyword"></font>
00228 <font class="keyword"></font>{
00229   <font class="comment">// are there any buffers that have been processed?</font>
00230   ALint processed_buffers;
00231 <font class="preprocessor">#ifdef _WIN32 // XXX more OpenAL hacks</font>
00232 <font class="preprocessor"></font>  alGetSourcei(m_ALSource, AL_BUFFERS_PROCESSED, &amp;processed_buffers);
00233 <font class="preprocessor">#else</font>
00234 <font class="preprocessor"></font>  alGetSourceiv(m_ALSource, AL_BUFFERS_PROCESSED, &amp;processed_buffers);
00235 <font class="preprocessor">#endif</font>
00236 <font class="preprocessor"></font>
00237   <font class="comment">// don't do any allocations if we don't need to</font>
00238   <font class="keywordflow">if</font> (processed_buffers == 0) {
00239     <font class="keywordflow">return</font>;
00240   }
00241 
00242   <font class="keywordtype">int</font> read_size_samples = m_BufferLength;
00243   <font class="keywordtype">int</font> read_size_bytes = read_size_samples * m_SampleSize;
00244   ALubyte* sample_buffer = <font class="keyword">new</font> ALubyte[read_size_bytes];
00245 
00246   <font class="keywordtype">int</font> buffer_length_bytes = read_size_bytes;
00247   <font class="keywordflow">while</font> (processed_buffers--) {
00248 
00249     <font class="keywordflow">if</font> (Read(sample_buffer, read_size_samples) == 0) {
00250       Stop();
00251       <font class="keywordflow">break</font>;
00252     }
00253 
00254     <font class="comment">// unqueue/refill/queue</font>
00255     ALuint buffer;
00256     alSourceUnqueueBuffers(m_ALSource, 1, &amp;buffer);
00257 
00258     alBufferData(
00259       buffer,
00260       m_Format,
00261       sample_buffer,
00262       buffer_length_bytes,
00263       m_SampleRate);
00264 
00265     alSourceQueueBuffers(m_ALSource, 1, &amp;buffer);
00266   }
00267 
00268   <font class="keyword">delete</font>[] sample_buffer;
00269 
00270   <a class="code" href="threads__win32_8cpp.html#a2">AI_Sleep</a>(50);
00271 }
00272 
00274 
00275 <font class="keywordtype">int</font>
00276 ALOutputStream::Read(<font class="keywordtype">void</font>* samples, <font class="keywordtype">int</font> sample_count)<font class="keyword"></font>
00277 <font class="keyword"></font>{
00278   <font class="comment">// try to read from the stream</font>
00279   <font class="keywordtype">int</font> samples_read = m_Source-&gt;Read(sample_count, samples);
00280 
00281   <font class="comment">// read the last sample</font>
00282   <font class="keywordflow">if</font> (samples_read &gt; 0) {
00283     memcpy(
00284       m_LastSample,
00285       (ALubyte*)samples + (samples_read - 1) * m_SampleSize,
00286       m_SampleSize
00287     );
00288   }
00289 
00290   <font class="comment">// fill the rest with silence</font>
00291   ALubyte* out = (ALubyte*)samples + m_SampleSize * samples_read;
00292   <font class="keywordtype">int</font> c = sample_count - samples_read;
00293   <font class="keywordflow">while</font> (c--) {
00294     memcpy(out, m_LastSample, m_SampleSize);
00295     out += m_SampleSize;
00296   }
00297 
00298   <font class="keywordflow">return</font> samples_read;
00299 }
00300 
00302 
00303 <font class="keywordtype">void</font>
00304 ALOutputStream::FillBuffers()<font class="keyword"></font>
00305 <font class="keyword"></font>{
00306   <font class="keywordtype">int</font> samples_to_read = m_BufferLength * BUFFER_COUNT;
00307   <font class="keywordtype">int</font> allocate = samples_to_read * m_SampleSize;
00308   ALubyte* sample_buffer = <font class="keyword">new</font> ALubyte[allocate];
00309   Read(sample_buffer, samples_to_read);
00310    
00311   <font class="comment">// stick the data into the buffers</font>
00312   ALubyte* samples = sample_buffer;
00313   ALuint*  buffer  = m_Buffers;
00314 
00315   <font class="keywordflow">for</font> (<font class="keywordtype">int</font> i = 0; i &lt; BUFFER_COUNT; i++) {
00316       
00317     alBufferData(
00318       *buffer,
00319       m_Format,
00320       samples,
00321       m_BufferLength * m_SampleSize,
00322       m_SampleRate);
00323 
00324     samples += m_BufferLength * m_SampleSize;
00325     buffer++;
00326   }
00327 
00328   <font class="keyword">delete</font>[] sample_buffer;
00329 }
00330 
00332 
00333 <font class="keywordtype">void</font>
00334 <a class="code" href="classALOutputStream.html#a0">ALOutputStream::Play</a>()<font class="keyword"></font>
00335 <font class="keyword"></font>{
00336   alSourcePlay(m_ALSource);
00337   m_IsPlaying = <font class="keyword">true</font>;
00338 }
00339 
00341 
00342 <font class="keywordtype">void</font>
00343 <a class="code" href="classALOutputStream.html#a1">ALOutputStream::Stop</a>()<font class="keyword"></font>
00344 <font class="keyword"></font>{
00345   alSourcePause(m_ALSource);
00346   m_IsPlaying = <font class="keyword">false</font>;
00347 }
00348 
00350 
00351 <font class="keywordtype">void</font>
00352 <a class="code" href="classALOutputStream.html#a2">ALOutputStream::Reset</a>()<font class="keyword"></font>
00353 <font class="keyword"></font>{
00354   <font class="keywordtype">bool</font> is_playing = IsPlaying();
00355   <font class="keywordflow">if</font> (is_playing) {
00356     Stop();
00357   }
00358 
00359   <font class="comment">// reset stream</font>
00360 
00361   <font class="keywordflow">if</font> (is_playing) {
00362     Play();
00363   }
00364 }
00365 
00367 
00368 <font class="keywordtype">bool</font>
00369 <a class="code" href="classALOutputStream.html#a3">ALOutputStream::IsPlaying</a>()<font class="keyword"></font>
00370 <font class="keyword"></font>{
00371   <font class="keywordflow">return</font> m_IsPlaying;
00372 }
00373 
00375 
00376 <font class="keywordtype">void</font>
00377 <a class="code" href="classALOutputStream.html#a4">ALOutputStream::SetVolume</a>(<font class="keywordtype">int</font> volume)<font class="keyword"></font>
00378 <font class="keyword"></font>{
00379   m_Volume = volume;
00380 
00381   <font class="keywordtype">float</font> v = (<font class="keywordtype">float</font>)m_Volume / ADR_VOLUME_MAX;
00382   alSourcef(m_ALSource, AL_GAIN, v);
00383 }
00384 
00386 
00387 <font class="keywordtype">int</font>
00388 <a class="code" href="classALOutputStream.html#a5">ALOutputStream::GetVolume</a>()<font class="keyword"></font>
00389 <font class="keyword"></font>{
00390   <font class="keywordflow">return</font> m_Volume;
00391 }
00392 
00394 
00395 <font class="preprocessor">#endif // WITH_OPENAL</font>
</font></pre></div><hr><address><small>Generated at Mon Jun 10 02:55:12 2002 for audiere by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.8.1 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2001</small></address>
</body>
</html>
