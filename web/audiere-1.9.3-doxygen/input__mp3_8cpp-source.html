<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>input_mp3.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc1 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>input_mp3.cpp</h1><a href="input__mp3_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment">  THIS IS WRITTEN FOR CHAD AUSTIN FOR AUDIERE</span>
00003 <span class="comment">  By Jacky Chong</span>
00004 <span class="comment"></span>
00005 <span class="comment">  In short, this is some wierd shit I wrote up because Chad</span>
00006 <span class="comment">  didn't want to touch this. Also, I have no idea what I've</span>
00007 <span class="comment">  done as well to get it work as well.</span>
00008 <span class="comment"></span>
00009 <span class="comment">  I've since done a bunch of work on it.  :)  -Chad</span>
00010 <span class="comment">*/</span>
00011 
00012 <span class="preprocessor">#include &lt;string.h&gt;</span>
00013 <span class="preprocessor">#include "<a class="code" href="input__mp3_8h.html">input_mp3.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="utility_8h.html">utility.h</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="debug_8h.html">debug.h</a>"</span>
00016 
00017 
00018 <span class="comment">// The number of MP3 frame that are processed at a time.  If this value</span>
00019 <span class="comment">// is smaller, the decoder should take less memory.  However, it may</span>
00020 <span class="comment">// skip on corrupt MP3s.</span>
00021 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> FRAME_COUNT = 10;
00022 
00023 
00024 <span class="keyword">namespace </span>audiere {
00025 
<a name="l00026"></a><a class="code" href="classaudiere_1_1MyLoader.html">00026</a> 
00027   <span class="keyword">class </span><a class="code" href="classaudiere_1_1MyLoader.html">MyLoader</a> : <span class="keyword">public</span> Soundinputstream {
<a name="l00028"></a><a class="code" href="classaudiere_1_1MyLoader.html#a0">00028</a>   <span class="keyword">public</span>:
00029     <a class="code" href="classaudiere_1_1MyLoader.html#a0">MyLoader</a>(<a class="code" href="namespaceaudiere.html#a0">FilePtr</a> file) {
00030       m_file = file;
00031       m_eof = <span class="keyword">false</span>;
00032     }
<a name="l00033"></a><a class="code" href="classaudiere_1_1MyLoader.html#a1">00033</a> 
00034     <span class="keywordtype">int</span> <a class="code" href="classaudiere_1_1MyLoader.html#a1">getbytedirect</a>() {
00035       <a class="code" href="namespaceaudiere.html#a33">u8</a> b;
00036       <span class="keywordflow">if</span> (m_file-&gt;read(&amp;b, 1) == 1) {
00037         <span class="keywordflow">return</span> b;
00038       } <span class="keywordflow">else</span> {
00039         seterrorcode(SOUND_ERROR_FILEREADFAIL);
00040         m_eof = <span class="keyword">true</span>;
00041         <span class="keywordflow">return</span> -1;
00042       }
00043     }
<a name="l00044"></a><a class="code" href="classaudiere_1_1MyLoader.html#a2">00044</a> 
00045     <span class="keywordtype">bool</span> <a class="code" href="classaudiere_1_1MyLoader.html#a2">_readbuffer</a>(<span class="keywordtype">char</span>* buffer, <span class="keywordtype">int</span> <a class="code" href="namespaceaudiere_1_1hidden.html#a10">size</a>) {
00046       <span class="keywordflow">if</span> (m_file-&gt;read(buffer, <a class="code" href="namespaceaudiere_1_1hidden.html#a10">size</a>) == <a class="code" href="namespaceaudiere_1_1hidden.html#a10">size</a>) {
00047         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00048       } <span class="keywordflow">else</span> {
00049         seterrorcode(SOUND_ERROR_FILEREADFAIL);
00050         m_eof = <span class="keyword">true</span>;
00051         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00052       }
00053     }
<a name="l00054"></a><a class="code" href="classaudiere_1_1MyLoader.html#a3">00054</a> 
00055     <span class="keywordtype">bool</span> <a class="code" href="classaudiere_1_1MyLoader.html#a3">eof</a>() {
00056       <span class="keywordflow">return</span> m_eof;
00057     }
<a name="l00058"></a><a class="code" href="classaudiere_1_1MyLoader.html#a4">00058</a> 
00059     <span class="keywordtype">int</span> <a class="code" href="classaudiere_1_1MyLoader.html#a4">getblock</a>(<span class="keywordtype">char</span>* buffer, <span class="keywordtype">int</span> <a class="code" href="namespaceaudiere_1_1hidden.html#a10">size</a>) {
00060       <span class="keywordtype">int</span> read = m_file-&gt;read(buffer, <a class="code" href="namespaceaudiere_1_1hidden.html#a10">size</a>);
00061       <span class="keywordflow">if</span> (read != <a class="code" href="namespaceaudiere_1_1hidden.html#a10">size</a>) {
00062         m_eof = <span class="keyword">true</span>;
00063       }
00064       <span class="keywordflow">return</span> read;
00065     }
<a name="l00066"></a><a class="code" href="classaudiere_1_1MyLoader.html#a5">00066</a> 
00067     <span class="keywordtype">int</span> <a class="code" href="classaudiere_1_1MyLoader.html#a5">getsize</a>() {
00068       <span class="keywordtype">int</span> pos = m_file-&gt;tell();
00069       m_file-&gt;seek(0, File::END);
00070       <span class="keywordtype">int</span> <a class="code" href="namespaceaudiere_1_1hidden.html#a10">size</a> = m_file-&gt;tell();
00071       m_file-&gt;seek(pos, File::BEGIN);
00072       <span class="keywordflow">return</span> <a class="code" href="namespaceaudiere_1_1hidden.html#a10">size</a>;
00073     }
<a name="l00074"></a><a class="code" href="classaudiere_1_1MyLoader.html#a6">00074</a> 
00075     <span class="keywordtype">void</span> <a class="code" href="classaudiere_1_1MyLoader.html#a6">setposition</a>(<span class="keywordtype">int</span> pos) {
00076       m_file-&gt;seek(pos, File::BEGIN);
00077       m_eof = <span class="keyword">false</span>;
00078     }
<a name="l00079"></a><a class="code" href="classaudiere_1_1MyLoader.html#a7">00079</a> 
00080     <span class="keywordtype">int</span> <a class="code" href="classaudiere_1_1MyLoader.html#a7">getposition</a>() {
00081       <span class="keywordflow">return</span> m_file-&gt;tell();
00082     }
00083 
00084   <span class="keyword">private</span>:
00085     <a class="code" href="namespaceaudiere.html#a0">FilePtr</a> m_file;
00086     <span class="keywordtype">bool</span> m_eof;
00087   };
00088 
<a name="l00089"></a><a class="code" href="classaudiere_1_1MP3InputStream.html#a0">00089</a> 
00090   MP3InputStream::MP3InputStream() {
00091     m_file = 0;
00092 
00093     m_channel_count = 2;
00094     m_sample_rate = 44100;
00095     m_sample_format = <a class="code" href="namespaceaudiere.html#a105a8">SF_S16</a>;
00096 
00097     m_decoder = 0;
00098     m_loader = 0;
00099   }
00100 
<a name="l00101"></a><a class="code" href="classaudiere_1_1MP3InputStream.html#a1">00101</a>   
00102   MP3InputStream::~MP3InputStream() {
00103     <span class="keyword">delete</span> m_decoder;
00104     <span class="keyword">delete</span> m_loader;
00105   }
00106 
00107 
<a name="l00108"></a><a class="code" href="classaudiere_1_1MP3InputStream.html#a2">00108</a>   <span class="keywordtype">bool</span>
00109   MP3InputStream::initialize(<a class="code" href="namespaceaudiere.html#a0">FilePtr</a> file) {
00110     m_file = file;
00111     m_loader = <span class="keyword">new</span> <a class="code" href="classaudiere_1_1MyLoader.html">MyLoader</a>(file);
00112     m_decoder = <span class="keyword">new</span> Mpegtoraw(m_loader, <span class="keyword">this</span>);
00113 
00114     m_decoder-&gt;initialize();
00115 
00116     <span class="comment">// this should call setsoundtype with the format of the stream</span>
00117     <span class="keywordflow">if</span> (!m_decoder-&gt;run(FRAME_COUNT)) {
00118       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00119     }
00120 
00121     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00122   }
00123 
00124 
<a name="l00125"></a><a class="code" href="classaudiere_1_1MP3InputStream.html#a3">00125</a>   <span class="keywordtype">void</span>
00126   MP3InputStream::getFormat(
00127     <span class="keywordtype">int</span>&amp; channel_count, 
00128     <span class="keywordtype">int</span>&amp; sample_rate, 
00129     <a class="code" href="namespaceaudiere.html#a105">SampleFormat</a>&amp; <a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a>) 
00130   {
00131     channel_count = m_channel_count;
00132     sample_rate = m_sample_rate;
00133     <a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a> = m_sample_format;
00134   }
00135 
00136   
<a name="l00137"></a><a class="code" href="classaudiere_1_1MP3InputStream.html#a4">00137</a>   <span class="keywordtype">int</span>
00138   MP3InputStream::doRead(<span class="keywordtype">int</span> frame_count, <span class="keywordtype">void</span>* samples) {
00139     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"MP3InputStream::doRead"</span>);
00140 
00141     <span class="keyword">const</span> <span class="keywordtype">int</span> frame_size = m_channel_count * <a class="code" href="namespaceaudiere.html#a45">GetSampleSize</a>(m_sample_format);
00142 
00143     <span class="keywordtype">int</span> frames_read = 0;
00144     <a class="code" href="namespaceaudiere.html#a33">u8</a>* out = (<a class="code" href="namespaceaudiere.html#a33">u8</a>*)samples;
00145 
00146     <span class="keywordflow">while</span> (frames_read &lt; frame_count) {
00147 
00148       <span class="comment">// no more samples?  ask the MP3 for more</span>
00149       <span class="keywordflow">if</span> (m_buffer.<a class="code" href="classaudiere_1_1QueueBuffer.html#a2">getSize</a>() &lt; frame_size) {
00150         <span class="keywordflow">if</span> (!m_decoder-&gt;run(FRAME_COUNT)) {
00151           <span class="comment">// done decoding?</span>
00152           <span class="keywordflow">return</span> frames_read;
00153         }
00154 
00155         <span class="comment">// if the buffer is still empty, we are done</span>
00156         <span class="keywordflow">if</span> (m_buffer.<a class="code" href="classaudiere_1_1QueueBuffer.html#a2">getSize</a>() &lt; frame_size) {
00157           <span class="keywordflow">return</span> frames_read;
00158         }
00159       }
00160 
00161       <span class="keyword">const</span> <span class="keywordtype">int</span> frames_left = frame_count - frames_read;
00162       <span class="keyword">const</span> <span class="keywordtype">int</span> frames_to_read = std::min(
00163         frames_left,
00164         m_buffer.<a class="code" href="classaudiere_1_1QueueBuffer.html#a2">getSize</a>() / frame_size);
00165 
00166       m_buffer.<a class="code" href="classaudiere_1_1QueueBuffer.html#a4">read</a>(out, frames_to_read * frame_size);
00167       out += frames_to_read * frame_size;
00168       frames_read += frames_to_read;
00169     }
00170 
00171     <span class="keywordflow">return</span> frames_read;
00172   }
00173 
00174 
<a name="l00175"></a><a class="code" href="classaudiere_1_1MP3InputStream.html#a5">00175</a>   <span class="keywordtype">void</span>
00176   MP3InputStream::reset() {
00177     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"MP3InputStream::reset"</span>);
00178 
00179     m_file-&gt;seek(0, File::BEGIN);
00180 
00181     m_buffer.<a class="code" href="classaudiere_1_1QueueBuffer.html#a5">clear</a>();
00182     m_channel_count = 2;
00183     m_sample_rate = 44100;
00184     m_sample_format = <a class="code" href="namespaceaudiere.html#a105a8">SF_S16</a>;
00185 
00186     <span class="keyword">delete</span> m_decoder;
00187     <span class="keyword">delete</span> m_loader;
00188 
00189     m_loader = <span class="keyword">new</span> <a class="code" href="classaudiere_1_1MyLoader.html">MyLoader</a>(m_file.get());
00190     m_decoder = <span class="keyword">new</span> Mpegtoraw(m_loader, <span class="keyword">this</span>);
00191 
00192     m_decoder-&gt;initialize();
00193 
00194     <span class="comment">// this should call setsoundtype with the format of the stream</span>
00195     <span class="keywordflow">if</span> (!m_decoder-&gt;run(FRAME_COUNT)) {
00196       <span class="keywordflow">return</span>;
00197     }
00198   }
00199 
00200 
<a name="l00201"></a><a class="code" href="classaudiere_1_1MP3InputStream.html#a6">00201</a>   <span class="keywordtype">bool</span>
00202   MP3InputStream::setsoundtype(<span class="keywordtype">int</span> stereo, <span class="keywordtype">int</span> samplesize, <span class="keywordtype">int</span> speed) {
00203     m_channel_count = (stereo ? 2 : 1);
00204     m_sample_rate = speed;
00205 
00206     <span class="keywordflow">if</span> (samplesize == 8) {
00207       m_sample_format = <a class="code" href="namespaceaudiere.html#a105a7">SF_U8</a>;
00208     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (samplesize == 16) {
00209       m_sample_format = <a class="code" href="namespaceaudiere.html#a105a8">SF_S16</a>;
00210     } <span class="keywordflow">else</span> {
00211       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00212     }
00213 
00214     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00215   }
00216 
00217 
<a name="l00218"></a><a class="code" href="classaudiere_1_1MP3InputStream.html#a7">00218</a>   <span class="keywordtype">bool</span>
00219   MP3InputStream::putblock(<span class="keywordtype">void</span>* buffer, <span class="keywordtype">int</span> <a class="code" href="namespaceaudiere_1_1hidden.html#a10">size</a>) {
00220     m_buffer.<a class="code" href="classaudiere_1_1QueueBuffer.html#a3">write</a>(buffer, <a class="code" href="namespaceaudiere_1_1hidden.html#a10">size</a>);
00221     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00222   }
00223 
00224 }
</pre></div><hr><address style="align: right;"><small>Generated on Tue Jul 15 12:36:49 2003 for audiere by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc1 </small></address>
</body>
</html>
