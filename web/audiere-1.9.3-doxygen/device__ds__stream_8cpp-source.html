<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>device_ds_stream.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc1 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>device_ds_stream.cpp</h1><a href="device__ds__stream_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="preprocessor">#include "<a class="code" href="device__ds__stream_8h.html">device_ds_stream.h</a>"</span>
00002 <span class="preprocessor">#include "<a class="code" href="device__ds_8h.html">device_ds.h</a>"</span>
00003 <span class="preprocessor">#include "<a class="code" href="debug_8h.html">debug.h</a>"</span>
00004 
00005 
00006 <span class="keyword">namespace </span>audiere {
<a name="l00007"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a0">00007</a> 
00008   DSOutputStream::DSOutputStream(
00009     <a class="code" href="classaudiere_1_1DSAudioDevice.html">DSAudioDevice</a>* device,
00010     IDirectSoundBuffer* buffer,
00011     <span class="keywordtype">int</span> buffer_length,
00012     <a class="code" href="classaudiere_1_1SampleSource.html">SampleSource</a>* source)
00013   {
00014     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"DSOutputStream::DSOutputStream"</span>);
00015 
00016     m_device = device;
00017 
00018     m_buffer        = buffer;
00019     m_buffer_length = buffer_length;
00020     m_next_read     = 0;
00021     m_last_play     = 0;
00022 
00023     DWORD frequency;
00024     m_buffer-&gt;GetFrequency(&amp;frequency);
00025     m_base_frequency = frequency;
00026 
00027     m_is_playing = <span class="keyword">false</span>;
00028 
00029     m_source = source;
00030 
00031     m_frame_size = <a class="code" href="namespaceaudiere.html#a96">GetFrameSize</a>(m_source);
00032 
00033     m_total_read   = 0;
00034     m_total_played = 0;
00035 
00036     m_last_frame = <span class="keyword">new</span> BYTE[m_frame_size];
00037 
00038     <a class="code" href="classaudiere_1_1DSOutputStream.html#a8">setVolume</a>(1);
00039     <a class="code" href="classaudiere_1_1DSOutputStream.html#a10">setPan</a>(0);
00040 
00041     <span class="comment">// fill the buffer with data</span>
00042     fillStream();
00043   }
00044 
<a name="l00045"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a1">00045</a> 
00046   DSOutputStream::~DSOutputStream() {
00047     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"DSOutputStream::~DSOutputStream"</span>);
00048 
00049     m_device-&gt;removeStream(<span class="keyword">this</span>);
00050 
00051     <span class="comment">// destroy the sound buffer interface</span>
00052     m_buffer-&gt;Release();
00053     <span class="keyword">delete</span>[] m_last_frame;
00054   }
00055 
00056   
<a name="l00057"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a2">00057</a>   <span class="keywordtype">void</span>
00058   DSOutputStream::play() {
00059     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"DSOutputStream::play"</span>);
00060     m_buffer-&gt;Play(0, 0, DSBPLAY_LOOPING);
00061     m_is_playing = <span class="keyword">true</span>;
00062   }
00063 
00064 
<a name="l00065"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a3">00065</a>   <span class="keywordtype">void</span>
00066   DSOutputStream::stop() {
00067     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"DSOutputStream::stop"</span>);
00068     m_buffer-&gt;Stop();
00069     m_is_playing = <span class="keyword">false</span>;
00070   }
00071 
00072 
<a name="l00073"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a4">00073</a>   <span class="keywordtype">bool</span>
00074   DSOutputStream::isPlaying() {
00075     <span class="keywordflow">return</span> m_is_playing;
00076   }
00077 
00078 
<a name="l00079"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a5">00079</a>   <span class="keywordtype">void</span>
00080   DSOutputStream::reset() {
00081     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"DSOutputStream::reset"</span>);
00082     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(<span class="keyword">this</span>);
00083     doReset();
00084   }
00085 
00086 
<a name="l00087"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a6">00087</a>   <span class="keywordtype">void</span>
00088   DSOutputStream::setRepeat(<span class="keywordtype">bool</span> repeat) {
00089     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(<span class="keyword">this</span>);
00090     m_source-&gt;setRepeat(repeat);
00091     <span class="keywordflow">if</span> (!<a class="code" href="classaudiere_1_1DSOutputStream.html#a4">isPlaying</a>()) {
00092       doReset();
00093     }
00094   }
00095 
00096 
<a name="l00097"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a7">00097</a>   <span class="keywordtype">bool</span>
00098   DSOutputStream::getRepeat() {
00099     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(<span class="keyword">this</span>);
00100     <span class="keywordflow">return</span> m_source-&gt;getRepeat();
00101   }
00102 
00103 
<a name="l00104"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a8">00104</a>   <span class="keywordtype">void</span>
00105   DSOutputStream::setVolume(<span class="keywordtype">float</span> volume) {
00106     m_volume = volume;
00107     m_buffer-&gt;SetVolume(DSAudioDevice::Volume_AudiereToDirectSound(volume));
00108   }
00109 
00110 
<a name="l00111"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a9">00111</a>   <span class="keywordtype">float</span>
00112   DSOutputStream::getVolume() {
00113     <span class="keywordflow">return</span> m_volume;
00114   }
00115 
00116 
<a name="l00117"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a10">00117</a>   <span class="keywordtype">void</span>
00118   DSOutputStream::setPan(<span class="keywordtype">float</span> pan) {
00119     m_pan = pan;
00120     m_buffer-&gt;SetPan(DSAudioDevice::Pan_AudiereToDirectSound(pan));
00121   }
00122 
00123 
<a name="l00124"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a11">00124</a>   <span class="keywordtype">float</span>
00125   DSOutputStream::getPan() {
00126     <span class="keywordflow">return</span> m_pan;
00127   }
00128 
00129 
<a name="l00130"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a12">00130</a>   <span class="keywordtype">void</span>
00131   DSOutputStream::setPitchShift(<span class="keywordtype">float</span> shift) {
00132     m_buffer-&gt;SetFrequency(DWORD(m_base_frequency * shift));
00133   }
00134 
00135 
<a name="l00136"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a13">00136</a>   <span class="keywordtype">float</span>
00137   DSOutputStream::getPitchShift() {
00138     DWORD frequency;
00139     m_buffer-&gt;GetFrequency(&amp;frequency);
00140     <span class="keywordflow">return</span> float(frequency) / m_base_frequency;
00141   }
00142   
00143 
<a name="l00144"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a14">00144</a>   <span class="keywordtype">bool</span>
00145   DSOutputStream::isSeekable() {
00146     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(<span class="keyword">this</span>);
00147     <span class="keywordflow">return</span> m_source-&gt;isSeekable();
00148   }
00149 
00150 
<a name="l00151"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a15">00151</a>   <span class="keywordtype">int</span>
00152   DSOutputStream::getLength() {
00153     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(<span class="keyword">this</span>);
00154     <span class="keywordflow">return</span> m_source-&gt;getLength();
00155   }
00156 
00157 
<a name="l00158"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a16">00158</a>   <span class="keywordtype">void</span>
00159   DSOutputStream::setPosition(<span class="keywordtype">int</span> position) {
00160     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(<span class="keyword">this</span>);
00161 
00162     <span class="comment">// figure out if we're playing or not</span>
00163     <span class="keywordtype">bool</span> is_playing = <a class="code" href="classaudiere_1_1DSOutputStream.html#a4">isPlaying</a>();
00164 
00165     <span class="comment">// if we're playing, stop</span>
00166     <span class="keywordflow">if</span> (is_playing) {
00167       <a class="code" href="classaudiere_1_1DSOutputStream.html#a3">stop</a>();
00168     }
00169 
00170     m_source-&gt;setPosition(position);
00171     m_last_play = 0;
00172 
00173     m_source-&gt;setPosition(position);
00174     m_total_read   = 0;
00175     m_total_played = 0;
00176     m_next_read    = 0;
00177     fillStream();
00178 
00179     <span class="comment">// if we were playing, restart</span>
00180     <span class="keywordflow">if</span> (is_playing) {
00181       <a class="code" href="classaudiere_1_1DSOutputStream.html#a2">play</a>();
00182     }
00183   }
00184 
00185 
<a name="l00186"></a><a class="code" href="classaudiere_1_1DSOutputStream.html#a17">00186</a>   <span class="keywordtype">int</span>
00187   DSOutputStream::getPosition() {
00188     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(<span class="keyword">this</span>);
00189     <span class="keywordtype">int</span> pos = m_source-&gt;getPosition() - (m_total_read - m_total_played);
00190     <span class="keywordflow">while</span> (pos &lt; 0) {
00191       pos += m_source-&gt;getLength();
00192     }
00193     <span class="keywordflow">return</span> pos;
00194   }
00195 
00196 
00197   <span class="keywordtype">void</span>
00198   DSOutputStream::doReset() {
00199     <span class="comment">// figure out if we're playing or not</span>
00200     <span class="keywordtype">bool</span> is_playing = <a class="code" href="classaudiere_1_1DSOutputStream.html#a4">isPlaying</a>();
00201 
00202     <span class="comment">// if we're playing, stop</span>
00203     <span class="keywordflow">if</span> (is_playing) {
00204       <a class="code" href="classaudiere_1_1DSOutputStream.html#a3">stop</a>();
00205     }
00206 
00207     m_buffer-&gt;SetCurrentPosition(0);
00208     m_last_play = 0;
00209 
00210     m_source-&gt;reset();
00211     m_total_read   = 0;
00212     m_total_played = 0;
00213     m_next_read    = 0;
00214     fillStream();
00215 
00216     <span class="comment">// if we were playing, restart</span>
00217     <span class="keywordflow">if</span> (is_playing) {
00218       <a class="code" href="classaudiere_1_1DSOutputStream.html#a2">play</a>();
00219     }
00220   }
00221 
00222 
00223   <span class="keywordtype">void</span>
00224   DSOutputStream::fillStream() {
00225     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"DSOutputStream::fillStream"</span>);
00226 
00227     <span class="comment">// we know the stream is stopped, so just lock the buffer and fill it</span>
00228 
00229     <span class="keywordtype">void</span>* buffer = NULL;
00230     DWORD buffer_length = 0;
00231 
00232     <span class="comment">// lock</span>
00233     HRESULT result = m_buffer-&gt;Lock(
00234       0,
00235       m_buffer_length * m_frame_size,
00236       &amp;buffer,
00237       &amp;buffer_length,
00238       NULL,
00239       NULL,
00240       0);
00241     <span class="keywordflow">if</span> (FAILED(result) || !buffer) {
00242       <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"FillStream failed!"</span>);
00243       <span class="keywordflow">return</span>;
00244     }
00245 
00246     <a class="code" href="debug_8h.html#a2">ADR_IF_DEBUG</a> {
00247       <span class="keywordtype">char</span> str[80];
00248       sprintf(str, <span class="stringliteral">"Buffer Length = %d"</span>, buffer_length);
00249       <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(str);
00250     }
00251 
00252     <span class="comment">// fill</span>
00253     <span class="keywordtype">int</span> samples_to_read = buffer_length / m_frame_size;
00254     <span class="keywordtype">int</span> samples_read = streamRead(samples_to_read, buffer);
00255     <span class="keywordflow">if</span> (samples_read != samples_to_read) {
00256       m_next_read = samples_read;
00257     } <span class="keywordflow">else</span> {
00258       m_next_read = 0;
00259     }
00260 
00261     <a class="code" href="debug_8h.html#a2">ADR_IF_DEBUG</a> {
00262       <span class="keywordtype">char</span> str[80];
00263       sprintf(str, <span class="stringliteral">"samples_to_read = %d"</span>, samples_to_read); <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(str);
00264       sprintf(str, <span class="stringliteral">"samples_read    = %d"</span>, samples_read);    <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(str);
00265       sprintf(str, <span class="stringliteral">"m_next_read     = %d"</span>, m_next_read);     <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(str);
00266     }
00267 
00268     <span class="comment">// unlock</span>
00269     m_buffer-&gt;Unlock(buffer, buffer_length, NULL, 0);
00270   }
00271 
00272 
00273   <span class="keywordtype">void</span>
00274   DSOutputStream::update() {
00275     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(<span class="keyword">this</span>);
00276 
00277     <span class="comment">// if it's not playing, don't do anything</span>
00278     <span class="keywordflow">if</span> (!<a class="code" href="classaudiere_1_1DSOutputStream.html#a4">isPlaying</a>()) {
00279       <span class="keywordflow">return</span>;
00280     }
00281 
00282     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"DSOutputStream::update"</span>);
00283 
00284     <span class="comment">/* this method reads more PCM data into the stream if it is required */</span>
00285 
00286     <span class="comment">// read the stream's play and write cursors</span>
00287     DWORD <a class="code" href="classaudiere_1_1DSOutputStream.html#a2">play</a>, write;
00288     HRESULT result = m_buffer-&gt;GetCurrentPosition(&amp;<a class="code" href="classaudiere_1_1DSOutputStream.html#a2">play</a>, &amp;write);
00289     <span class="keywordflow">if</span> (FAILED(result)) {
00290       <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"GetCurrentPosition failed"</span>);
00291       <span class="keywordflow">return</span>;
00292     }
00293 
00294     <span class="comment">// deal with them in samples, not bytes</span>
00295     <a class="code" href="classaudiere_1_1DSOutputStream.html#a2">play</a>  /= m_frame_size;
00296     write /= m_frame_size;
00297 
00298     <a class="code" href="debug_8h.html#a2">ADR_IF_DEBUG</a> {
00299       <span class="keywordtype">char</span> str[160];
00300       sprintf(str,
00301         <span class="stringliteral">"play: %d  write: %d  nextread: %d"</span>,
00302         <a class="code" href="classaudiere_1_1DSOutputStream.html#a2">play</a>, write, m_next_read);
00303       <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(str);
00304     }
00305 
00306     <span class="comment">// how many samples have we playen since the last update?</span>
00307     <span class="keywordflow">if</span> (<a class="code" href="classaudiere_1_1DSOutputStream.html#a2">play</a> &lt; m_last_play) {
00308       m_total_played += <a class="code" href="classaudiere_1_1DSOutputStream.html#a2">play</a> + m_buffer_length - m_last_play;
00309     } <span class="keywordflow">else</span> {
00310       m_total_played += <a class="code" href="classaudiere_1_1DSOutputStream.html#a2">play</a> - m_last_play;
00311     }
00312     m_last_play = <a class="code" href="classaudiere_1_1DSOutputStream.html#a2">play</a>;
00313 
00314     <span class="comment">// read from |m_next_read| to |play|</span>
00315     <span class="keywordtype">int</span> read_length = <a class="code" href="classaudiere_1_1DSOutputStream.html#a2">play</a> - m_next_read;
00316     <span class="keywordflow">if</span> (read_length &lt; 0) {
00317       read_length += m_buffer_length;
00318     }
00319 
00320     <span class="keywordflow">if</span> (read_length == 0) {
00321       <span class="keywordflow">return</span>;
00322     }
00323 
00324     <span class="comment">// lock the buffer</span>
00325     <span class="keywordtype">void</span>* buffer1;
00326     <span class="keywordtype">void</span>* buffer2;
00327     DWORD buffer1_length;
00328     DWORD buffer2_length;
00329     result = m_buffer-&gt;Lock(
00330       m_next_read * m_frame_size,
00331       read_length * m_frame_size,
00332       &amp;buffer1, &amp;buffer1_length,
00333       &amp;buffer2, &amp;buffer2_length,
00334       0);
00335     <span class="keywordflow">if</span> (FAILED(result)) {
00336       <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"Lock() failed!"</span>);
00337       <span class="keywordflow">return</span>;
00338     }
00339 
00340     <a class="code" href="debug_8h.html#a2">ADR_IF_DEBUG</a> {
00341       <span class="keywordtype">char</span> str[160];
00342       sprintf(str, <span class="stringliteral">"buffer1: %d  buffer2: %d"</span>, buffer1_length, buffer2_length);
00343       <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(str);
00344     }
00345 
00346     <span class="comment">// now actually read samples</span>
00347     <span class="keywordtype">int</span> length1 = buffer1_length / m_frame_size;
00348     <span class="keywordtype">int</span> length2 = buffer2_length / m_frame_size;
00349     <span class="keywordtype">int</span> read = streamRead(length1, buffer1);
00350     <span class="keywordflow">if</span> (buffer2) {
00351       <span class="keywordflow">if</span> (length1 == read) {
00352         read += streamRead(length2, buffer2);
00353       } <span class="keywordflow">else</span> {
00354         fillSilence(length2, buffer2);
00355       }
00356     }
00357 
00358     <a class="code" href="debug_8h.html#a2">ADR_IF_DEBUG</a> {
00359       <span class="keywordtype">char</span> str[80];
00360       sprintf(str, <span class="stringliteral">"read: %d"</span>, read);
00361       <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(str);
00362     }
00363 
00364     m_next_read = (m_next_read + read) % m_buffer_length;
00365 
00366     <span class="comment">// unlock</span>
00367     m_buffer-&gt;Unlock(buffer1, buffer1_length, buffer2, buffer2_length);
00368 
00369   
00370     <span class="comment">// Should we stop?</span>
00371     <span class="keywordflow">if</span> (m_total_played &gt; m_total_read) {
00372       <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"Stopping stream!"</span>);
00373 
00374       <a class="code" href="classaudiere_1_1DSOutputStream.html#a3">stop</a>();
00375       m_buffer-&gt;SetCurrentPosition(0);
00376       m_last_play = 0;
00377 
00378       m_source-&gt;reset();
00379 
00380       m_total_played = 0;
00381       m_total_read = 0;
00382       m_next_read = 0;
00383       fillStream();
00384 
00385       <span class="keywordflow">return</span>;
00386     }
00387   }
00388 
00389 
00390   <span class="comment">// read as much as possible from the stream source, fill the rest</span>
00391   <span class="comment">// with silence</span>
00392   <span class="keywordtype">int</span>
00393   DSOutputStream::streamRead(<span class="keywordtype">int</span> sample_count, <span class="keywordtype">void</span>* samples) {
00394     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"streamRead"</span>);
00395 
00396     <span class="comment">// try to read from the stream</span>
00397     <span class="keywordtype">int</span> samples_read = m_source-&gt;read(sample_count, samples);
00398 
00399     <a class="code" href="debug_8h.html#a2">ADR_IF_DEBUG</a> {
00400       <span class="keywordtype">char</span> str[80];
00401       sprintf(str, <span class="stringliteral">"samples_read = %d\n"</span>, samples_read);
00402       <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(str);
00403     }
00404 
00405     <span class="comment">// remember the last sample</span>
00406     <span class="keywordflow">if</span> (samples_read &gt; 0) {
00407       memcpy(
00408         m_last_frame,
00409         (BYTE*)samples + (samples_read - 1) * m_frame_size,
00410         m_frame_size);
00411     }
00412 
00413     <span class="comment">// fill the rest with silence</span>
00414     BYTE* out = (BYTE*)samples + m_frame_size * samples_read;
00415     <span class="keywordtype">int</span> c = sample_count - samples_read;
00416     fillSilence(c, out);
00417 
00418     m_total_read += samples_read;
00419     <span class="keywordflow">return</span> samples_read;
00420   }
00421 
00422 
00423   <span class="keywordtype">void</span>
00424   DSOutputStream::fillSilence(<span class="keywordtype">int</span> sample_count, <span class="keywordtype">void</span>* samples) {
00425     <span class="keywordtype">int</span> c = sample_count;
00426     BYTE* out = (BYTE*)samples;
00427     <span class="keywordflow">while</span> (c--) {
00428       memcpy(out, m_last_frame, m_frame_size);
00429       out += m_frame_size;
00430     }
00431   }
00432 
00433 }
</pre></div><hr><address style="align: right;"><small>Generated on Tue Jul 15 12:36:48 2003 for audiere by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc1 </small></address>
</body>
</html>
