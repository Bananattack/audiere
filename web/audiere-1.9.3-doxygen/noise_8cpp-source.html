<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>noise.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc1 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>noise.cpp</h1><a href="noise_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="preprocessor">#include &lt;algorithm&gt;</span>
00002 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00003 <span class="preprocessor">#include "<a class="code" href="basic__source_8h.html">basic_source.h</a>"</span>
00004 <span class="preprocessor">#include "<a class="code" href="internal_8h.html">internal.h</a>"</span>
00005 <span class="preprocessor">#include "<a class="code" href="types_8h.html">types.h</a>"</span>
00006 
00007 <span class="keyword">namespace </span>audiere {
<a name="l00008"></a><a class="code" href="classaudiere_1_1WhiteNoise.html">00008</a> 
00009   <span class="keyword">class </span><a class="code" href="classaudiere_1_1WhiteNoise.html">WhiteNoise</a> : <span class="keyword">public</span> <a class="code" href="classaudiere_1_1BasicSource.html">BasicSource</a> {
<a name="l00010"></a><a class="code" href="classaudiere_1_1WhiteNoise.html#a0">00010</a>   <span class="keyword">public</span>:
00011     <span class="keywordtype">void</span> <a class="code" href="audiere_8h.html#a0">ADR_CALL</a> <a class="code" href="classaudiere_1_1WhiteNoise.html#a0">getFormat</a>(
00012       <span class="keywordtype">int</span>&amp; channel_count,
00013       <span class="keywordtype">int</span>&amp; sample_rate,
00014       <a class="code" href="namespaceaudiere.html#a105">SampleFormat</a>&amp; <a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a>)
00015     {
00016       channel_count = 1;
00017       sample_rate   = 44100;
00018       <a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a> = <a class="code" href="namespaceaudiere.html#a105a8">SF_S16</a>;
00019     }
<a name="l00020"></a><a class="code" href="classaudiere_1_1WhiteNoise.html#a1">00020</a> 
00021     <span class="keywordtype">int</span> <a class="code" href="classaudiere_1_1WhiteNoise.html#a1">doRead</a>(<span class="keywordtype">int</span> frame_count, <span class="keywordtype">void</span>* buffer) {
00022       <a class="code" href="namespaceaudiere.html#a36">s16</a>* out = (<a class="code" href="namespaceaudiere.html#a36">s16</a>*)buffer;
00023       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; frame_count; ++i) {
00024         *out++ = (rand() % 65536 - 32768);
00025       }
00026       <span class="keywordflow">return</span> frame_count;
00027     }
<a name="l00028"></a><a class="code" href="classaudiere_1_1WhiteNoise.html#a2">00028</a> 
00029     <span class="keywordtype">void</span> <a class="code" href="audiere_8h.html#a0">ADR_CALL</a> <a class="code" href="classaudiere_1_1WhiteNoise.html#a2">reset</a>() {
00030     }
00031   };
<a name="l00032"></a><a class="code" href="namespaceaudiere.html#a74">00032</a> 
00033   <a class="code" href="namespaceaudiere.html#a66">ADR_EXPORT</a>(<a class="code" href="classaudiere_1_1SampleSource.html">SampleSource</a>*) AdrCreateWhiteNoise() {
00034     <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classaudiere_1_1WhiteNoise.html">WhiteNoise</a>();
00035   }
00036 
00037 
00038   <span class="comment">// pink noise generation thanks to PortAudio (http://portaudio.com)</span>
00039   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> MAX_RANDOM_ROWS = 30;
00040   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> RANDOM_BITS = 24;
00041   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> RANDOM_SHIFT = <span class="keyword">sizeof</span>(long) * 8 - RANDOM_BITS;
00042 
<a name="l00043"></a><a class="code" href="classaudiere_1_1PinkNoise.html">00043</a> 
00044   <span class="keyword">class </span><a class="code" href="classaudiere_1_1PinkNoise.html">PinkNoise</a> : <span class="keyword">public</span> <a class="code" href="classaudiere_1_1BasicSource.html">BasicSource</a> {
<a name="l00045"></a><a class="code" href="classaudiere_1_1PinkNoise.html#a0">00045</a>   <span class="keyword">public</span>:
00046     <a class="code" href="classaudiere_1_1PinkNoise.html#a0">PinkNoise</a>() {
00047       doReset();
00048     }
<a name="l00049"></a><a class="code" href="classaudiere_1_1PinkNoise.html#a1">00049</a> 
00050     <span class="keywordtype">void</span> <a class="code" href="audiere_8h.html#a0">ADR_CALL</a> <a class="code" href="classaudiere_1_1PinkNoise.html#a1">getFormat</a>(
00051       <span class="keywordtype">int</span>&amp; channel_count,
00052       <span class="keywordtype">int</span>&amp; sample_rate,
00053       <a class="code" href="namespaceaudiere.html#a105">SampleFormat</a>&amp; <a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a>)
00054     {
00055       channel_count = 1;
00056       sample_rate   = 44100;
00057       <a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a> = <a class="code" href="namespaceaudiere.html#a105a8">SF_S16</a>;
00058     }
<a name="l00059"></a><a class="code" href="classaudiere_1_1PinkNoise.html#a2">00059</a> 
00060     <span class="keywordtype">int</span> <a class="code" href="classaudiere_1_1PinkNoise.html#a2">doRead</a>(<span class="keywordtype">int</span> frame_count, <span class="keywordtype">void</span>* buffer) {
00061       <a class="code" href="namespaceaudiere.html#a36">s16</a>* out = (<a class="code" href="namespaceaudiere.html#a36">s16</a>*)buffer;
00062       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; frame_count; ++i) {
00063         *out++ = <a class="code" href="namespaceaudiere.html#a36">s16</a>(generate() * 32767 - 16384);
00064       }
00065       <span class="keywordflow">return</span> frame_count;
00066     }
<a name="l00067"></a><a class="code" href="classaudiere_1_1PinkNoise.html#a3">00067</a> 
00068     <span class="keywordtype">void</span> <a class="code" href="audiere_8h.html#a0">ADR_CALL</a> <a class="code" href="classaudiere_1_1PinkNoise.html#a3">reset</a>() {
00069       doReset();
00070     }
00071 
00072   <span class="keyword">private</span>:
00073     <span class="keywordtype">void</span> doReset() {
00074       <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> numRows = 12;
00075 
00076       m_seed = 22222;
00077 
00078       m_index = 0;
00079       m_index_mask = (1 &lt;&lt; numRows) - 1;
00080 
00081       <span class="comment">// Calculate maximum possible signed random value.</span>
00082       <span class="comment">// Extra 1 for white noise always added.</span>
00083       <span class="keywordtype">long</span> pmax = (numRows + 1) * (1 &lt;&lt; (RANDOM_BITS - 1));
00084       m_scalar = 1.0f / pmax;
00085       
00086       std::fill(m_rows, m_rows + numRows, 0);
00087       m_running_sum = 0;
00088     }
00089 
00090     <span class="keywordtype">float</span> generate() {
00091       <span class="comment">// Increment and mask index.</span>
00092       m_index = (m_index + 1) &amp; m_index_mask;
00093 
00094       <span class="comment">// If index is zero, don't update any random values.</span>
00095       <span class="keywordflow">if</span> (m_index) {
00096         <span class="comment">// Determine how many trailing zeros in PinkIndex.</span>
00097         <span class="comment">// This algorithm will hang if n==0 so test first.</span>
00098         <span class="keywordtype">int</span> numZeros = 0;
00099         <span class="keywordtype">int</span> n = m_index;
00100         <span class="keywordflow">while</span> ((n &amp; 1) == 0) {
00101           n = n &gt;&gt; 1;
00102           numZeros++;
00103         }
00104         <span class="comment">// Replace the indexed ROWS random value.</span>
00105         <span class="comment">// Subtract and add back to RunningSum instead of adding all the random</span>
00106         <span class="comment">// values together. Only one changes each time.</span>
00107         m_running_sum -= m_rows[numZeros];
00108         <span class="keywordtype">long</span> newRandom = generateRandom() &gt;&gt; RANDOM_SHIFT;
00109         m_running_sum += newRandom;
00110         m_rows[numZeros] = newRandom;
00111       }
00112 
00113       <span class="comment">// Add extra white noise value.</span>
00114       <span class="keywordtype">long</span> newRandom = generateRandom() &gt;&gt; RANDOM_SHIFT;
00115       <span class="keywordtype">long</span> sum = m_running_sum + newRandom;
00116       <span class="comment">// Scale to range of -1.0 to 0.9999.</span>
00117       <span class="keywordflow">return</span> m_scalar * sum;
00118     }
00119 
00120     <span class="keywordtype">long</span> generateRandom() {
00121       m_seed = (m_seed * 196314165) + 907633515;
00122       <span class="keywordflow">return</span> m_seed;
00123     }
00124 
00125     <span class="keywordtype">long</span>  m_rows[MAX_RANDOM_ROWS];
00126     <span class="keywordtype">long</span>  m_running_sum;
00127     <span class="keywordtype">int</span>   m_index;
00128     <span class="keywordtype">int</span>   m_index_mask;
00129     <span class="keywordtype">float</span> m_scalar;
00130 
00131     <span class="keywordtype">long</span> m_seed;
00132   };
00133 
00134   <a class="code" href="namespaceaudiere.html#a66">ADR_EXPORT</a>(SampleSource*) AdrCreatePinkNoise() {
00135     <span class="keywordflow">return</span> <span class="keyword">new</span> PinkNoise();
00136   }
00137 
00138 }
</pre></div><hr><address style="align: right;"><small>Generated on Tue Jul 15 12:36:50 2003 for audiere by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc1 </small></address>
</body>
</html>
