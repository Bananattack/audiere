<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>utility.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc1 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>utility.h</h1><a href="utility_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="preprocessor">#ifndef UTILITY_H</span>
00002 <span class="preprocessor"></span><span class="preprocessor">#define UTILITY_H</span>
00003 <span class="preprocessor"></span>
00004 
00005 <span class="preprocessor">#ifdef _MSC_VER</span>
00006 <span class="preprocessor"></span><span class="preprocessor">#pragma warning(disable : 4786)</span>
00007 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00008 <span class="preprocessor"></span>
00009 
00010 <span class="preprocessor">#include &lt;map&gt;</span>
00011 <span class="preprocessor">#include &lt;string&gt;</span>
00012 <span class="preprocessor">#include &lt;utility&gt;</span>
00013 <span class="preprocessor">#include "<a class="code" href="audiere_8h.html">audiere.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="types_8h.html">types.h</a>"</span>
00015 
00016 
00017 <span class="preprocessor">#if defined(_MSC_VER) &amp;&amp; _MSC_VER &lt;= 1200</span>
00018 <span class="preprocessor"></span>
00019   <span class="comment">// std::min and std::max are broken in VC++ 6, so define our own.</span>
00020   <span class="comment">// Unfortunately, this means we must include utility.h to use</span>
00021   <span class="comment">// std::min and std::max</span>
00022   <span class="keyword">namespace </span>std {
00023 
00024 <span class="preprocessor">    #ifdef min</span>
00025 <span class="preprocessor"></span><span class="preprocessor">      #undef min</span>
00026 <span class="preprocessor"></span><span class="preprocessor">    #endif</span>
00027 <span class="preprocessor"></span>
00028 <span class="preprocessor">    #ifdef max</span>
00029 <span class="preprocessor"></span><span class="preprocessor">      #undef max</span>
00030 <span class="preprocessor"></span><span class="preprocessor">    #endif</span>
00031 <span class="preprocessor"></span>
00032     <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;
00033     <span class="keyword">inline</span> T min(T a, T b) {
00034       <span class="keywordflow">return</span> (a &lt; b ? a : b);
00035     }
00036 
00037     <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;
00038     <span class="keyword">inline</span> T max(T a, T b) {
00039       <span class="keywordflow">return</span> (a &gt; b ? a : b);
00040     }
00041   }
00042 
00043 <span class="preprocessor">#else</span>
00044 <span class="preprocessor"></span>
00045 <span class="preprocessor">  #include &lt;algorithm&gt;</span>
00046 
00047 <span class="preprocessor">#endif</span>
00048 <span class="preprocessor"></span>
00049 
00050 <span class="keyword">namespace </span>audiere {
00051 
00052 
<a name="l00053"></a><a class="code" href="namespaceaudiere.html#a95">00053</a>   <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;
00054   T <a class="code" href="namespaceaudiere.html#a95">clamp</a>(T min, T x, T max) {
00055     <span class="keywordflow">return</span> std::max(std::min(x, max), min);
00056   }
00057 
<a name="l00058"></a><a class="code" href="classaudiere_1_1ParameterList.html">00058</a> 
00059   <span class="keyword">class </span><a class="code" href="classaudiere_1_1ParameterList.html">ParameterList</a> {
00060   <span class="keyword">public</span>:
00061     <a class="code" href="classaudiere_1_1ParameterList.html#a0">ParameterList</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* <a class="code" href="namespaceaudiere_1_1hidden.html#a0">parameters</a>);
00062     std::string <a class="code" href="classaudiere_1_1ParameterList.html#a1">getValue</a>(<span class="keyword">const</span> std::string&amp; key, <span class="keyword">const</span> std::string&amp; defValue) <span class="keyword">const</span>;
00063     <span class="keywordtype">bool</span> <a class="code" href="classaudiere_1_1ParameterList.html#a2">getBoolean</a>(<span class="keyword">const</span> std::string&amp; key, <span class="keywordtype">bool</span> def) <span class="keyword">const</span>;
00064     <span class="keywordtype">int</span> <a class="code" href="classaudiere_1_1ParameterList.html#a3">getInt</a>(<span class="keyword">const</span> std::string&amp; key, <span class="keywordtype">int</span> def) <span class="keyword">const</span>;
00065 
00066   <span class="keyword">private</span>:
00067     std::map&lt;std::string, std::string&gt; m_values;
00068   };
00069 
00070   <span class="keywordtype">int</span> <a class="code" href="namespaceaudiere.html#a93">strcmp_case</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* a, <span class="keyword">const</span> <span class="keywordtype">char</span>* b);
00071 
<a name="l00072"></a><a class="code" href="namespaceaudiere.html#a96">00072</a> 
00073   <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="namespaceaudiere.html#a96">GetFrameSize</a>(<a class="code" href="classaudiere_1_1SampleSource.html">SampleSource</a>* source) {
00074     <span class="keywordtype">int</span> channel_count, sample_rate;
00075     <a class="code" href="namespaceaudiere.html#a105">SampleFormat</a> <a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a>;
00076     source-&gt;<a class="code" href="classaudiere_1_1SampleSource.html#a0">getFormat</a>(channel_count, sample_rate, <a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a>);
00077     <span class="keywordflow">return</span> <a class="code" href="namespaceaudiere.html#a45">GetSampleSize</a>(<a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a>) * channel_count;
00078   }
<a name="l00079"></a><a class="code" href="namespaceaudiere.html#a97">00079</a>   
00080   <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="namespaceaudiere.html#a96">GetFrameSize</a>(<span class="keyword">const</span> <a class="code" href="classaudiere_1_1RefPtr.html">SampleSourcePtr</a>&amp; source) {
00081     <span class="keywordflow">return</span> <a class="code" href="namespaceaudiere.html#a96">GetFrameSize</a>(source.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00082   }
00083 
<a name="l00084"></a><a class="code" href="namespaceaudiere.html#a98">00084</a> 
00085   <span class="keyword">inline</span> <a class="code" href="namespaceaudiere.html#a35">u16</a> <a class="code" href="namespaceaudiere.html#a98">read16_le</a>(<span class="keyword">const</span> <a class="code" href="namespaceaudiere.html#a33">u8</a>* b) {
00086     <span class="keywordflow">return</span> b[0] + (b[1] &lt;&lt; 8);
00087   }
<a name="l00088"></a><a class="code" href="namespaceaudiere.html#a99">00088</a> 
00089   <span class="keyword">inline</span> <a class="code" href="namespaceaudiere.html#a35">u16</a> <a class="code" href="namespaceaudiere.html#a99">read16_be</a>(<span class="keyword">const</span> <a class="code" href="namespaceaudiere.html#a33">u8</a>* b) {
00090     <span class="keywordflow">return</span> (b[0] &lt;&lt; 8) + b[1];
00091   }
<a name="l00092"></a><a class="code" href="namespaceaudiere.html#a100">00092</a> 
00093   <span class="keyword">inline</span> <a class="code" href="namespaceaudiere.html#a37">u32</a> <a class="code" href="namespaceaudiere.html#a100">read32_le</a>(<span class="keyword">const</span> <a class="code" href="namespaceaudiere.html#a33">u8</a>* b) {
00094     <span class="keywordflow">return</span> <a class="code" href="namespaceaudiere.html#a98">read16_le</a>(b) + (<a class="code" href="namespaceaudiere.html#a98">read16_le</a>(b + 2) &lt;&lt; 16);
00095   }
<a name="l00096"></a><a class="code" href="namespaceaudiere.html#a101">00096</a> 
00097   <span class="keyword">inline</span> <a class="code" href="namespaceaudiere.html#a37">u32</a> <a class="code" href="namespaceaudiere.html#a101">read32_be</a>(<span class="keyword">const</span> <a class="code" href="namespaceaudiere.html#a33">u8</a>* b) {
00098     <span class="keywordflow">return</span> (<a class="code" href="namespaceaudiere.html#a99">read16_be</a>(b) &lt;&lt; 16) + <a class="code" href="namespaceaudiere.html#a99">read16_be</a>(b + 2);
00099   }
00100 
00102   <span class="keyword">inline</span> <a class="code" href="namespaceaudiere.html#a37">u32</a> <a class="code" href="namespaceaudiere.html#a102">readLD_be</a>(<span class="keyword">const</span> <a class="code" href="namespaceaudiere.html#a33">u8</a>* b) {
00103     <a class="code" href="namespaceaudiere.html#a37">u32</a> mantissa = <a class="code" href="namespaceaudiere.html#a101">read32_be</a>(b + 2);
00104     <a class="code" href="namespaceaudiere.html#a33">u8</a> exp = 30 - b[1];
00105     <a class="code" href="namespaceaudiere.html#a37">u32</a> last = 0;
00106     <span class="keywordflow">while</span> (exp--) {
00107       last = mantissa;
00108       mantissa &gt;&gt;= 1;
00109     }
00110     <span class="keywordflow">if</span> (last &amp; 0x1) {
00111       mantissa++;
00112     }
00113     <span class="keywordflow">return</span> mantissa;
00114   }
00115 
<a name="l00116"></a><a class="code" href="namespaceaudiere.html#a103">00116</a> 
00117   <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="namespaceaudiere.html#a103">GetFileLength</a>(<a class="code" href="classaudiere_1_1File.html">File</a>* file) {
00118     <span class="keywordtype">int</span> pos = file-&gt;<a class="code" href="classaudiere_1_1File.html#a2">tell</a>();
00119     file-&gt;<a class="code" href="classaudiere_1_1File.html#a1">seek</a>(0, File::END);
00120     <span class="keywordtype">int</span> length = file-&gt;<a class="code" href="classaudiere_1_1File.html#a2">tell</a>();
00121     file-&gt;<a class="code" href="classaudiere_1_1File.html#a1">seek</a>(pos, File::BEGIN);
00122     <span class="keywordflow">return</span> length;
00123   }
00124 
<a name="l00125"></a><a class="code" href="namespaceaudiere.html#a104">00125</a> 
00126   <span class="keyword">inline</span> <a class="code" href="classaudiere_1_1SampleSource.html">SampleSource</a>* <a class="code" href="namespaceaudiere.html#a104">OpenBufferStream</a>(
00127     <span class="keywordtype">void</span>* samples, <span class="keywordtype">int</span> sample_count,
00128     <span class="keywordtype">int</span> channel_count, <span class="keywordtype">int</span> sample_rate, <a class="code" href="namespaceaudiere.html#a105">SampleFormat</a> <a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a>)
00129   {
00130     <span class="keywordflow">return</span> <a class="code" href="namespaceaudiere.html#a59">CreateSampleBuffer</a>(
00131       samples, sample_count,
00132       channel_count, sample_rate, <a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a>)-&gt;<a class="code" href="classaudiere_1_1SampleBuffer.html#a3">openStream</a>();
00133   }
00134 
<a name="l00135"></a><a class="code" href="classaudiere_1_1QueueBuffer.html">00135</a> 
00136   <span class="keyword">class </span><a class="code" href="classaudiere_1_1QueueBuffer.html">QueueBuffer</a> {
<a name="l00137"></a><a class="code" href="classaudiere_1_1QueueBuffer.html#a0">00137</a>   <span class="keyword">public</span>:
00138     <a class="code" href="classaudiere_1_1QueueBuffer.html#a0">QueueBuffer</a>() {
00139       m_capacity = 256;
00140       m_size = 0;
00141 
00142       m_buffer = (<a class="code" href="namespaceaudiere.html#a33">u8</a>*)malloc(m_capacity);
00143     }
<a name="l00144"></a><a class="code" href="classaudiere_1_1QueueBuffer.html#a1">00144</a> 
00145     <a class="code" href="classaudiere_1_1QueueBuffer.html#a1">~QueueBuffer</a>() {
00146       m_buffer = (<a class="code" href="namespaceaudiere.html#a33">u8</a>*)realloc(m_buffer, 0);
00147     }
<a name="l00148"></a><a class="code" href="classaudiere_1_1QueueBuffer.html#a2">00148</a> 
00149     <span class="keywordtype">int</span> <a class="code" href="classaudiere_1_1QueueBuffer.html#a2">getSize</a>() {
00150       <span class="keywordflow">return</span> m_size;
00151     }
<a name="l00152"></a><a class="code" href="classaudiere_1_1QueueBuffer.html#a3">00152</a> 
00153     <span class="keywordtype">void</span> <a class="code" href="classaudiere_1_1QueueBuffer.html#a3">write</a>(<span class="keywordtype">void</span>* buffer, <span class="keywordtype">int</span> <a class="code" href="namespaceaudiere_1_1hidden.html#a10">size</a>) {
00154       <span class="keywordtype">bool</span> need_realloc = <span class="keyword">false</span>;
00155       <span class="keywordflow">while</span> (<a class="code" href="namespaceaudiere_1_1hidden.html#a10">size</a> + m_size &gt; m_capacity) {
00156         m_capacity *= 2;
00157         need_realloc = <span class="keyword">true</span>;
00158       }
00159 
00160       <span class="keywordflow">if</span> (need_realloc) {
00161         m_buffer = (<a class="code" href="namespaceaudiere.html#a33">u8</a>*)realloc(m_buffer, m_capacity);
00162       }
00163 
00164       memcpy(m_buffer + m_size, buffer, <a class="code" href="namespaceaudiere_1_1hidden.html#a10">size</a>);
00165       m_size += <a class="code" href="namespaceaudiere_1_1hidden.html#a10">size</a>;
00166     }
<a name="l00167"></a><a class="code" href="classaudiere_1_1QueueBuffer.html#a4">00167</a> 
00168     <span class="keywordtype">int</span> <a class="code" href="classaudiere_1_1QueueBuffer.html#a4">read</a>(<span class="keywordtype">void</span>* buffer, <span class="keywordtype">int</span> <a class="code" href="namespaceaudiere_1_1hidden.html#a10">size</a>) {
00169       <span class="keywordtype">int</span> to_read = std::min(<a class="code" href="namespaceaudiere_1_1hidden.html#a10">size</a>, m_size);
00170       memcpy(buffer, m_buffer, to_read);
00171       memmove(m_buffer, m_buffer + to_read, m_size - to_read);
00172       m_size -= to_read;
00173       <span class="keywordflow">return</span> to_read;
00174     }
<a name="l00175"></a><a class="code" href="classaudiere_1_1QueueBuffer.html#a5">00175</a> 
00176     <span class="keywordtype">void</span> <a class="code" href="classaudiere_1_1QueueBuffer.html#a5">clear</a>() {
00177       m_size = 0;
00178     }
00179 
00180   <span class="keyword">private</span>:
00181     <a class="code" href="namespaceaudiere.html#a33">u8</a>* m_buffer;
00182     <span class="keywordtype">int</span> m_capacity;
00183     <span class="keywordtype">int</span> m_size;
00184 
00185     <span class="comment">// private and unimplemented to prevent their use</span>
00186     <a class="code" href="classaudiere_1_1QueueBuffer.html#a0">QueueBuffer</a>(<span class="keyword">const</span> <a class="code" href="classaudiere_1_1QueueBuffer.html#a0">QueueBuffer</a>&amp;);
00187     <a class="code" href="classaudiere_1_1QueueBuffer.html#a0">QueueBuffer</a>&amp; operator=(<span class="keyword">const</span> <a class="code" href="classaudiere_1_1QueueBuffer.html#a0">QueueBuffer</a>&amp;);
00188   };
00189 
<a name="l00190"></a><a class="code" href="classaudiere_1_1SizedBuffer.html">00190</a> 
00191   <span class="keyword">class </span><a class="code" href="classaudiere_1_1SizedBuffer.html">SizedBuffer</a> {
<a name="l00192"></a><a class="code" href="classaudiere_1_1SizedBuffer.html#a0">00192</a>   <span class="keyword">public</span>:
00193     <a class="code" href="classaudiere_1_1SizedBuffer.html#a0">SizedBuffer</a>() {
00194       m_capacity = 256;
00195       m_buffer = malloc(m_capacity);
00196     }
<a name="l00197"></a><a class="code" href="classaudiere_1_1SizedBuffer.html#a1">00197</a> 
00198     <a class="code" href="classaudiere_1_1SizedBuffer.html#a1">~SizedBuffer</a>() {
00199       m_buffer = realloc(m_buffer, 0);
00200     }
<a name="l00201"></a><a class="code" href="classaudiere_1_1SizedBuffer.html#a2">00201</a> 
00202     <span class="keywordtype">void</span> <a class="code" href="classaudiere_1_1SizedBuffer.html#a2">ensureSize</a>(<span class="keywordtype">int</span> <a class="code" href="namespaceaudiere_1_1hidden.html#a10">size</a>) {
00203       <span class="keywordtype">bool</span> need_realloc = <span class="keyword">false</span>;
00204       <span class="keywordflow">while</span> (m_capacity &lt; <a class="code" href="namespaceaudiere_1_1hidden.html#a10">size</a>) {
00205         m_capacity *= 2;
00206         need_realloc = <span class="keyword">true</span>;
00207       }
00208       <span class="keywordflow">if</span> (need_realloc) {
00209         m_buffer = realloc(m_buffer, m_capacity);
00210       }
00211     }
<a name="l00212"></a><a class="code" href="classaudiere_1_1SizedBuffer.html#a3">00212</a> 
00213     <span class="keywordtype">void</span>* <a class="code" href="classaudiere_1_1SizedBuffer.html#a3">get</a>() {
00214       <span class="keywordflow">return</span> m_buffer;
00215     }
00216 
00217   <span class="keyword">private</span>:
00218     <span class="keywordtype">void</span>* m_buffer;
00219     <span class="keywordtype">int</span> m_capacity;
00220 
00221     <span class="comment">// private and unimplemented to prevent their use</span>
00222     <a class="code" href="classaudiere_1_1SizedBuffer.html#a0">SizedBuffer</a>(<span class="keyword">const</span> <a class="code" href="classaudiere_1_1SizedBuffer.html#a0">SizedBuffer</a>&amp;);
00223     <a class="code" href="classaudiere_1_1SizedBuffer.html#a0">SizedBuffer</a>&amp; operator=(<span class="keyword">const</span> <a class="code" href="classaudiere_1_1SizedBuffer.html#a0">SizedBuffer</a>&amp;);
00224   };
00225 
00226 }
00227 
00228 
00229 <span class="preprocessor">#endif</span>
</pre></div><hr><address style="align: right;"><small>Generated on Tue Jul 15 12:36:51 2003 for audiere by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc1 </small></address>
</body>
</html>
