<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>input_wav.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc1 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>input_wav.cpp</h1><a href="input__wav_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="preprocessor">#include &lt;string.h&gt;</span>
00002 <span class="preprocessor">#include "<a class="code" href="debug_8h.html">debug.h</a>"</span>
00003 <span class="preprocessor">#include "<a class="code" href="input__wav_8h.html">input_wav.h</a>"</span>
00004 <span class="preprocessor">#include "<a class="code" href="utility_8h.html">utility.h</a>"</span>
00005 
00006 
00007 <span class="keyword">namespace </span>audiere {
00008 
00009   <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">bool</span> IsValidSampleSize(<a class="code" href="namespaceaudiere.html#a37">u32</a> <a class="code" href="namespaceaudiere_1_1hidden.html#a10">size</a>) {
00010     <span class="keywordflow">return</span> (<a class="code" href="namespaceaudiere_1_1hidden.html#a10">size</a> == 8 || <a class="code" href="namespaceaudiere_1_1hidden.html#a10">size</a> == 16);
00011   }
00012 
<a name="l00013"></a><a class="code" href="classaudiere_1_1WAVInputStream.html#a0">00013</a> 
00014   WAVInputStream::WAVInputStream() {
00015     m_file = 0;
00016 
00017     m_channel_count = 0;
00018     m_sample_rate   = 0;
00019     m_sample_format = <a class="code" href="namespaceaudiere.html#a105a7">SF_U8</a>;  <span class="comment">// reasonable default?</span>
00020 
00021     m_data_chunk_location = 0;
00022     m_data_chunk_length   = 0;
00023 
00024     m_frames_left_in_chunk = 0;
00025   }
00026 
00027 
<a name="l00029"></a><a class="code" href="classaudiere_1_1WAVInputStream.html#a1">00029</a>   <span class="keywordtype">bool</span>
00030   WAVInputStream::initialize(<a class="code" href="namespaceaudiere.html#a0">FilePtr</a> file) {
00031     m_file = file;
00032 
00033     <span class="comment">// read the RIFF header</span>
00034     <span class="keywordtype">char</span> riff_id[4];
00035     <a class="code" href="namespaceaudiere.html#a33">u8</a>   riff_length_buffer[4];
00036     <span class="keywordtype">char</span> riff_datatype[4];
00037 
00038     <a class="code" href="namespaceaudiere.html#a37">u32</a> <a class="code" href="namespaceaudiere_1_1hidden.html#a10">size</a> = 0;
00039     <a class="code" href="namespaceaudiere_1_1hidden.html#a10">size</a> += file-&gt;read(riff_id, 4);
00040     <a class="code" href="namespaceaudiere_1_1hidden.html#a10">size</a> += file-&gt;read(riff_length_buffer, 4);
00041     <a class="code" href="namespaceaudiere_1_1hidden.html#a10">size</a> += file-&gt;read(riff_datatype, 4);
00042 
00043     <span class="keywordtype">int</span> riff_length = <a class="code" href="namespaceaudiere.html#a100">read32_le</a>(riff_length_buffer);
00044 
00045     <span class="keywordflow">if</span> (<a class="code" href="namespaceaudiere_1_1hidden.html#a10">size</a> != 12 ||
00046         memcmp(riff_id, <span class="stringliteral">"RIFF"</span>, 4) != 0 ||
00047         riff_length == 0 ||
00048         memcmp(riff_datatype, <span class="stringliteral">"WAVE"</span>, 4) != 0) {
00049 
00050       <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"Couldn't read RIFF header"</span>);
00051 
00052       <span class="comment">// so we don't destroy the file</span>
00053       m_file = 0;
00054       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00055     }
00056 
00057     <span class="keywordflow">if</span> (findFormatChunk() &amp;&amp; findDataChunk()) {
00058       <span class="keywordflow">return</span> <span class="keyword">true</span>;
00059     } <span class="keywordflow">else</span> {
00060       m_file = 0;
00061       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00062     }
00063   }
00064 
00065 
<a name="l00066"></a><a class="code" href="classaudiere_1_1WAVInputStream.html#a2">00066</a>   <span class="keywordtype">void</span>
00067   WAVInputStream::getFormat(
00068     <span class="keywordtype">int</span>&amp; channel_count,
00069     <span class="keywordtype">int</span>&amp; sample_rate,
00070     <a class="code" href="namespaceaudiere.html#a105">SampleFormat</a>&amp; <a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a>)
00071   {
00072     channel_count = m_channel_count;
00073     sample_rate   = m_sample_rate;
00074     <a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a> = m_sample_format;
00075   }
00076 
00077 
<a name="l00078"></a><a class="code" href="classaudiere_1_1WAVInputStream.html#a3">00078</a>   <span class="keywordtype">int</span>
00079   WAVInputStream::doRead(<span class="keywordtype">int</span> frame_count, <span class="keywordtype">void</span>* buffer) {
00080     <span class="keywordflow">if</span> (m_frames_left_in_chunk == 0) {
00081       <span class="keywordflow">return</span> 0;
00082     }
00083 
00084     <span class="keyword">const</span> <span class="keywordtype">int</span> frames_to_read = std::min(frame_count, m_frames_left_in_chunk);
00085     <span class="keyword">const</span> <span class="keywordtype">int</span> frame_size = m_channel_count * <a class="code" href="namespaceaudiere.html#a45">GetSampleSize</a>(m_sample_format);
00086     <span class="keyword">const</span> <span class="keywordtype">int</span> bytes_to_read = frames_to_read * frame_size;
00087   
00088     <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="classaudiere_1_1BasicSource.html#a1">read</a> = m_file-&gt;read(buffer, bytes_to_read);
00089     <span class="keyword">const</span> <span class="keywordtype">int</span> frames_read = <a class="code" href="classaudiere_1_1BasicSource.html#a1">read</a> / frame_size;
00090 
00091 <span class="preprocessor">#if WORDS_BIGENDIAN</span>
00092 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (m_sample_format == <a class="code" href="namespaceaudiere.html#a105a8">SF_S16</a>) {
00093       <span class="comment">// make little endian into host endian</span>
00094       <a class="code" href="namespaceaudiere.html#a33">u8</a>* out = (<a class="code" href="namespaceaudiere.html#a33">u8</a>*)buffer;
00095       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; frames_read * m_channel_count; ++i) {
00096         std::swap(out[0], out[1]);
00097         out += 2;
00098       }
00099     }
00100 <span class="preprocessor">#endif</span>
00101 <span class="preprocessor"></span>
00102     <span class="comment">// assume that if we didn't get a full read, we're done</span>
00103     <span class="keywordflow">if</span> (<a class="code" href="classaudiere_1_1BasicSource.html#a1">read</a> != bytes_to_read) {
00104       m_frames_left_in_chunk = 0;
00105       <span class="keywordflow">return</span> frames_read;
00106     }
00107 
00108     m_frames_left_in_chunk -= frames_read;
00109     <span class="keywordflow">return</span> frames_read;
00110   }
00111 
00112 
<a name="l00113"></a><a class="code" href="classaudiere_1_1WAVInputStream.html#a4">00113</a>   <span class="keywordtype">void</span>
00114   WAVInputStream::reset() {
00115     <span class="comment">// seek to the beginning of the data chunk</span>
00116     m_frames_left_in_chunk = m_data_chunk_length;
00117     m_file-&gt;seek(m_data_chunk_location, File::BEGIN);
00118   }
00119 
00120 
<a name="l00121"></a><a class="code" href="classaudiere_1_1WAVInputStream.html#a5">00121</a>   <span class="keywordtype">bool</span>
00122   WAVInputStream::isSeekable() {
00123     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00124   }
00125 
00126 
<a name="l00127"></a><a class="code" href="classaudiere_1_1WAVInputStream.html#a6">00127</a>   <span class="keywordtype">int</span>
00128   WAVInputStream::getLength() {
00129     <span class="keywordflow">return</span> m_data_chunk_length;
00130   }
00131 
00132 
<a name="l00133"></a><a class="code" href="classaudiere_1_1WAVInputStream.html#a7">00133</a>   <span class="keywordtype">void</span>
00134   WAVInputStream::setPosition(<span class="keywordtype">int</span> position) {
00135     <span class="keywordtype">int</span> frame_size = m_channel_count * <a class="code" href="namespaceaudiere.html#a45">GetSampleSize</a>(m_sample_format);
00136     m_frames_left_in_chunk = m_data_chunk_length - position;
00137     m_file-&gt;seek(m_data_chunk_location + position * frame_size, File::BEGIN);
00138   }
00139 
00140 
<a name="l00141"></a><a class="code" href="classaudiere_1_1WAVInputStream.html#a8">00141</a>   <span class="keywordtype">int</span>
00142   WAVInputStream::getPosition() {
00143     <span class="keywordflow">return</span> m_data_chunk_length - m_frames_left_in_chunk;
00144   }
00145 
00146 
00147   <span class="keywordtype">bool</span>
00148   WAVInputStream::findFormatChunk() {
00149     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"WAVInputStream::findFormatChunk"</span>);
00150 
00151     <span class="comment">// seek to just after the RIFF header</span>
00152     m_file-&gt;seek(12, File::BEGIN);
00153 
00154     <span class="comment">// search for a format chunk</span>
00155     <span class="keywordflow">for</span> (;;) {
00156       <span class="keywordtype">char</span> chunk_id[4];
00157       <a class="code" href="namespaceaudiere.html#a33">u8</a>   chunk_length_buffer[4];
00158 
00159       <span class="keywordtype">int</span> <a class="code" href="namespaceaudiere_1_1hidden.html#a10">size</a> = m_file-&gt;read(chunk_id, 4);
00160       <a class="code" href="namespaceaudiere_1_1hidden.html#a10">size</a>    += m_file-&gt;read(chunk_length_buffer, 4);
00161       <a class="code" href="namespaceaudiere.html#a37">u32</a> chunk_length = <a class="code" href="namespaceaudiere.html#a100">read32_le</a>(chunk_length_buffer);
00162 
00163       <span class="comment">// if we couldn't read enough, we're done</span>
00164       <span class="keywordflow">if</span> (<a class="code" href="namespaceaudiere_1_1hidden.html#a10">size</a> != 8) {
00165         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00166       }
00167 
00168       <span class="comment">// if we found a format chunk, excellent!</span>
00169       <span class="keywordflow">if</span> (memcmp(chunk_id, <span class="stringliteral">"fmt "</span>, 4) == 0 &amp;&amp; chunk_length &gt;= 16) {
00170 
00171         <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"Found format chunk"</span>);
00172 
00173         <span class="comment">// read format chunk</span>
00174         <a class="code" href="namespaceaudiere.html#a33">u8</a> chunk[16];
00175         <a class="code" href="namespaceaudiere_1_1hidden.html#a10">size</a> = m_file-&gt;read(chunk, 16);
00176 
00177         <span class="comment">// could we read the entire format chunk?</span>
00178         <span class="keywordflow">if</span> (<a class="code" href="namespaceaudiere_1_1hidden.html#a10">size</a> &lt; 16) {
00179           <span class="keywordflow">return</span> <span class="keyword">false</span>;
00180         }
00181 
00182         chunk_length -= <a class="code" href="namespaceaudiere_1_1hidden.html#a10">size</a>;
00183 
00184         <span class="comment">// parse the memory into useful information</span>
00185         <a class="code" href="namespaceaudiere.html#a35">u16</a> format_tag         = <a class="code" href="namespaceaudiere.html#a98">read16_le</a>(chunk + 0);
00186         <a class="code" href="namespaceaudiere.html#a35">u16</a> channel_count      = <a class="code" href="namespaceaudiere.html#a98">read16_le</a>(chunk + 2);
00187         <a class="code" href="namespaceaudiere.html#a37">u32</a> samples_per_second = <a class="code" href="namespaceaudiere.html#a100">read32_le</a>(chunk + 4);
00188         <span class="comment">//u32 bytes_per_second   = read32_le(chunk + 8);</span>
00189         <span class="comment">//u16 block_align        = read16_le(chunk + 12);</span>
00190         <a class="code" href="namespaceaudiere.html#a35">u16</a> bits_per_sample    = <a class="code" href="namespaceaudiere.html#a98">read16_le</a>(chunk + 14);
00191 
00192         <span class="comment">// format_tag must be 1 (WAVE_FORMAT_PCM)</span>
00193         <span class="comment">// we only support mono and stereo</span>
00194         <span class="keywordflow">if</span> (format_tag != 1 ||
00195             channel_count &gt; 2 ||
00196             !IsValidSampleSize(bits_per_sample)) {
00197           <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"Invalid WAV"</span>);
00198           <span class="keywordflow">return</span> <span class="keyword">false</span>;
00199         }
00200 
00201         <span class="comment">// skip the rest of the chunk</span>
00202         <span class="keywordflow">if</span> (!skipBytes(chunk_length)) {
00203           <span class="comment">// oops, end of stream</span>
00204           <span class="keywordflow">return</span> <span class="keyword">false</span>;
00205         }
00206 
00207         <span class="comment">// figure out the sample format</span>
00208         <span class="keywordflow">if</span> (bits_per_sample == 8) {
00209           m_sample_format = <a class="code" href="namespaceaudiere.html#a105a7">SF_U8</a>;
00210         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bits_per_sample == 16) {
00211           m_sample_format = <a class="code" href="namespaceaudiere.html#a105a8">SF_S16</a>;
00212         } <span class="keywordflow">else</span> {
00213           <span class="keywordflow">return</span> <span class="keyword">false</span>;
00214         }
00215 
00216         <span class="comment">// store the other important .wav attributes</span>
00217         m_channel_count = channel_count;
00218         m_sample_rate   = samples_per_second;
00219         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00220 
00221       } <span class="keywordflow">else</span> {
00222 
00223         <span class="comment">// skip the rest of the chunk</span>
00224         <span class="keywordflow">if</span> (!skipBytes(chunk_length)) {
00225           <span class="comment">// oops, end of stream</span>
00226           <span class="keywordflow">return</span> <span class="keyword">false</span>;
00227         }
00228 
00229       }
00230     }
00231   }
00232 
00233 
00234   <span class="keywordtype">bool</span>
00235   WAVInputStream::findDataChunk() {
00236     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"WAVInputStream::findDataChunk"</span>);
00237 
00238     <span class="comment">// seek to just after the RIFF header</span>
00239     m_file-&gt;seek(12, File::BEGIN);
00240 
00241     <span class="comment">// search for a data chunk</span>
00242     <span class="keywordflow">while</span> (true) {
00243       <span class="keywordtype">char</span> chunk_id[4];
00244       <a class="code" href="namespaceaudiere.html#a33">u8</a>   chunk_length_buffer[4];
00245 
00246       <span class="keywordtype">int</span> <a class="code" href="namespaceaudiere_1_1hidden.html#a10">size</a> = m_file-&gt;read(chunk_id, 4);
00247       <a class="code" href="namespaceaudiere_1_1hidden.html#a10">size</a>    += m_file-&gt;read(chunk_length_buffer, 4);
00248       <a class="code" href="namespaceaudiere.html#a37">u32</a> chunk_length = <a class="code" href="namespaceaudiere.html#a100">read32_le</a>(chunk_length_buffer);
00249 
00250       <span class="comment">// if we couldn't read enough, we're done</span>
00251       <span class="keywordflow">if</span> (<a class="code" href="namespaceaudiere_1_1hidden.html#a10">size</a> != 8) {
00252         <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"Couldn't read chunk header"</span>);
00253         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00254       }
00255 
00256       <span class="comment">// if we found a data chunk, excellent!</span>
00257       <span class="keywordflow">if</span> (memcmp(chunk_id, <span class="stringliteral">"data"</span>, 4) == 0) {
00258 
00259         <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"Found data chunk"</span>);
00260 
00261         <span class="comment">// calculate the frame size so we can truncate the data chunk</span>
00262         <span class="keywordtype">int</span> frame_size = m_channel_count * <a class="code" href="namespaceaudiere.html#a45">GetSampleSize</a>(m_sample_format);
00263 
00264         m_data_chunk_location  = m_file-&gt;tell();
00265         m_data_chunk_length    = chunk_length / frame_size;
00266         m_frames_left_in_chunk = m_data_chunk_length;
00267         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00268 
00269       } <span class="keywordflow">else</span> {
00270 
00271         <a class="code" href="debug_8h.html#a2">ADR_IF_DEBUG</a> {
00272           <span class="keywordtype">char</span> str[80];
00273           sprintf(str, <span class="stringliteral">"Skipping: %d bytes in chunk '%c%c%c%c'"</span>,
00274                   (<span class="keywordtype">int</span>)chunk_length,
00275                   chunk_id[0], chunk_id[1], chunk_id[2], chunk_id[3]);
00276           <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(str);
00277         }
00278 
00279         <span class="comment">// skip the rest of the chunk</span>
00280         <span class="keywordflow">if</span> (!skipBytes(chunk_length)) {
00281           <span class="comment">// oops, end of stream</span>
00282           <span class="keywordflow">return</span> <span class="keyword">false</span>;
00283         }
00284 
00285       }
00286     }
00287   }
00288 
00289 
00290   <span class="keywordtype">bool</span>
00291   WAVInputStream::skipBytes(<span class="keywordtype">int</span> <a class="code" href="namespaceaudiere_1_1hidden.html#a10">size</a>) {
00292     <span class="keywordflow">return</span> m_file-&gt;seek(<a class="code" href="namespaceaudiere_1_1hidden.html#a10">size</a>, File::CURRENT);
00293   }
00294 
00295 
00296 }
</pre></div><hr><address style="align: right;"><small>Generated on Tue Jul 15 12:36:49 2003 for audiere by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc1 </small></address>
</body>
</html>
