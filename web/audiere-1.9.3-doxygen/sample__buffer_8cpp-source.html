<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>sample_buffer.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc1 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>sample_buffer.cpp</h1><a href="sample__buffer_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="preprocessor">#include "<a class="code" href="audiere_8h.html">audiere.h</a>"</span>
00002 <span class="preprocessor">#include "<a class="code" href="basic__source_8h.html">basic_source.h</a>"</span>
00003 <span class="preprocessor">#include "<a class="code" href="internal_8h.html">internal.h</a>"</span>
00004 <span class="preprocessor">#include "<a class="code" href="types_8h.html">types.h</a>"</span>
00005 <span class="preprocessor">#include "<a class="code" href="utility_8h.html">utility.h</a>"</span>
00006 
00007 
00008 <span class="keyword">namespace </span>audiere {
<a name="l00009"></a><a class="code" href="classaudiere_1_1BufferStream.html">00009</a> 
00010   <span class="keyword">class </span><a class="code" href="classaudiere_1_1BufferStream.html">BufferStream</a> : <span class="keyword">public</span> <a class="code" href="classaudiere_1_1BasicSource.html">BasicSource</a> {
<a name="l00011"></a><a class="code" href="classaudiere_1_1BufferStream.html#a0">00011</a>   <span class="keyword">public</span>:
00012     <a class="code" href="classaudiere_1_1BufferStream.html#a0">BufferStream</a>(<a class="code" href="classaudiere_1_1SampleBuffer.html">SampleBuffer</a>* buffer) {
00013       m_buffer = buffer;
00014 
00015       <span class="comment">// get the sample format so we can calculate the size of each frame</span>
00016       <span class="keywordtype">int</span> <a class="code" href="namespaceaudiere.html#a26">channel_count</a>, <a class="code" href="namespaceaudiere.html#a27">sample_rate</a>;
00017       <a class="code" href="namespaceaudiere.html#a105">SampleFormat</a> <a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a>;
00018       buffer-&gt;<a class="code" href="classaudiere_1_1SampleBuffer.html#a0">getFormat</a>(<a class="code" href="namespaceaudiere.html#a26">channel_count</a>, <a class="code" href="namespaceaudiere.html#a27">sample_rate</a>, <a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a>);
00019 
00020       m_frame_size  = <a class="code" href="namespaceaudiere.html#a26">channel_count</a> * <a class="code" href="namespaceaudiere.html#a45">GetSampleSize</a>(<a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a>);
00021       m_frame_count = m_buffer-&gt;getLength();
00022       m_samples     = (<span class="keyword">const</span> <a class="code" href="namespaceaudiere.html#a33">u8</a>*)m_buffer-&gt;getSamples();
00023 
00024       m_position = 0;
00025     }
00026 
<a name="l00027"></a><a class="code" href="classaudiere_1_1BufferStream.html#a1">00027</a> 
00028     <span class="keywordtype">void</span> <a class="code" href="audiere_8h.html#a0">ADR_CALL</a> <a class="code" href="classaudiere_1_1BufferStream.html#a1">getFormat</a>(
00029       <span class="keywordtype">int</span>&amp; <a class="code" href="namespaceaudiere.html#a26">channel_count</a>,
00030       <span class="keywordtype">int</span>&amp; <a class="code" href="namespaceaudiere.html#a27">sample_rate</a>,
00031       <a class="code" href="namespaceaudiere.html#a105">SampleFormat</a>&amp; <a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a>)
00032     {
00033       m_buffer-&gt;getFormat(<a class="code" href="namespaceaudiere.html#a26">channel_count</a>, <a class="code" href="namespaceaudiere.html#a27">sample_rate</a>, <a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a>);
00034     }
00035 
<a name="l00036"></a><a class="code" href="classaudiere_1_1BufferStream.html#a2">00036</a> 
00037     <span class="keywordtype">int</span> <a class="code" href="classaudiere_1_1BufferStream.html#a2">doRead</a>(<span class="keywordtype">int</span> <a class="code" href="namespaceaudiere.html#a25">frame_count</a>, <span class="keywordtype">void</span>* buffer) {
00038       <span class="keywordtype">int</span> to_read = std::min(<a class="code" href="namespaceaudiere.html#a25">frame_count</a>, m_frame_count - m_position);
00039       memcpy(
00040         buffer,
00041         m_samples + m_position * m_frame_size,
00042         to_read * m_frame_size);
00043       m_position += to_read;
00044       <span class="keywordflow">return</span> to_read;
00045     }
00046 
<a name="l00047"></a><a class="code" href="classaudiere_1_1BufferStream.html#a3">00047</a> 
00048     <span class="keywordtype">void</span> <a class="code" href="audiere_8h.html#a0">ADR_CALL</a> <a class="code" href="classaudiere_1_1BufferStream.html#a3">reset</a>() {
00049       m_position = 0;
00050     }
00051 
<a name="l00052"></a><a class="code" href="classaudiere_1_1BufferStream.html#a4">00052</a> 
<a name="l00053"></a><a class="code" href="classaudiere_1_1BufferStream.html#a5">00053</a>     <span class="keywordtype">bool</span> <a class="code" href="audiere_8h.html#a0">ADR_CALL</a> <a class="code" href="classaudiere_1_1BufferStream.html#a4">isSeekable</a>()              { <span class="keywordflow">return</span> <span class="keyword">true</span>;           }
<a name="l00054"></a><a class="code" href="classaudiere_1_1BufferStream.html#a6">00054</a>     <span class="keywordtype">int</span> <a class="code" href="audiere_8h.html#a0">ADR_CALL</a> <a class="code" href="classaudiere_1_1BufferStream.html#a5">getLength</a>()                { <span class="keywordflow">return</span> m_frame_count;  }
<a name="l00055"></a><a class="code" href="classaudiere_1_1BufferStream.html#a7">00055</a>     <span class="keywordtype">void</span> <a class="code" href="audiere_8h.html#a0">ADR_CALL</a> <a class="code" href="classaudiere_1_1BufferStream.html#a6">setPosition</a>(<span class="keywordtype">int</span> position) { m_position = position; }
00056     <span class="keywordtype">int</span> <a class="code" href="audiere_8h.html#a0">ADR_CALL</a> <a class="code" href="classaudiere_1_1BufferStream.html#a7">getPosition</a>()              { <span class="keywordflow">return</span> m_position;     }
00057 
00058   <span class="keyword">private</span>:
00059     RefPtr&lt;SampleBuffer&gt; m_buffer;
00060     <span class="keywordtype">int</span> m_frame_size;
00061     <span class="keywordtype">int</span> m_frame_count;
00062     <span class="keyword">const</span> <a class="code" href="namespaceaudiere.html#a33">u8</a>* m_samples;
00063 
00064     <span class="keywordtype">int</span> m_position;  <span class="comment">// in frames</span>
00065   };
00066 
<a name="l00067"></a><a class="code" href="classaudiere_1_1SampleBufferImpl.html">00067</a> 
00068   <span class="keyword">class </span><a class="code" href="classaudiere_1_1SampleBufferImpl.html">SampleBufferImpl</a> : <span class="keyword">public</span> <a class="code" href="classaudiere_1_1RefImplementation.html">RefImplementation</a>&lt;SampleBuffer&gt; {
<a name="l00069"></a><a class="code" href="classaudiere_1_1SampleBufferImpl.html#a0">00069</a>   <span class="keyword">public</span>:
00070     <a class="code" href="classaudiere_1_1SampleBufferImpl.html#a0">SampleBufferImpl</a>(
00071       <span class="keywordtype">void</span>* samples, <span class="keywordtype">int</span> <a class="code" href="namespaceaudiere.html#a25">frame_count</a>,
00072       <span class="keywordtype">int</span> <a class="code" href="namespaceaudiere.html#a26">channel_count</a>, <span class="keywordtype">int</span> <a class="code" href="namespaceaudiere.html#a27">sample_rate</a>, <a class="code" href="namespaceaudiere.html#a105">SampleFormat</a> <a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a>)
00073     {
00074       <span class="keyword">const</span> <span class="keywordtype">int</span> frame_size = <a class="code" href="namespaceaudiere.html#a26">channel_count</a> * <a class="code" href="namespaceaudiere.html#a45">GetSampleSize</a>(<a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a>);
00075       <span class="keyword">const</span> <span class="keywordtype">int</span> buffer_size = <a class="code" href="namespaceaudiere.html#a25">frame_count</a> * frame_size;
00076       m_samples = <span class="keyword">new</span> <a class="code" href="namespaceaudiere.html#a33">u8</a>[buffer_size];
00077       <span class="keywordflow">if</span> (samples) {
00078         memcpy(m_samples, samples, buffer_size);
00079       } <span class="keywordflow">else</span> {
00080         memset(m_samples, 0, buffer_size);
00081       }
00082 
00083       m_frame_count   = <a class="code" href="namespaceaudiere.html#a25">frame_count</a>;
00084       m_channel_count = <a class="code" href="namespaceaudiere.html#a26">channel_count</a>;
00085       m_sample_rate   = <a class="code" href="namespaceaudiere.html#a27">sample_rate</a>;
00086       m_sample_format = <a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a>;
00087     }
<a name="l00088"></a><a class="code" href="classaudiere_1_1SampleBufferImpl.html#a1">00088</a> 
00089     <a class="code" href="classaudiere_1_1SampleBufferImpl.html#a1">~SampleBufferImpl</a>() {
00090       <span class="keyword">delete</span>[] m_samples;
00091     }
<a name="l00092"></a><a class="code" href="classaudiere_1_1SampleBufferImpl.html#a2">00092</a> 
00093     <span class="keywordtype">void</span> <a class="code" href="audiere_8h.html#a0">ADR_CALL</a> <a class="code" href="classaudiere_1_1SampleBufferImpl.html#a2">getFormat</a>(
00094       <span class="keywordtype">int</span>&amp; <a class="code" href="namespaceaudiere.html#a26">channel_count</a>,
00095       <span class="keywordtype">int</span>&amp; <a class="code" href="namespaceaudiere.html#a27">sample_rate</a>,
00096       <a class="code" href="namespaceaudiere.html#a105">SampleFormat</a>&amp; <a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a>)
00097     {
00098       <a class="code" href="namespaceaudiere.html#a26">channel_count</a> = m_channel_count;
00099       <a class="code" href="namespaceaudiere.html#a27">sample_rate</a>   = m_sample_rate;
00100       <a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a> = m_sample_format;
00101     }
<a name="l00102"></a><a class="code" href="classaudiere_1_1SampleBufferImpl.html#a3">00102</a> 
00103     <span class="keywordtype">int</span> <a class="code" href="audiere_8h.html#a0">ADR_CALL</a> <a class="code" href="classaudiere_1_1SampleBufferImpl.html#a3">getLength</a>() {
00104       <span class="keywordflow">return</span> m_frame_count;
00105     }
<a name="l00106"></a><a class="code" href="classaudiere_1_1SampleBufferImpl.html#a4">00106</a> 
00107     <span class="keyword">const</span> <span class="keywordtype">void</span>* <a class="code" href="audiere_8h.html#a0">ADR_CALL</a> <a class="code" href="classaudiere_1_1SampleBufferImpl.html#a4">getSamples</a>() {
00108       <span class="keywordflow">return</span> m_samples;
00109     }
<a name="l00110"></a><a class="code" href="classaudiere_1_1SampleBufferImpl.html#a5">00110</a> 
00111     <a class="code" href="classaudiere_1_1SampleSource.html">SampleSource</a>* <a class="code" href="audiere_8h.html#a0">ADR_CALL</a> <a class="code" href="classaudiere_1_1SampleBufferImpl.html#a5">openStream</a>() {
00112       <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classaudiere_1_1BufferStream.html">BufferStream</a>(<span class="keyword">this</span>);
00113     }
00114 
00115   <span class="keyword">private</span>:
00116     <a class="code" href="namespaceaudiere.html#a33">u8</a>* m_samples;
00117     <span class="keywordtype">int</span> m_frame_count;
00118     <span class="keywordtype">int</span> m_channel_count;
00119     <span class="keywordtype">int</span> m_sample_rate;
00120     <a class="code" href="namespaceaudiere.html#a105">SampleFormat</a> m_sample_format;
00121   };
00122 
00123 
00124   <a class="code" href="namespaceaudiere.html#a66">ADR_EXPORT</a>(SampleBuffer*) AdrCreateSampleBuffer(
<a name="l00125"></a><a class="code" href="namespaceaudiere.html#a27">00125</a>     <span class="keywordtype">void</span>* samples,
00126     <span class="keywordtype">int</span> <a class="code" href="namespaceaudiere.html#a25">frame_count</a>,
00127     <span class="keywordtype">int</span> <a class="code" href="namespaceaudiere.html#a26">channel_count</a>,
00128     <span class="keywordtype">int</span> <a class="code" href="namespaceaudiere.html#a27">sample_rate</a>,
00129     <a class="code" href="namespaceaudiere.html#a105">SampleFormat</a> <a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a>)
00130   {
00131     <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classaudiere_1_1SampleBufferImpl.html">SampleBufferImpl</a>(
00132       samples, <a class="code" href="namespaceaudiere.html#a25">frame_count</a>,
00133       <a class="code" href="namespaceaudiere.html#a26">channel_count</a>, <a class="code" href="namespaceaudiere.html#a27">sample_rate</a>, <a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a>);
00134   }
00135 
00136   <a class="code" href="namespaceaudiere.html#a66">ADR_EXPORT</a>(SampleBuffer*) AdrCreateSampleBufferFromSource(
00137     SampleSource* source)
00138   {
00139     <span class="comment">// if there is no source or it isn't seekable, we can't make a</span>
00140     <span class="comment">// buffer from it</span>
00141     <span class="keywordflow">if</span> (!source || !source-&gt;isSeekable()) {
00142       <span class="keywordflow">return</span> 0;
00143     }
00144 
00145     <span class="keywordtype">int</span> length = source-&gt;getLength();
00146     <span class="keywordtype">int</span> <a class="code" href="namespaceaudiere.html#a26">channel_count</a>, <a class="code" href="namespaceaudiere.html#a27">sample_rate</a>;
00147     <a class="code" href="namespaceaudiere.html#a105">SampleFormat</a> <a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a>;
00148     source-&gt;getFormat(<a class="code" href="namespaceaudiere.html#a26">channel_count</a>, <a class="code" href="namespaceaudiere.html#a27">sample_rate</a>, <a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a>);
00149 
00150     <span class="keywordtype">int</span> stream_length_bytes = length *
00151       <a class="code" href="namespaceaudiere.html#a26">channel_count</a> * <a class="code" href="namespaceaudiere.html#a45">GetSampleSize</a>(<a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a>);
00152     <a class="code" href="namespaceaudiere.html#a33">u8</a>* buffer = <span class="keyword">new</span> <a class="code" href="namespaceaudiere.html#a33">u8</a>[stream_length_bytes];
00153 
00154     source-&gt;setPosition(0);
00155     source-&gt;read(length, buffer);
00156 
00157     SampleBuffer* sb = <a class="code" href="namespaceaudiere.html#a59">CreateSampleBuffer</a>(
00158       buffer, length, <a class="code" href="namespaceaudiere.html#a26">channel_count</a>, <a class="code" href="namespaceaudiere.html#a27">sample_rate</a>, <a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a>);
00159 
00160     <span class="keyword">delete</span>[] buffer;
00161     <span class="keywordflow">return</span> sb;
00162   }
00163 
00164 }
</pre></div><hr><address style="align: right;"><small>Generated on Tue Jul 15 12:36:50 2003 for audiere by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc1 </small></address>
</body>
</html>
