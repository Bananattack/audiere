<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>device_null.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc1 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>device_null.cpp</h1><a href="device__null_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="preprocessor">#ifdef _MSC_VER</span>
00002 <span class="preprocessor"></span><span class="preprocessor">#pragma warning(disable : 4786)</span>
00003 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00004 <span class="preprocessor"></span>
00005 
00006 <span class="preprocessor">#include &lt;algorithm&gt;</span>
00007 <span class="preprocessor">#include &lt;functional&gt;</span>
00008 <span class="preprocessor">#include "<a class="code" href="device__null_8h.html">device_null.h</a>"</span>
00009 <span class="preprocessor">#include "<a class="code" href="timer_8h.html">timer.h</a>"</span>
00010 <span class="preprocessor">#include "<a class="code" href="threads_8h.html">threads.h</a>"</span>
00011 <span class="preprocessor">#include "<a class="code" href="utility_8h.html">utility.h</a>"</span>
00012 
00013 <span class="keyword">namespace </span>audiere {
00014 
<a name="l00015"></a><a class="code" href="classaudiere_1_1NullAudioDevice.html#d0">00015</a>   <a class="code" href="classaudiere_1_1NullAudioDevice.html">NullAudioDevice</a>*
00016   NullAudioDevice::create(<span class="keyword">const</span> <a class="code" href="classaudiere_1_1ParameterList.html">ParameterList</a>&amp; <span class="comment">/*parameters*/</span>) {
00017     <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classaudiere_1_1NullAudioDevice.html">NullAudioDevice</a>;
00018   }
00019 
00020 
00021   NullAudioDevice::NullAudioDevice() {
00022   }
00023 
00024 
00025   NullAudioDevice::~NullAudioDevice() {
00026     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"~NullAudioDevice"</span>);
00027 
00028     <a class="code" href="debug_8h.html#a3">ADR_ASSERT</a>(m_streams.size() == 0,
00029       <span class="stringliteral">"Null output context should not die with open streams"</span>);
00030   }
00031 
00032 
<a name="l00033"></a><a class="code" href="classaudiere_1_1NullAudioDevice.html#a0">00033</a>   <span class="keywordtype">void</span>
00034   NullAudioDevice::update() {
00035     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"NullAudioDevice::update"</span>);
00036     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(<span class="keyword">this</span>);
00037 
00038     StreamList::iterator i = m_streams.begin();
00039     <span class="keywordflow">for</span> (; i != m_streams.end(); ++i) {
00040       (*i)-&gt;update();
00041     }
00042 
00043     <a class="code" href="namespaceaudiere.html#a83">AI_Sleep</a>(50);
00044   }
00045 
00046 
<a name="l00047"></a><a class="code" href="classaudiere_1_1NullAudioDevice.html#a1">00047</a>   <a class="code" href="classaudiere_1_1OutputStream.html">OutputStream</a>*
00048   NullAudioDevice::openStream(<a class="code" href="classaudiere_1_1SampleSource.html">SampleSource</a>* source) {
00049     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"NullAudioDevice::openStream"</span>);
00050     
00051     <span class="keywordflow">if</span> (!source) {
00052       <span class="keywordflow">return</span> 0;
00053     }
00054 
00055     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(<span class="keyword">this</span>);
00056 
00057     <a class="code" href="classaudiere_1_1NullOutputStream.html">NullOutputStream</a>* stream = <span class="keyword">new</span> <a class="code" href="classaudiere_1_1NullAudioDevice.html#l0">NullOutputStream</a>(<span class="keyword">this</span>, source);
00058     m_streams.push_back(stream);
00059     <span class="keywordflow">return</span> stream;
00060   }
00061 
00062 
<a name="l00063"></a><a class="code" href="classaudiere_1_1NullAudioDevice.html#a2">00063</a>   <a class="code" href="classaudiere_1_1OutputStream.html">OutputStream</a>*
00064   NullAudioDevice::openBuffer(
00065     <span class="keywordtype">void</span>* samples, <span class="keywordtype">int</span> frame_count,
00066     <span class="keywordtype">int</span> channel_count, <span class="keywordtype">int</span> sample_rate, <a class="code" href="namespaceaudiere.html#a105">SampleFormat</a> <a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a>)
00067   {
00068     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"NullAudioDevice::openBuffer"</span>);
00069 
00070     <a class="code" href="classaudiere_1_1RefPtr.html">RefPtr&lt;SampleSource&gt;</a> <a class="code" href="namespaceaudiere.html#a29">source</a>(<a class="code" href="namespaceaudiere.html#a104">OpenBufferStream</a>(
00071       samples, frame_count,
00072       channel_count, sample_rate, <a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a>));
00073     <span class="keywordflow">return</span> <a class="code" href="classaudiere_1_1NullAudioDevice.html#a1">openStream</a>(source.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00074   }
00075 
00076 
<a name="l00077"></a><a class="code" href="classaudiere_1_1NullAudioDevice.html#a3">00077</a>   <span class="keyword">const</span> <span class="keywordtype">char</span>*
00078   NullAudioDevice::getName() {
00079     <span class="keywordflow">return</span> <span class="stringliteral">"null"</span>;
00080   }
00081 
00082 
00083   <span class="keywordtype">void</span>
00084   NullAudioDevice::removeStream(NullOutputStream* stream) {
00085     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(<span class="keyword">this</span>);
00086     m_streams.remove(stream);
00087   }
00088 
00089 
00090   NullOutputStream::NullOutputStream(
00091     NullAudioDevice* device,
00092     SampleSource* source)
00093   : m_device(device)
00094   , m_source(source)
00095   , m_is_playing(false)
00096   , m_volume(1)
00097   , m_pan(0)
00098   , m_shift(1)
00099   , m_last_update(0)
00100   {
00101     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"NullOutputStream::NullOutputStream"</span>);
00102     m_source-&gt;getFormat(m_channel_count, m_sample_rate, m_sample_format);
00103   }
00104 
00105 
00106   NullOutputStream::~NullOutputStream() {
00107     m_device-&gt;removeStream(<span class="keyword">this</span>);
00108   }
00109 
00110 
<a name="l00111"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a0">00111</a>   <span class="keywordtype">void</span>
00112   NullOutputStream::play() {
00113     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"NullOutputStream::play"</span>);
00114     m_is_playing = <span class="keyword">true</span>;
00115     resetTimer();
00116   }
00117 
00118 
<a name="l00119"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a1">00119</a>   <span class="keywordtype">void</span>
00120   NullOutputStream::stop() {
00121     m_is_playing = <span class="keyword">false</span>;
00122   }
00123 
00124 
<a name="l00125"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a2">00125</a>   <span class="keywordtype">void</span>
00126   NullOutputStream::reset() {
00127     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00128     resetTimer();
00129     m_source-&gt;reset();
00130   }
00131 
00132 
<a name="l00133"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a3">00133</a>   <span class="keywordtype">bool</span>
00134   NullOutputStream::isPlaying() {
00135     <span class="keywordflow">return</span> m_is_playing;
00136   }
00137 
00138 
<a name="l00139"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a4">00139</a>   <span class="keywordtype">void</span>
00140   NullOutputStream::setRepeat(<span class="keywordtype">bool</span> repeat) {
00141     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00142     m_source-&gt;setRepeat(repeat);
00143   }
00144 
00145 
<a name="l00146"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a5">00146</a>   <span class="keywordtype">bool</span>
00147   NullOutputStream::getRepeat() {
00148     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00149     <span class="keywordflow">return</span> m_source-&gt;getRepeat();
00150   }
00151 
00152 
<a name="l00153"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a6">00153</a>   <span class="keywordtype">void</span>
00154   NullOutputStream::setVolume(<span class="keywordtype">float</span> volume) {
00155     m_volume = volume;
00156   }
00157 
00158 
<a name="l00159"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a7">00159</a>   <span class="keywordtype">float</span>
00160   NullOutputStream::getVolume() {
00161     <span class="keywordflow">return</span> m_volume;
00162   }
00163 
00164   
<a name="l00165"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a8">00165</a>   <span class="keywordtype">void</span>
00166   NullOutputStream::setPan(<span class="keywordtype">float</span> pan) {
00167     m_pan = pan;
00168   }
00169 
00170   
<a name="l00171"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a9">00171</a>   <span class="keywordtype">float</span>
00172   NullOutputStream::getPan() {
00173     <span class="keywordflow">return</span> m_pan;
00174   }
00175 
00176 
<a name="l00177"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a10">00177</a>   <span class="keywordtype">void</span>
00178   NullOutputStream::setPitchShift(<span class="keywordtype">float</span> shift) {
00179     m_shift = shift;
00180   }
00181 
00182 
<a name="l00183"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a11">00183</a>   <span class="keywordtype">float</span>
00184   NullOutputStream::getPitchShift() {
00185     <span class="keywordflow">return</span> m_shift;
00186   }
00187 
00188 
<a name="l00189"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a12">00189</a>   <span class="keywordtype">bool</span>
00190   NullOutputStream::isSeekable() {
00191     <span class="keywordflow">return</span> m_source-&gt;isSeekable();
00192   }
00193 
00194 
<a name="l00195"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a13">00195</a>   <span class="keywordtype">int</span>
00196   NullOutputStream::getLength() {
00197     <span class="keywordflow">return</span> m_source-&gt;getLength();
00198   }
00199 
00200 
<a name="l00201"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a14">00201</a>   <span class="keywordtype">void</span>
00202   NullOutputStream::setPosition(<span class="keywordtype">int</span> position) {
00203     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(m_device.<a class="code" href="classaudiere_1_1RefPtr.html#a8">get</a>());
00204     m_source-&gt;setPosition(position);
00205     <a class="code" href="classaudiere_1_1NullOutputStream.html#a2">reset</a>();
00206   }
00207 
00208 
<a name="l00209"></a><a class="code" href="classaudiere_1_1NullOutputStream.html#a15">00209</a>   <span class="keywordtype">int</span>
00210   NullOutputStream::getPosition() {
00211     <span class="keywordflow">return</span> m_source-&gt;getPosition();
00212   }
00213 
00214 
00215   <span class="keywordtype">void</span>
00216   NullOutputStream::resetTimer() {
00217     m_last_update = <a class="code" href="timer__ansi_8cpp.html#a0">GetNow</a>();
00218   }
00219 
00220 
00221   <span class="keywordtype">void</span>
00222   NullOutputStream::update() {
00223     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"NullOutputStream::update"</span>);
00224 
00225     <span class="keywordflow">if</span> (m_is_playing) {
00226       <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"Null output stream is playing"</span>);
00227 
00228       <span class="comment">// get number of microseconds elapsed since last playing update</span>
00229       <span class="comment">// so we can read that much time worth of samples</span>
00230       <a class="code" href="namespaceaudiere.html#a39">u64</a> now = <a class="code" href="timer__ansi_8cpp.html#a0">GetNow</a>();
00231       <a class="code" href="namespaceaudiere.html#a39">u64</a> elapsed = now - m_last_update;
00232 
00233       <span class="keywordtype">double</span> shifted_time = m_shift * <a class="code" href="namespaceaudiere.html#a40">s64</a>(elapsed) / 1000000.0;  <span class="comment">// in seconds</span>
00234       <span class="keywordtype">int</span> samples_to_read = int(m_sample_rate * shifted_time);
00235 
00236       <a class="code" href="debug_8h.html#a2">ADR_IF_DEBUG</a> {
00237         <span class="keywordtype">char</span> str[100];
00238         sprintf(str, <span class="stringliteral">"Samples to read: %d"</span>, samples_to_read);
00239         <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(str);
00240       }
00241 
00242       <span class="keywordtype">int</span> samples_read = dummyRead(samples_to_read);
00243 
00244       <span class="keywordflow">if</span> (samples_read != samples_to_read) {
00245         <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"Stopping null output stream"</span>);
00246         m_source-&gt;reset();
00247         <a class="code" href="classaudiere_1_1NullOutputStream.html#a1">stop</a>();
00248       }
00249 
00250       m_last_update = now;
00251     }
00252   }
00253 
00254 
00255   <span class="keywordtype">int</span>
00256   NullOutputStream::dummyRead(<span class="keywordtype">int</span> samples_to_read) {
00257     <span class="keywordtype">int</span> total = 0;  <span class="comment">// number of samples read so far</span>
00258 
00259     <span class="keyword">const</span> <span class="keywordtype">int</span> bytes_per_sample = <a class="code" href="namespaceaudiere.html#a45">GetSampleSize</a>(m_sample_format);
00260 
00261     <span class="comment">// read samples into dummy buffer, counting the number we actually read</span>
00262     <a class="code" href="namespaceaudiere.html#a33">u8</a>* dummy = <span class="keyword">new</span> <a class="code" href="namespaceaudiere.html#a33">u8</a>[1024 * m_channel_count * bytes_per_sample];
00263     <span class="keywordflow">while</span> (samples_to_read &gt; 0) {
00264       <span class="keywordtype">int</span> read = std::min(1024, samples_to_read);
00265       <span class="keywordtype">int</span> actual_read = m_source-&gt;read(read, dummy);
00266       total += actual_read;
00267       samples_to_read -= actual_read;
00268       <span class="keywordflow">if</span> (actual_read &lt; read) {
00269         <span class="keywordflow">break</span>;
00270       }
00271     }
00272 
00273     <span class="keyword">delete</span>[] dummy;
00274     <span class="keywordflow">return</span> total;
00275   }
00276 
00277 }
</pre></div><hr><address style="align: right;"><small>Generated on Tue Jul 15 12:36:48 2003 for audiere by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc1 </small></address>
</body>
</html>
