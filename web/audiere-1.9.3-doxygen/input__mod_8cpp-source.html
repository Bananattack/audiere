<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>input_mod.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc1 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>input_mod.cpp</h1><a href="input__mod_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00002 <span class="preprocessor">#include "<a class="code" href="input__mod_8h.html">input_mod.h</a>"</span>
00003 <span class="preprocessor">#include "<a class="code" href="debug_8h.html">debug.h</a>"</span>
00004 
00005 
00006 <span class="keyword">namespace </span>audiere {
<a name="l00007"></a><a class="code" href="classaudiere_1_1MODInputStream.html#a0">00007</a> 
00008   MODInputStream::MODInputStream() {
00009     m_duh = 0;
00010     m_renderer = 0;
00011   }
00012 
<a name="l00013"></a><a class="code" href="classaudiere_1_1MODInputStream.html#a1">00013</a> 
00014   MODInputStream::~MODInputStream() {
00015     <span class="keywordflow">if</span> (m_renderer) {
00016       duh_end_sigrenderer(m_renderer);
00017       m_renderer = 0;
00018     }
00019 
00020     <span class="keywordflow">if</span> (m_duh) {
00021       unload_duh(m_duh);
00022       m_duh = 0;
00023     }
00024   }
00025 
00026 
<a name="l00027"></a><a class="code" href="classaudiere_1_1MODInputStream.html#a2">00027</a>   <span class="keywordtype">bool</span>
00028   MODInputStream::initialize(<a class="code" href="namespaceaudiere.html#a0">FilePtr</a> file) {
00029     <span class="comment">// first time we run, initialize DUMB</span>
00030     <span class="keyword">static</span> <span class="keywordtype">bool</span> initialized = <span class="keyword">false</span>;
00031     <span class="keywordflow">if</span> (!initialized) {
00032       <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"Initializing DUMB"</span>);
00033 
00034       atexit(dumb_exit);
00035 
00036       <span class="keyword">static</span> DUMBFILE_SYSTEM dfs = {
00037         dfs_open,
00038         dfs_skip,
00039         dfs_getc,
00040         dfs_getnc,
00041         dfs_close,
00042       };
00043       register_dumbfile_system(&amp;dfs);
00044 
00045       <span class="comment">// cubic simply takes too much of the CPU...</span>
00046       dumb_resampling_quality = DUMB_RQ_LINEAR;
00047 
00048       initialized = <span class="keyword">true</span>;
00049     }
00050 
00051     m_duh = openDUH(file);
00052     <span class="keywordflow">if</span> (!m_duh) {
00053       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00054     }
00055 
00056     m_renderer = duh_start_sigrenderer(m_duh, 0, 2, 0);
00057     <span class="keywordflow">if</span> (!m_renderer) {
00058       unload_duh(m_duh);
00059       m_duh = 0;
00060       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00061     }
00062 
00063     DUMB_IT_SIGRENDERER* renderer = duh_get_it_sigrenderer(m_renderer);
00064     dumb_it_set_loop_callback(renderer, &amp;MODInputStream::loopCallback, <span class="keyword">this</span>);
00065 
00066     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00067   }
00068 
00069 
<a name="l00070"></a><a class="code" href="classaudiere_1_1MODInputStream.html#a3">00070</a>   <span class="keywordtype">void</span>
00071   MODInputStream::getFormat(
00072     <span class="keywordtype">int</span>&amp; channel_count,
00073     <span class="keywordtype">int</span>&amp; sample_rate,
00074     <a class="code" href="namespaceaudiere.html#a105">SampleFormat</a>&amp; <a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a>)
00075   {
00076     channel_count = 2;
00077     sample_rate   = 44100;
00078     <a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a> = <a class="code" href="namespaceaudiere.html#a105a8">SF_S16</a>;
00079   }
00080 
00081 
<a name="l00082"></a><a class="code" href="classaudiere_1_1MODInputStream.html#a4">00082</a>   <span class="keywordtype">void</span>
00083   MODInputStream::reset() {
00084     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"MOD_Reset"</span>);
00085     DUH_SIGRENDERER* renderer = duh_start_sigrenderer(m_duh, 0, 2, 0);
00086     <span class="keywordflow">if</span> (renderer) {
00087       <span class="keywordflow">if</span> (m_renderer) {
00088         duh_end_sigrenderer(m_renderer);
00089       }
00090       m_renderer = renderer;
00091 
00092       DUMB_IT_SIGRENDERER* renderer = duh_get_it_sigrenderer(m_renderer);
00093       dumb_it_set_loop_callback(renderer, &amp;MODInputStream::loopCallback, <span class="keyword">this</span>);
00094     }
00095   }
00096 
00097   
<a name="l00098"></a><a class="code" href="classaudiere_1_1MODInputStream.html#a5">00098</a>   <span class="keywordtype">int</span>
00099   MODInputStream::doRead(<span class="keywordtype">int</span> frame_count, <span class="keywordtype">void</span>* buffer) {
00100     <span class="keywordflow">return</span> duh_render(m_renderer, 16, 0, 1.0f, 65536.0f / 44100,
00101                       frame_count, buffer);
00102   }
00103 
00104 
00105   DUH*
00106   MODInputStream::openDUH(<a class="code" href="namespaceaudiere.html#a0">FilePtr</a> file) {
00107     <span class="keyword">const</span> <span class="keywordtype">char</span>* filename = (<span class="keyword">const</span> <span class="keywordtype">char</span>*)file.get();
00108 
00109     DUH* duh = dumb_load_it(filename);
00110     <span class="keywordflow">if</span> (duh) <span class="keywordflow">return</span> duh;
00111     file-&gt;seek(0, File::BEGIN);
00112 
00113     duh = dumb_load_xm(filename);
00114     <span class="keywordflow">if</span> (duh) <span class="keywordflow">return</span> duh;
00115     file-&gt;seek(0, File::BEGIN);
00116 
00117     duh = dumb_load_s3m(filename);
00118     <span class="keywordflow">if</span> (duh) <span class="keywordflow">return</span> duh;
00119     file-&gt;seek(0, File::BEGIN);
00120 
00121     <span class="keywordflow">return</span> dumb_load_mod(filename);
00122   }
00123 
00124   
00125   <span class="keywordtype">void</span>*
00126   MODInputStream::dfs_open(<span class="keyword">const</span> <span class="keywordtype">char</span>* filename) {
00127     <span class="keywordflow">return</span> const_cast&lt;char*&gt;(filename);
00128   }
00129 
00130   
00131   <span class="keywordtype">int</span>
00132   MODInputStream::dfs_skip(<span class="keywordtype">void</span>* f, <span class="keywordtype">long</span> n) {
00133     File* file = (File*)f;
00134     <span class="keywordflow">if</span> (file-&gt;seek(n, File::CURRENT)) {
00135       <span class="keywordflow">return</span> 0;
00136     } <span class="keywordflow">else</span> {
00137       <span class="keywordflow">return</span> -1;
00138     }
00139   }
00140 
00141 
00142   <span class="keywordtype">int</span>
00143   MODInputStream::dfs_getc(<span class="keywordtype">void</span>* f) {
00144     File* file = (File*)f;
00145     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> c;
00146     <span class="keywordflow">if</span> (file-&gt;read(&amp;c, 1) == 1) {
00147       <span class="keywordflow">return</span> c;
00148     } <span class="keywordflow">else</span> {
00149       <span class="keywordflow">return</span> -1;
00150     }
00151   }
00152 
00153 
00154   <span class="keywordtype">long</span>
00155   MODInputStream::dfs_getnc(<span class="keywordtype">char</span>* ptr, <span class="keywordtype">long</span> n, <span class="keywordtype">void</span>* f) {
00156     File* file = (File*)f;
00157     <span class="keywordflow">return</span> file-&gt;read(ptr, n);
00158   }
00159 
00160 
00161   <span class="keywordtype">void</span>
00162   MODInputStream::dfs_close(<span class="keywordtype">void</span>* f) {
00163     <span class="comment">// nothing</span>
00164   }
00165 
00166   <span class="keywordtype">int</span>
00167   MODInputStream::loopCallback(<span class="keywordtype">void</span>* ptr) {
00168     <a class="code" href="classaudiere_1_1MODInputStream.html#a0">MODInputStream</a>* This = (<a class="code" href="classaudiere_1_1MODInputStream.html#a0">MODInputStream</a>*)ptr;
00169     <span class="keywordflow">return</span> (This-&gt;getRepeat() ? 0 : -1);
00170   }
00171 
00172 }
</pre></div><hr><address style="align: right;"><small>Generated on Tue Jul 15 12:36:49 2003 for audiere by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc1 </small></address>
</body>
</html>
