<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>input.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc1 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>input.cpp</h1><a href="input_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="preprocessor">#include &lt;memory&gt;</span>
00002 <span class="preprocessor">#include &lt;string.h&gt;</span>
00003 <span class="preprocessor">#include "<a class="code" href="debug_8h.html">debug.h</a>"</span>
00004 <span class="preprocessor">#include "<a class="code" href="default__file_8h.html">default_file.h</a>"</span>
00005 <span class="preprocessor">#ifndef NO_FLAC</span>
00006 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="input__flac_8h.html">input_flac.h</a>"</span>
00007 <span class="preprocessor">#endif</span>
00008 <span class="preprocessor"></span><span class="preprocessor">#ifndef NO_DUMB</span>
00009 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="input__mod_8h.html">input_mod.h</a>"</span>
00010 <span class="preprocessor">#endif</span>
00011 <span class="preprocessor"></span><span class="preprocessor">#ifndef NO_MP3</span>
00012 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="input__mp3_8h.html">input_mp3.h</a>"</span>
00013 <span class="preprocessor">#endif</span>
00014 <span class="preprocessor"></span><span class="preprocessor">#ifndef NO_OGG</span>
00015 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="input__ogg_8h.html">input_ogg.h</a>"</span>
00016 <span class="preprocessor">#endif</span>
00017 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="input__wav_8h.html">input_wav.h</a>"</span>
00018 <span class="preprocessor">#include "<a class="code" href="input__aiff_8h.html">input_aiff.h</a>"</span>
00019 <span class="preprocessor">#include "<a class="code" href="internal_8h.html">internal.h</a>"</span>
00020 <span class="preprocessor">#include "<a class="code" href="utility_8h.html">utility.h</a>"</span>
00021 
00022 
00023 <span class="keyword">namespace </span>audiere {
00024 
00025 
00026   <a class="code" href="namespaceaudiere.html#a66">ADR_EXPORT</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>*) AdrGetSupportedFileFormats() {
00027     <span class="keywordflow">return</span>
00028       <span class="stringliteral">"AIFF Files:aiff,aifc"</span>  <span class="stringliteral">";"</span>
00029 <span class="preprocessor">#ifndef NO_MP3</span>
00030 <span class="preprocessor"></span>      <span class="stringliteral">"MP3 Files:mp3"</span>  <span class="stringliteral">";"</span>
00031 <span class="preprocessor">#endif</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#ifndef NO_OGG</span>
00033 <span class="preprocessor"></span>      <span class="stringliteral">"Ogg Vorbis Files:ogg"</span>  <span class="stringliteral">";"</span>
00034 <span class="preprocessor">#endif</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#ifndef NO_FLAC</span>
00036 <span class="preprocessor"></span>      <span class="stringliteral">"FLAC Files:flac"</span>  <span class="stringliteral">";"</span>
00037 <span class="preprocessor">#endif</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#ifndef NO_DUMB</span>
00039 <span class="preprocessor"></span>      <span class="stringliteral">"Mod Files:mod,s3m,xm,it"</span>  <span class="stringliteral">";"</span>
00040 <span class="preprocessor">#endif</span>
00041 <span class="preprocessor"></span>      <span class="stringliteral">"WAV Files:wav"</span>;
00042   }
00043 
00044 
00045   <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;
00046   <span class="keyword">static</span> T* TryInputStream(<span class="keyword">const</span> <a class="code" href="namespaceaudiere.html#a0">FilePtr</a>&amp; file) {
00047 
00048     <span class="comment">// initialize should never close the file</span>
00049 
00050     T* source = <span class="keyword">new</span> T();
00051     <span class="keywordflow">if</span> (source-&gt;initialize(file)) {
00052       <span class="keywordflow">return</span> source;
00053     } <span class="keywordflow">else</span> {
00054       <span class="keyword">delete</span> source;
00055       <span class="keywordflow">return</span> 0;
00056     }
00057   }
00058 
<a name="l00059"></a><a class="code" href="input_8cpp.html#a0">00059</a> 
00060 <span class="preprocessor">#define TRY_SOURCE(source_type) {                             \</span>
00061 <span class="preprocessor">  source_type* source = TryInputStream&lt;source_type&gt;(file);    \</span>
00062 <span class="preprocessor">  if (source) {                                               \</span>
00063 <span class="preprocessor">    return source;                                            \</span>
00064 <span class="preprocessor">  } else {                                                    \</span>
00065 <span class="preprocessor">    file-&gt;seek(0, File::BEGIN);                               \</span>
00066 <span class="preprocessor">  }                                                           \</span>
00067 <span class="preprocessor">}</span>
00068 <span class="preprocessor"></span>
<a name="l00069"></a><a class="code" href="input_8cpp.html#a1">00069</a> 
00070 <span class="preprocessor">#define TRY_OPEN(format) {                                    \</span>
00071 <span class="preprocessor">  SampleSource* source = OpenSource(file, filename, format);  \</span>
00072 <span class="preprocessor">  if (source) {                                               \</span>
00073 <span class="preprocessor">    return source;                                            \</span>
00074 <span class="preprocessor">  }                                                           \</span>
00075 <span class="preprocessor">}</span>
00076 <span class="preprocessor"></span>
<a name="l00077"></a><a class="code" href="namespaceaudiere.html#a71">00077</a> 
00078   <span class="keywordtype">bool</span> <a class="code" href="namespaceaudiere.html#a71">end_is</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* begin, <span class="keyword">const</span> <span class="keywordtype">char</span>* ext) {
00079     <span class="keyword">const</span> <span class="keywordtype">char</span>* end = begin + strlen(begin);
00080     <span class="keywordtype">int</span> ext_length = strlen(ext);
00081     <span class="keywordflow">if</span> (ext_length &gt; end - begin) {
00082       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00083     } <span class="keywordflow">else</span> {
00084       <span class="keywordflow">return</span> (<a class="code" href="namespaceaudiere.html#a93">strcmp_case</a>(end - ext_length, ext) == 0);
00085     }
00086   }
00087 
<a name="l00088"></a><a class="code" href="namespaceaudiere.html#a72">00088</a> 
00089   <a class="code" href="namespaceaudiere.html#a106">FileFormat</a> <a class="code" href="namespaceaudiere.html#a72">GuessFormat</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* filename) {
00090     <span class="keywordflow">if</span> (<a class="code" href="namespaceaudiere.html#a71">end_is</a>(filename, <span class="stringliteral">".aiff"</span>)) {
00091       <span class="keywordflow">return</span> <a class="code" href="namespaceaudiere.html#a106a15">FF_AIFF</a>;
00092     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="namespaceaudiere.html#a71">end_is</a>(filename, <span class="stringliteral">".wav"</span>)) {
00093       <span class="keywordflow">return</span> <a class="code" href="namespaceaudiere.html#a106a10">FF_WAV</a>;
00094     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="namespaceaudiere.html#a71">end_is</a>(filename, <span class="stringliteral">".ogg"</span>)) {
00095       <span class="keywordflow">return</span> <a class="code" href="namespaceaudiere.html#a106a11">FF_OGG</a>;
00096     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="namespaceaudiere.html#a71">end_is</a>(filename, <span class="stringliteral">".flac"</span>)) {
00097       <span class="keywordflow">return</span> <a class="code" href="namespaceaudiere.html#a106a12">FF_FLAC</a>;
00098     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="namespaceaudiere.html#a71">end_is</a>(filename, <span class="stringliteral">".mp3"</span>)) {
00099       <span class="keywordflow">return</span> <a class="code" href="namespaceaudiere.html#a106a13">FF_MP3</a>;
00100     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="namespaceaudiere.html#a71">end_is</a>(filename, <span class="stringliteral">".it"</span>) ||
00101                <a class="code" href="namespaceaudiere.html#a71">end_is</a>(filename, <span class="stringliteral">".xm"</span>) ||
00102                <a class="code" href="namespaceaudiere.html#a71">end_is</a>(filename, <span class="stringliteral">".s3m"</span>) ||
00103                <a class="code" href="namespaceaudiere.html#a71">end_is</a>(filename, <span class="stringliteral">".mod"</span>)) {
00104       <span class="keywordflow">return</span> <a class="code" href="namespaceaudiere.html#a106a14">FF_MOD</a>;
00105     } <span class="keywordflow">else</span> {
00106       <span class="keywordflow">return</span> <a class="code" href="namespaceaudiere.html#a106a9">FF_AUTODETECT</a>;
00107     }
00108   }
00109 
00110 
00118   SampleSource* <a class="code" href="namespaceaudiere.html#a73">OpenSource</a>(
00119     <span class="keyword">const</span> <a class="code" href="namespaceaudiere.html#a0">FilePtr</a>&amp; file,
00120     <span class="keyword">const</span> <span class="keywordtype">char</span>* filename,
00121     <a class="code" href="namespaceaudiere.html#a106">FileFormat</a> <a class="code" href="namespaceaudiere_1_1hidden.html#a1">file_format</a>)
00122   {
00123     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"OpenSource"</span>);
00124     <a class="code" href="debug_8h.html#a3">ADR_ASSERT</a>(file != 0, <span class="stringliteral">"file must not be null"</span>);
00125 
00126     <span class="keywordflow">switch</span> (file_format) {
00127       <span class="keywordflow">case</span> <a class="code" href="namespaceaudiere.html#a106a9">FF_AUTODETECT</a>:
00128         
00129         <span class="comment">// if filename is available, use it as a hint</span>
00130         <span class="keywordflow">if</span> (filename) {
00131           <a class="code" href="namespaceaudiere.html#a106">FileFormat</a> format = <a class="code" href="namespaceaudiere.html#a72">GuessFormat</a>(filename);
00132           <span class="keywordflow">if</span> (format != <a class="code" href="namespaceaudiere.html#a106a9">FF_AUTODETECT</a>) {
00133             <a class="code" href="input_8cpp.html#a1">TRY_OPEN</a>(format);
00134           }
00135         }
00136 
00137         <span class="comment">// autodetect otherwise, in decreasing order of possibility of failure</span>
00138         <a class="code" href="input_8cpp.html#a1">TRY_OPEN</a>(<a class="code" href="namespaceaudiere.html#a106a14">FF_MOD</a>);
00139         <a class="code" href="input_8cpp.html#a1">TRY_OPEN</a>(<a class="code" href="namespaceaudiere.html#a106a15">FF_AIFF</a>);
00140         <a class="code" href="input_8cpp.html#a1">TRY_OPEN</a>(<a class="code" href="namespaceaudiere.html#a106a10">FF_WAV</a>);
00141         <a class="code" href="input_8cpp.html#a1">TRY_OPEN</a>(<a class="code" href="namespaceaudiere.html#a106a11">FF_OGG</a>);
00142         <a class="code" href="input_8cpp.html#a1">TRY_OPEN</a>(<a class="code" href="namespaceaudiere.html#a106a13">FF_MP3</a>);
00143         <a class="code" href="input_8cpp.html#a1">TRY_OPEN</a>(<a class="code" href="namespaceaudiere.html#a106a12">FF_FLAC</a>);
00144         <span class="keywordflow">return</span> 0;
00145 
00146 <span class="preprocessor">#ifndef NO_DUMB</span>
00147 <span class="preprocessor"></span>      <span class="keywordflow">case</span> <a class="code" href="namespaceaudiere.html#a106a14">FF_MOD</a>:
00148         <a class="code" href="input_8cpp.html#a0">TRY_SOURCE</a>(MODInputStream);
00149         <span class="keywordflow">return</span> 0;
00150 <span class="preprocessor">#endif</span>
00151 <span class="preprocessor"></span>
00152       <span class="keywordflow">case</span> <a class="code" href="namespaceaudiere.html#a106a15">FF_AIFF</a>:
00153         <a class="code" href="input_8cpp.html#a0">TRY_SOURCE</a>(AIFFInputStream);
00154         <span class="keywordflow">return</span> 0;
00155 
00156       <span class="keywordflow">case</span> <a class="code" href="namespaceaudiere.html#a106a10">FF_WAV</a>:
00157         <a class="code" href="input_8cpp.html#a0">TRY_SOURCE</a>(WAVInputStream);
00158         <span class="keywordflow">return</span> 0;
00159 
00160 <span class="preprocessor">#ifndef NO_OGG</span>
00161 <span class="preprocessor"></span>      <span class="keywordflow">case</span> <a class="code" href="namespaceaudiere.html#a106a11">FF_OGG</a>:
00162         <a class="code" href="input_8cpp.html#a0">TRY_SOURCE</a>(OGGInputStream);
00163         <span class="keywordflow">return</span> 0;
00164 <span class="preprocessor">#endif</span>
00165 <span class="preprocessor"></span>
00166 <span class="preprocessor">#ifndef NO_MP3</span>
00167 <span class="preprocessor"></span>      <span class="keywordflow">case</span> <a class="code" href="namespaceaudiere.html#a106a13">FF_MP3</a>:
00168         <a class="code" href="input_8cpp.html#a0">TRY_SOURCE</a>(MP3InputStream);
00169         <span class="keywordflow">return</span> 0;
00170 <span class="preprocessor">#endif</span>
00171 <span class="preprocessor"></span>
00172 <span class="preprocessor">#ifndef NO_FLAC</span>
00173 <span class="preprocessor"></span>      <span class="keywordflow">case</span> <a class="code" href="namespaceaudiere.html#a106a12">FF_FLAC</a>:
00174         <a class="code" href="input_8cpp.html#a0">TRY_SOURCE</a>(FLACInputStream);
00175         <span class="keywordflow">return</span> 0;
00176 <span class="preprocessor">#endif</span>
00177 <span class="preprocessor"></span>
00178       <span class="keywordflow">default</span>:
00179         <span class="keywordflow">return</span> 0;
00180     }
00181   }
00182 
00183 
00184   <a class="code" href="namespaceaudiere.html#a66">ADR_EXPORT</a>(SampleSource*) AdrOpenSampleSource(
00185     <span class="keyword">const</span> <span class="keywordtype">char</span>* filename,
00186     <a class="code" href="namespaceaudiere.html#a106">FileFormat</a> <a class="code" href="namespaceaudiere_1_1hidden.html#a1">file_format</a>)
00187   {
00188     <span class="keywordflow">if</span> (!filename) {
00189       <span class="keywordflow">return</span> 0;
00190     }
00191     <a class="code" href="namespaceaudiere.html#a0">FilePtr</a> file = <a class="code" href="namespaceaudiere.html#a64">OpenFile</a>(filename, <span class="keyword">false</span>);
00192     <span class="keywordflow">if</span> (!file) {
00193       <span class="keywordflow">return</span> 0;
00194     }
00195     <span class="keywordflow">return</span> <a class="code" href="namespaceaudiere.html#a73">OpenSource</a>(file, filename, <a class="code" href="namespaceaudiere_1_1hidden.html#a1">file_format</a>);
00196   }
00197 
00198 
00199   <a class="code" href="namespaceaudiere.html#a66">ADR_EXPORT</a>(SampleSource*) AdrOpenSampleSourceFromFile(
00200     File* file,
00201     <a class="code" href="namespaceaudiere.html#a106">FileFormat</a> <a class="code" href="namespaceaudiere_1_1hidden.html#a1">file_format</a>)
00202   {
00203     <span class="keywordflow">if</span> (!file) {
00204       <span class="keywordflow">return</span> 0;
00205     }
00206     <span class="keywordflow">return</span> <a class="code" href="namespaceaudiere.html#a73">OpenSource</a>(file, 0, <a class="code" href="namespaceaudiere_1_1hidden.html#a1">file_format</a>);
00207   }
00208 
00209 }
</pre></div><hr><address style="align: right;"><small>Generated on Tue Jul 15 12:36:48 2003 for audiere by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc1 </small></address>
</body>
</html>
