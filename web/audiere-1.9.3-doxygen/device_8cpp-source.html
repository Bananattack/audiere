<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>device.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc1 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>device.cpp</h1><a href="device_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">// *sigh*, looking forward to VS.NET...</span>
00002 <span class="preprocessor">#ifdef _MSC_VER</span>
00003 <span class="preprocessor"></span><span class="preprocessor">#pragma warning(disable : 4786)</span>
00004 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00005 <span class="preprocessor"></span>
00006 
00007 <span class="preprocessor">#include &lt;string&gt;</span>
00008 <span class="preprocessor">#include "<a class="code" href="audiere_8h.html">audiere.h</a>"</span>
00009 <span class="preprocessor">#include "<a class="code" href="debug_8h.html">debug.h</a>"</span>
00010 <span class="preprocessor">#include "<a class="code" href="device__null_8h.html">device_null.h</a>"</span>
00011 <span class="preprocessor">#include "<a class="code" href="internal_8h.html">internal.h</a>"</span>
00012 <span class="preprocessor">#include "<a class="code" href="threads_8h.html">threads.h</a>"</span>
00013 
00014 <span class="preprocessor">#ifdef _MSC_VER</span>
00015 <span class="preprocessor"></span>
00016 <span class="preprocessor">  #include &lt;windows.h&gt;</span>
00017 <span class="preprocessor">  #include &lt;mmsystem.h&gt;</span>
00018 <span class="preprocessor">  #include "<a class="code" href="device__ds_8h.html">device_ds.h</a>"</span>
00019 <span class="preprocessor">  #include "<a class="code" href="device__mm_8h.html">device_mm.h</a>"</span>
00020 
00021 <span class="preprocessor">#endif</span>
00022 <span class="preprocessor"></span>
00023 <span class="preprocessor">#ifdef HAVE_OSS</span>
00024 <span class="preprocessor"></span><span class="preprocessor">  #include "<a class="code" href="device__oss_8h.html">device_oss.h</a>"</span>
00025 <span class="preprocessor">#endif</span>
00026 <span class="preprocessor"></span>
00027 <span class="preprocessor">#ifdef HAVE_AL</span>
00028 <span class="preprocessor"></span><span class="preprocessor">  #include "<a class="code" href="device__al_8h.html">device_al.h</a>"</span>
00029 <span class="preprocessor">#endif</span>
00030 <span class="preprocessor"></span>
00031 <span class="preprocessor">#ifdef HAVE_DSOUND</span>
00032 <span class="preprocessor"></span><span class="preprocessor">  #include "<a class="code" href="device__ds_8h.html">device_ds.h</a>"</span>
00033 <span class="preprocessor">#endif</span>
00034 <span class="preprocessor"></span>
00035 <span class="preprocessor">#ifdef HAVE_WINMM</span>
00036 <span class="preprocessor"></span><span class="preprocessor">  #include "<a class="code" href="device__mm_8h.html">device_mm.h</a>"</span>
00037 <span class="preprocessor">#endif</span>
00038 <span class="preprocessor"></span>
00039 
00040 <span class="keyword">namespace </span>audiere {
00041 
<a name="l00042"></a><a class="code" href="namespaceaudiere.html#a67">00042</a> 
00043   <a class="code" href="namespaceaudiere.html#a66">ADR_EXPORT</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>*) AdrGetSupportedAudioDevices() {
00044     <span class="keywordflow">return</span>
00045 <span class="preprocessor">#ifdef _MSC_VER</span>
00046 <span class="preprocessor"></span>      <span class="stringliteral">"directsound:DirectSound (high-performance)"</span>  <span class="stringliteral">";"</span>
00047       <span class="stringliteral">"winmm:Windows Multimedia (compatible)"</span>  <span class="stringliteral">";"</span>
00048 <span class="preprocessor">#else</span>
00049 <span class="preprocessor"></span><span class="preprocessor">#ifdef HAVE_OSS</span>
00050 <span class="preprocessor"></span>      <span class="stringliteral">"oss:Open Sound System"</span>  <span class="stringliteral">";"</span>
00051 <span class="preprocessor">#endif</span>
00052 <span class="preprocessor"></span><span class="preprocessor">#ifdef HAVE_DSOUND</span>
00053 <span class="preprocessor"></span>      <span class="stringliteral">"directsound:DirectSound (high-performance)"</span>  <span class="stringliteral">";"</span>
00054 <span class="preprocessor">#endif</span>
00055 <span class="preprocessor"></span><span class="preprocessor">#ifdef HAVE_WINMM</span>
00056 <span class="preprocessor"></span>      <span class="stringliteral">"winmm:Windows Multimedia (compatible)"</span>  <span class="stringliteral">";"</span>
00057 <span class="preprocessor">#endif</span>
00058 <span class="preprocessor"></span><span class="preprocessor">#ifdef HAVE_AL</span>
00059 <span class="preprocessor"></span>      <span class="stringliteral">"al:SGI AL"</span>  <span class="stringliteral">";"</span>
00060 <span class="preprocessor">#endif</span>
00061 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00062 <span class="preprocessor"></span>      <span class="stringliteral">"null:Null output (no sound)"</span>  ;
00063   }
00064 
<a name="l00065"></a><a class="code" href="device_8cpp.html#a0">00065</a> 
00066 <span class="preprocessor">  #define NEED_SEMICOLON do ; while (false)</span>
<a name="l00067"></a><a class="code" href="device_8cpp.html#a1">00067</a> <span class="preprocessor"></span>
00068 <span class="preprocessor">  #define TRY_GROUP(group_name) {                               \</span>
00069 <span class="preprocessor">    AudioDevice* device = DoOpenDevice(group_name, parameters); \</span>
00070 <span class="preprocessor">    if (device) {                                               \</span>
00071 <span class="preprocessor">      return device;                                            \</span>
00072 <span class="preprocessor">    }                                                           \</span>
00073 <span class="preprocessor">  } NEED_SEMICOLON</span>
<a name="l00074"></a><a class="code" href="device_8cpp.html#a2">00074</a> <span class="preprocessor"></span>
00075 <span class="preprocessor">  #define TRY_DEVICE(DeviceType) {                         \</span>
00076 <span class="preprocessor">    DeviceType* device = DeviceType::create(parameters);   \</span>
00077 <span class="preprocessor">    if (device) {                                          \</span>
00078 <span class="preprocessor">      return device;                                       \</span>
00079 <span class="preprocessor">    }                                                      \</span>
00080 <span class="preprocessor">  } NEED_SEMICOLON</span>
00081 <span class="preprocessor"></span>
<a name="l00082"></a><a class="code" href="namespaceaudiere.html#a68">00082</a> 
00083   <a class="code" href="classaudiere_1_1AudioDevice.html">AudioDevice</a>* <a class="code" href="namespaceaudiere.html#a68">DoOpenDevice</a>(
00084     <span class="keyword">const</span> std::string&amp; name,
00085     <span class="keyword">const</span> <a class="code" href="classaudiere_1_1ParameterList.html">ParameterList</a>&amp; <a class="code" href="namespaceaudiere_1_1hidden.html#a0">parameters</a>)
00086   {
00087     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"DoOpenDevice"</span>);
00088 
00089 <span class="preprocessor">    #ifdef _MSC_VER</span>
00090 <span class="preprocessor"></span>
00091       <span class="keywordflow">if</span> (name == <span class="stringliteral">""</span> || name == <span class="stringliteral">"autodetect"</span>) {
00092         <a class="code" href="device_8cpp.html#a1">TRY_GROUP</a>(<span class="stringliteral">"directsound"</span>);
00093         <a class="code" href="device_8cpp.html#a1">TRY_GROUP</a>(<span class="stringliteral">"winmm"</span>);
00094         <span class="keywordflow">return</span> 0;
00095       }
00096 
00097       <span class="keywordflow">if</span> (name == <span class="stringliteral">"directsound"</span>) {
00098         <a class="code" href="device_8cpp.html#a2">TRY_DEVICE</a>(<a class="code" href="classaudiere_1_1DSAudioDevice.html">DSAudioDevice</a>);
00099         <span class="keywordflow">return</span> 0;
00100       }
00101 
00102       <span class="keywordflow">if</span> (name == <span class="stringliteral">"winmm"</span>) {
00103         <a class="code" href="device_8cpp.html#a2">TRY_DEVICE</a>(<a class="code" href="classaudiere_1_1MMAudioDevice.html">MMAudioDevice</a>);
00104         <span class="keywordflow">return</span> 0;
00105       }
00106 
00107       <span class="keywordflow">if</span> (name == <span class="stringliteral">"null"</span>) {
00108         <a class="code" href="device_8cpp.html#a2">TRY_DEVICE</a>(<a class="code" href="classaudiere_1_1NullAudioDevice.html">NullAudioDevice</a>);
00109         <span class="keywordflow">return</span> 0;
00110       }
00111 
00112 <span class="preprocessor">    #else  // not Win32 - assume autoconf UNIX</span>
00113 <span class="preprocessor"></span>
00114       <span class="keywordflow">if</span> (name == <span class="stringliteral">""</span> || name == <span class="stringliteral">"autodetect"</span>) {
00115         <span class="comment">// in decreasing order of sound API quality</span>
00116         <a class="code" href="device_8cpp.html#a1">TRY_GROUP</a>(<span class="stringliteral">"al"</span>);
00117         <a class="code" href="device_8cpp.html#a1">TRY_GROUP</a>(<span class="stringliteral">"directsound"</span>);
00118         <a class="code" href="device_8cpp.html#a1">TRY_GROUP</a>(<span class="stringliteral">"winmm"</span>);
00119         <a class="code" href="device_8cpp.html#a1">TRY_GROUP</a>(<span class="stringliteral">"oss"</span>);
00120         <span class="keywordflow">return</span> 0;
00121       }
00122 
00123 <span class="preprocessor">      #ifdef HAVE_OSS</span>
00124 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (name == <span class="stringliteral">"oss"</span>) {
00125           <a class="code" href="device_8cpp.html#a2">TRY_DEVICE</a>(<a class="code" href="classaudiere_1_1OSSAudioDevice.html">OSSAudioDevice</a>);
00126           <span class="keywordflow">return</span> 0;
00127         }
00128 <span class="preprocessor">      #endif</span>
00129 <span class="preprocessor"></span>
00130 <span class="preprocessor">      #ifdef HAVE_DSOUND</span>
00131 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (name == <span class="stringliteral">"directsound"</span>) {
00132           <a class="code" href="device_8cpp.html#a2">TRY_DEVICE</a>(<a class="code" href="classaudiere_1_1DSAudioDevice.html">DSAudioDevice</a>);
00133           <span class="keywordflow">return</span> 0;
00134         }
00135 <span class="preprocessor">      #endif</span>
00136 <span class="preprocessor"></span>
00137 <span class="preprocessor">      #ifdef HAVE_WINMM</span>
00138 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (name == <span class="stringliteral">"winmm"</span>) {
00139           <a class="code" href="device_8cpp.html#a2">TRY_DEVICE</a>(<a class="code" href="classaudiere_1_1MMAudioDevice.html">MMAudioDevice</a>);
00140           <span class="keywordflow">return</span> 0;
00141         }
00142 <span class="preprocessor">      #endif</span>
00143 <span class="preprocessor"></span>
00144 <span class="preprocessor">      #ifdef HAVE_AL</span>
00145 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (name == <span class="stringliteral">"al"</span>) {
00146           <a class="code" href="device_8cpp.html#a2">TRY_DEVICE</a>(<a class="code" href="classaudiere_1_1ALAudioDevice.html">ALAudioDevice</a>);
00147           <span class="keywordflow">return</span> 0;
00148         }
00149 <span class="preprocessor">      #endif</span>
00150 <span class="preprocessor"></span>
00151       <span class="keywordflow">if</span> (name == <span class="stringliteral">"null"</span>) {
00152         <a class="code" href="device_8cpp.html#a2">TRY_DEVICE</a>(<a class="code" href="classaudiere_1_1NullAudioDevice.html">NullAudioDevice</a>);
00153         <span class="keywordflow">return</span> 0;
00154       }
00155 
00156 <span class="preprocessor">    #endif</span>
00157 <span class="preprocessor"></span>
00158     <span class="comment">// no devices</span>
00159     <span class="keywordflow">return</span> 0;
00160   }
00161 
<a name="l00162"></a><a class="code" href="classaudiere_1_1ThreadedDevice.html">00162</a> 
00163   <span class="keyword">class </span><a class="code" href="classaudiere_1_1ThreadedDevice.html">ThreadedDevice</a> : <span class="keyword">public</span> <a class="code" href="classaudiere_1_1RefImplementation.html">RefImplementation</a>&lt;AudioDevice&gt; {
<a name="l00164"></a><a class="code" href="classaudiere_1_1ThreadedDevice.html#a0">00164</a>   <span class="keyword">public</span>:
00165     <a class="code" href="classaudiere_1_1ThreadedDevice.html#a0">ThreadedDevice</a>(<a class="code" href="classaudiere_1_1AudioDevice.html">AudioDevice</a>* device) {
00166       <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"ThreadedDevice::ThreadedDevice"</span>);
00167       <span class="keywordflow">if</span> (device) {
00168         <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"Device is valid"</span>);
00169       } <span class="keywordflow">else</span> {
00170         <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"Device is not valid"</span>);
00171       }
00172 
00173       m_device = device;
00174       m_thread_exists = <span class="keyword">false</span>;
00175       m_thread_should_die = <span class="keyword">false</span>;
00176 
00178       <span class="keywordtype">bool</span> result = <a class="code" href="namespaceaudiere.html#a82">AI_CreateThread</a>(threadRoutine, <span class="keyword">this</span>, 2);
00179       <span class="keywordflow">if</span> (!result) {
00180         <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"THREAD CREATION FAILED"</span>);
00181       }
00182     }
<a name="l00183"></a><a class="code" href="classaudiere_1_1ThreadedDevice.html#a1">00183</a> 
00184     <a class="code" href="classaudiere_1_1ThreadedDevice.html#a1">~ThreadedDevice</a>() {
00185       m_thread_should_die = <span class="keyword">true</span>;
00186       <span class="keywordflow">while</span> (m_thread_exists) {
00187         <a class="code" href="namespaceaudiere.html#a83">AI_Sleep</a>(50);
00188       }
00189     }
00190 
<a name="l00191"></a><a class="code" href="classaudiere_1_1ThreadedDevice.html#a2">00191</a>     <span class="comment">// don't need to update the device...  the thread does it for us</span>
00192     <span class="keywordtype">void</span> <a class="code" href="audiere_8h.html#a0">ADR_CALL</a> <a class="code" href="classaudiere_1_1ThreadedDevice.html#a2">update</a>() {
00193     }
<a name="l00194"></a><a class="code" href="classaudiere_1_1ThreadedDevice.html#a3">00194</a> 
00195     <a class="code" href="classaudiere_1_1OutputStream.html">OutputStream</a>* <a class="code" href="audiere_8h.html#a0">ADR_CALL</a> <a class="code" href="classaudiere_1_1ThreadedDevice.html#a3">openStream</a>(<a class="code" href="classaudiere_1_1SampleSource.html">SampleSource</a>* source) {
00196       <span class="keywordflow">return</span> m_device-&gt;openStream(source);
00197     }
<a name="l00198"></a><a class="code" href="classaudiere_1_1ThreadedDevice.html#a4">00198</a> 
00199     <a class="code" href="classaudiere_1_1OutputStream.html">OutputStream</a>* <a class="code" href="audiere_8h.html#a0">ADR_CALL</a> <a class="code" href="classaudiere_1_1ThreadedDevice.html#a4">openBuffer</a>(
00200       <span class="keywordtype">void</span>* samples, <span class="keywordtype">int</span> frame_count,
00201       <span class="keywordtype">int</span> channel_count, <span class="keywordtype">int</span> sample_rate, <a class="code" href="namespaceaudiere.html#a105">SampleFormat</a> <a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a>)
00202     {
00203       <span class="keywordflow">return</span> m_device-&gt;openBuffer(
00204         samples, frame_count,
00205         channel_count, sample_rate, <a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a>);
00206     }
<a name="l00207"></a><a class="code" href="classaudiere_1_1ThreadedDevice.html#a5">00207</a> 
00208     <span class="keyword">const</span> <span class="keywordtype">char</span>* <a class="code" href="audiere_8h.html#a0">ADR_CALL</a> <a class="code" href="classaudiere_1_1ThreadedDevice.html#a5">getName</a>() {
00209       <span class="keywordflow">return</span> m_device-&gt;getName();
00210     }
00211 
00212   <span class="keyword">private</span>:
00213     <span class="keywordtype">void</span> run() {
00214       m_thread_exists = <span class="keyword">true</span>;
00215       <span class="keywordflow">while</span> (!m_thread_should_die) {
00216         m_device-&gt;update();
00217       }
00218       m_thread_exists = <span class="keyword">false</span>;
00219     }
00220 
00221     <span class="keyword">static</span> <span class="keywordtype">void</span> threadRoutine(<span class="keywordtype">void</span>* arg) {
00222       <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"ThreadedDevice::threadRoutine"</span>);
00223       <span class="keywordflow">if</span> (arg) {
00224         <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"arg is valid"</span>);
00225       } <span class="keywordflow">else</span> {
00226         <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"arg is not valid"</span>);
00227       }
00228 
00229       <a class="code" href="classaudiere_1_1ThreadedDevice.html#a0">ThreadedDevice</a>* This = (<a class="code" href="classaudiere_1_1ThreadedDevice.html#a0">ThreadedDevice</a>*)arg;
00230       This-&gt;run();
00231     }
00232 
00233   <span class="keyword">private</span>:
00234     RefPtr&lt;AudioDevice&gt; m_device;
00235     <span class="keyword">volatile</span> <span class="keywordtype">bool</span> m_thread_should_die;
00236     <span class="keyword">volatile</span> <span class="keywordtype">bool</span> m_thread_exists;
00237   };
00238 
00239 
00240   <a class="code" href="namespaceaudiere.html#a66">ADR_EXPORT</a>(AudioDevice*) AdrOpenDevice(
00241     <span class="keyword">const</span> <span class="keywordtype">char</span>* name,
00242     <span class="keyword">const</span> <span class="keywordtype">char</span>* <a class="code" href="namespaceaudiere_1_1hidden.html#a0">parameters</a>)
00243   {
00244     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"AdrOpenDevice"</span>);
00245 
00246     <span class="keywordflow">if</span> (!name) {
00247       name = <span class="stringliteral">""</span>;
00248     }
00249     <span class="keywordflow">if</span> (!<a class="code" href="namespaceaudiere_1_1hidden.html#a0">parameters</a>) {
00250       <a class="code" href="namespaceaudiere_1_1hidden.html#a0">parameters</a> = <span class="stringliteral">""</span>;
00251     }
00252 
00253     <span class="comment">// first, we need an unthreaded audio device</span>
00254     AudioDevice* device = <a class="code" href="namespaceaudiere.html#a68">DoOpenDevice</a>(
00255       std::string(name),
00256       ParameterList(<a class="code" href="namespaceaudiere_1_1hidden.html#a0">parameters</a>));
00257     <span class="keywordflow">if</span> (!device) {
00258       <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"Could not open device"</span>);
00259       <span class="keywordflow">return</span> 0;
00260     }
00261 
00262     <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"creating threaded device"</span>);
00263     <span class="keywordflow">return</span> <span class="keyword">new</span> ThreadedDevice(device);
00264   }
00265 
00266 }
</pre></div><hr><address style="align: right;"><small>Generated on Tue Jul 15 12:36:47 2003 for audiere by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc1 </small></address>
</body>
</html>
