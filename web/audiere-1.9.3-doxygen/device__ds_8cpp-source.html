<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>device_ds.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc1 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>device_ds.cpp</h1><a href="device__ds_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="preprocessor">#include &lt;algorithm&gt;</span>
00002 <span class="preprocessor">#include &lt;sstream&gt;</span>
00003 <span class="preprocessor">#include &lt;math.h&gt;</span>
00004 <span class="preprocessor">#include "<a class="code" href="device__ds_8h.html">device_ds.h</a>"</span>
00005 <span class="preprocessor">#include "<a class="code" href="device__ds__stream_8h.html">device_ds_stream.h</a>"</span>
00006 <span class="preprocessor">#include "<a class="code" href="device__ds__buffer_8h.html">device_ds_buffer.h</a>"</span>
00007 <span class="preprocessor">#include "<a class="code" href="debug_8h.html">debug.h</a>"</span>
00008 <span class="preprocessor">#include "<a class="code" href="utility_8h.html">utility.h</a>"</span>
00009 
00010 
00011 <span class="keyword">namespace </span>audiere {
00012 
00013   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> DEFAULT_BUFFER_LENGTH = 1000;  <span class="comment">// one second</span>
00014 
00015 
<a name="l00016"></a><a class="code" href="classaudiere_1_1DSAudioDevice.html#d0">00016</a>   <a class="code" href="classaudiere_1_1DSAudioDevice.html">DSAudioDevice</a>*
00017   DSAudioDevice::create(<span class="keyword">const</span> <a class="code" href="classaudiere_1_1ParameterList.html">ParameterList</a>&amp; <a class="code" href="namespaceaudiere_1_1hidden.html#a0">parameters</a>) {
00018     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"DSAudioDevice::create"</span>);
00019 
00020     <span class="comment">// parse parameters</span>
00021     <span class="keywordtype">int</span> stream_buffer_length = <a class="code" href="namespaceaudiere_1_1hidden.html#a0">parameters</a>.getInt(<span class="stringliteral">"buffer"</span>, 0);
00022     <span class="keywordflow">if</span> (stream_buffer_length &lt;= 0) {
00023       stream_buffer_length = DEFAULT_BUFFER_LENGTH;
00024     }
00025     <span class="keywordtype">int</span> min_buffer_length = <a class="code" href="namespaceaudiere_1_1hidden.html#a0">parameters</a>.getInt(<span class="stringliteral">"min_buffer_size"</span>, 0);
00026     min_buffer_length = std::max(1, min_buffer_length);
00027     <span class="keywordtype">bool</span> global_focus = <a class="code" href="namespaceaudiere_1_1hidden.html#a0">parameters</a>.getBoolean(<span class="stringliteral">"global"</span>, <span class="keyword">true</span>);
00028 
00029     <span class="comment">// initialize COM</span>
00030     HRESULT rv = CoInitialize(NULL);
00031     <span class="keywordflow">if</span> (FAILED(rv)) {
00032       <span class="keywordflow">return</span> 0;
00033     }
00034 
00035     <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"COM initialized properly"</span>);
00036 
00037     <span class="comment">// register anonymous window class</span>
00038     <span class="comment">// don't worry about failure, if it fails, the window creation will fail</span>
00039     WNDCLASS wc;
00040     wc.style          = 0;
00041     wc.lpfnWndProc    = DefWindowProc;
00042     wc.cbClsExtra     = 0;
00043     wc.cbWndExtra     = 0;
00044     wc.hInstance      = GetModuleHandle(NULL);
00045     wc.hIcon          = NULL;
00046     wc.hCursor        = NULL;
00047     wc.hbrBackground  = NULL;
00048     wc.lpszMenuName   = NULL;
00049     wc.lpszClassName  = <span class="stringliteral">"AudiereHiddenWindow"</span>;
00050     RegisterClass(&amp;wc);
00051 
00052     <span class="comment">// create anonymous window</span>
00053     HWND anonymous_window = CreateWindow(
00054       <span class="stringliteral">"AudiereHiddenWindow"</span>, <span class="stringliteral">""</span>, WS_POPUP,
00055       0, 0, 0, 0,
00056       NULL, NULL, GetModuleHandle(NULL), NULL);
00057     <span class="keywordflow">if</span> (!anonymous_window) {
00058       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00059     }
00060 
00061     <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"Anonymous window created successfully"</span>);
00062 
00063     <span class="comment">// create the DirectSound object</span>
00064     IDirectSound* direct_sound;
00065     rv = CoCreateInstance(
00066       CLSID_DirectSound,
00067       NULL,
00068       CLSCTX_INPROC_SERVER,
00069       IID_IDirectSound,
00070       (<span class="keywordtype">void</span>**)&amp;direct_sound);
00071     <span class="keywordflow">if</span> (FAILED(rv) || !direct_sound) {
00072       DestroyWindow(anonymous_window);
00073       <span class="keywordflow">return</span> 0;
00074     }
00075 
00076     <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"Created DS object"</span>);
00077 
00078     LPGUID guid = NULL;
00079     GUID stack_guid;  <span class="comment">// so we can point 'guid' to an object that won't be destroyed</span>
00080 
00081     std::string guid_string = <a class="code" href="namespaceaudiere_1_1hidden.html#a0">parameters</a>.getValue(<span class="stringliteral">"device_guid"</span>, <span class="stringliteral">""</span>);
00082     <span class="keywordflow">if</span> (!guid_string.empty()) {
00083       <span class="keywordflow">if</span> (UuidFromString((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)guid_string.c_str(), &amp;stack_guid) == RPC_S_OK) {
00084         guid = &amp;stack_guid;
00085       }
00086     }
00087 
00088     <span class="comment">// initialize the DirectSound device</span>
00089     rv = direct_sound-&gt;Initialize(guid);
00090     <span class="keywordflow">if</span> (FAILED(rv)) {
00091       DestroyWindow(anonymous_window);
00092       direct_sound-&gt;Release();
00093       <span class="keywordflow">return</span> 0;
00094     }
00095 
00096     <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"Initialized DS object"</span>);
00097 
00098     <span class="comment">// set the cooperative level</span>
00099     rv = direct_sound-&gt;SetCooperativeLevel(anonymous_window, DSSCL_NORMAL);
00100     <span class="keywordflow">if</span> (FAILED(rv)) {
00101       DestroyWindow(anonymous_window);
00102       direct_sound-&gt;Release();
00103       <span class="keywordflow">return</span> 0;
00104     }
00105 
00106     <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"Set cooperative level"</span>);
00107 
00108     <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classaudiere_1_1DSAudioDevice.html">DSAudioDevice</a>(
00109       global_focus, stream_buffer_length, min_buffer_length,
00110       anonymous_window, direct_sound);
00111   }
00112 
00113 
00114   DSAudioDevice::DSAudioDevice(
00115     <span class="keywordtype">bool</span> global_focus,
00116     <span class="keywordtype">int</span> stream_buffer_length,
00117     <span class="keywordtype">int</span> min_buffer_length,
00118     HWND anonymous_window,
00119     IDirectSound* direct_sound)
00120   {
00121     m_global_focus      = global_focus;
00122     m_buffer_length     = stream_buffer_length;
00123     m_min_buffer_length = min_buffer_length;
00124     m_anonymous_window  = anonymous_window;
00125     m_direct_sound      = direct_sound;
00126   }
00127 
00128 
00129   DSAudioDevice::~DSAudioDevice() {
00130     <a class="code" href="debug_8h.html#a3">ADR_ASSERT</a>(m_open_streams.size() == 0,
00131       <span class="stringliteral">"DirectSound output context should not die with open streams"</span>);
00132 
00133     <span class="comment">// shut down DirectSound</span>
00134     <span class="keywordflow">if</span> (m_direct_sound) {
00135       m_direct_sound-&gt;Release();
00136       m_direct_sound = NULL;
00137     }
00138 
00139     <span class="comment">// if the anonymous window is open, close it</span>
00140     <span class="keywordflow">if</span> (m_anonymous_window) {
00141       DestroyWindow(m_anonymous_window);
00142       m_anonymous_window = NULL;
00143     }
00144 
00145     CoUninitialize();
00146   }
00147 
00148 
<a name="l00149"></a><a class="code" href="classaudiere_1_1DSAudioDevice.html#a0">00149</a>   <span class="keywordtype">void</span>
00150   DSAudioDevice::update() {
00151     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(<span class="keyword">this</span>);
00152 
00153     <span class="comment">// enumerate all open streams</span>
00154     StreamList::iterator i = m_open_streams.begin();
00155     <span class="keywordflow">while</span> (i != m_open_streams.end()) {
00156       <a class="code" href="classaudiere_1_1DSOutputStream.html">DSOutputStream</a>* s = *i++;
00157       s-&gt;<a class="code" href="classaudiere_1_1DSOutputStream.html#c2">update</a>();
00158     }
00159 
00160     Sleep(50);
00161   }
00162 
00163 
<a name="l00164"></a><a class="code" href="classaudiere_1_1DSAudioDevice.html#a1">00164</a>   <a class="code" href="classaudiere_1_1OutputStream.html">OutputStream</a>*
00165   DSAudioDevice::openStream(<a class="code" href="classaudiere_1_1SampleSource.html">SampleSource</a>* source) {
00166     <span class="keywordflow">if</span> (!source) {
00167       <span class="keywordflow">return</span> 0;
00168     }
00169 
00170     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"DSAudioDevice::openStream"</span>);
00171     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(<span class="keyword">this</span>);
00172 
00173     <span class="keywordtype">int</span> channel_count, sample_rate;
00174     <a class="code" href="namespaceaudiere.html#a105">SampleFormat</a> <a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a>;
00175     source-&gt;<a class="code" href="classaudiere_1_1SampleSource.html#a0">getFormat</a>(channel_count, sample_rate, <a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a>);
00176 
00177     <span class="keyword">const</span> <span class="keywordtype">int</span> frame_size = channel_count * <a class="code" href="namespaceaudiere.html#a45">GetSampleSize</a>(<a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a>);
00178 
00179     <span class="comment">// calculate an ideal buffer size</span>
00180     <span class="keyword">const</span> <span class="keywordtype">int</span> buffer_length = sample_rate * m_buffer_length / 1000;
00181 
00182     <span class="comment">// define the wave format</span>
00183     WAVEFORMATEX wfx;
00184     memset(&amp;wfx, 0, <span class="keyword">sizeof</span>(wfx));
00185     wfx.wFormatTag      = WAVE_FORMAT_PCM;
00186     wfx.nChannels       = channel_count;
00187     wfx.nSamplesPerSec  = sample_rate;
00188     wfx.nAvgBytesPerSec = sample_rate * frame_size;
00189     wfx.nBlockAlign     = frame_size;
00190     wfx.wBitsPerSample  = <a class="code" href="namespaceaudiere.html#a45">GetSampleSize</a>(<a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a>) * 8;
00191     wfx.cbSize          = <span class="keyword">sizeof</span>(wfx);
00192 
00193     DSBUFFERDESC dsbd;
00194     memset(&amp;dsbd, 0, <span class="keyword">sizeof</span>(dsbd));
00195     dsbd.dwSize        = <span class="keyword">sizeof</span>(dsbd);
00196     dsbd.dwFlags       = DSBCAPS_GETCURRENTPOSITION2 | DSBCAPS_CTRLPAN |
00197                          DSBCAPS_CTRLVOLUME | DSBCAPS_CTRLFREQUENCY;
00198     <span class="keywordflow">if</span> (m_global_focus) {
00199       dsbd.dwFlags |= DSBCAPS_GLOBALFOCUS;
00200     }
00201     dsbd.dwBufferBytes = frame_size * buffer_length;
00202     dsbd.lpwfxFormat   = &amp;wfx;
00203 
00204     <span class="comment">// create the DirectSound buffer</span>
00205     IDirectSoundBuffer* buffer;
00206     HRESULT result = m_direct_sound-&gt;CreateSoundBuffer(
00207       &amp;dsbd, &amp;buffer, NULL);
00208     <span class="keywordflow">if</span> (FAILED(result) || !buffer) {
00209       <span class="keywordflow">return</span> 0;
00210     }
00211 
00212     <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(<span class="stringliteral">"CreateSoundBuffer succeeded"</span>);
00213 
00214     <span class="comment">// now create the output stream</span>
00215     <a class="code" href="classaudiere_1_1DSOutputStream.html">DSOutputStream</a>* stream = <span class="keyword">new</span> <a class="code" href="classaudiere_1_1DSAudioDevice.html#l0">DSOutputStream</a>(
00216       <span class="keyword">this</span>, buffer, buffer_length, source);
00217 
00218     <span class="comment">// add it the list of streams and return</span>
00219     m_open_streams.push_back(stream);
00220     <span class="keywordflow">return</span> stream;
00221   }
00222 
00223 
<a name="l00224"></a><a class="code" href="classaudiere_1_1DSAudioDevice.html#a2">00224</a>   <a class="code" href="classaudiere_1_1OutputStream.html">OutputStream</a>*
00225   DSAudioDevice::openBuffer(
00226     <span class="keywordtype">void</span>* samples, <span class="keywordtype">int</span> frame_count,
00227     <span class="keywordtype">int</span> channel_count, <span class="keywordtype">int</span> sample_rate, <a class="code" href="namespaceaudiere.html#a105">SampleFormat</a> <a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a>)
00228   {
00229     <a class="code" href="debug_8h.html#a0">ADR_GUARD</a>(<span class="stringliteral">"DSAudioDevice::openBuffer"</span>);
00230     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(<span class="keyword">this</span>);
00231 
00232     <span class="keyword">const</span> <span class="keywordtype">int</span> frame_size = channel_count * <a class="code" href="namespaceaudiere.html#a45">GetSampleSize</a>(<a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a>);
00233 
00234     WAVEFORMATEX wfx;
00235     memset(&amp;wfx, 0, <span class="keyword">sizeof</span>(wfx));
00236     wfx.wFormatTag      = WAVE_FORMAT_PCM;
00237     wfx.nChannels       = channel_count;
00238     wfx.nSamplesPerSec  = sample_rate;
00239     wfx.nAvgBytesPerSec = sample_rate * frame_size;
00240     wfx.nBlockAlign     = frame_size;
00241     wfx.wBitsPerSample  = <a class="code" href="namespaceaudiere.html#a45">GetSampleSize</a>(<a class="code" href="namespaceaudiere_1_1hidden.html#a7">sample_format</a>) * 8;
00242     wfx.cbSize          = <span class="keyword">sizeof</span>(wfx);
00243 
00244     DSBUFFERDESC dsbd;
00245     memset(&amp;dsbd, 0, <span class="keyword">sizeof</span>(dsbd));
00246     dsbd.dwSize  = <span class="keyword">sizeof</span>(dsbd);
00247     dsbd.dwFlags = DSBCAPS_GETCURRENTPOSITION2 | DSBCAPS_CTRLPAN |
00248                    DSBCAPS_CTRLVOLUME | DSBCAPS_CTRLFREQUENCY |
00249                    DSBCAPS_STATIC;
00250     <span class="keywordflow">if</span> (m_global_focus) {
00251       dsbd.dwFlags |= DSBCAPS_GLOBALFOCUS;
00252     }
00253 
00254     <span class="keyword">const</span> <span class="keywordtype">int</span> buffer_frame_count = std::max(m_min_buffer_length, frame_count);
00255     <span class="keyword">const</span> <span class="keywordtype">int</span> buffer_size = buffer_frame_count * frame_size;
00256     dsbd.dwBufferBytes = buffer_size;
00257     dsbd.lpwfxFormat   = &amp;wfx;
00258 
00259     <span class="comment">// create the DS buffer</span>
00260     IDirectSoundBuffer* buffer;
00261     HRESULT result = m_direct_sound-&gt;CreateSoundBuffer(
00262       &amp;dsbd, &amp;buffer, NULL);
00263     <span class="keywordflow">if</span> (FAILED(result) || !buffer) {
00264       <span class="keywordflow">return</span> 0;
00265     }
00266 
00267     <a class="code" href="debug_8h.html#a2">ADR_IF_DEBUG</a> {
00268       DSBCAPS caps;
00269       caps.dwSize = <span class="keyword">sizeof</span>(caps);
00270       result = buffer-&gt;GetCaps(&amp;caps);
00271       <span class="keywordflow">if</span> (FAILED(result)) {
00272         buffer-&gt;Release();
00273         <span class="keywordflow">return</span> 0;
00274       } <span class="keywordflow">else</span> {
00275         std::ostringstream ss;
00276         ss &lt;&lt; <span class="stringliteral">"actual buffer size: "</span> &lt;&lt; caps.dwBufferBytes &lt;&lt; std::endl
00277            &lt;&lt; <span class="stringliteral">"buffer_size: "</span> &lt;&lt; buffer_size;
00278         <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(ss.str().c_str());
00279       }
00280     }
00281 
00282     <span class="keywordtype">void</span>* data;
00283     DWORD data_size;
00284     result = buffer-&gt;Lock(0, buffer_size, &amp;data, &amp;data_size, 0, 0, 0);
00285     <span class="keywordflow">if</span> (FAILED(result)) {
00286       buffer-&gt;Release();
00287       <span class="keywordflow">return</span> 0;
00288     }
00289 
00290     <a class="code" href="debug_8h.html#a2">ADR_IF_DEBUG</a> {
00291       std::ostringstream ss;
00292       ss &lt;&lt; <span class="stringliteral">"buffer size: "</span> &lt;&lt; buffer_size &lt;&lt; std::endl
00293          &lt;&lt; <span class="stringliteral">"data size:   "</span> &lt;&lt; data_size &lt;&lt; std::endl
00294          &lt;&lt; <span class="stringliteral">"frame count: "</span> &lt;&lt; frame_count;
00295       <a class="code" href="debug_8h.html#a1">ADR_LOG</a>(ss.str().c_str());
00296     }
00297 
00298     <span class="keyword">const</span> <span class="keywordtype">int</span> actual_size = frame_count * frame_size;
00299     memcpy(data, samples, actual_size);
00300     memset((<a class="code" href="namespaceaudiere.html#a33">u8</a>*)data + actual_size, 0, buffer_size - actual_size);
00301 
00302     buffer-&gt;Unlock(data, data_size, 0, 0);
00303 
00304     <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classaudiere_1_1DSOutputBuffer.html">DSOutputBuffer</a>(<span class="keyword">this</span>, buffer, buffer_frame_count, frame_size);
00305   }
00306 
00307 
<a name="l00308"></a><a class="code" href="classaudiere_1_1DSAudioDevice.html#a3">00308</a>   <span class="keyword">const</span> <span class="keywordtype">char</span>* <a class="code" href="audiere_8h.html#a0">ADR_CALL</a>
00309   DSAudioDevice::getName() {
00310     <span class="keywordflow">return</span> <span class="stringliteral">"directsound"</span>;
00311   }
00312 
00313 
00314   <span class="keywordtype">void</span>
00315   DSAudioDevice::removeStream(DSOutputStream* stream) {
00316     <a class="code" href="threads_8h.html#a0">SYNCHRONIZED</a>(<span class="keyword">this</span>);
00317     m_open_streams.remove(stream);
00318   }
00319 
00320 
<a name="l00321"></a><a class="code" href="classaudiere_1_1DSAudioDevice.html#d1">00321</a>   <span class="keywordtype">int</span>
00322   DSAudioDevice::Volume_AudiereToDirectSound(<span class="keywordtype">float</span> volume) {
00323     <span class="keywordflow">if</span> (volume == 0) {
00324       <span class="keywordflow">return</span> -10000;
00325     } <span class="keywordflow">else</span> {
00326       <span class="keywordtype">double</span> attenuate = 1000 * log(1 / volume);
00327       <span class="keywordflow">return</span> int(-attenuate);
00328     }
00329   }
00330 
00331 
<a name="l00332"></a><a class="code" href="classaudiere_1_1DSAudioDevice.html#d2">00332</a>   <span class="keywordtype">int</span>
00333   DSAudioDevice::Pan_AudiereToDirectSound(<span class="keywordtype">float</span> pan) {
00334     <span class="keywordflow">if</span> (pan &lt; 0) {
00335       <span class="keywordflow">return</span> -<a class="code" href="classaudiere_1_1DSAudioDevice.html#d2">Pan_AudiereToDirectSound</a>(-pan);
00336     } <span class="keywordflow">else</span> {
00337       <span class="keywordflow">return</span> -<a class="code" href="classaudiere_1_1DSAudioDevice.html#d1">Volume_AudiereToDirectSound</a>(1 - pan);
00338     }
00339   }
00340 
00341 }
</pre></div><hr><address style="align: right;"><small>Generated on Tue Jul 15 12:36:47 2003 for audiere by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc1 </small></address>
</body>
</html>
